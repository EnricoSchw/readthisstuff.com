!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){},{}],2:[function(require,module,exports){(function(global){"use strict";function _interopDefault(ex){return ex&&"object"==typeof ex&&"default"in ex?ex.default:ex}function interopDefault(ex){return ex&&"object"==typeof ex&&"default"in ex?ex.default:ex}function createCommonjsModule(fn,module){return module={exports:{}},fn(module,module.exports),module.exports}function byPriorityDescending(a,b){return b.priority-a.priority}function _on(event,method,context,priority){var bindings;return validateMethod(method,context),bindings=this.__events__.hasOwnProperty(event)?this.__events__[event]:this.__events__[event]=[],bindings.push({method:method,context:context||null,priority:priority}),this}function _off(event,method,context){var i,bindings;if(1===arguments.length)return delete this.__events__[event],this;if(validateMethod(method,context),!(event in this.__events__&&this.__events__[event].length))return this;for(arguments.length<3&&(context=null),bindings=this.__events__[event],i=bindings.length;i--;)bindings[i].method===method&&bindings[i].context===context&&bindings.splice(i,1);return 0===bindings.length&&delete this.__events__[event],this}function _disconnect$1(context){return forEach$2(this.__events__,function(bindings,event){for(var this$1=this,i=bindings.length-1;i>=0;i--)bindings[i]&&bindings[i].context===context&&_off.call(this$1,event,bindings[i].method,context)}.bind(this)),this}function validateMethod(method,context){if("string"==typeof method){if(void 0===context||null===context)throw new Error('Method name "'+method+'" has no context.');if(!(method in context))throw new Error('Method not found: "'+method+'"');if("function"!=typeof context[method])throw new Error('Property "'+method+'" is not a function')}else if("function"!=typeof method)throw new Error("Invalid callback. Function or method name expected.")}function uuid$1(prefix,len){prefix&&"-"!==prefix[prefix.length-1]&&(prefix=prefix.concat("-"));var idx,chars="0123456789abcdefghijklmnopqrstuvwxyz".split(""),uuid=[],radix=16;if(len=len||32)for(idx=0;idx<len;idx++)uuid[idx]=chars[0|Math.random()*radix];else{var r;for(uuid[8]=uuid[13]=uuid[18]=uuid[23]="-",uuid[14]="4",idx=0;idx<36;idx++)uuid[idx]||(r=0|16*Math.random(),uuid[idx]=chars[19===idx?3&r|8:r])}return(prefix?prefix:"")+uuid.join("")}function hasConflict$1$1(a,b){if(a.type===INSERT&&b.type===INSERT)return a.pos===b.pos;if(a.type===DELETE$1&&b.type===DELETE$1)return!(a.pos>=b.pos+b.str.length||b.pos>=a.pos+a.str.length);var del,ins;return a.type===DELETE$1?(del=a,ins=b):(del=b,ins=a),ins.pos>=del.pos&&ins.pos<del.pos+del.str.length}function transform_insert_insert(a,b){a.pos===b.pos?b.pos+=a.str.length:a.pos<b.pos?b.pos+=a.str.length:a.pos+=b.str.length}function transform_delete_delete$1(a,b,first){if(a.pos>b.pos)return transform_delete_delete$1(b,a,!first);if(a.pos===b.pos&&a.str.length>b.str.length)return transform_delete_delete$1(b,a,!first);if(b.pos<a.pos+a.str.length){var s=b.pos-a.pos,s1=a.str.length-s,s2=s+b.str.length;a.str=a.str.slice(0,s)+a.str.slice(s2),b.str=b.str.slice(s1),b.pos-=s}else b.pos-=a.str.length}function transform_insert_delete(a,b){if(a.type===DELETE$1)return transform_insert_delete(b,a);if(a.pos<=b.pos)b.pos+=a.str.length;else if(a.pos>=b.pos+b.str.length)a.pos-=b.str.length;else{var s=a.pos-b.pos;b.str=b.str.slice(0,s)+a.str+b.str.slice(s),a.str=""}}function transform_insert_insert$1(a,b){a.pos===b.pos?b.pos+=1:a.pos<b.pos?b.pos+=1:a.pos+=1}function transform_delete_delete$2(a,b){return a.pos===b.pos?(b.type=NOP$1,void(a.type=NOP$1)):void(a.pos<b.pos?b.pos-=1:a.pos-=1)}function transform_insert_delete$1(a,b){if(a.type===DELETE$2){var tmp=a;a=b,b=tmp}a.pos<=b.pos?b.pos+=1:a.pos-=1}function _createNewSelection(containerSel,start,end){var newSel=new ContainerSelection(containerSel.containerId,start.path,start.offset,end.path,end.offset,(!1),containerSel.surfaceId),doc=containerSel._internal.doc;return doc&&newSel.attach(doc),newSel}function fromJSON(json){if(!json)return Selection.nullSelection;var type=json.type;switch(type){case"property":return PropertySelection.fromJSON(json);case"container":return ContainerSelection.fromJSON(json);case"node":return NodeSelection.fromJSON(json);case"custom":return CustomSelection.fromJSON(json);default:return Selection.nullSelection}}function _transformInplaceSingle(a,b){for(var i=0;i<a.ops.length;i++)for(var a_op=a.ops[i],j=0;j<b.ops.length;j++){var b_op=b.ops[j];ObjectOperation.transform(a_op,b_op,{inplace:!0})}a.before&&_transformSelectionInplace(a.before.selection,b),a.after&&_transformSelectionInplace(a.after.selection,b),b.before&&_transformSelectionInplace(b.before.selection,a),b.after&&_transformSelectionInplace(b.after.selection,a)}function _transformInplaceBatch(A,B){isArray$1(A)||(A=[A]),isArray$1(B)||(B=[B]);for(var i=0;i<A.length;i++)for(var a=A[i],j=0;j<B.length;j++){var b=B[j];_transformInplaceSingle(a,b)}}function _transformSelectionInplace(sel,a){if(!sel||!sel.isPropertySelection()&&!sel.isContainerSelection())return!1;for(var ops=a.ops,hasChanged=!1,isCollapsed=sel.isCollapsed(),i=0;i<ops.length;i++){var op=ops[i];hasChanged|=_transformCoordinateInplace(sel.start,op),isCollapsed?(sel.isContainerSelection()&&(sel.endPath=sel.startPath),sel.endOffset=sel.startOffset):hasChanged|=_transformCoordinateInplace(sel.end,op)}return hasChanged}function _transformCoordinateInplace(coor,op){if(!isEqual$2(op.path,coor.path))return!1;var hasChanged=!1;if("update"===op.type&&"string"===op.propertyType){var newOffset,diff=op.diff;diff.isInsert()&&diff.pos<=coor.offset?(newOffset=coor.offset+diff.str.length,coor.offset=newOffset,hasChanged=!0):diff.isDelete()&&diff.pos<=coor.offset&&(newOffset=Math.max(diff.pos,coor.offset-diff.str.length),coor.offset=newOffset,hasChanged=!0)}return hasChanged}function deleteFromArray(array,value){for(var i=0;i<array.length;i++)array[i]===value&&(array.splice(i,1),i--)}function _createSelection(){var coor,range,path,startOffset,endOffset,doc=this;if(1===arguments.length&&null===arguments[0])return Selection.nullSelection;if(arguments[0]instanceof Coordinate)return coor=arguments[0],coor.isNodeCoordinate()?NodeSelection._createFromCoordinate(coor):new PropertySelection(coor.path,coor.offset,coor.offset);if(arguments[0]instanceof Range){range=arguments[0];var inOneNode=isEqual$2(range.start.path,range.end.path);return inOneNode?range.start.isNodeCoordinate()?NodeSelection._createFromRange(range):new PropertySelection(range.start.path,range.start.offset,range.end.offset,range.reverse,range.containerId):new ContainerSelection(range.containerId,range.start.path,range.start.offset,range.end.path,range.end.offset,range.reverse)}return 1===arguments.length&&isObject$1(arguments[0])?_createSelectionFromData(doc,arguments[0]):2===arguments.length&&isArray$1(arguments[0])?(path=arguments[0],startOffset=arguments[1],new PropertySelection(path,startOffset,startOffset)):3===arguments.length&&isArray$1(arguments[0])?(path=arguments[0],startOffset=arguments[1],endOffset=arguments[2],new PropertySelection(path,startOffset,endOffset,startOffset>endOffset)):5===arguments.length&&isString$1(arguments[0])?_createSelectionFromData(doc,{type:"container",containerId:arguments[0],startPath:arguments[1],startOffset:arguments[2],endPath:arguments[3],endOffset:arguments[4]}):(console.error("Illegal arguments for Selection.create().",arguments),Selection.nullSelection)}function _createSelectionFromData(doc,selData){var tmp;if("property"===selData.type)return null!==selData.endOffset&&void 0!==selData.endOffset||(selData.endOffset=selData.startOffset),selData.hasOwnProperty("reverse")||(selData.startOffset>selData.endOffset?(tmp=selData.startOffset,selData.startOffset=selData.endOffset,selData.endOffset=tmp,selData.reverse=!0):selData.reverse=!1),new PropertySelection(selData.path,selData.startOffset,selData.endOffset,selData.reverse,selData.containerId,selData.surfaceId);if("container"===selData.type){var container=doc.get(selData.containerId,"strict"),start=new Coordinate(selData.startPath,selData.startOffset),end=new Coordinate(selData.endPath,selData.endOffset),startAddress=container.getAddress(start),endAddress=container.getAddress(end),isReverse=selData.reverse;if(!startAddress)throw new Error("Invalid arguments for ContainerSelection: ",start.toString());if(!endAddress)throw new Error("Invalid arguments for ContainerSelection: ",end.toString());return selData.hasOwnProperty("reverse")||(isReverse=endAddress.isBefore(startAddress,"strict"),isReverse&&(tmp=start,start=end,end=tmp)),_allignCoordinate(doc,start,!0),_allignCoordinate(doc,end,!1),new ContainerSelection(container.id,start.path,start.offset,end.path,end.offset,isReverse,selData.surfaceId)}if("node"===selData.type)return NodeSelection.fromJSON(selData);if("custom"===selData.type)return CustomSelection.fromJSON(selData);throw new Error("Illegal selection type",selData)}function _allignCoordinate(doc,coor,isStart){if(!coor.isNodeCoordinate()){var nodeId=coor.getNodeId(),node=doc.get(nodeId);node.isText()||(console.warn("Selecting a non-textish node partially is not supported. Select the full node."),coor.path=[nodeId],coor.offset=isStart?0:1)}}function request(method,url,data,cb){var request=new XMLHttpRequest;request.open(method,url,!0),request.setRequestHeader("Content-Type","application/json; charset=UTF-8"),request.onload=function(){if(!(request.status>=200&&request.status<400))return cb(new Error("Request failed. Returned status: "+request.status));var res=request.responseText;isJson(res)&&(res=JSON.parse(res)),cb(null,res)},data?request.send(JSON.stringify(data)):request.send()}function isJson(str){try{JSON.parse(str)}catch(e){return!1}return!0}function insertedText(doc,coordinate,length){if(length){var index=doc.getIndex("annotations"),annotations=index.get(coordinate.path);forEach$2(annotations,function(anno){var pos=coordinate.offset,start=anno.startOffset,end=anno.endOffset,newStart=start,newEnd=end;(pos<start||pos===start)&&(newStart+=length),(pos<end||pos===end&&!anno.isInline())&&(newEnd+=length),newStart!==start&&doc.set([anno.id,"startOffset"],newStart),newEnd!==end&&doc.set([anno.id,"endOffset"],newEnd)}),index=doc.getIndex("container-annotation-anchors");var anchors=index.get(coordinate.path);forEach$2(anchors,function(anchor){var pos=coordinate.offset,start=anchor.offset,changed=!1;if((pos<start||pos===start&&!coordinate.after)&&(start+=length,changed=!0),changed){var property=anchor.isStart?"startOffset":"endOffset";doc.set([anchor.id,property],start)}})}}function deletedText(doc,path,startOffset,endOffset){if(startOffset!==endOffset){var index=doc.getIndex("annotations"),annotations=index.get(path),length=endOffset-startOffset;forEach$2(annotations,function(anno){var pos1=startOffset,pos2=endOffset,start=anno.startOffset,end=anno.endOffset,newStart=start,newEnd=end;pos2<=start?(newStart-=length,newEnd-=length,doc.set([anno.id,"startOffset"],newStart),doc.set([anno.id,"endOffset"],newEnd)):(pos1<=start&&(newStart=start-Math.min(pos2-pos1,start-pos1)),pos1<=end&&(newEnd=end-Math.min(pos2-pos1,end-pos1)),start!==end&&newStart===newEnd?doc.delete(anno.id):(start!==newStart&&doc.set([anno.id,"startOffset"],newStart),end!==newEnd&&doc.set([anno.id,"endOffset"],newEnd)))}),index=doc.getIndex("container-annotation-anchors");var anchors=index.get(path),containerAnnoIds=[];forEach$2(anchors,function(anchor){containerAnnoIds.push(anchor.id);var pos1=startOffset,pos2=endOffset,start=anchor.offset,changed=!1;if(pos2<=start)start-=length,changed=!0;else if(pos1<=start){var newStart=start-Math.min(pos2-pos1,start-pos1);start!==newStart&&(start=newStart,changed=!0)}if(changed){var property=anchor.isStart?"startOffset":"endOffset";doc.set([anchor.id,property],start)}}),forEach$2(uniq$1(containerAnnoIds),function(id){var anno=doc.get(id),annoSel=anno.getSelection();annoSel.isCollapsed()&&doc.delete(id)})}}function transferAnnotations(doc,path,offset,newPath,newOffset){var index=doc.getIndex("annotations"),annotations=index.get(path,offset);forEach$2(annotations,function(a){var newStart,newEnd,isInside=offset>a.startOffset&&offset<a.endOffset,start=a.startOffset,end=a.endOffset;if(isInside){if(a.canSplit()){var newAnno=a.toJSON();newAnno.id=uuid$1(a.type+"_"),newAnno.startOffset=newOffset,newAnno.endOffset=newOffset+a.endOffset-offset,newAnno.path=newPath,doc.create(newAnno)}newStart=a.startOffset,newEnd=offset,newEnd===newStart?doc.delete(a.id):(newStart!==start&&doc.set([a.id,"startOffset"],newStart),newEnd!==end&&doc.set([a.id,"endOffset"],newEnd))}else a.startOffset>=offset&&(newStart=newOffset+a.startOffset-offset,newEnd=newOffset+a.endOffset-offset,doc.set([a.id,"path"],newPath),doc.set([a.id,"startOffset"],newStart),doc.set([a.id,"endOffset"],newEnd))}),index=doc.getIndex("container-annotation-anchors");var anchors=index.get(path),containerAnnoIds=[];forEach$2(anchors,function(anchor){containerAnnoIds.push(anchor.id);var start=anchor.offset;if(offset<=start){var pathProperty=anchor.isStart?"startPath":"endPath",offsetProperty=anchor.isStart?"startOffset":"endOffset";doc.set([anchor.id,pathProperty],newPath),doc.set([anchor.id,offsetProperty],newOffset+anchor.offset-offset)}}),forEach$2(uniq$1(containerAnnoIds),function(id){var anno=doc.get(id),annoSel=anno.getSelection();annoSel.isCollapsed()&&doc.delete(id)})}function _defineSchema(NodeClass,schema){schema.type&&(NodeClass.type=schema.type);var compiledSchema=_compileSchema(schema);NodeClass.schema=_unfoldedSchema(NodeClass,compiledSchema),NodeClass.defaultProps=_extractDefaultProps(NodeClass)}function _compileSchema(schema){var compiledSchema={};return each$2(schema,function(definition,name){"type"!==name&&((isString$1(definition)||isArray$1(definition))&&(definition={type:definition}),definition=_compileDefintion(definition),definition.name=name,compiledSchema[name]=definition)}),compiledSchema}function _compileDefintion(definition){var result=definition;return isArray$1(definition.type)&&"array"!==definition[0]?definition.type=["array",definition.type[0]]:"text"===definition.type&&(result={type:"string",default:""}),result}function _unfoldedSchema(NodeClass,compiledSchema){for(var schemas=[compiledSchema],clazz=NodeClass;clazz;){var parentProto=Object.getPrototypeOf(clazz.prototype);if(!parentProto)break;clazz=parentProto.constructor,clazz&&clazz.schema&&schemas.unshift(clazz.schema)}return schemas.unshift({}),Object.assign.apply(null,schemas)}function _extractDefaultProps(NodeClass){var unfoldedSchema=NodeClass.unfoldedSchema,defaultProps={};return each$2(unfoldedSchema,function(prop,name){prop.hasOwnProperty("default")&&(defaultProps[name]=prop.default)}),defaultProps}function _checked(prop,value){var type;if(type=isArray$1(prop.type)?"array":prop.type,null===value){if(prop.notNull)throw new Error("Value for property "+prop.name+" is null.");return value}if(void 0===value)throw new Error("Value for property "+prop.name+" is undefined.");if("string"===type&&!isString$1(value)||"boolean"===type&&!isBoolean$1(value)||"number"===type&&!isNumber$1(value)||"array"===type&&!isArray$1(value)||"id"===type&&!isString$1(value)||"object"===type&&!isObject$1(value))throw new Error("Illegal value type for property "+prop.name+": expected "+type+", was "+typeof value);return value}function _matchPropertyEvent(eventName){return/([a-zA-Z_0-9]+):changed/.exec(eventName)}function _extractEntries(annotations){var openers=[],closers=[];each$2(annotations,function(a){var isAnchor=!!a.isAnchor&&a.isAnchor();if(isAnchor)openers.push({mode:ANCHOR,pos:a.offset,id:a.id,level:Fragmenter.ALWAYS_ON_TOP,type:"anchor",node:a,counter:-1,length:0});else{var l=Fragmenter.NORMAL,isInline=!!a.isInline&&a.isInline();isInline?l=Number.MAX_VALUE:a.constructor.hasOwnProperty("fragmentation")?l=a.constructor.fragmentation:a.hasOwnProperty("fragmentationHint")&&(l=a.fragmentationHint);var startOffset=Math.min(a.startOffset,a.endOffset),endOffset=Math.max(a.startOffset,a.endOffset),opener={pos:startOffset,mode:ENTER,level:l,id:a.id,type:a.type,node:a,length:0,counter:-1};openers.push(opener),closers.push({pos:endOffset,mode:EXIT,level:l,id:a.id,type:a.type,node:a,opener:opener})}}),openers.sort(_compareOpeners);for(var i=openers.length-1;i>=0;i--)openers[i].idx=i;closers.sort(_compareClosers);for(var entries=new Array(openers.length+closers.length),idx=0,idx1=0,idx2=0,opener=openers[idx1],closer=closers[idx2];opener||closer;)opener&&closer?closer.pos<=opener.pos&&closer.opener!==opener?(entries[idx]=closer,idx2++):(entries[idx]=opener,idx1++):opener?(entries[idx]=opener,idx1++):closer&&(entries[idx]=closer,idx2++),opener=openers[idx1],closer=closers[idx2],idx++;return entries}function _compareOpeners(a,b){if(a.pos<b.pos)return-1;if(a.pos>b.pos)return 1;if(a.mode<b.mode)return-1;if(a.mode>b.mode)return 1;if(a.mode===b.mode){if(a.level<b.level)return-1;if(a.level>b.level)return 1}return 0}function _compareClosers(a,b){return a.pos<b.pos?-1:a.pos>b.pos?1:a.pos===a.opener.pos&&b.pos===b.opener.pos?a.opener.idx<b.opener.idx?-1:1:a.opener.idx>b.opener.idx?-1:a.opener.idx<b.opener.idx?1:0}function encodeXMLEntities(str){return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function createCountingIdGenerator(){var counters={};return function(prefix){counters.hasOwnProperty(prefix)||(counters[prefix]=1);var result=[prefix,"-",counters[prefix]++].join("");return result}}function _once(listener,handler){return function(event){handler(event),listener._el.removeEventListener(listener)}}function DelegatedEvent(owner,selectedTarget,originalEvent){this.owner=owner,this.target=selectedTarget,this.originalEvent=originalEvent}function matches(el,selector){var elProto=window.Element.prototype,_matches=elProto.matches||elProto.matchesSelector||elProto.msMatchesSelector||elProto.webkitMatchesSelector;return _matches.call(el,selector)}function deleteNode(tx,args){var nodeId=args.nodeId;if(!nodeId)throw new Error("Parameter `nodeId` is mandatory.");var node=tx.get(nodeId);if(!node)throw new Error("Invalid 'nodeId'. Node does not exist.");var container,i,containerId=args.containerId,annos=tx.getIndex("annotations").get(nodeId);for(i=0;i<annos.length;i++)tx.delete(annos[i].id);var anchors=tx.getIndex("container-annotation-anchors").get(nodeId);for(i=0;i<anchors.length;i++){var anchor=anchors[i];if(container=tx.get(anchor.containerId),tx.get(anchor.id)){var pos=container.getPosition(anchor.path[0]),path=void 0,offset=void 0;if(anchor.isStart)if(pos<container.getLength()-1){var nextNode=container.getChildAt(pos+1);path=nextNode.isText()?[nextNode.id,"content"]:[nextNode.id],tx.set([anchor.id,"startPath"],path),tx.set([anchor.id,"startOffset"],0)}else tx.delete(anchor.id);else if(pos>0){var previousNode=container.getChildAt(pos-1);previousNode.isText()?(path=[previousNode.id,"content"],offset=tx.get(path).length):(path=[previousNode.id],offset=1),tx.set([anchor.id,"endPath"],path),tx.set([anchor.id,"endOffset"],offset)}else tx.delete(anchor.id)}}return containerId&&(container=tx.get(containerId),container.hide(nodeId)),node.hasChildren()&&node.getChildren().forEach(function(child){deleteNode(tx,{nodeId:child.id})}),tx.delete(nodeId),args}function _mergeNodes(tx,args){var firstNodeId=args.firstNodeId,secondNodeId=args.secondNodeId,firstNode=tx.get(firstNodeId),secondNode=tx.get(secondNodeId),mergeTrafo=_getNodeMerger(args.editingBehavior,firstNode,secondNode);return mergeTrafo?mergeTrafo(tx,extend$1({},args,{containerId:args.containerId,first:firstNode,second:secondNode})):args}function _getNodeMerger(behavior,node,otherNode){if(behavior){if(behavior.canMerge(node.type,otherNode.type))return behavior.getMerger(node.type,otherNode.type);if(node.isInstanceOf("text")&&behavior.canMerge("textish",otherNode.type))return behavior.getMerger("textish",otherNode.type);if(otherNode.isInstanceOf("text")&&behavior.canMerge(node.type,"textish"))return behavior.getMerger(node.type,"textish")}return node.isInstanceOf("text")&&otherNode.isInstanceOf("text")?_mergeTextNodes:(console.info("No merge behavior defined for %s <- %s",node.type,otherNode.type),null)}function _mergeTextNodes(tx,args){var selection,containerId=args.containerId,first=args.first,second=args.second,container=tx.get(containerId),firstPath=first.getTextPath(),firstText=first.getText(),firstLength=firstText.length,secondPath=second.getTextPath(),secondText=second.getText();return 0===firstLength?(container.hide(firstPath[0]),tx.delete(firstPath[0]),selection=tx.createSelection({type:"property",path:secondPath,startOffset:0})):(tx.update(firstPath,{insert:{offset:firstLength,value:secondText}}),annotationHelpers.transferAnnotations(tx,secondPath,0,firstPath,firstLength),container.hide(secondPath[0]),tx.delete(secondPath[0]),selection=tx.createSelection({type:"property",path:firstPath,startOffset:firstLength})),args.selection=selection,args}function updateAnnotations(tx,args){var op=args.op;if(!op.isUpdate())throw new Error("Only text updates are supported.");var diff=op.diff;return diff.isInsert()?_upateAfterInsert(tx,args):diff.isDelete()?_updateAfterDelete(tx,args):args}function _upateAfterInsert(tx,args){var op=args.op,diff=op.diff;return annotationHelpers.insertedText(tx,new Coordinate(op.path,diff.pos),diff.getLength(),args.ignoredAnnotations),args}function _updateAfterDelete(tx,args){var op=args.op,diff=op.diff;return annotationHelpers.deletedText(tx,op.path,diff.pos,diff.pos+diff.getLength(),args.replaceTextSupport),args}function deleteSelection(tx,args){var selection=args.selection;return selection.isCollapsed()||(selection.isPropertySelection()?args=_deletePropertySelection(tx,args):selection.isContainerSelection()?args=_deleteContainerSelection(tx,args):selection.isNodeSelection()&&(args=_deleteNodeSelection(tx,args))),args}function _deletePropertySelection(tx,args){var sel=args.selection,path=sel.path,startOffset=sel.startOffset,endOffset=sel.endOffset,op=tx.update(path,{delete:{start:startOffset,end:endOffset}});return updateAnnotations(tx,{op:op}),args.selection=tx.createSelection(path,startOffset),args}function _deleteContainerSelection(tx,args){var sel=args.selection,containerId=sel.containerId,container=tx.get(containerId),startPos=container.getPosition(sel.start.path[0]),fragments=sel.getFragments();if(0===fragments.length)return args;for(var node,type,remainingCoor=null,i=0;i<fragments.length;i++){var fragment=fragments[i];if(fragment.isPropertyFragment())if(fragment.isPartial())remainingCoor||(remainingCoor={path:fragment.path,offset:fragment.startOffset}),_deletePropertySelection(tx,{selection:fragment});else{var nodeId=fragment.path[0];deleteNode(tx,extend$1({},args,{nodeId:nodeId,containerId:container.id}))}else fragment.isNodeFragment()&&deleteNode(tx,extend$1({},args,{nodeId:fragment.nodeId,containerId:container.id}))}return remainingCoor?args.selection=tx.createSelection(remainingCoor.path,remainingCoor.offset):(type=tx.getSchema().getDefaultTextType(),node={type:type,id:uuid$1(type),content:""},tx.create(node),container.show(node.id,startPos),args.selection=tx.createSelection([node.id,"content"],0)),fragments.length>1&&fragments[0].isPartial()&&last$1(fragments).isPartial()&&merge$1(tx,extend$1({},args,{selection:args.selection,containerId:containerId,path:sel.endPath,direction:"left"})),0===container.nodes.length&&(type=tx.getSchema().getDefaultTextType(),node={type:type,id:uuid$1(type),content:""},tx.create(node),container.show(node.id,0),args.selection=tx.createSelection([node.id,"content"],0)),args}function _deleteNodeSelection(tx,args){var sel=args.selection;if(!sel||!sel.isNodeSelection())throw new Error("'sel' must be a NodeSelection");if(!sel.isFull())return args;var nodeId=sel.getNodeId(),containerId=sel.containerId,container=tx.get(containerId),pos=container.getPosition(nodeId);deleteNode(tx,{nodeId:nodeId,containerId:containerId});var newNode=tx.create({type:tx.getSchema().getDefaultTextType(),content:""});return container.show(newNode.id,pos),{selection:tx.createSelection([newNode.id,"content"],0)}}function breakNode(tx,args){if(!args.selection)throw new Error("Argument 'selection' is mandatory.");if(!args.containerId)throw new Error("Argument 'containerId' is mandatory.");args.selection.isCollapsed()||(args=deleteSelection(tx,args));var sel=args.selection;if(sel.isNodeSelection())return sel.isFull()?args:breakWholeNode(tx,args);var node=tx.get(sel.start.path[0]),behavior=args.editingBehavior;if(behavior&&behavior.canBreak(node.type)){var breaker=behavior.getBreaker(node.type);return breaker.call(breaker,tx,args)}return node.isText()?breakTextNode(tx,args):(console.info("Breaking is not supported for node type %s.",node.type),args)}function breakTextNode(tx,args){var sel=args.selection,containerId=args.containerId;if(!sel.isPropertySelection())throw new Error("Expected property selection.");var newNode,path=sel.path,offset=sel.startOffset,node=tx.get(path[0]),text=node.getText(),container=tx.get(containerId),nodePos=container.getPosition(node.id),id=uuid$1(node.type),newPath=[id,"content"];return 0===offset?(newNode=tx.create({id:id,type:node.type,content:""}),container.show(id,nodePos),sel=tx.createSelection(path,0)):(newNode=node.toJSON(),newNode.id=id,newNode.content=text.substring(offset),offset===text.length&&(newNode.type=tx.getSchema().getDefaultTextType()),tx.create(newNode),offset<text.length&&(annotationHelpers.transferAnnotations(tx,path,offset,[id,"content"],0),tx.update(path,{delete:{start:offset,end:text.length}})),container.show(id,nodePos+1),sel=tx.createSelection(newPath,0)),args.selection=sel,args.node=newNode,args}function breakWholeNode(tx,args){var sel=args.selection,containerId=args.containerId;if(!sel)throw new Error("Illegal argument: selection is mandatory.");if(!containerId)throw new Error("Illegal argument: containerId is mandatory.");if(!sel.isNodeSelection())throw new Error("Illegal argument: selection should be a NodeSelection");var newSel,container=tx.get(containerId),nodeId=sel.getNodeId(),nodePos=container.getPosition(nodeId),type=tx.getSchema().getDefaultTextType(),newNode=tx.create({type:type,content:""});return sel.isBefore()?(container.show(newNode.id,nodePos),newSel=sel):(container.show(newNode.id,nodePos+1),newSel=tx.createSelection([newNode.id,"content"],0)),args.selection=newSel,args.node=newNode,args}function copySelection(doc,args){var selection=args.selection;if(!selection||!selection._isSelection)throw new Error("'selection' is mandatory.");return selection.isNull()||selection.isCollapsed()?args.doc=null:selection.isPropertySelection()?args.doc=_copyPropertySelection(doc,selection):selection.isContainerSelection()?args.doc=_copyContainerSelection(doc,selection):selection.isNodeSelection()?args.doc=_copyNodeSelection(doc,selection):(console.error("Copy is not yet supported for selection type."),args.doc=null),args}function _copyPropertySelection(doc,selection){var path=selection.start.path,offset=selection.start.offset,endOffset=selection.end.offset,text=doc.get(path),snippet=doc.createSnippet(),containerNode=snippet.getContainer();snippet.create({type:doc.schema.getDefaultTextType(),id:Document.TEXT_SNIPPET_ID,content:text.substring(offset,endOffset)}),containerNode.show(Document.TEXT_SNIPPET_ID);var annotations=doc.getIndex("annotations").get(path,offset,endOffset);return each$2(annotations,function(anno){var data=cloneDeep$1(anno.toJSON());data.path=[Document.TEXT_SNIPPET_ID,"content"],data.startOffset=Math.max(offset,anno.startOffset)-offset,data.endOffset=Math.min(endOffset,anno.endOffset)-offset,snippet.create(data)}),snippet}function _copyContainerSelection(doc,selection){var container=doc.get(selection.containerId),snippet=doc.createSnippet(),containerNode=snippet.getContainer(),fragments=selection.getFragments();if(0===fragments.length)return snippet;for(var created={},i=0;i<fragments.length;i++){var fragment=fragments[i],nodeId=fragment.getNodeId(),node=doc.get(nodeId);created[nodeId]||(_copyNode(snippet,node,container,created),containerNode.show(nodeId))}var path,offset,text,firstFragment=fragments[0],lastFragment=last$1(fragments);return firstFragment.isPropertyFragment()&&(path=firstFragment.path,offset=firstFragment.startOffset,text=doc.get(path),snippet.update(path,{delete:{start:0,end:offset}}),annotationHelpers.deletedText(snippet,path,0,offset)),lastFragment.isPropertyFragment()&&(path=lastFragment.path,offset=lastFragment.endOffset,text=doc.get(path),snippet.update(path,{delete:{start:offset,end:text.length}}),annotationHelpers.deletedText(snippet,path,offset,text.length)),snippet}function _copyNodeSelection(doc,selection){var container=doc.get(selection.containerId),snippet=doc.createSnippet(),containerNode=snippet.getContainer(),nodeId=selection.getNodeId(),node=doc.get(nodeId);return _copyNode(snippet,node,container,{}),containerNode.show(node.id),snippet}function _copyNode(doc,node,container,created){if(node.hasChildren()){var children=node.getChildren();children.forEach(function(child){_copyNode(doc,child,container,created)})}created[node.id]=doc.create(node.toJSON());var annotationIndex=doc.getIndex("annotations"),annotations=annotationIndex.get([node.id]);each$2(annotations,function(anno){doc.create(cloneDeep$1(anno.toJSON()))})}function createAnnotation(tx,args){var sel=args.selection;if(!sel)throw new Error("selection is required.");var anno=args.node;if(!anno)throw new Error("node is required");if(!sel.isPropertySelection()&&!sel.isContainerSelection()||sel.isCollapsed())throw new Error("Invalid selection for createAnnotation");if(sel.isContainerSelection()&&args.splitContainerSelections)return _createPropertyAnnotations(tx,args);if(documentHelpers.isContainerAnnotation(tx,anno.type))anno.startPath=sel.startPath,anno.endPath=sel.endPath,anno.containerId=sel.containerId;else{if(!sel.isPropertySelection())throw new Error("Illegal state: can not apply ContainerSelection");anno.path=sel.path}return anno.startOffset=sel.startOffset,anno.endOffset=sel.endOffset,args.result=tx.create(anno),args}function _createPropertyAnnotations(tx,args){var sels,sel=args.selection,node=args.node;sel.isPropertySelection()?sels=[]:sel.isContainerSelection()&&(sels=sel.splitIntoPropertySelections());for(var i=0;i<sels.length;i++){var anno={id:uuid$1(node.type)};extend$1(anno,node),anno.path=sels[i].getPath(),anno.startOffset=sels[i].startOffset,anno.endOffset=sels[i].endOffset,tx.create(anno)}}function _deleteCharacterInProperty(tx,args){var sel=args.selection;if(!sel.isPropertySelection())throw new Error("Expecting a property selection.");var startChar,endChar,direction=args.direction,containerId=args.containerId,path=sel.path,text=tx.get(path);if(0===sel.startOffset&&"left"===direction||sel.startOffset===text.length&&"right"===direction){if(containerId){var tmp=merge$1(tx,extend$1({},args,{selection:sel,containerId:containerId,path:sel.path,direction:direction}));args.selection=tmp.selection}}else{startChar="left"===direction?sel.startOffset-1:sel.startOffset,endChar=startChar+1;var op=tx.update(sel.path,{delete:{start:startChar,end:endChar}});updateAnnotations(tx,{op:op}),args.selection=tx.createSelection(sel.path,startChar)}return args}function _deleteCharacterWithNodeSelection(tx,args){var sel=args.selection;if(!sel.isNodeSelection())throw new Error("Expecting a node selection.");var pos,text,direction=args.direction,containerId=args.containerId,nodeId=sel.getNodeId(),container=tx.get(containerId);if(sel.isFull()||sel.isBefore()&&"right"===direction||sel.isAfter()&&"left"===direction)return deleteNode(tx,{
nodeId:nodeId,containerId:containerId});if(sel.isBefore()&&"left"===direction){if(pos=container.getPosition(nodeId),pos>0){var previous=container.getNodeAt(pos-1);previous.isText()&&(text=previous.getText(),0===text.length?deleteNode(tx,{nodeId:previous.id,containerId:containerId}):sel=tx.createSelection(previous.getTextPath(),text.length))}}else if(sel.isAfter()&&"right"===direction&&(pos=container.getPosition(nodeId),pos<container.getLength()-1)){var next=container.getNodeAt(pos+1);next.isText()&&next.isEmpty()&&deleteNode(tx,{nodeId:next.id,containerId:containerId})}return{selection:sel}}function expandAnnotation(tx,args){var sel=args.selection,anno=args.anno;if(!sel||!sel._isSelection)throw new Error('Argument "selection" is required.');if(!anno||!anno._isAnnotation)throw new Error('Argument "anno" is required.');var annoSel=anno.getSelection(),newAnnoSel=annoSel.expand(sel);return anno.updateRange(tx,newAnnoSel),args.result=anno,args}function fuseAnnotation(tx,args){var annos=args.annos;if(!isArray$1(annos)||annos.length<2)throw new Error("fuseAnnotation(): at least two annotations are necessary.");var sel,annoType;return annos.forEach(function(anno,idx){if(0===idx)sel=anno.getSelection(),annoType=anno.type;else{if(anno.type!==annoType)throw new Error("fuseAnnotation(): all annotations must be of the same type.");sel=sel.expand(anno.getSelection())}}),each$2(annos,function(anno){tx.delete(anno.id)}),args.selection=sel,args.node={type:annoType},createAnnotation(tx,args)}function replaceText(tx,args){return _defaultReplace(tx,args)}function _defaultReplace(tx,args){var out=deleteSelection(tx,extend$1({},args,{direction:"right"})),sel=out.selection;if(!sel.isPropertySelection())throw new Error("Invalid state.");var text=args.text,op=tx.update(sel.path,{insert:{offset:sel.startOffset,value:text}});return updateAnnotations(tx,{op:op}),args.selection=tx.createSelection(sel.path,sel.startOffset+text.length),args}function insertInlineNode(tx,args){var tmp=insertText(tx,{selection:args.selection,text:"\ufeff"}),inlineNodeSel=tx.createSelection({type:"property",path:tmp.selection.path,startOffset:tmp.selection.startOffset-1,endOffset:tmp.selection.endOffset});return args.node=args.node,args.selection=inlineNodeSel,args=createAnnotation(tx,args)}function insertNode(tx,args){var selection=args.selection,node=args.node;if(!args.containerId)throw new Error("containerId is mandatory");if(!args.selection)throw new Error("selection is mandatory");if(!args.node)throw new Error("node is mandatory");var tmp,containerId=args.containerId,container=tx.get(containerId);selection.isCollapsed()||(tmp=deleteSelection(tx,args),selection=tmp.selection),tmp=breakNode(tx,args),selection=tmp.selection,node.id||(node.id=uuid$1(node.type)),tx.get(node.id)||(node=tx.create(node)),node=tx.get(node.id);var nodePos=container.getPosition(selection.start.getNodeId());return container.show(node.id,nodePos),node.isText()?args.selection=tx.createSelection({type:"property",path:[node.id,"content"],startOffset:0}):args.selection=tx.createSelection({type:"container",containerId:containerId,startPath:[node.id],startOffset:0,endPath:[node.id],endOffset:1}),args}function _convertPlainTextToDocument(tx,args){var node,defaultTextType=tx.getSchema().getDefaultTextType(),lines=args.text.split(/\s*\n\s*\n/),pasteDoc=tx.newInstance(),container=pasteDoc.create({type:"container",id:Document.SNIPPET_ID,nodes:[]});if(1===lines.length)node=pasteDoc.create({id:Document.TEXT_SNIPPET_ID,type:defaultTextType,content:lines[0]}),container.show(node.id);else for(var i=0;i<lines.length;i++)node=pasteDoc.create({id:uuid$1(defaultTextType),type:defaultTextType,content:lines[i]}),container.show(node.id);return pasteDoc}function _pasteAnnotatedText(tx,args){var copy=args.doc,sel=args.selection,nodes=copy.get(Document.SNIPPET_ID).nodes,textPath=[nodes[0],"content"],text=copy.get(textPath),annotations=copy.getIndex("annotations").get(textPath),path=sel.start.path,offset=sel.start.offset;return tx.update(path,{insert:{offset:offset,value:text}}),annotationHelpers.insertedText(tx,sel.start,text.length),sel=tx.createSelection({type:"property",path:sel.start.path,startOffset:sel.start.offset+text.length}),each$2(annotations,function(anno){var data=anno.toJSON();data.path=path.slice(0),data.startOffset+=offset,data.endOffset+=offset,tx.get(data.id)&&(data.id=uuid$1(data.type)),tx.create(data)}),args.selection=sel,args}function _pasteDocument(tx,args){var insertPos,pasteDoc=args.doc,containerId=args.containerId,sel=args.selection,container=tx.get(containerId),startPath=sel.start.path,startPos=container.getPosition(sel.start.getNodeId()),text=tx.get(startPath);if(text.length===sel.start.offset)insertPos=startPos+1;else{var result=breakNode(tx,args);sel=result.selection,insertPos=startPos+1}insertPos<0&&console.error("Could not find insertion position in ContainerNode.");for(var nodeIds=pasteDoc.get(Document.SNIPPET_ID).nodes,annoIndex=pasteDoc.getIndex("annotations"),insertedNodes=[],i=0;i<nodeIds.length;i++){var nodeId=nodeIds[i],node=_copyNode$1(tx,pasteDoc.get(nodeId));container.show(node.id,insertPos++),insertedNodes.push(node);for(var annos=annoIndex.get(nodeId),j=0;j<annos.length;j++){var data=annos[j].toJSON();node.id!==nodeId&&(data.path[0]=node.id),tx.get(data.id)&&(data.id=uuid$1(data.type)),tx.create(data)}}if(0===insertedNodes.length)return args;var firstNode=insertedNodes[0],lastNode=last$1(insertedNodes);return args.selection=tx.createSelection({type:"container",containerId:containerId,startPath:[firstNode.id],startOffset:0,endPath:[lastNode.id],endOffset:1}),args}function _copyNode$1(tx,pasteNode){var nodeId=pasteNode.id,data=pasteNode.toJSON();if(tx.get(nodeId)&&(data.id=uuid$1(pasteNode.type)),pasteNode.hasChildren())for(var children=pasteNode.getChildren(),childrenIds=data[pasteNode.getChildrenProperty()],i=0;i<children.length;i++){var childNode=_copyNode$1(tx,children[i]);childrenIds[i]=childNode.id}return tx.create(data)}function switchTextType(tx,args){var sel=args.selection;if(!sel.isPropertySelection())return console.error("Selection must be a PropertySelection."),args;var path=sel.path,nodeId=path[0],data=args.data,node=tx.get(nodeId);if(!node.isInstanceOf("text"))return console.warn("Trying to use switchTextType on a non text node. Skipping."),args;var newNode=extend$1({id:uuid$1(data.type),type:data.type,content:node.content},data),newPath=[newNode.id,"content"];newNode=tx.create(newNode),annotationHelpers.transferAnnotations(tx,path,0,newPath,0);var container=tx.get(args.containerId),pos=container.getPosition(nodeId);return pos>=0&&(container.hide(nodeId),container.show(newNode.id,pos)),deleteNode(tx,{nodeId:node.id}),args.selection=tx.createSelection(newPath,sel.startOffset,sel.endOffset),args.node=newNode,args}function truncateAnnotation(tx,args){var sel=args.selection,anno=args.anno;if(!sel||!sel._isSelection)throw new Error('Argument "selection" is required.');if(!anno||!anno._isAnnotation)throw new Error('Argument "anno" is required.');var annoSel=anno.getSelection(),newAnnoSel=annoSel.truncateWith(sel);return anno.updateRange(tx,newAnnoSel),args.result=anno,args}function _create$1(state,vel){var comp=vel._comp;console.assert(!comp,"Component instance should not exist when this method is used.");var parent=vel.parent._comp;return parent||(parent=_create$1(state,vel.parent)),vel._isVirtualComponent?(console.assert(parent,"A Component should have a parent."),comp=new vel.ComponentClass(parent,vel.props),comp.__htmlConfig__=vel._copyHTMLConfig()):vel._isVirtualHTMLElement?comp=new Component.Element(parent,vel):vel._isVirtualTextNode&&(comp=new Component.TextNode(parent,vel)),vel._ref&&(comp._ref=vel._ref),vel._owner&&(comp._owner=vel._owner._comp),vel._comp=comp,comp}function _capture(state,vel,forceCapture){if(state.isCaptured(vel))return vel;var comp=vel._comp;if(comp||(comp=_create$1(state,vel),state.setNew(vel)),vel._isVirtualComponent){var needRerender;if(forceCapture?needRerender=!0:(needRerender=!comp.el||comp.shouldRerender(vel.props),comp.__htmlConfig__=vel._copyHTMLConfig(),state.setOldProps(vel,comp.props),state.setOldState(vel,comp.state),comp._setProps(vel.props),state.isNew(vel)||state.setUpdated(vel)),needRerender){var context=new CaptureContext(vel),content=comp.render(context.$$);if(!content||!content._isVirtualHTMLElement)throw new Error("Component.render must return VirtualHTMLElement");if(comp.__htmlConfig__&&content._mergeHTMLConfig(comp.__htmlConfig__),content._comp=comp,vel._content=content,!state.isNew(vel)&&comp.isMounted()&&state.setUpdated(vel),_prepareVirtualComponent(state,comp,content),substanceGlobals$1.DEBUG_RENDERING){for(var stack=content.children.slice(0);stack.length;){var child=stack.shift();state.isCaptured(child)||child._isVirtualComponent||(child._comp||_create$1(state,child),child._isVirtualHTMLElement&&child.children.length>0&&(stack=stack.concat(child.children)),state.setCaptured(child))}state.setCaptured(content);for(var descendingContext=new DescendingContext(state,context);descendingContext.hasPendingCaptures();)descendingContext.reset(),comp.render(descendingContext.$$)}else _capture(state,vel._content)}else state.setSkipped(vel)}else if(vel._isVirtualHTMLElement)for(var i=0;i<vel.children.length;i++)_capture(state,vel.children[i]);return state.setCaptured(vel),vel}function _render$1$1(state,vel){if(!state.isSkipped(vel)){console.assert(state.isCaptured(vel),"VirtualElement must be captured before rendering");var comp=vel._comp;if(console.assert(comp&&comp._isComponent,"A captured VirtualElement must have a component instance attached."),vel._isVirtualComponent)return void _render$1$1(state,vel._content);if(comp.el||(comp.el=_createElement$1(vel),comp.el._comp=comp),_updateElement(comp,vel),vel._isVirtualHTMLElement&&!vel.hasInnerHTML()){var oldComp,virtualComp,newComp,newChildren=vel.children,pos1=0,pos2=0,oldChildren=[];for(comp.el.getChildNodes().forEach(function(node){var childComp=node._comp;!childComp||state.isRelocated(childComp)?comp.el.removeChild(node):oldChildren.push(childComp)});pos1<oldChildren.length||pos2<newChildren.length;){do oldComp=oldChildren[pos1++];while(oldComp&&state.isDetached(oldComp));if(virtualComp=newChildren[pos2++],oldComp&&!virtualComp){for(;oldComp;)_removeChild(state,comp,oldComp),oldComp=oldChildren[pos1++];break}oldComp&&oldComp.el.isTextNode()&&virtualComp&&virtualComp._isVirtualTextNode&&oldComp.el.textContent===virtualComp.text||(state.isRendered(virtualComp)||_render$1$1(state,virtualComp),newComp=virtualComp._comp,state.isRelocated(newComp)&&newComp._setParent(comp),console.assert(newComp,"Component instance should now be available."),!virtualComp||oldComp?state.isMapped(virtualComp)?newComp===oldComp||(state.setDetached(oldComp),_removeChild(state,comp,oldComp),pos2--):state.isMapped(oldComp)?(_insertChildBefore(state,comp,newComp,oldComp),pos1--):_replaceChild(state,comp,oldComp,newComp):_appendChild$1(state,comp,newComp))}}var refs={},foreignRefs={};vel._context&&(each$2(vel._context.refs,function(vel,ref){refs[ref]=vel._comp}),each$2(vel._context.foreignRefs,function(vel,ref){foreignRefs[ref]=vel._comp})),comp.refs=refs,comp.__foreignRefs__=foreignRefs,state.setRendered(vel)}}function _triggerUpdate(state,vel){vel._isVirtualComponent?(state.isSkipped(vel)||vel._content.children.forEach(_triggerUpdate.bind(null,state)),state.isUpdated(vel)&&vel._comp.didUpdate(state.getOldProps(vel),state.getOldState(vel))):vel._isVirtualHTMLElement&&vel.children.forEach(_triggerUpdate.bind(null,state))}function _appendChild$1(state,parent,child){parent.el.appendChild(child.el),_triggerDidMount(state,parent,child)}function _replaceChild(state,parent,oldChild,newChild){parent.el.replaceChild(oldChild.el,newChild.el),state.isDetached(oldChild)||oldChild.triggerDispose(),_triggerDidMount(state,parent,newChild)}function _insertChildBefore(state,parent,child,before){parent.el.insertBefore(child.el,before.el),_triggerDidMount(state,parent,child)}function _removeChild(state,parent,child){parent.el.removeChild(child.el),state.isDetached(child)||child.triggerDispose()}function _triggerDidMount(state,parent,child){state.isDetached(child)||!parent.isMounted()||child.isMounted()||child.triggerDidMount(!0)}function _prepareVirtualComponent(state,comp,vc){var newRefs={},foreignRefs={};vc._context&&(newRefs=vc._context.refs,foreignRefs=vc._context.foreignRefs);var oldRefs=comp.refs,oldForeignRefs=comp.__foreignRefs__;each$2(newRefs,function(vc,ref){var comp=oldRefs[ref];comp&&_mapComponents(state,comp,vc)}),each$2(foreignRefs,function(vc,ref){var comp=oldForeignRefs[ref];comp&&_mapComponents(state,comp,vc)})}function _mapComponents(state,comp,vc){if(!comp&&!vc)return!0;if(!comp||!vc)return!1;if(state.isMapped(vc)||state.isMapped(comp))return vc._comp===comp;if(vc._comp)return vc._comp===comp&&(state.setMapped(vc),state.setMapped(comp),!0);if(!_isOfSameType(comp,vc))return!1;vc._comp=comp,state.setMapped(vc),state.setMapped(comp);var canMapParent,parent=comp.getParent();if(vc.parent)canMapParent=_mapComponents(state,parent,vc.parent);else if(vc._preliminaryParent){for(;parent&&parent._isElementComponent;)parent=parent.getParent();canMapParent=_mapComponents(state,parent,vc._preliminaryParent)}return canMapParent||(state.setRelocated(vc),state.setRelocated(comp)),canMapParent}function _isOfSameType(comp,vc){return comp._isElementComponent&&vc._isVirtualHTMLElement||comp._isComponent&&vc._isVirtualComponent&&comp.constructor===vc.ComponentClass||comp._isTextNodeComponent&&vc._isVirtualTextNode}function _createElement$1(vel){var el;return el=vel._isVirtualTextNode?DefaultDOMElement.createTextNode(vel.text):DefaultDOMElement.createElement(vel.tagName)}function _updateElement(comp,vel){if(comp._isTextNodeComponent)return void comp.setTextContent(vel.text);var el=comp.el;console.assert(el,"Component's element should exist at this point.");var tagName=el.getTagName();if(vel.tagName.toLowerCase()!==tagName&&el.setTagName(vel.tagName),_updateHash({oldHash:el.getAttributes(),newHash:vel.getAttributes(),update:function(key,val){el.setAttribute(key,val)},remove:function(key){el.removeAttribute(key)}}),_updateHash({oldHash:el.htmlProps,newHash:vel.htmlProps,update:function(key,val){el.setProperty(key,val)},remove:function(key){el.removeProperty(key)}}),_updateListeners({el:el,oldListeners:el.getEventListeners(),newListeners:vel.getEventListeners()}),vel.hasInnerHTML()){if(el._hasInnerHTML){var oldInnerHTML=el.getInnerHTML(),newInnerHTML=vel.getInnerHTML();oldInnerHTML!==newInnerHTML&&el.setInnerHTML(newInnerHTML)}else el.empty(),el.setInnerHTML(vel.getInnerHTML());el._hasInnerHTML=!0}}function _updateHash(args){var key,newHash=args.newHash,oldHash=args.oldHash||{},updatedKeys={},update=args.update,remove=args.remove;for(key in newHash)if(newHash.hasOwnProperty(key)){var oldVal=oldHash[key],newVal=newHash[key];updatedKeys[key]=!0,oldVal!==newVal&&update(key,newVal)}for(key in oldHash)oldHash.hasOwnProperty(key)&&!updatedKeys[key]&&remove(key)}function _updateListeners(args){var el=args.el,newListeners=args.newListeners||[];el.removeAllEventListeners();for(var i=0;i<newListeners.length;i++)el.addEventListener(newListeners[i])}function _createWrappingVirtualComponent(comp){var vel=new VirtualElement.Component(comp.constructor);return vel._comp=comp,comp.__htmlConfig__&&vel._mergeHTMLConfig(comp.__htmlConfig__),vel}function _disposeChild(child){child.triggerDispose(),child._owner&&child._ref&&(console.assert(child._owner.refs[child._ref]===child,"Owner's ref should point to this child instance."),delete child._owner.refs[child._ref])}function _mountChild(parent,child){parent.isMounted()&&child.triggerDidMount(!0),child._owner&&child._ref&&(child._owner.refs[child._ref]=child)}function _unwrapComp(el){if(el)return el._comp}function _unwrapCompStrict(el){return console.assert(el._comp,"Expecting a back-link to the component instance."),_unwrapComp(el)}function notNull(n){return n}function _getBoundingRect(rects){var bounds={left:Number.POSITIVE_INFINITY,top:Number.POSITIVE_INFINITY,right:Number.NEGATIVE_INFINITY,bottom:Number.NEGATIVE_INFINITY,width:Number.NaN,height:Number.NaN};return forEach$2(rects,function(rect){rect.left<bounds.left&&(bounds.left=rect.left),rect.top<bounds.top&&(bounds.top=rect.top),rect.left+rect.width>bounds.right&&(bounds.right=rect.left+rect.width),rect.top+rect.height>bounds.bottom&&(bounds.bottom=rect.top+rect.height)}),bounds.width=bounds.right-bounds.left,bounds.height=bounds.bottom-bounds.top,bounds}function _getBoundingOffsetsRect(el,relativeParentEl){var relativeParentElRect=relativeParentEl.getBoundingClientRect(),elRect=_getBoundingRect(el.getClientRects()),left=elRect.left-relativeParentElRect.left,top=elRect.top-relativeParentElRect.top;return{left:left,top:top,right:relativeParentElRect.width-left-elRect.width,bottom:relativeParentElRect.height-top-elRect.height,width:elRect.width,height:elRect.height}}function getRelativeBoundingRect(els,containerEl){void 0===els.length&&(els=[els]);var elRects=map$2(els,function(el){return _getBoundingOffsetsRect(el,containerEl)}),elsRect=_getBoundingRect(elRects),containerElRect=containerEl.getBoundingClientRect();return{left:elsRect.left,top:elsRect.top,right:containerElRect.width-elsRect.left-elsRect.width,bottom:containerElRect.height-elsRect.top-elsRect.height,width:elsRect.width,height:elsRect.height}}function createSurfaceId(surface){var surfaceParent=surface._getSurfaceParent();return surfaceParent?surfaceParent.getId()+"/"+surface.name:surface.name}function _getPropertyContext(root,node,offset){for(var result={el:null,path:null,node:node,offset:offset};node&&node!==root;){if(node.isElementNode()){var path=node.getAttribute("data-path");if(path)return result.el=node,result.path=path.split("."),result;node.getAttribute("data-inline")&&(result.node=node,offset>0&&(result.offset=1))}node=node.getParent()}return null}function _getCharPos(node,offset){var parent,childIdx,charPos=offset;if(parent=node.getParent(),node.isTextNode())if(node===parent.firstChild){var parentPath=parent.getAttribute("data-path"),parentOffset=parent.getAttribute("data-offset");charPos=parentPath?offset:parentOffset?parseInt(parentOffset,10)+offset:_getCharPos(parent,0)+offset}else childIdx=parent.getChildIndex(node),charPos=_getCharPos(parent,childIdx)+offset;else{if(!node.isElementNode())return null;var pathStr=node.getAttribute("data-path"),offsetStr=node.getAttribute("data-offset");pathStr?charPos=_countCharacters(node,offset):offsetStr?(childIdx=parent.getChildIndex(node),charPos=parseInt(offsetStr,10)+_countCharacters(node,offset)):(childIdx=parent.getChildIndex(node),charPos=_getCharPos(parent,childIdx)+_countCharacters(node,offset))}return charPos}function _countCharacters(el,maxIdx){var charPos=0;if(el.getAttribute("data-inline"))return 0===maxIdx?0:1;var l=el.getChildCount();1===arguments.length&&(maxIdx=l),maxIdx=Math.min(l,maxIdx);for(var i=0,child=el.getFirstChild();i<maxIdx;child=child.getNextSibling(),i++)if(child.isTextNode())charPos+=child.getTextContent().length;else if(child.isElementNode()){var length=child.getAttribute("data-length");charPos+=child.getAttribute("data-inline")?1:length?parseInt(length,10):_countCharacters(child)}return charPos}function percentage(ratio){return String(Math.floor(100*ratio*100)/100)+" %"}function _getData(event){var dataTransfer=event.dataTransfer;if(dataTransfer)return{types:dataTransfer.types,items:Array.prototype.slice.call(dataTransfer.items),files:Array.prototype.slice.call(dataTransfer.files)}}function _getTargetInfo(event){var target={element:DefaultDOMElement.wrapNativeElement(event.target)},comp=Component.getComponentFromNativeElement(event.target);if(comp=_getComponent(comp)){if(target.comp=comp,target._isSurface?target.surface=comp:comp.context.surface&&(target.surface=comp.context.surface),target.surface){var sel=target.surface.getSelectionFromEvent(event);sel&&(target.selection=sel)}var node=comp.props.node;node&&(target.node=node),comp._isTextPropertyComponent&&(target.path=comp.props.path)}return target}function _getComponent(comp){return comp._isTextNodeComponent||comp._isElementComponent?_getComponent(comp.getParent()):comp}function _getPath(el){if(el._isDOMElement||(el=DefaultDOMElement.wrapNativeElement(el)),el.isElementNode()){var pathStr=el.getAttribute("data-path");return pathStr.split(".")}throw new Error("Can't get path from element:"+el.outerHTML)}function _createRange(start,end,isReverse,containerId){if(isReverse){var tmp=start;start=end,end=tmp}return new Range(start,end,isReverse,containerId)}function _createRangeForIsolatedBlockNode(nodeId,containerId){return new Range(new Coordinate([nodeId],0),new Coordinate([nodeId],1),(!1),containerId)}function makeMap(keys){return keys.reduce(function(obj,key){return obj[key]=!0,obj},{})}function createChangeset(doc,fn){if(!doc._isDocument||!isFunction$1(fn))throw new Error("Illegal arguments");var session=new DocumentSession(doc),change=session.transaction(fn);return[change.toJSON()]}function insertText$1$1(tx,args){var path=args.path;if(!isArray$1(path))throw new Error("args.path is mandatory");var pos=args.pos;if(!isNumber$1(pos))throw new Error("args.pos is mandatory");var text=args.text;if(!isString$1(text))throw new Error("args.text is mandatory");var sel=tx.createSelection({type:"property",path:path,startOffset:pos,endOffset:pos});insertText(tx,{selection:sel,text:text||"$$$"})}function createTestArticle(seedFn){var doc=new TestArticle;return seedFn&&seedFn(doc),doc}function createTestDocumentFactory(){return{createDocument:function(){return createTestArticle()},createChangeset:function(){var doc=createTestArticle();return createChangeset(doc)}}}Object.defineProperty(exports,"__esModule",{value:!0});var $=_interopDefault(require("substance-cheerio")),SubstanceError=function(Error){function SubstanceError(name,options){Error.call(this,name,options),this.name=name,this.message=options.message,this.info=options.info,this.errorCode=options.errorCode,this.cause=options.cause,Error.captureStackTrace&&Error.captureStackTrace(this,SubstanceError)}return Error&&(SubstanceError.__proto__=Error),SubstanceError.prototype=Object.create(Error&&Error.prototype),SubstanceError.prototype.constructor=SubstanceError,SubstanceError.prototype.inspect=function(){var parts=[];return parts.push(this.stack),this.info&&parts.push(this.info+". "),this.cause&&(parts.push("\nCaused by: "),this.cause.inspect?parts.push(this.cause.inspect()):parts.push(this.cause.toString())),parts.join("")},SubstanceError}(Error);SubstanceError.fromJSON=function(err){if(!err)return null;var error=new SubstanceError(err.name,{message:err.message,info:err.info,errorCode:err.errorCode,cause:SubstanceError.fromJSON(err.cause)});return error};var ChangeStore=function(config){this.config=config};ChangeStore.prototype.getChanges=function(args,cb){var changes=this._getChanges(args.documentId);if(args.sinceVersion||(args.sinceVersion=0),args.sinceVersion<0)return cb(new SubstanceError("ChangeStore.ReadError",{message:'Illegal argument "sinceVersion":'+args.sinceVersion}));if(args.toVersion<0)return cb(new SubstanceError("ChangeStore.ReadError",{message:'Illegal argument "toVersion":'+args.toVersion}));if(args.sinceVersion>=args.toVersion)return cb(new SubstanceError("ChangeStore.ReadError",{message:'Illegal version arguments "sinceVersion":'+args.sinceVersion+', toVersion":'+args.toVersion}));var res,version=this._getVersion(args.documentId);0===args.sinceVersion?(res={version:version,changes:changes.slice(0,args.toVersion)},cb(null,res)):args.sinceVersion>0&&(res={version:version,changes:changes.slice(args.sinceVersion,args.toVersion)},cb(null,res))},ChangeStore.prototype.addChange=function(args,cb){if(!args.documentId)return cb(new SubstanceError("ChangeStore.CreateError",{message:"No documentId provided"}));if(!args.change)return cb(new SubstanceError("ChangeStore.CreateError",{message:"No change provided"}));this._addChange(args.documentId,args.change);var newVersion=this._getVersion(args.documentId);cb(null,newVersion)},ChangeStore.prototype.deleteChanges=function(documentId,cb){var deletedChanges=this._deleteChanges(documentId);cb(null,deletedChanges.length)},ChangeStore.prototype.getVersion=function(id,cb){cb(null,this._getVersion(id))},ChangeStore.prototype.seed=function(changes,cb){return this._changes=changes,cb&&cb(null),this},ChangeStore.prototype._deleteChanges=function(documentId){var changes=this._getChanges(documentId);return delete this._changes[documentId],changes},ChangeStore.prototype._getVersion=function(documentId){var changes=this._changes[documentId];return changes?changes.length:0},ChangeStore.prototype._getChanges=function(documentId){return this._changes[documentId]||[]},ChangeStore.prototype._addChange=function(documentId,change){this._changes[documentId]||(this._changes[documentId]=[]),this._changes[documentId].push(change)};var commonjsGlobal="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},_arrayEach=createCommonjsModule(function(module){function arrayEach(array,iteratee){for(var index=-1,length=array?array.length:0;++index<length&&iteratee(array[index],index,array)!==!1;);return array}module.exports=arrayEach}),_arrayEach$1=interopDefault(_arrayEach),require$$15=Object.freeze({default:_arrayEach$1}),_createBaseFor=createCommonjsModule(function(module){function createBaseFor(fromRight){return function(object,iteratee,keysFunc){for(var index=-1,iterable=Object(object),props=keysFunc(object),length=props.length;length--;){var key=props[fromRight?length:++index];if(iteratee(iterable[key],key,iterable)===!1)break}return object}}module.exports=createBaseFor}),_createBaseFor$1=interopDefault(_createBaseFor),require$$0$2=Object.freeze({default:_createBaseFor$1}),_baseFor=createCommonjsModule(function(module){var createBaseFor=interopDefault(require$$0$2),baseFor=createBaseFor();module.exports=baseFor}),_baseFor$1=interopDefault(_baseFor),require$$1$1=Object.freeze({default:_baseFor$1}),_getPrototype=createCommonjsModule(function(module){function getPrototype(value){return nativeGetPrototype(Object(value))}var nativeGetPrototype=Object.getPrototypeOf;module.exports=getPrototype}),_getPrototype$1=interopDefault(_getPrototype),require$$1$2=Object.freeze({default:_getPrototype$1}),_baseHas=createCommonjsModule(function(module){function baseHas(object,key){return null!=object&&(hasOwnProperty.call(object,key)||"object"==typeof object&&key in object&&null===getPrototype(object))}var getPrototype=interopDefault(require$$1$2),objectProto=Object.prototype,hasOwnProperty=objectProto.hasOwnProperty;module.exports=baseHas}),_baseHas$1=interopDefault(_baseHas),require$$5=Object.freeze({default:_baseHas$1}),_baseKeys=createCommonjsModule(function(module){function baseKeys(object){return nativeKeys(Object(object))}var nativeKeys=Object.keys;module.exports=baseKeys}),_baseKeys$1=interopDefault(_baseKeys),require$$4=Object.freeze({default:_baseKeys$1}),_baseTimes=createCommonjsModule(function(module){function baseTimes(n,iteratee){for(var index=-1,result=Array(n);++index<n;)result[index]=iteratee(index);return result}module.exports=baseTimes}),_baseTimes$1=interopDefault(_baseTimes),require$$4$1=Object.freeze({default:_baseTimes$1}),_baseProperty=createCommonjsModule(function(module){function baseProperty(key){return function(object){return null==object?void 0:object[key]}}module.exports=baseProperty}),_baseProperty$1=interopDefault(_baseProperty),require$$3$1=Object.freeze({default:_baseProperty$1}),_getLength=createCommonjsModule(function(module){var baseProperty=interopDefault(require$$3$1),getLength=baseProperty("length");module.exports=getLength}),_getLength$1=interopDefault(_getLength),require$$2$1=Object.freeze({default:_getLength$1}),isObject=createCommonjsModule(function(module){function isObject(value){var type=typeof value;return!!value&&("object"==type||"function"==type)}module.exports=isObject}),isObject$1=interopDefault(isObject),require$$2$3=Object.freeze({default:isObject$1}),isFunction=createCommonjsModule(function(module){function isFunction(value){var tag=isObject(value)?objectToString.call(value):"";return tag==funcTag||tag==genTag}var isObject=interopDefault(require$$2$3),funcTag="[object Function]",genTag="[object GeneratorFunction]",objectProto=Object.prototype,objectToString=objectProto.toString;module.exports=isFunction}),isFunction$1=interopDefault(isFunction),require$$2$2=Object.freeze({default:isFunction$1}),isLength=createCommonjsModule(function(module){function isLength(value){return"number"==typeof value&&value>-1&&value%1==0&&value<=MAX_SAFE_INTEGER}var MAX_SAFE_INTEGER=9007199254740991;module.exports=isLength}),isLength$1=interopDefault(isLength),require$$2$4=Object.freeze({default:isLength$1}),isArrayLike=createCommonjsModule(function(module){function isArrayLike(value){return null!=value&&isLength(getLength(value))&&!isFunction(value)}var getLength=interopDefault(require$$2$1),isFunction=interopDefault(require$$2$2),isLength=interopDefault(require$$2$4);module.exports=isArrayLike}),isArrayLike$1=interopDefault(isArrayLike),require$$3=Object.freeze({default:isArrayLike$1}),isObjectLike=createCommonjsModule(function(module){function isObjectLike(value){return!!value&&"object"==typeof value}module.exports=isObjectLike}),isObjectLike$1=interopDefault(isObjectLike),require$$0$4=Object.freeze({default:isObjectLike$1}),isArrayLikeObject=createCommonjsModule(function(module){function isArrayLikeObject(value){return isObjectLike(value)&&isArrayLike(value)}var isArrayLike=interopDefault(require$$3),isObjectLike=interopDefault(require$$0$4);module.exports=isArrayLikeObject}),isArrayLikeObject$1=interopDefault(isArrayLikeObject),require$$1$4=Object.freeze({default:isArrayLikeObject$1}),isArguments=createCommonjsModule(function(module){function isArguments(value){return isArrayLikeObject(value)&&hasOwnProperty.call(value,"callee")&&(!propertyIsEnumerable.call(value,"callee")||objectToString.call(value)==argsTag)}var isArrayLikeObject=interopDefault(require$$1$4),argsTag="[object Arguments]",objectProto=Object.prototype,hasOwnProperty=objectProto.hasOwnProperty,objectToString=objectProto.toString,propertyIsEnumerable=objectProto.propertyIsEnumerable;module.exports=isArguments}),isArguments$1=interopDefault(isArguments),require$$1$3=Object.freeze({default:isArguments$1}),isArray=createCommonjsModule(function(module){var isArray=Array.isArray;module.exports=isArray}),isArray$1=interopDefault(isArray),require$$0$5=Object.freeze({default:isArray$1}),isString=createCommonjsModule(function(module){function isString(value){return"string"==typeof value||!isArray(value)&&isObjectLike(value)&&objectToString.call(value)==stringTag}var isArray=interopDefault(require$$0$5),isObjectLike=interopDefault(require$$0$4),stringTag="[object String]",objectProto=Object.prototype,objectToString=objectProto.toString;module.exports=isString}),isString$1=interopDefault(isString),require$$2$5=Object.freeze({default:isString$1}),_indexKeys=createCommonjsModule(function(module){function indexKeys(object){var length=object?object.length:void 0;return isLength(length)&&(isArray(object)||isString(object)||isArguments(object))?baseTimes(length,String):null}var baseTimes=interopDefault(require$$4$1),isArguments=interopDefault(require$$1$3),isArray=interopDefault(require$$0$5),isLength=interopDefault(require$$2$4),isString=interopDefault(require$$2$5);module.exports=indexKeys}),_indexKeys$1=interopDefault(_indexKeys),require$$2=Object.freeze({default:_indexKeys$1}),_isIndex=createCommonjsModule(function(module){function isIndex(value,length){return length=null==length?MAX_SAFE_INTEGER:length,!!length&&("number"==typeof value||reIsUint.test(value))&&value>-1&&value%1==0&&value<length}var MAX_SAFE_INTEGER=9007199254740991,reIsUint=/^(?:0|[1-9]\d*)$/;module.exports=isIndex}),_isIndex$1=interopDefault(_isIndex),require$$3$2=Object.freeze({
default:_isIndex$1}),_isPrototype=createCommonjsModule(function(module){function isPrototype(value){var Ctor=value&&value.constructor,proto="function"==typeof Ctor&&Ctor.prototype||objectProto;return value===proto}var objectProto=Object.prototype;module.exports=isPrototype}),_isPrototype$1=interopDefault(_isPrototype),require$$0$6=Object.freeze({default:_isPrototype$1}),keys=createCommonjsModule(function(module){function keys(object){var isProto=isPrototype(object);if(!isProto&&!isArrayLike(object))return baseKeys(object);var indexes=indexKeys(object),skipIndexes=!!indexes,result=indexes||[],length=result.length;for(var key in object)!baseHas(object,key)||skipIndexes&&("length"==key||isIndex(key,length))||isProto&&"constructor"==key||result.push(key);return result}var baseHas=interopDefault(require$$5),baseKeys=interopDefault(require$$4),indexKeys=interopDefault(require$$2),isArrayLike=interopDefault(require$$3),isIndex=interopDefault(require$$3$2),isPrototype=interopDefault(require$$0$6);module.exports=keys}),keys$1=interopDefault(keys),require$$0$3=Object.freeze({default:keys$1}),_baseForOwn=createCommonjsModule(function(module){function baseForOwn(object,iteratee){return object&&baseFor(object,iteratee,keys)}var baseFor=interopDefault(require$$1$1),keys=interopDefault(require$$0$3);module.exports=baseForOwn}),_baseForOwn$1=interopDefault(_baseForOwn),require$$1=Object.freeze({default:_baseForOwn$1}),_createBaseEach=createCommonjsModule(function(module){function createBaseEach(eachFunc,fromRight){return function(collection,iteratee){if(null==collection)return collection;if(!isArrayLike(collection))return eachFunc(collection,iteratee);for(var length=collection.length,index=fromRight?length:-1,iterable=Object(collection);(fromRight?index--:++index<length)&&iteratee(iterable[index],index,iterable)!==!1;);return collection}}var isArrayLike=interopDefault(require$$3);module.exports=createBaseEach}),_createBaseEach$1=interopDefault(_createBaseEach),require$$0$7=Object.freeze({default:_createBaseEach$1}),_baseEach=createCommonjsModule(function(module){var baseForOwn=interopDefault(require$$1),createBaseEach=interopDefault(require$$0$7),baseEach=createBaseEach(baseForOwn);module.exports=baseEach}),_baseEach$1=interopDefault(_baseEach),require$$0$1=Object.freeze({default:_baseEach$1}),_listCacheClear=createCommonjsModule(function(module){function listCacheClear(){this.__data__=[]}module.exports=listCacheClear}),_listCacheClear$1=interopDefault(_listCacheClear),require$$4$3=Object.freeze({default:_listCacheClear$1}),eq=createCommonjsModule(function(module){function eq(value,other){return value===other||value!==value&&other!==other}module.exports=eq}),eq$1=interopDefault(eq),require$$3$4=Object.freeze({default:eq$1}),_assocIndexOf=createCommonjsModule(function(module){function assocIndexOf(array,key){for(var length=array.length;length--;)if(eq(array[length][0],key))return length;return-1}var eq=interopDefault(require$$3$4);module.exports=assocIndexOf}),_assocIndexOf$1=interopDefault(_assocIndexOf),require$$0$8=Object.freeze({default:_assocIndexOf$1}),_listCacheDelete=createCommonjsModule(function(module){function listCacheDelete(key){var data=this.__data__,index=assocIndexOf(data,key);if(index<0)return!1;var lastIndex=data.length-1;return index==lastIndex?data.pop():splice.call(data,index,1),!0}var assocIndexOf=interopDefault(require$$0$8),arrayProto=Array.prototype,splice=arrayProto.splice;module.exports=listCacheDelete}),_listCacheDelete$1=interopDefault(_listCacheDelete),require$$3$3=Object.freeze({default:_listCacheDelete$1}),_listCacheGet=createCommonjsModule(function(module){function listCacheGet(key){var data=this.__data__,index=assocIndexOf(data,key);return index<0?void 0:data[index][1]}var assocIndexOf=interopDefault(require$$0$8);module.exports=listCacheGet}),_listCacheGet$1=interopDefault(_listCacheGet),require$$2$7=Object.freeze({default:_listCacheGet$1}),_listCacheHas=createCommonjsModule(function(module){function listCacheHas(key){return assocIndexOf(this.__data__,key)>-1}var assocIndexOf=interopDefault(require$$0$8);module.exports=listCacheHas}),_listCacheHas$1=interopDefault(_listCacheHas),require$$1$7=Object.freeze({default:_listCacheHas$1}),_listCacheSet=createCommonjsModule(function(module){function listCacheSet(key,value){var data=this.__data__,index=assocIndexOf(data,key);return index<0?data.push([key,value]):data[index][1]=value,this}var assocIndexOf=interopDefault(require$$0$8);module.exports=listCacheSet}),_listCacheSet$1=interopDefault(_listCacheSet),require$$0$9=Object.freeze({default:_listCacheSet$1}),_ListCache=createCommonjsModule(function(module){function ListCache(entries){var this$1=this,index=-1,length=entries?entries.length:0;for(this.clear();++index<length;){var entry=entries[index];this$1.set(entry[0],entry[1])}}var listCacheClear=interopDefault(require$$4$3),listCacheDelete=interopDefault(require$$3$3),listCacheGet=interopDefault(require$$2$7),listCacheHas=interopDefault(require$$1$7),listCacheSet=interopDefault(require$$0$9);ListCache.prototype.clear=listCacheClear,ListCache.prototype.delete=listCacheDelete,ListCache.prototype.get=listCacheGet,ListCache.prototype.has=listCacheHas,ListCache.prototype.set=listCacheSet,module.exports=ListCache}),_ListCache$1=interopDefault(_ListCache),require$$1$6=Object.freeze({default:_ListCache$1}),_stackClear=createCommonjsModule(function(module){function stackClear(){this.__data__=new ListCache}var ListCache=interopDefault(require$$1$6);module.exports=stackClear}),_stackClear$1=interopDefault(_stackClear),require$$4$4=Object.freeze({default:_stackClear$1}),_stackDelete=createCommonjsModule(function(module){function stackDelete(key){return this.__data__.delete(key)}module.exports=stackDelete}),_stackDelete$1=interopDefault(_stackDelete),require$$3$5=Object.freeze({default:_stackDelete$1}),_stackGet=createCommonjsModule(function(module){function stackGet(key){return this.__data__.get(key)}module.exports=stackGet}),_stackGet$1=interopDefault(_stackGet),require$$2$8=Object.freeze({default:_stackGet$1}),_stackHas=createCommonjsModule(function(module){function stackHas(key){return this.__data__.has(key)}module.exports=stackHas}),_stackHas$1=interopDefault(_stackHas),require$$1$8=Object.freeze({default:_stackHas$1}),_isHostObject=createCommonjsModule(function(module){function isHostObject(value){var result=!1;if(null!=value&&"function"!=typeof value.toString)try{result=!!(value+"")}catch(e){}return result}module.exports=isHostObject}),_isHostObject$1=interopDefault(_isHostObject),require$$1$11=Object.freeze({default:_isHostObject$1}),_checkGlobal=createCommonjsModule(function(module){function checkGlobal(value){return value&&value.Object===Object?value:null}module.exports=checkGlobal}),_checkGlobal$1=interopDefault(_checkGlobal),require$$0$14=Object.freeze({default:_checkGlobal$1}),_root=createCommonjsModule(function(module){var checkGlobal=interopDefault(require$$0$14),freeGlobal=checkGlobal("object"==typeof commonjsGlobal&&commonjsGlobal),freeSelf=checkGlobal("object"==typeof self&&self),thisGlobal=checkGlobal("object"==typeof commonjsGlobal&&commonjsGlobal),root=freeGlobal||freeSelf||thisGlobal||Function("return this")();module.exports=root}),_root$1=interopDefault(_root),require$$1$12=Object.freeze({default:_root$1}),_coreJsData=createCommonjsModule(function(module){var root=interopDefault(require$$1$12),coreJsData=root["__core-js_shared__"];module.exports=coreJsData}),_coreJsData$1=interopDefault(_coreJsData),require$$0$13=Object.freeze({default:_coreJsData$1}),_isMasked=createCommonjsModule(function(module){function isMasked(func){return!!maskSrcKey&&maskSrcKey in func}var coreJsData=interopDefault(require$$0$13),maskSrcKey=function(){var uid=/[^.]+$/.exec(coreJsData&&coreJsData.keys&&coreJsData.keys.IE_PROTO||"");return uid?"Symbol(src)_1."+uid:""}();module.exports=isMasked}),_isMasked$1=interopDefault(_isMasked),require$$2$10=Object.freeze({default:_isMasked$1}),_toSource=createCommonjsModule(function(module){function toSource(func){if(null!=func){try{return funcToString.call(func)}catch(e){}try{return func+""}catch(e){}}return""}var funcToString=Function.prototype.toString;module.exports=toSource}),_toSource$1=interopDefault(_toSource),require$$0$15=Object.freeze({default:_toSource$1}),_baseIsNative=createCommonjsModule(function(module){function baseIsNative(value){if(!isObject(value)||isMasked(value))return!1;var pattern=isFunction(value)||isHostObject(value)?reIsNative:reIsHostCtor;return pattern.test(toSource(value))}var isFunction=interopDefault(require$$2$2),isHostObject=interopDefault(require$$1$11),isMasked=interopDefault(require$$2$10),isObject=interopDefault(require$$2$3),toSource=interopDefault(require$$0$15),reRegExpChar=/[\\^$.*+?()[\]{}|]/g,reIsHostCtor=/^\[object .+?Constructor\]$/,objectProto=Object.prototype,funcToString=Function.prototype.toString,hasOwnProperty=objectProto.hasOwnProperty,reIsNative=RegExp("^"+funcToString.call(hasOwnProperty).replace(reRegExpChar,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");module.exports=baseIsNative}),_baseIsNative$1=interopDefault(_baseIsNative),require$$1$10=Object.freeze({default:_baseIsNative$1}),_getValue=createCommonjsModule(function(module){function getValue(object,key){return null==object?void 0:object[key]}module.exports=getValue}),_getValue$1=interopDefault(_getValue),require$$0$16=Object.freeze({default:_getValue$1}),_getNative=createCommonjsModule(function(module){function getNative(object,key){var value=getValue(object,key);return baseIsNative(value)?value:void 0}var baseIsNative=interopDefault(require$$1$10),getValue=interopDefault(require$$0$16);module.exports=getNative}),_getNative$1=interopDefault(_getNative),require$$1$9=Object.freeze({default:_getNative$1}),_nativeCreate=createCommonjsModule(function(module){var getNative=interopDefault(require$$1$9),nativeCreate=getNative(Object,"create");module.exports=nativeCreate}),_nativeCreate$1=interopDefault(_nativeCreate),require$$0$12=Object.freeze({default:_nativeCreate$1}),_hashClear=createCommonjsModule(function(module){function hashClear(){this.__data__=nativeCreate?nativeCreate(null):{}}var nativeCreate=interopDefault(require$$0$12);module.exports=hashClear}),_hashClear$1=interopDefault(_hashClear),require$$4$6=Object.freeze({default:_hashClear$1}),_hashDelete=createCommonjsModule(function(module){function hashDelete(key){return this.has(key)&&delete this.__data__[key]}module.exports=hashDelete}),_hashDelete$1=interopDefault(_hashDelete),require$$3$6=Object.freeze({default:_hashDelete$1}),_hashGet=createCommonjsModule(function(module){function hashGet(key){var data=this.__data__;if(nativeCreate){var result=data[key];return result===HASH_UNDEFINED?void 0:result}return hasOwnProperty.call(data,key)?data[key]:void 0}var nativeCreate=interopDefault(require$$0$12),HASH_UNDEFINED="__lodash_hash_undefined__",objectProto=Object.prototype,hasOwnProperty=objectProto.hasOwnProperty;module.exports=hashGet}),_hashGet$1=interopDefault(_hashGet),require$$2$11=Object.freeze({default:_hashGet$1}),_hashHas=createCommonjsModule(function(module){function hashHas(key){var data=this.__data__;return nativeCreate?void 0!==data[key]:hasOwnProperty.call(data,key)}var nativeCreate=interopDefault(require$$0$12),objectProto=Object.prototype,hasOwnProperty=objectProto.hasOwnProperty;module.exports=hashHas}),_hashHas$1=interopDefault(_hashHas),require$$1$13=Object.freeze({default:_hashHas$1}),_hashSet=createCommonjsModule(function(module){function hashSet(key,value){var data=this.__data__;return data[key]=nativeCreate&&void 0===value?HASH_UNDEFINED:value,this}var nativeCreate=interopDefault(require$$0$12),HASH_UNDEFINED="__lodash_hash_undefined__";module.exports=hashSet}),_hashSet$1=interopDefault(_hashSet),require$$0$17=Object.freeze({default:_hashSet$1}),_Hash=createCommonjsModule(function(module){function Hash(entries){var this$1=this,index=-1,length=entries?entries.length:0;for(this.clear();++index<length;){var entry=entries[index];this$1.set(entry[0],entry[1])}}var hashClear=interopDefault(require$$4$6),hashDelete=interopDefault(require$$3$6),hashGet=interopDefault(require$$2$11),hashHas=interopDefault(require$$1$13),hashSet=interopDefault(require$$0$17);Hash.prototype.clear=hashClear,Hash.prototype.delete=hashDelete,Hash.prototype.get=hashGet,Hash.prototype.has=hashHas,Hash.prototype.set=hashSet,module.exports=Hash}),_Hash$1=interopDefault(_Hash),require$$2$9=Object.freeze({default:_Hash$1}),_Map=createCommonjsModule(function(module){var getNative=interopDefault(require$$1$9),root=interopDefault(require$$1$12),Map=getNative(root,"Map");module.exports=Map}),_Map$1=interopDefault(_Map),require$$4$7=Object.freeze({default:_Map$1}),_mapCacheClear=createCommonjsModule(function(module){function mapCacheClear(){this.__data__={hash:new Hash,map:new(Map||ListCache),string:new Hash}}var Hash=interopDefault(require$$2$9),ListCache=interopDefault(require$$1$6),Map=interopDefault(require$$4$7);module.exports=mapCacheClear}),_mapCacheClear$1=interopDefault(_mapCacheClear),require$$4$5=Object.freeze({default:_mapCacheClear$1}),_isKeyable=createCommonjsModule(function(module){function isKeyable(value){var type=typeof value;return"string"==type||"number"==type||"symbol"==type||"boolean"==type?"__proto__"!==value:null===value}module.exports=isKeyable}),_isKeyable$1=interopDefault(_isKeyable),require$$0$19=Object.freeze({default:_isKeyable$1}),_getMapData=createCommonjsModule(function(module){function getMapData(map,key){var data=map.__data__;return isKeyable(key)?data["string"==typeof key?"string":"hash"]:data.map}var isKeyable=interopDefault(require$$0$19);module.exports=getMapData}),_getMapData$1=interopDefault(_getMapData),require$$0$18=Object.freeze({default:_getMapData$1}),_mapCacheDelete=createCommonjsModule(function(module){function mapCacheDelete(key){return getMapData(this,key).delete(key)}var getMapData=interopDefault(require$$0$18);module.exports=mapCacheDelete}),_mapCacheDelete$1=interopDefault(_mapCacheDelete),require$$3$7=Object.freeze({default:_mapCacheDelete$1}),_mapCacheGet=createCommonjsModule(function(module){function mapCacheGet(key){return getMapData(this,key).get(key)}var getMapData=interopDefault(require$$0$18);module.exports=mapCacheGet}),_mapCacheGet$1=interopDefault(_mapCacheGet),require$$2$12=Object.freeze({default:_mapCacheGet$1}),_mapCacheHas=createCommonjsModule(function(module){function mapCacheHas(key){return getMapData(this,key).has(key)}var getMapData=interopDefault(require$$0$18);module.exports=mapCacheHas}),_mapCacheHas$1=interopDefault(_mapCacheHas),require$$1$14=Object.freeze({default:_mapCacheHas$1}),_mapCacheSet=createCommonjsModule(function(module){function mapCacheSet(key,value){return getMapData(this,key).set(key,value),this}var getMapData=interopDefault(require$$0$18);module.exports=mapCacheSet}),_mapCacheSet$1=interopDefault(_mapCacheSet),require$$0$20=Object.freeze({default:_mapCacheSet$1}),_MapCache=createCommonjsModule(function(module){function MapCache(entries){var this$1=this,index=-1,length=entries?entries.length:0;for(this.clear();++index<length;){var entry=entries[index];this$1.set(entry[0],entry[1])}}var mapCacheClear=interopDefault(require$$4$5),mapCacheDelete=interopDefault(require$$3$7),mapCacheGet=interopDefault(require$$2$12),mapCacheHas=interopDefault(require$$1$14),mapCacheSet=interopDefault(require$$0$20);MapCache.prototype.clear=mapCacheClear,MapCache.prototype.delete=mapCacheDelete,MapCache.prototype.get=mapCacheGet,MapCache.prototype.has=mapCacheHas,MapCache.prototype.set=mapCacheSet,module.exports=MapCache}),_MapCache$1=interopDefault(_MapCache),require$$0$11=Object.freeze({default:_MapCache$1}),_stackSet=createCommonjsModule(function(module){function stackSet(key,value){var cache=this.__data__;return cache instanceof ListCache&&cache.__data__.length==LARGE_ARRAY_SIZE&&(cache=this.__data__=new MapCache(cache.__data__)),cache.set(key,value),this}var ListCache=interopDefault(require$$1$6),MapCache=interopDefault(require$$0$11),LARGE_ARRAY_SIZE=200;module.exports=stackSet}),_stackSet$1=interopDefault(_stackSet),require$$0$10=Object.freeze({default:_stackSet$1}),_Stack=createCommonjsModule(function(module){function Stack(entries){this.__data__=new ListCache(entries)}var ListCache=interopDefault(require$$1$6),stackClear=interopDefault(require$$4$4),stackDelete=interopDefault(require$$3$5),stackGet=interopDefault(require$$2$8),stackHas=interopDefault(require$$1$8),stackSet=interopDefault(require$$0$10);Stack.prototype.clear=stackClear,Stack.prototype.delete=stackDelete,Stack.prototype.get=stackGet,Stack.prototype.has=stackHas,Stack.prototype.set=stackSet,module.exports=Stack}),_Stack$1=interopDefault(_Stack),require$$16=Object.freeze({default:_Stack$1}),_setCacheAdd=createCommonjsModule(function(module){function setCacheAdd(value){return this.__data__.set(value,HASH_UNDEFINED),this}var HASH_UNDEFINED="__lodash_hash_undefined__";module.exports=setCacheAdd}),_setCacheAdd$1=interopDefault(_setCacheAdd),require$$1$15=Object.freeze({default:_setCacheAdd$1}),_setCacheHas=createCommonjsModule(function(module){function setCacheHas(value){return this.__data__.has(value)}module.exports=setCacheHas}),_setCacheHas$1=interopDefault(_setCacheHas),require$$0$22=Object.freeze({default:_setCacheHas$1}),_SetCache=createCommonjsModule(function(module){function SetCache(values){var this$1=this,index=-1,length=values?values.length:0;for(this.__data__=new MapCache;++index<length;)this$1.add(values[index])}var MapCache=interopDefault(require$$0$11),setCacheAdd=interopDefault(require$$1$15),setCacheHas=interopDefault(require$$0$22);SetCache.prototype.add=SetCache.prototype.push=setCacheAdd,SetCache.prototype.has=setCacheHas,module.exports=SetCache}),_SetCache$1=interopDefault(_SetCache),require$$5$1=Object.freeze({default:_SetCache$1}),_arraySome=createCommonjsModule(function(module){function arraySome(array,predicate){for(var index=-1,length=array?array.length:0;++index<length;)if(predicate(array[index],index,array))return!0;return!1}module.exports=arraySome}),_arraySome$1=interopDefault(_arraySome),require$$0$23=Object.freeze({default:_arraySome$1}),_equalArrays=createCommonjsModule(function(module){function equalArrays(array,other,equalFunc,customizer,bitmask,stack){var isPartial=bitmask&PARTIAL_COMPARE_FLAG,arrLength=array.length,othLength=other.length;if(arrLength!=othLength&&!(isPartial&&othLength>arrLength))return!1;var stacked=stack.get(array);if(stacked)return stacked==other;var index=-1,result=!0,seen=bitmask&UNORDERED_COMPARE_FLAG?new SetCache:void 0;for(stack.set(array,other);++index<arrLength;){var arrValue=array[index],othValue=other[index];if(customizer)var compared=isPartial?customizer(othValue,arrValue,index,other,array,stack):customizer(arrValue,othValue,index,array,other,stack);if(void 0!==compared){if(compared)continue;result=!1;break}if(seen){if(!arraySome(other,function(othValue,othIndex){if(!seen.has(othIndex)&&(arrValue===othValue||equalFunc(arrValue,othValue,customizer,bitmask,stack)))return seen.add(othIndex)})){result=!1;break}}else if(arrValue!==othValue&&!equalFunc(arrValue,othValue,customizer,bitmask,stack)){result=!1;break}}return stack.delete(array),result}var SetCache=interopDefault(require$$5$1),arraySome=interopDefault(require$$0$23),UNORDERED_COMPARE_FLAG=1,PARTIAL_COMPARE_FLAG=2;module.exports=equalArrays}),_equalArrays$1=interopDefault(_equalArrays),require$$2$14=Object.freeze({default:_equalArrays$1}),_Symbol=createCommonjsModule(function(module){var root=interopDefault(require$$1$12),Symbol=root.Symbol;module.exports=Symbol}),_Symbol$1=interopDefault(_Symbol),require$$0$24=Object.freeze({default:_Symbol$1}),_Uint8Array=createCommonjsModule(function(module){var root=interopDefault(require$$1$12),Uint8Array=root.Uint8Array;module.exports=Uint8Array}),_Uint8Array$1=interopDefault(_Uint8Array),require$$0$25=Object.freeze({default:_Uint8Array$1}),_mapToArray=createCommonjsModule(function(module){function mapToArray(map){var index=-1,result=Array(map.size);return map.forEach(function(value,key){result[++index]=[key,value]}),result}module.exports=mapToArray}),_mapToArray$1=interopDefault(_mapToArray),require$$0$26=Object.freeze({default:_mapToArray$1}),_setToArray=createCommonjsModule(function(module){function setToArray(set){var index=-1,result=Array(set.size);return set.forEach(function(value){result[++index]=value}),result}module.exports=setToArray}),_setToArray$1=interopDefault(_setToArray),require$$0$27=Object.freeze({default:_setToArray$1}),_equalByTag=createCommonjsModule(function(module){function equalByTag(object,other,tag,equalFunc,customizer,bitmask,stack){switch(tag){case dataViewTag:if(object.byteLength!=other.byteLength||object.byteOffset!=other.byteOffset)return!1;object=object.buffer,other=other.buffer;case arrayBufferTag:return!(object.byteLength!=other.byteLength||!equalFunc(new Uint8Array(object),new Uint8Array(other)));case boolTag:case dateTag:return+object==+other;case errorTag:return object.name==other.name&&object.message==other.message;case numberTag:return object!=+object?other!=+other:object==+other;case regexpTag:case stringTag:return object==other+"";case mapTag:var convert=mapToArray;case setTag:var isPartial=bitmask&PARTIAL_COMPARE_FLAG;if(convert||(convert=setToArray),object.size!=other.size&&!isPartial)return!1;var stacked=stack.get(object);return stacked?stacked==other:(bitmask|=UNORDERED_COMPARE_FLAG,stack.set(object,other),equalArrays(convert(object),convert(other),equalFunc,customizer,bitmask,stack));case symbolTag:if(symbolValueOf)return symbolValueOf.call(object)==symbolValueOf.call(other)}return!1}var Symbol=interopDefault(require$$0$24),Uint8Array=interopDefault(require$$0$25),equalArrays=interopDefault(require$$2$14),mapToArray=interopDefault(require$$0$26),setToArray=interopDefault(require$$0$27),UNORDERED_COMPARE_FLAG=1,PARTIAL_COMPARE_FLAG=2,boolTag="[object Boolean]",dateTag="[object Date]",errorTag="[object Error]",mapTag="[object Map]",numberTag="[object Number]",regexpTag="[object RegExp]",setTag="[object Set]",stringTag="[object String]",symbolTag="[object Symbol]",arrayBufferTag="[object ArrayBuffer]",dataViewTag="[object DataView]",symbolProto=Symbol?Symbol.prototype:void 0,symbolValueOf=symbolProto?symbolProto.valueOf:void 0;module.exports=equalByTag}),_equalByTag$1=interopDefault(_equalByTag),require$$5$2=Object.freeze({default:_equalByTag$1}),_equalObjects=createCommonjsModule(function(module){function equalObjects(object,other,equalFunc,customizer,bitmask,stack){var isPartial=bitmask&PARTIAL_COMPARE_FLAG,objProps=keys(object),objLength=objProps.length,othProps=keys(other),othLength=othProps.length;if(objLength!=othLength&&!isPartial)return!1;for(var index=objLength;index--;){var key=objProps[index];if(!(isPartial?key in other:baseHas(other,key)))return!1}var stacked=stack.get(object);if(stacked)return stacked==other;var result=!0;stack.set(object,other);for(var skipCtor=isPartial;++index<objLength;){key=objProps[index];var objValue=object[key],othValue=other[key];if(customizer)var compared=isPartial?customizer(othValue,objValue,key,other,object,stack):customizer(objValue,othValue,key,object,other,stack);if(!(void 0===compared?objValue===othValue||equalFunc(objValue,othValue,customizer,bitmask,stack):compared)){result=!1;break}skipCtor||(skipCtor="constructor"==key)}if(result&&!skipCtor){var objCtor=object.constructor,othCtor=other.constructor;objCtor!=othCtor&&"constructor"in object&&"constructor"in other&&!("function"==typeof objCtor&&objCtor instanceof objCtor&&"function"==typeof othCtor&&othCtor instanceof othCtor)&&(result=!1)}return stack.delete(object),result}var baseHas=interopDefault(require$$5),keys=interopDefault(require$$0$3),PARTIAL_COMPARE_FLAG=2;module.exports=equalObjects}),_equalObjects$1=interopDefault(_equalObjects),require$$4$8=Object.freeze({default:_equalObjects$1}),_DataView=createCommonjsModule(function(module){var getNative=interopDefault(require$$1$9),root=interopDefault(require$$1$12),DataView=getNative(root,"DataView");module.exports=DataView}),_DataView$1=interopDefault(_DataView),require$$5$3=Object.freeze({default:_DataView$1}),_Promise=createCommonjsModule(function(module){var getNative=interopDefault(require$$1$9),root=interopDefault(require$$1$12),Promise=getNative(root,"Promise");module.exports=Promise}),_Promise$1=interopDefault(_Promise),require$$3$8=Object.freeze({default:_Promise$1}),_Set=createCommonjsModule(function(module){var getNative=interopDefault(require$$1$9),root=interopDefault(require$$1$12),Set=getNative(root,"Set");module.exports=Set}),_Set$1=interopDefault(_Set),require$$2$15=Object.freeze({default:_Set$1}),_WeakMap=createCommonjsModule(function(module){var getNative=interopDefault(require$$1$9),root=interopDefault(require$$1$12),WeakMap=getNative(root,"WeakMap");module.exports=WeakMap}),_WeakMap$1=interopDefault(_WeakMap),require$$1$16=Object.freeze({default:_WeakMap$1}),_getTag=createCommonjsModule(function(module){function getTag(value){return objectToString.call(value)}var DataView=interopDefault(require$$5$3),Map=interopDefault(require$$4$7),Promise=interopDefault(require$$3$8),Set=interopDefault(require$$2$15),WeakMap=interopDefault(require$$1$16),toSource=interopDefault(require$$0$15),mapTag="[object Map]",objectTag="[object Object]",promiseTag="[object Promise]",setTag="[object Set]",weakMapTag="[object WeakMap]",dataViewTag="[object DataView]",objectProto=Object.prototype,objectToString=objectProto.toString,dataViewCtorString=toSource(DataView),mapCtorString=toSource(Map),promiseCtorString=toSource(Promise),setCtorString=toSource(Set),weakMapCtorString=toSource(WeakMap);(DataView&&getTag(new DataView(new ArrayBuffer(1)))!=dataViewTag||Map&&getTag(new Map)!=mapTag||Promise&&getTag(Promise.resolve())!=promiseTag||Set&&getTag(new Set)!=setTag||WeakMap&&getTag(new WeakMap)!=weakMapTag)&&(getTag=function(value){var result=objectToString.call(value),Ctor=result==objectTag?value.constructor:void 0,ctorString=Ctor?toSource(Ctor):void 0;if(ctorString)switch(ctorString){case dataViewCtorString:return dataViewTag;case mapCtorString:return mapTag;case promiseCtorString:return promiseTag;case setCtorString:return setTag;case weakMapCtorString:return weakMapTag}return result}),module.exports=getTag}),_getTag$1=interopDefault(_getTag),require$$8=Object.freeze({default:_getTag$1}),isTypedArray=createCommonjsModule(function(module){function isTypedArray(value){return isObjectLike(value)&&isLength(value.length)&&!!typedArrayTags[objectToString.call(value)]}var isLength=interopDefault(require$$2$4),isObjectLike=interopDefault(require$$0$4),argsTag="[object Arguments]",arrayTag="[object Array]",boolTag="[object Boolean]",dateTag="[object Date]",errorTag="[object Error]",funcTag="[object Function]",mapTag="[object Map]",numberTag="[object Number]",objectTag="[object Object]",regexpTag="[object RegExp]",setTag="[object Set]",stringTag="[object String]",weakMapTag="[object WeakMap]",arrayBufferTag="[object ArrayBuffer]",dataViewTag="[object DataView]",float32Tag="[object Float32Array]",float64Tag="[object Float64Array]",int8Tag="[object Int8Array]",int16Tag="[object Int16Array]",int32Tag="[object Int32Array]",uint8Tag="[object Uint8Array]",uint8ClampedTag="[object Uint8ClampedArray]",uint16Tag="[object Uint16Array]",uint32Tag="[object Uint32Array]",typedArrayTags={};typedArrayTags[float32Tag]=typedArrayTags[float64Tag]=typedArrayTags[int8Tag]=typedArrayTags[int16Tag]=typedArrayTags[int32Tag]=typedArrayTags[uint8Tag]=typedArrayTags[uint8ClampedTag]=typedArrayTags[uint16Tag]=typedArrayTags[uint32Tag]=!0,typedArrayTags[argsTag]=typedArrayTags[arrayTag]=typedArrayTags[arrayBufferTag]=typedArrayTags[boolTag]=typedArrayTags[dataViewTag]=typedArrayTags[dateTag]=typedArrayTags[errorTag]=typedArrayTags[funcTag]=typedArrayTags[mapTag]=typedArrayTags[numberTag]=typedArrayTags[objectTag]=typedArrayTags[regexpTag]=typedArrayTags[setTag]=typedArrayTags[stringTag]=typedArrayTags[weakMapTag]=!1;var objectProto=Object.prototype,objectToString=objectProto.toString;module.exports=isTypedArray}),isTypedArray$1=interopDefault(isTypedArray),require$$0$28=Object.freeze({default:isTypedArray$1}),_baseIsEqualDeep=createCommonjsModule(function(module){function baseIsEqualDeep(object,other,equalFunc,customizer,bitmask,stack){var objIsArr=isArray(object),othIsArr=isArray(other),objTag=arrayTag,othTag=arrayTag;objIsArr||(objTag=getTag(object),objTag=objTag==argsTag?objectTag:objTag),othIsArr||(othTag=getTag(other),othTag=othTag==argsTag?objectTag:othTag);var objIsObj=objTag==objectTag&&!isHostObject(object),othIsObj=othTag==objectTag&&!isHostObject(other),isSameTag=objTag==othTag;if(isSameTag&&!objIsObj)return stack||(stack=new Stack),objIsArr||isTypedArray(object)?equalArrays(object,other,equalFunc,customizer,bitmask,stack):equalByTag(object,other,objTag,equalFunc,customizer,bitmask,stack);if(!(bitmask&PARTIAL_COMPARE_FLAG)){var objIsWrapped=objIsObj&&hasOwnProperty.call(object,"__wrapped__"),othIsWrapped=othIsObj&&hasOwnProperty.call(other,"__wrapped__");if(objIsWrapped||othIsWrapped){var objUnwrapped=objIsWrapped?object.value():object,othUnwrapped=othIsWrapped?other.value():other;return stack||(stack=new Stack),equalFunc(objUnwrapped,othUnwrapped,customizer,bitmask,stack)}}return!!isSameTag&&(stack||(stack=new Stack),equalObjects(object,other,equalFunc,customizer,bitmask,stack))}var Stack=interopDefault(require$$16),equalArrays=interopDefault(require$$2$14),equalByTag=interopDefault(require$$5$2),equalObjects=interopDefault(require$$4$8),getTag=interopDefault(require$$8),isArray=interopDefault(require$$0$5),isHostObject=interopDefault(require$$1$11),isTypedArray=interopDefault(require$$0$28),PARTIAL_COMPARE_FLAG=2,argsTag="[object Arguments]",arrayTag="[object Array]",objectTag="[object Object]",objectProto=Object.prototype,hasOwnProperty=objectProto.hasOwnProperty;module.exports=baseIsEqualDeep}),_baseIsEqualDeep$1=interopDefault(_baseIsEqualDeep),require$$2$13=Object.freeze({default:_baseIsEqualDeep$1}),_baseIsEqual=createCommonjsModule(function(module){function baseIsEqual(value,other,customizer,bitmask,stack){return value===other||(null==value||null==other||!isObject(value)&&!isObjectLike(other)?value!==value&&other!==other:baseIsEqualDeep(value,other,baseIsEqual,customizer,bitmask,stack))}var baseIsEqualDeep=interopDefault(require$$2$13),isObject=interopDefault(require$$2$3),isObjectLike=interopDefault(require$$0$4);module.exports=baseIsEqual}),_baseIsEqual$1=interopDefault(_baseIsEqual),require$$0$21=Object.freeze({default:_baseIsEqual$1}),_baseIsMatch=createCommonjsModule(function(module){function baseIsMatch(object,source,matchData,customizer){var index=matchData.length,length=index,noCustomizer=!customizer;if(null==object)return!length;for(object=Object(object);index--;){var data=matchData[index];if(noCustomizer&&data[2]?data[1]!==object[data[0]]:!(data[0]in object))return!1}for(;++index<length;){data=matchData[index];var key=data[0],objValue=object[key],srcValue=data[1];if(noCustomizer&&data[2]){if(void 0===objValue&&!(key in object))return!1}else{var stack=new Stack;if(customizer)var result=customizer(objValue,srcValue,key,object,source,stack);if(!(void 0===result?baseIsEqual(srcValue,objValue,customizer,UNORDERED_COMPARE_FLAG|PARTIAL_COMPARE_FLAG,stack):result))return!1}}return!0}var Stack=interopDefault(require$$16),baseIsEqual=interopDefault(require$$0$21),UNORDERED_COMPARE_FLAG=1,PARTIAL_COMPARE_FLAG=2;module.exports=baseIsMatch}),_baseIsMatch$1=interopDefault(_baseIsMatch),require$$1$5=Object.freeze({default:_baseIsMatch$1}),_isStrictComparable=createCommonjsModule(function(module){function isStrictComparable(value){return value===value&&!isObject(value)}var isObject=interopDefault(require$$2$3);module.exports=isStrictComparable}),_isStrictComparable$1=interopDefault(_isStrictComparable),require$$2$16=Object.freeze({default:_isStrictComparable$1
}),_getMatchData=createCommonjsModule(function(module){function getMatchData(object){for(var result=keys(object),length=result.length;length--;){var key=result[length],value=object[key];result[length]=[key,value,isStrictComparable(value)]}return result}var isStrictComparable=interopDefault(require$$2$16),keys=interopDefault(require$$0$3);module.exports=getMatchData}),_getMatchData$1=interopDefault(_getMatchData),require$$0$29=Object.freeze({default:_getMatchData$1}),_matchesStrictComparable=createCommonjsModule(function(module){function matchesStrictComparable(key,srcValue){return function(object){return null!=object&&(object[key]===srcValue&&(void 0!==srcValue||key in Object(object)))}}module.exports=matchesStrictComparable}),_matchesStrictComparable$1=interopDefault(_matchesStrictComparable),require$$1$17=Object.freeze({default:_matchesStrictComparable$1}),_baseMatches=createCommonjsModule(function(module){function baseMatches(source){var matchData=getMatchData(source);return 1==matchData.length&&matchData[0][2]?matchesStrictComparable(matchData[0][0],matchData[0][1]):function(object){return object===source||baseIsMatch(object,source,matchData)}}var baseIsMatch=interopDefault(require$$1$5),getMatchData=interopDefault(require$$0$29),matchesStrictComparable=interopDefault(require$$1$17);module.exports=baseMatches}),_baseMatches$1=interopDefault(_baseMatches),require$$4$2=Object.freeze({default:_baseMatches$1}),memoize=createCommonjsModule(function(module){function memoize(func,resolver){if("function"!=typeof func||resolver&&"function"!=typeof resolver)throw new TypeError(FUNC_ERROR_TEXT);var memoized=function(){var args=arguments,key=resolver?resolver.apply(this,args):args[0],cache=memoized.cache;if(cache.has(key))return cache.get(key);var result=func.apply(this,args);return memoized.cache=cache.set(key,result),result};return memoized.cache=new(memoize.Cache||MapCache),memoized}var MapCache=interopDefault(require$$0$11),FUNC_ERROR_TEXT="Expected a function";memoize.Cache=MapCache,module.exports=memoize}),memoize$1=interopDefault(memoize),require$$1$19=Object.freeze({default:memoize$1}),isSymbol=createCommonjsModule(function(module){function isSymbol(value){return"symbol"==typeof value||isObjectLike(value)&&objectToString.call(value)==symbolTag}var isObjectLike=interopDefault(require$$0$4),symbolTag="[object Symbol]",objectProto=Object.prototype,objectToString=objectProto.toString;module.exports=isSymbol}),isSymbol$1=interopDefault(isSymbol),require$$0$32=Object.freeze({default:isSymbol$1}),_baseToString=createCommonjsModule(function(module){function baseToString(value){if("string"==typeof value)return value;if(isSymbol(value))return symbolToString?symbolToString.call(value):"";var result=value+"";return"0"==result&&1/value==-INFINITY?"-0":result}var Symbol=interopDefault(require$$0$24),isSymbol=interopDefault(require$$0$32),INFINITY=1/0,symbolProto=Symbol?Symbol.prototype:void 0,symbolToString=symbolProto?symbolProto.toString:void 0;module.exports=baseToString}),_baseToString$1=interopDefault(_baseToString),require$$2$17=Object.freeze({default:_baseToString$1}),toString$1=createCommonjsModule(function(module){function toString(value){return null==value?"":baseToString(value)}var baseToString=interopDefault(require$$2$17);module.exports=toString}),toString$2=interopDefault(toString$1),require$$0$31=Object.freeze({default:toString$2}),_stringToPath=createCommonjsModule(function(module){var memoize=interopDefault(require$$1$19),toString=interopDefault(require$$0$31),rePropName=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(\.|\[\])(?:\4|$))/g,reEscapeChar=/\\(\\)?/g,stringToPath=memoize(function(string){var result=[];return toString(string).replace(rePropName,function(match,number,quote,string){result.push(quote?string.replace(reEscapeChar,"$1"):number||match)}),result});module.exports=stringToPath}),_stringToPath$1=interopDefault(_stringToPath),require$$0$30=Object.freeze({default:_stringToPath$1}),_castPath=createCommonjsModule(function(module){function castPath(value){return isArray(value)?value:stringToPath(value)}var isArray=interopDefault(require$$0$5),stringToPath=interopDefault(require$$0$30);module.exports=castPath}),_castPath$1=interopDefault(_castPath),require$$4$9=Object.freeze({default:_castPath$1}),_isKey=createCommonjsModule(function(module){function isKey(value,object){if(isArray(value))return!1;var type=typeof value;return!("number"!=type&&"symbol"!=type&&"boolean"!=type&&null!=value&&!isSymbol(value))||(reIsPlainProp.test(value)||!reIsDeepProp.test(value)||null!=object&&value in Object(object))}var isArray=interopDefault(require$$0$5),isSymbol=interopDefault(require$$0$32),reIsDeepProp=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,reIsPlainProp=/^\w*$/;module.exports=isKey}),_isKey$1=interopDefault(_isKey),require$$3$10=Object.freeze({default:_isKey$1}),_toKey=createCommonjsModule(function(module){function toKey(value){if("string"==typeof value||isSymbol(value))return value;var result=value+"";return"0"==result&&1/value==-INFINITY?"-0":result}var isSymbol=interopDefault(require$$0$32),INFINITY=1/0;module.exports=toKey}),_toKey$1=interopDefault(_toKey),require$$0$33=Object.freeze({default:_toKey$1}),_baseGet=createCommonjsModule(function(module){function baseGet(object,path){path=isKey(path,object)?[path]:castPath(path);for(var index=0,length=path.length;null!=object&&index<length;)object=object[toKey(path[index++])];return index&&index==length?object:void 0}var castPath=interopDefault(require$$4$9),isKey=interopDefault(require$$3$10),toKey=interopDefault(require$$0$33);module.exports=baseGet}),_baseGet$1=interopDefault(_baseGet),require$$1$18=Object.freeze({default:_baseGet$1}),get$1$1=createCommonjsModule(function(module){function get(object,path,defaultValue){var result=null==object?void 0:baseGet(object,path);return void 0===result?defaultValue:result}var baseGet=interopDefault(require$$1$18);module.exports=get}),get$2$1=interopDefault(get$1$1),require$$5$4=Object.freeze({default:get$2$1}),_baseHasIn=createCommonjsModule(function(module){function baseHasIn(object,key){return null!=object&&key in Object(object)}module.exports=baseHasIn}),_baseHasIn$1=interopDefault(_baseHasIn),require$$1$20=Object.freeze({default:_baseHasIn$1}),_hasPath=createCommonjsModule(function(module){function hasPath(object,path,hasFunc){path=isKey(path,object)?[path]:castPath(path);for(var result,index=-1,length=path.length;++index<length;){var key=toKey(path[index]);if(!(result=null!=object&&hasFunc(object,key)))break;object=object[key]}if(result)return result;var length=object?object.length:0;return!!length&&isLength(length)&&isIndex(key,length)&&(isArray(object)||isString(object)||isArguments(object))}var castPath=interopDefault(require$$4$9),isArguments=interopDefault(require$$1$3),isArray=interopDefault(require$$0$5),isIndex=interopDefault(require$$3$2),isKey=interopDefault(require$$3$10),isLength=interopDefault(require$$2$4),isString=interopDefault(require$$2$5),toKey=interopDefault(require$$0$33);module.exports=hasPath}),_hasPath$1=interopDefault(_hasPath),require$$0$34=Object.freeze({default:_hasPath$1}),hasIn=createCommonjsModule(function(module){function hasIn(object,path){return null!=object&&hasPath(object,path,baseHasIn)}var baseHasIn=interopDefault(require$$1$20),hasPath=interopDefault(require$$0$34);module.exports=hasIn}),hasIn$1=interopDefault(hasIn),require$$4$10=Object.freeze({default:hasIn$1}),_baseMatchesProperty=createCommonjsModule(function(module){function baseMatchesProperty(path,srcValue){return isKey(path)&&isStrictComparable(srcValue)?matchesStrictComparable(toKey(path),srcValue):function(object){var objValue=get(object,path);return void 0===objValue&&objValue===srcValue?hasIn(object,path):baseIsEqual(srcValue,objValue,void 0,UNORDERED_COMPARE_FLAG|PARTIAL_COMPARE_FLAG)}}var baseIsEqual=interopDefault(require$$0$21),get=interopDefault(require$$5$4),hasIn=interopDefault(require$$4$10),isKey=interopDefault(require$$3$10),isStrictComparable=interopDefault(require$$2$16),matchesStrictComparable=interopDefault(require$$1$17),toKey=interopDefault(require$$0$33),UNORDERED_COMPARE_FLAG=1,PARTIAL_COMPARE_FLAG=2;module.exports=baseMatchesProperty}),_baseMatchesProperty$1=interopDefault(_baseMatchesProperty),require$$3$9=Object.freeze({default:_baseMatchesProperty$1}),identity=createCommonjsModule(function(module){function identity(value){return value}module.exports=identity}),identity$1=interopDefault(identity),require$$2$18=Object.freeze({default:identity$1}),_basePropertyDeep=createCommonjsModule(function(module){function basePropertyDeep(path){return function(object){return baseGet(object,path)}}var baseGet=interopDefault(require$$1$18);module.exports=basePropertyDeep}),_basePropertyDeep$1=interopDefault(_basePropertyDeep),require$$2$19=Object.freeze({default:_basePropertyDeep$1}),property=createCommonjsModule(function(module){function property(path){return isKey(path)?baseProperty(toKey(path)):basePropertyDeep(path)}var baseProperty=interopDefault(require$$3$1),basePropertyDeep=interopDefault(require$$2$19),isKey=interopDefault(require$$3$10),toKey=interopDefault(require$$0$33);module.exports=property}),property$1=interopDefault(property),require$$0$35=Object.freeze({default:property$1}),_baseIteratee=createCommonjsModule(function(module){function baseIteratee(value){return"function"==typeof value?value:null==value?identity:"object"==typeof value?isArray(value)?baseMatchesProperty(value[0],value[1]):baseMatches(value):property(value)}var baseMatches=interopDefault(require$$4$2),baseMatchesProperty=interopDefault(require$$3$9),identity=interopDefault(require$$2$18),isArray=interopDefault(require$$0$5),property=interopDefault(require$$0$35);module.exports=baseIteratee}),_baseIteratee$1=interopDefault(_baseIteratee),require$$2$6=Object.freeze({default:_baseIteratee$1}),forEach$1$1=createCommonjsModule(function(module){function forEach(collection,iteratee){var func=isArray(collection)?arrayEach:baseEach;return func(collection,baseIteratee(iteratee,3))}var arrayEach=interopDefault(require$$15),baseEach=interopDefault(require$$0$1),baseIteratee=interopDefault(require$$2$6),isArray=interopDefault(require$$0$5);module.exports=forEach}),forEach$2=interopDefault(forEach$1$1),require$$0=Object.freeze({default:forEach$2}),EventEmitter=function(){};EventEmitter.prototype.emit=function(event){if(event in this.__events__){for(var bindings=this.__events__[event].slice(),args=Array.prototype.slice.call(arguments,1),i=0,len=bindings.length;i<len;i++){var binding=bindings[i];binding.method.apply(binding.context,args)}return!0}return!1},EventEmitter.prototype.on=function(event,method,context,options){var priority=0;4===arguments.length&&(priority=options.priority||priority),_on.call(this,event,method,context,priority),this.__events__[event].sort(byPriorityDescending)},EventEmitter.prototype.off=function(event,method,context){1===arguments.length&&isObject$1(arguments[0])?_disconnect$1.call(this,arguments[0]):_off.apply(this,arguments)},EventEmitter.prototype._debugEvents=function(){console.log("### EventEmitter: ",this),forEach$2(this.__events__,function(handlers,name){console.log("- %s listeners for %s: ",handlers.length,name,handlers)})};var __events__={get:function(){return this.___events___||(this.___events___={}),this.___events___},configurable:!0,enumerable:!1};Object.defineProperty(EventEmitter.prototype,"__events__",__events__),EventEmitter.mixin=function(clazz){var properties=Object.getOwnPropertyNames(EventEmitter.prototype);properties.forEach(function(name){"constructor"!==name&&"__events__"!==name&&(clazz.prototype[name]=EventEmitter.prototype[name])}),Object.defineProperty(clazz.prototype,"__events__",__events__)};var __id__=0,ClientConnection=function(EventEmitter$$1){function ClientConnection(config){EventEmitter$$1.call(this),this.__id__=__id__++,this.config=config,this._onMessage=this._onMessage.bind(this),this._onConnectionOpen=this._onConnectionOpen.bind(this),this._onConnectionClose=this._onConnectionClose.bind(this),this._connect()}return EventEmitter$$1&&(ClientConnection.__proto__=EventEmitter$$1),ClientConnection.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),ClientConnection.prototype.constructor=ClientConnection,ClientConnection.prototype._createWebSocket=function(){throw SubstanceError("AbstractMethodError")},ClientConnection.prototype._connect=function(){this.ws=this._createWebSocket(),this.ws.addEventListener("open",this._onConnectionOpen),this.ws.addEventListener("close",this._onConnectionClose),this.ws.addEventListener("message",this._onMessage)},ClientConnection.prototype._disconnect=function(){this.ws.removeEventListener("message",this._onMessage),this.ws.removeEventListener("open",this._onConnectionOpen),this.ws.removeEventListener("close",this._onConnectionClose),this.ws=null},ClientConnection.prototype._onConnectionOpen=function(){this.emit("open")},ClientConnection.prototype._onConnectionClose=function(){this._disconnect(),this.emit("close"),console.info("websocket connection closed. Attempting to reconnect in 5s."),setTimeout(function(){this._connect()}.bind(this),5e3)},ClientConnection.prototype._onMessage=function(msg){msg=this.deserializeMessage(msg.data),this.emit("message",msg)},ClientConnection.prototype.send=function(msg){return this.isOpen()?void this.ws.send(this.serializeMessage(msg)):void console.warn("Message could not be sent. Connection is not open.",msg)},ClientConnection.prototype.isOpen=function(){return this.ws&&1===this.ws.readyState},ClientConnection.prototype.serializeMessage=function(msg){return JSON.stringify(msg)},ClientConnection.prototype.deserializeMessage=function(msg){return JSON.parse(msg)},ClientConnection}(EventEmitter),__id__$1=0,CollabClient=function(EventEmitter$$1){function CollabClient(config){EventEmitter$$1.call(this),this.__id__=__id__$1++,this.config=config,this.connection=config.connection,this.scope="substance/collab",this._onMessage=this._onMessage.bind(this),this._onConnectionOpen=this._onConnectionOpen.bind(this),this._onConnectionClose=this._onConnectionClose.bind(this),this.connection.on("open",this._onConnectionOpen),this.connection.on("close",this._onConnectionClose),this.connection.on("message",this._onMessage)}return EventEmitter$$1&&(CollabClient.__proto__=EventEmitter$$1),CollabClient.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),CollabClient.prototype.constructor=CollabClient,CollabClient.prototype._onConnectionClose=function(){this.emit("disconnected")},CollabClient.prototype._onConnectionOpen=function(){this.emit("connected")},CollabClient.prototype._onMessage=function(msg){msg.scope===this.scope?this.emit("message",msg):"_internal"!==msg.scope&&console.info("Message ignored. Not sent in hub scope",msg)},CollabClient.prototype.send=function(msg){return this.connection.isOpen()?(msg.scope=this.scope,this.config.enhanceMessage&&(msg=this.config.enhanceMessage(msg)),void this.connection.send(msg)):void console.warn("Message could not be sent. Connection not open.",msg)},CollabClient.prototype.isConnected=function(){return this.connection.isOpen()},CollabClient.prototype.dispose=function(){this.connection.off(this)},CollabClient}(EventEmitter),_arrayMap=createCommonjsModule(function(module){function arrayMap(array,iteratee){for(var index=-1,length=array?array.length:0,result=Array(length);++index<length;)result[index]=iteratee(array[index],index,array);return result}module.exports=arrayMap}),_arrayMap$1=interopDefault(_arrayMap),require$$0$36=Object.freeze({default:_arrayMap$1}),_baseMap=createCommonjsModule(function(module){function baseMap(collection,iteratee){var index=-1,result=isArrayLike(collection)?Array(collection.length):[];return baseEach(collection,function(value,key,collection){result[++index]=iteratee(value,key,collection)}),result}var baseEach=interopDefault(require$$0$1),isArrayLike=interopDefault(require$$3);module.exports=baseMap}),_baseMap$1=interopDefault(_baseMap),require$$1$21=Object.freeze({default:_baseMap$1}),map$1=createCommonjsModule(function(module){function map(collection,iteratee){var func=isArray(collection)?arrayMap:baseMap;return func(collection,baseIteratee(iteratee,3))}var arrayMap=interopDefault(require$$0$36),baseIteratee=interopDefault(require$$2$6),baseMap=interopDefault(require$$1$21),isArray=interopDefault(require$$0$5);module.exports=map}),map$2=interopDefault(map$1),_assignValue=createCommonjsModule(function(module){function assignValue(object,key,value){var objValue=object[key];hasOwnProperty.call(object,key)&&eq(objValue,value)&&(void 0!==value||key in object)||(object[key]=value)}var eq=interopDefault(require$$3$4),objectProto=Object.prototype,hasOwnProperty=objectProto.hasOwnProperty;module.exports=assignValue}),_assignValue$1=interopDefault(_assignValue),require$$5$5=Object.freeze({default:_assignValue$1}),_copyObject=createCommonjsModule(function(module){function copyObject(source,props,object,customizer){object||(object={});for(var index=-1,length=props.length;++index<length;){var key=props[index],newValue=customizer?customizer(object[key],source[key],key,object,source):source[key];assignValue(object,key,newValue)}return object}var assignValue=interopDefault(require$$5$5);module.exports=copyObject}),_copyObject$1=interopDefault(_copyObject),require$$1$22=Object.freeze({default:_copyObject$1}),_isIterateeCall=createCommonjsModule(function(module){function isIterateeCall(value,index,object){if(!isObject(object))return!1;var type=typeof index;return!!("number"==type?isArrayLike(object)&&isIndex(index,object.length):"string"==type&&index in object)&&eq(object[index],value)}var eq=interopDefault(require$$3$4),isArrayLike=interopDefault(require$$3),isIndex=interopDefault(require$$3$2),isObject=interopDefault(require$$2$3);module.exports=isIterateeCall}),_isIterateeCall$1=interopDefault(_isIterateeCall),require$$1$23=Object.freeze({default:_isIterateeCall$1}),_apply$1=createCommonjsModule(function(module){function apply(func,thisArg,args){var length=args.length;switch(length){case 0:return func.call(thisArg);case 1:return func.call(thisArg,args[0]);case 2:return func.call(thisArg,args[0],args[1]);case 3:return func.call(thisArg,args[0],args[1],args[2])}return func.apply(thisArg,args)}module.exports=apply}),_apply$2=interopDefault(_apply$1),require$$1$24=Object.freeze({default:_apply$2}),toNumber=createCommonjsModule(function(module){function toNumber(value){if("number"==typeof value)return value;if(isSymbol(value))return NAN;if(isObject(value)){var other=isFunction(value.valueOf)?value.valueOf():value;value=isObject(other)?other+"":other}if("string"!=typeof value)return 0===value?value:+value;value=value.replace(reTrim,"");var isBinary=reIsBinary.test(value);return isBinary||reIsOctal.test(value)?freeParseInt(value.slice(2),isBinary?2:8):reIsBadHex.test(value)?NAN:+value}var isFunction=interopDefault(require$$2$2),isObject=interopDefault(require$$2$3),isSymbol=interopDefault(require$$0$32),NAN=NaN,reTrim=/^\s+|\s+$/g,reIsBadHex=/^[-+]0x[0-9a-f]+$/i,reIsBinary=/^0b[01]+$/i,reIsOctal=/^0o[0-7]+$/i,freeParseInt=parseInt;module.exports=toNumber}),toNumber$1=interopDefault(toNumber),require$$0$40=Object.freeze({default:toNumber$1}),toFinite=createCommonjsModule(function(module){function toFinite(value){if(!value)return 0===value?value:0;if(value=toNumber(value),value===INFINITY||value===-INFINITY){var sign=value<0?-1:1;return sign*MAX_INTEGER}return value===value?value:0}var toNumber=interopDefault(require$$0$40),INFINITY=1/0,MAX_INTEGER=1.7976931348623157e308;module.exports=toFinite}),toFinite$1=interopDefault(toFinite),require$$0$39=Object.freeze({default:toFinite$1}),toInteger=createCommonjsModule(function(module){function toInteger(value){var result=toFinite(value),remainder=result%1;return result===result?remainder?result-remainder:result:0}var toFinite=interopDefault(require$$0$39);module.exports=toInteger}),toInteger$1=interopDefault(toInteger),require$$1$25=Object.freeze({default:toInteger$1}),rest=createCommonjsModule(function(module){function rest(func,start){if("function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);return start=nativeMax(void 0===start?func.length-1:toInteger(start),0),function(){for(var args=arguments,index=-1,length=nativeMax(args.length-start,0),array=Array(length);++index<length;)array[index]=args[start+index];switch(start){case 0:return func.call(this,array);case 1:return func.call(this,args[0],array);case 2:return func.call(this,args[0],args[1],array)}var otherArgs=Array(start+1);for(index=-1;++index<start;)otherArgs[index]=args[index];return otherArgs[start]=array,apply(func,this,otherArgs)}}var apply=interopDefault(require$$1$24),toInteger=interopDefault(require$$1$25),FUNC_ERROR_TEXT="Expected a function",nativeMax=Math.max;module.exports=rest}),rest$1=interopDefault(rest),require$$0$38=Object.freeze({default:rest$1}),_createAssigner=createCommonjsModule(function(module){function createAssigner(assigner){return rest(function(object,sources){var index=-1,length=sources.length,customizer=length>1?sources[length-1]:void 0,guard=length>2?sources[2]:void 0;for(customizer=assigner.length>3&&"function"==typeof customizer?(length--,customizer):void 0,guard&&isIterateeCall(sources[0],sources[1],guard)&&(customizer=length<3?void 0:customizer,length=1),object=Object(object);++index<length;){var source=sources[index];source&&assigner(object,source,index,customizer)}return object})}var isIterateeCall=interopDefault(require$$1$23),rest=interopDefault(require$$0$38);module.exports=createAssigner}),_createAssigner$1=interopDefault(_createAssigner),require$$3$11=Object.freeze({default:_createAssigner$1}),_Reflect=createCommonjsModule(function(module){var root=interopDefault(require$$1$12),Reflect=root.Reflect;module.exports=Reflect}),_Reflect$1=interopDefault(_Reflect),require$$1$26=Object.freeze({default:_Reflect$1}),_iteratorToArray=createCommonjsModule(function(module){function iteratorToArray(iterator){for(var data,result=[];!(data=iterator.next()).done;)result.push(data.value);return result}module.exports=iteratorToArray}),_iteratorToArray$1=interopDefault(_iteratorToArray),require$$0$42=Object.freeze({default:_iteratorToArray$1}),_baseKeysIn=createCommonjsModule(function(module){function baseKeysIn(object){object=null==object?object:Object(object);var result=[];for(var key in object)result.push(key);return result}var Reflect=interopDefault(require$$1$26),iteratorToArray=interopDefault(require$$0$42),objectProto=Object.prototype,enumerate=Reflect?Reflect.enumerate:void 0,propertyIsEnumerable=objectProto.propertyIsEnumerable;enumerate&&!propertyIsEnumerable.call({valueOf:1},"valueOf")&&(baseKeysIn=function(object){return iteratorToArray(enumerate(object))}),module.exports=baseKeysIn}),_baseKeysIn$1=interopDefault(_baseKeysIn),require$$3$12=Object.freeze({default:_baseKeysIn$1}),keysIn=createCommonjsModule(function(module){function keysIn(object){for(var index=-1,isProto=isPrototype(object),props=baseKeysIn(object),propsLength=props.length,indexes=indexKeys(object),skipIndexes=!!indexes,result=indexes||[],length=result.length;++index<propsLength;){var key=props[index];skipIndexes&&("length"==key||isIndex(key,length))||"constructor"==key&&(isProto||!hasOwnProperty.call(object,key))||result.push(key)}return result}var baseKeysIn=interopDefault(require$$3$12),indexKeys=interopDefault(require$$2),isIndex=interopDefault(require$$3$2),isPrototype=interopDefault(require$$0$6),objectProto=Object.prototype,hasOwnProperty=objectProto.hasOwnProperty;module.exports=keysIn}),keysIn$1=interopDefault(keysIn),require$$0$41=Object.freeze({default:keysIn$1}),assignIn=createCommonjsModule(function(module){var assignValue=interopDefault(require$$5$5),copyObject=interopDefault(require$$1$22),createAssigner=interopDefault(require$$3$11),isArrayLike=interopDefault(require$$3),isPrototype=interopDefault(require$$0$6),keysIn=interopDefault(require$$0$41),objectProto=Object.prototype,propertyIsEnumerable=objectProto.propertyIsEnumerable,nonEnumShadows=!propertyIsEnumerable.call({valueOf:1},"valueOf"),assignIn=createAssigner(function(object,source){if(nonEnumShadows||isPrototype(source)||isArrayLike(source))return void copyObject(source,keysIn(source),object);for(var key in source)assignValue(object,key,source[key])});module.exports=assignIn}),assignIn$1=interopDefault(assignIn),require$$0$37=Object.freeze({default:assignIn$1}),extend=createCommonjsModule(function(module){module.exports=interopDefault(require$$0$37)}),extend$1=interopDefault(extend),isEqual$1=createCommonjsModule(function(module){function isEqual(value,other){return baseIsEqual(value,other)}var baseIsEqual=interopDefault(require$$0$21);module.exports=isEqual}),isEqual$2=interopDefault(isEqual$1),_baseAssign=createCommonjsModule(function(module){function baseAssign(object,source){return object&&copyObject(source,keys(source),object)}var copyObject=interopDefault(require$$1$22),keys=interopDefault(require$$0$3);module.exports=baseAssign}),_baseAssign$1=interopDefault(_baseAssign),require$$13=Object.freeze({default:_baseAssign$1}),_cloneBuffer=createCommonjsModule(function(module){function cloneBuffer(buffer,isDeep){if(isDeep)return buffer.slice();var result=new buffer.constructor(buffer.length);return buffer.copy(result),result}module.exports=cloneBuffer}),_cloneBuffer$1=interopDefault(_cloneBuffer),require$$12=Object.freeze({default:_cloneBuffer$1}),_copyArray=createCommonjsModule(function(module){function copyArray(source,array){var index=-1,length=source.length;for(array||(array=Array(length));++index<length;)array[index]=source[index];return array}module.exports=copyArray}),_copyArray$1=interopDefault(_copyArray),require$$11=Object.freeze({default:_copyArray$1}),stubArray=createCommonjsModule(function(module){function stubArray(){return[]}module.exports=stubArray}),stubArray$1=interopDefault(stubArray),require$$0$45=Object.freeze({default:stubArray$1}),_getSymbols=createCommonjsModule(function(module){function getSymbols(object){return getOwnPropertySymbols(Object(object))}var stubArray=interopDefault(require$$0$45),getOwnPropertySymbols=Object.getOwnPropertySymbols;getOwnPropertySymbols||(getSymbols=stubArray),module.exports=getSymbols}),_getSymbols$1=interopDefault(_getSymbols),require$$0$44=Object.freeze({default:_getSymbols$1}),_copySymbols=createCommonjsModule(function(module){function copySymbols(source,object){return copyObject(source,getSymbols(source),object)}var copyObject=interopDefault(require$$1$22),getSymbols=interopDefault(require$$0$44);module.exports=copySymbols}),_copySymbols$1=interopDefault(_copySymbols),require$$10=Object.freeze({default:_copySymbols$1}),_arrayPush=createCommonjsModule(function(module){function arrayPush(array,values){for(var index=-1,length=values.length,offset=array.length;++index<length;)array[offset+index]=values[index];return array}module.exports=arrayPush}),_arrayPush$1=interopDefault(_arrayPush),require$$2$21=Object.freeze({default:_arrayPush$1}),_baseGetAllKeys=createCommonjsModule(function(module){function baseGetAllKeys(object,keysFunc,symbolsFunc){var result=keysFunc(object);return isArray(object)?result:arrayPush(result,symbolsFunc(object))}var arrayPush=interopDefault(require$$2$21),isArray=interopDefault(require$$0$5);module.exports=baseGetAllKeys}),_baseGetAllKeys$1=interopDefault(_baseGetAllKeys),require$$2$20=Object.freeze({default:_baseGetAllKeys$1}),_getAllKeys=createCommonjsModule(function(module){function getAllKeys(object){return baseGetAllKeys(object,keys,getSymbols)}var baseGetAllKeys=interopDefault(require$$2$20),getSymbols=interopDefault(require$$0$44),keys=interopDefault(require$$0$3);module.exports=getAllKeys}),_getAllKeys$1=interopDefault(_getAllKeys),require$$9=Object.freeze({default:_getAllKeys$1}),_initCloneArray=createCommonjsModule(function(module){function initCloneArray(array){var length=array.length,result=array.constructor(length);return length&&"string"==typeof array[0]&&hasOwnProperty.call(array,"index")&&(result.index=array.index,result.input=array.input),result}var objectProto=Object.prototype,hasOwnProperty=objectProto.hasOwnProperty;module.exports=initCloneArray}),_initCloneArray$1=interopDefault(_initCloneArray),require$$7=Object.freeze({default:_initCloneArray$1}),_cloneArrayBuffer=createCommonjsModule(function(module){function cloneArrayBuffer(arrayBuffer){var result=new arrayBuffer.constructor(arrayBuffer.byteLength);return new Uint8Array(result).set(new Uint8Array(arrayBuffer)),result}var Uint8Array=interopDefault(require$$0$25);module.exports=cloneArrayBuffer}),_cloneArrayBuffer$1=interopDefault(_cloneArrayBuffer),require$$0$46=Object.freeze({default:_cloneArrayBuffer$1}),_cloneDataView=createCommonjsModule(function(module){function cloneDataView(dataView,isDeep){var buffer=isDeep?cloneArrayBuffer(dataView.buffer):dataView.buffer;return new dataView.constructor(buffer,dataView.byteOffset,dataView.byteLength)}var cloneArrayBuffer=interopDefault(require$$0$46);module.exports=cloneDataView}),_cloneDataView$1=interopDefault(_cloneDataView),require$$5$6=Object.freeze({default:_cloneDataView$1}),_addMapEntry=createCommonjsModule(function(module){function addMapEntry(map,pair){return map.set(pair[0],pair[1]),map}module.exports=addMapEntry}),_addMapEntry$1=interopDefault(_addMapEntry),require$$2$22=Object.freeze({default:_addMapEntry$1}),_arrayReduce=createCommonjsModule(function(module){function arrayReduce(array,iteratee,accumulator,initAccum){var index=-1,length=array?array.length:0;for(initAccum&&length&&(accumulator=array[++index]);++index<length;)accumulator=iteratee(accumulator,array[index],index,array);return accumulator}module.exports=arrayReduce}),_arrayReduce$1=interopDefault(_arrayReduce),require$$0$47=Object.freeze({default:_arrayReduce$1}),_cloneMap=createCommonjsModule(function(module){function cloneMap(map,isDeep,cloneFunc){var array=isDeep?cloneFunc(mapToArray(map),!0):mapToArray(map);return arrayReduce(array,addMapEntry,new map.constructor)}var addMapEntry=interopDefault(require$$2$22),arrayReduce=interopDefault(require$$0$47),mapToArray=interopDefault(require$$0$26);module.exports=cloneMap}),_cloneMap$1=interopDefault(_cloneMap),require$$4$11=Object.freeze({default:_cloneMap$1}),_cloneRegExp=createCommonjsModule(function(module){function cloneRegExp(regexp){var result=new regexp.constructor(regexp.source,reFlags.exec(regexp));return result.lastIndex=regexp.lastIndex,result}var reFlags=/\w*$/;module.exports=cloneRegExp}),_cloneRegExp$1=interopDefault(_cloneRegExp),require$$3$13=Object.freeze({default:_cloneRegExp$1}),_addSetEntry=createCommonjsModule(function(module){function addSetEntry(set,value){return set.add(value),set}module.exports=addSetEntry}),_addSetEntry$1=interopDefault(_addSetEntry),require$$2$24=Object.freeze({default:_addSetEntry$1}),_cloneSet=createCommonjsModule(function(module){function cloneSet(set,isDeep,cloneFunc){var array=isDeep?cloneFunc(setToArray(set),!0):setToArray(set);return arrayReduce(array,addSetEntry,new set.constructor)}var addSetEntry=interopDefault(require$$2$24),arrayReduce=interopDefault(require$$0$47),setToArray=interopDefault(require$$0$27);module.exports=cloneSet}),_cloneSet$1=interopDefault(_cloneSet),require$$2$23=Object.freeze({default:_cloneSet$1}),_cloneSymbol=createCommonjsModule(function(module){function cloneSymbol(symbol){return symbolValueOf?Object(symbolValueOf.call(symbol)):{}}var Symbol=interopDefault(require$$0$24),symbolProto=Symbol?Symbol.prototype:void 0,symbolValueOf=symbolProto?symbolProto.valueOf:void 0;module.exports=cloneSymbol}),_cloneSymbol$1=interopDefault(_cloneSymbol),require$$1$27=Object.freeze({default:_cloneSymbol$1}),_cloneTypedArray=createCommonjsModule(function(module){function cloneTypedArray(typedArray,isDeep){var buffer=isDeep?cloneArrayBuffer(typedArray.buffer):typedArray.buffer;return new typedArray.constructor(buffer,typedArray.byteOffset,typedArray.length);
}var cloneArrayBuffer=interopDefault(require$$0$46);module.exports=cloneTypedArray}),_cloneTypedArray$1=interopDefault(_cloneTypedArray),require$$0$48=Object.freeze({default:_cloneTypedArray$1}),_initCloneByTag=createCommonjsModule(function(module){function initCloneByTag(object,tag,cloneFunc,isDeep){var Ctor=object.constructor;switch(tag){case arrayBufferTag:return cloneArrayBuffer(object);case boolTag:case dateTag:return new Ctor((+object));case dataViewTag:return cloneDataView(object,isDeep);case float32Tag:case float64Tag:case int8Tag:case int16Tag:case int32Tag:case uint8Tag:case uint8ClampedTag:case uint16Tag:case uint32Tag:return cloneTypedArray(object,isDeep);case mapTag:return cloneMap(object,isDeep,cloneFunc);case numberTag:case stringTag:return new Ctor(object);case regexpTag:return cloneRegExp(object);case setTag:return cloneSet(object,isDeep,cloneFunc);case symbolTag:return cloneSymbol(object)}}var cloneArrayBuffer=interopDefault(require$$0$46),cloneDataView=interopDefault(require$$5$6),cloneMap=interopDefault(require$$4$11),cloneRegExp=interopDefault(require$$3$13),cloneSet=interopDefault(require$$2$23),cloneSymbol=interopDefault(require$$1$27),cloneTypedArray=interopDefault(require$$0$48),boolTag="[object Boolean]",dateTag="[object Date]",mapTag="[object Map]",numberTag="[object Number]",regexpTag="[object RegExp]",setTag="[object Set]",stringTag="[object String]",symbolTag="[object Symbol]",arrayBufferTag="[object ArrayBuffer]",dataViewTag="[object DataView]",float32Tag="[object Float32Array]",float64Tag="[object Float64Array]",int8Tag="[object Int8Array]",int16Tag="[object Int16Array]",int32Tag="[object Int32Array]",uint8Tag="[object Uint8Array]",uint8ClampedTag="[object Uint8ClampedArray]",uint16Tag="[object Uint16Array]",uint32Tag="[object Uint32Array]";module.exports=initCloneByTag}),_initCloneByTag$1=interopDefault(_initCloneByTag),require$$6=Object.freeze({default:_initCloneByTag$1}),_baseCreate=createCommonjsModule(function(module){function baseCreate(proto){return isObject(proto)?objectCreate(proto):{}}var isObject=interopDefault(require$$2$3),objectCreate=Object.create;module.exports=baseCreate}),_baseCreate$1=interopDefault(_baseCreate),require$$2$25=Object.freeze({default:_baseCreate$1}),_initCloneObject=createCommonjsModule(function(module){function initCloneObject(object){return"function"!=typeof object.constructor||isPrototype(object)?{}:baseCreate(getPrototype(object))}var baseCreate=interopDefault(require$$2$25),getPrototype=interopDefault(require$$1$2),isPrototype=interopDefault(require$$0$6);module.exports=initCloneObject}),_initCloneObject$1=interopDefault(_initCloneObject),require$$5$7=Object.freeze({default:_initCloneObject$1}),stubFalse=createCommonjsModule(function(module){function stubFalse(){return!1}module.exports=stubFalse}),stubFalse$1=interopDefault(stubFalse),require$$0$49=Object.freeze({default:stubFalse$1}),isBuffer=createCommonjsModule(function(module,exports){var root=interopDefault(require$$1$12),stubFalse=interopDefault(require$$0$49),freeExports="object"==typeof exports&&exports,freeModule=freeExports&&"object"==typeof module&&module,moduleExports=freeModule&&freeModule.exports===freeExports,Buffer=moduleExports?root.Buffer:void 0,isBuffer=Buffer?function(value){return value instanceof Buffer}:stubFalse;module.exports=isBuffer}),isBuffer$1=interopDefault(isBuffer),require$$3$14=Object.freeze({default:isBuffer$1}),_baseClone=createCommonjsModule(function(module){function baseClone(value,isDeep,isFull,customizer,key,object,stack){var result;if(customizer&&(result=object?customizer(value,key,object,stack):customizer(value)),void 0!==result)return result;if(!isObject(value))return value;var isArr=isArray(value);if(isArr){if(result=initCloneArray(value),!isDeep)return copyArray(value,result)}else{var tag=getTag(value),isFunc=tag==funcTag||tag==genTag;if(isBuffer(value))return cloneBuffer(value,isDeep);if(tag==objectTag||tag==argsTag||isFunc&&!object){if(isHostObject(value))return object?value:{};if(result=initCloneObject(isFunc?{}:value),!isDeep)return copySymbols(value,baseAssign(result,value))}else{if(!cloneableTags[tag])return object?value:{};result=initCloneByTag(value,tag,baseClone,isDeep)}}stack||(stack=new Stack);var stacked=stack.get(value);if(stacked)return stacked;if(stack.set(value,result),!isArr)var props=isFull?getAllKeys(value):keys(value);return arrayEach(props||value,function(subValue,key){props&&(key=subValue,subValue=value[key]),assignValue(result,key,baseClone(subValue,isDeep,isFull,customizer,key,value,stack))}),result}var Stack=interopDefault(require$$16),arrayEach=interopDefault(require$$15),assignValue=interopDefault(require$$5$5),baseAssign=interopDefault(require$$13),cloneBuffer=interopDefault(require$$12),copyArray=interopDefault(require$$11),copySymbols=interopDefault(require$$10),getAllKeys=interopDefault(require$$9),getTag=interopDefault(require$$8),initCloneArray=interopDefault(require$$7),initCloneByTag=interopDefault(require$$6),initCloneObject=interopDefault(require$$5$7),isArray=interopDefault(require$$0$5),isBuffer=interopDefault(require$$3$14),isHostObject=interopDefault(require$$1$11),isObject=interopDefault(require$$2$3),keys=interopDefault(require$$0$3),argsTag="[object Arguments]",arrayTag="[object Array]",boolTag="[object Boolean]",dateTag="[object Date]",errorTag="[object Error]",funcTag="[object Function]",genTag="[object GeneratorFunction]",mapTag="[object Map]",numberTag="[object Number]",objectTag="[object Object]",regexpTag="[object RegExp]",setTag="[object Set]",stringTag="[object String]",symbolTag="[object Symbol]",weakMapTag="[object WeakMap]",arrayBufferTag="[object ArrayBuffer]",dataViewTag="[object DataView]",float32Tag="[object Float32Array]",float64Tag="[object Float64Array]",int8Tag="[object Int8Array]",int16Tag="[object Int16Array]",int32Tag="[object Int32Array]",uint8Tag="[object Uint8Array]",uint8ClampedTag="[object Uint8ClampedArray]",uint16Tag="[object Uint16Array]",uint32Tag="[object Uint32Array]",cloneableTags={};cloneableTags[argsTag]=cloneableTags[arrayTag]=cloneableTags[arrayBufferTag]=cloneableTags[dataViewTag]=cloneableTags[boolTag]=cloneableTags[dateTag]=cloneableTags[float32Tag]=cloneableTags[float64Tag]=cloneableTags[int8Tag]=cloneableTags[int16Tag]=cloneableTags[int32Tag]=cloneableTags[mapTag]=cloneableTags[numberTag]=cloneableTags[objectTag]=cloneableTags[regexpTag]=cloneableTags[setTag]=cloneableTags[stringTag]=cloneableTags[symbolTag]=cloneableTags[uint8Tag]=cloneableTags[uint8ClampedTag]=cloneableTags[uint16Tag]=cloneableTags[uint32Tag]=!0,cloneableTags[errorTag]=cloneableTags[funcTag]=cloneableTags[weakMapTag]=!1,module.exports=baseClone}),_baseClone$1=interopDefault(_baseClone),require$$0$43=Object.freeze({default:_baseClone$1}),clone$1$1=createCommonjsModule(function(module){function clone(value){return baseClone(value,!1,!0)}var baseClone=interopDefault(require$$0$43);module.exports=clone}),clone$2=interopDefault(clone$1$1),cloneDeep=createCommonjsModule(function(module){function cloneDeep(value){return baseClone(value,!0,!0)}var baseClone=interopDefault(require$$0$43);module.exports=cloneDeep}),cloneDeep$1=interopDefault(cloneDeep),isNumber=createCommonjsModule(function(module){function isNumber(value){return"number"==typeof value||isObjectLike(value)&&objectToString.call(value)==numberTag}var isObjectLike=interopDefault(require$$0$4),numberTag="[object Number]",objectProto=Object.prototype,objectToString=objectProto.toString;module.exports=isNumber}),isNumber$1=interopDefault(isNumber),_baseSet=createCommonjsModule(function(module){function baseSet(object,path,value,customizer){path=isKey(path,object)?[path]:castPath(path);for(var index=-1,length=path.length,lastIndex=length-1,nested=object;null!=nested&&++index<length;){var key=toKey(path[index]);if(isObject(nested)){var newValue=value;if(index!=lastIndex){var objValue=nested[key];newValue=customizer?customizer(objValue,key,nested):void 0,void 0===newValue&&(newValue=null==objValue?isIndex(path[index+1])?[]:{}:objValue)}assignValue(nested,key,newValue)}nested=nested[key]}return object}var assignValue=interopDefault(require$$5$5),castPath=interopDefault(require$$4$9),isIndex=interopDefault(require$$3$2),isKey=interopDefault(require$$3$10),isObject=interopDefault(require$$2$3),toKey=interopDefault(require$$0$33);module.exports=baseSet}),_baseSet$1=interopDefault(_baseSet),require$$0$50=Object.freeze({default:_baseSet$1}),setWith=createCommonjsModule(function(module){function setWith(object,path,value,customizer){return customizer="function"==typeof customizer?customizer:void 0,null==object?object:baseSet(object,path,value,customizer)}var baseSet=interopDefault(require$$0$50);module.exports=setWith}),setWith$1=interopDefault(setWith),last=createCommonjsModule(function(module){function last(array){var length=array?array.length:0;return length?array[length-1]:void 0}module.exports=last}),last$1=interopDefault(last),require$$2$26=Object.freeze({default:last$1}),_baseSlice=createCommonjsModule(function(module){function baseSlice(array,start,end){var index=-1,length=array.length;start<0&&(start=-start>length?0:length+start),end=end>length?length:end,end<0&&(end+=length),length=start>end?0:end-start>>>0,start>>>=0;for(var result=Array(length);++index<length;)result[index]=array[index+start];return result}module.exports=baseSlice}),_baseSlice$1=interopDefault(_baseSlice),require$$0$52=Object.freeze({default:_baseSlice$1}),_parent=createCommonjsModule(function(module){function parent(object,path){return 1==path.length?object:baseGet(object,baseSlice(path,0,-1))}var baseGet=interopDefault(require$$1$18),baseSlice=interopDefault(require$$0$52);module.exports=parent}),_parent$1=interopDefault(_parent),require$$1$28=Object.freeze({default:_parent$1}),_baseUnset=createCommonjsModule(function(module){function baseUnset(object,path){path=isKey(path,object)?[path]:castPath(path),object=parent(object,path);var key=toKey(last(path));return!(null!=object&&baseHas(object,key))||delete object[key]}var baseHas=interopDefault(require$$5),castPath=interopDefault(require$$4$9),isKey=interopDefault(require$$3$10),last=interopDefault(require$$2$26),parent=interopDefault(require$$1$28),toKey=interopDefault(require$$0$33);module.exports=baseUnset}),_baseUnset$1=interopDefault(_baseUnset),require$$0$51=Object.freeze({default:_baseUnset$1}),unset=createCommonjsModule(function(module){function unset(object,path){return null==object||baseUnset(object,path)}var baseUnset=interopDefault(require$$0$51);module.exports=unset}),unset$1=interopDefault(unset),DataObject=function(root){root&&(this.__root__=root)};DataObject.prototype.contains=function(id){return Boolean(this.getRoot()[id])},DataObject.prototype.getRoot=function(){return this.__root__?this.__root__:this},DataObject.prototype.get=function(path){if(path){if(isString$1(path))return this.getRoot()[path];if(arguments.length>1&&(path=Array.prototype.slice(arguments,0)),!isArray$1(path))throw new Error("Illegal argument for DataObject.get()");return get$2$1(this.getRoot(),path)}},DataObject.prototype.set=function(path,value){if(!path)throw new Error("Illegal argument: DataObject.set(>path<, value) - path is mandatory.");isString$1(path)?this.getRoot()[path]=value:setWith$1(this.getRoot(),path,value)},DataObject.prototype.delete=function(path){if(isString$1(path))delete this.getRoot()[path];else if(1===path.length)delete this.getRoot()[path[0]];else{var success=unset$1(this.getRoot(),path);if(!success)throw new Error("Could not delete property at path"+path)}},DataObject.prototype.clear=function(){var root=this.getRoot();for(var key in root)root.hasOwnProperty(key)&&delete root[key]},DataObject.prototype._isDataObject=!0;var Operation=function(){},prototypeAccessors={_isOperation:{}};prototypeAccessors._isOperation.get=function(){return!0},Object.defineProperties(Operation.prototype,prototypeAccessors);var Conflict=function(Error){function Conflict(a,b){Error.call(this,"Conflict: "+JSON.stringify(a)+" vs "+JSON.stringify(b)),this.a=a,this.b=b}return Error&&(Conflict.__proto__=Error),Conflict.prototype=Object.create(Error&&Error.prototype),Conflict.prototype.constructor=Conflict,Conflict}(Error),INSERT="insert",DELETE$1="delete",TextOperation=function(Operation$$1){function TextOperation(data){if(Operation$$1.call(this),!data||void 0===data.type||void 0===data.pos||void 0===data.str)throw new Error("Illegal argument: insufficient data.");if(this.type=data.type,this.pos=data.pos,this.str=data.str,!this.isInsert()&&!this.isDelete())throw new Error("Illegal type.");if(!isString$1(this.str))throw new Error("Illegal argument: expecting string.");if(!isNumber$1(this.pos)||this.pos<0)throw new Error("Illegal argument: expecting positive number as pos.")}Operation$$1&&(TextOperation.__proto__=Operation$$1),TextOperation.prototype=Object.create(Operation$$1&&Operation$$1.prototype),TextOperation.prototype.constructor=TextOperation;var prototypeAccessors={_isTextOperation:{}};return prototypeAccessors._isTextOperation.get=function(){return!0},TextOperation.prototype.apply=function(str){if(this.isEmpty())return str;if(this.type===INSERT){if(str.length<this.pos)throw new Error("Provided string is too short.");return str.splice?str.splice(this.pos,0,this.str):str.slice(0,this.pos).concat(this.str).concat(str.slice(this.pos))}if(str.length<this.pos+this.str.length)throw new Error("Provided string is too short.");return str.splice?str.splice(this.pos,this.str.length):str.slice(0,this.pos).concat(str.slice(this.pos+this.str.length))},TextOperation.prototype.clone=function(){return new TextOperation(this)},TextOperation.prototype.isNOP=function(){return"NOP"===this.type||0===this.str.length},TextOperation.prototype.isInsert=function(){return this.type===INSERT},TextOperation.prototype.isDelete=function(){return this.type===DELETE$1},TextOperation.prototype.getLength=function(){return this.str.length},TextOperation.prototype.invert=function(){var data={type:this.isInsert()?DELETE$1:INSERT,pos:this.pos,str:this.str};return new TextOperation(data)},TextOperation.prototype.hasConflict=function(other){return hasConflict$1$1(this,other)},TextOperation.prototype.isEmpty=function(){return 0===this.str.length},TextOperation.prototype.toJSON=function(){return{type:this.type,pos:this.pos,str:this.str}},TextOperation.prototype.toString=function(){return["(",this.isInsert()?INSERT:DELETE$1,",",this.pos,",'",this.str,"')"].join("")},Object.defineProperties(TextOperation.prototype,prototypeAccessors),TextOperation}(Operation),transform$1=function(a,b,options){if(options=options||{},options["no-conflict"]&&hasConflict$1$1(a,b))throw new Conflict(a,b);return options.inplace||(a=a.clone(),b=b.clone()),a.type===INSERT&&b.type===INSERT?transform_insert_insert(a,b):a.type===DELETE$1&&b.type===DELETE$1?transform_delete_delete$1(a,b,!0):transform_insert_delete(a,b),[a,b]};TextOperation.transform=function(){return transform$1.apply(null,arguments)},TextOperation.Insert=function(pos,str){return new TextOperation({type:INSERT,pos:pos,str:str})},TextOperation.Delete=function(pos,str){return new TextOperation({type:DELETE$1,pos:pos,str:str})},TextOperation.INSERT=INSERT,TextOperation.DELETE=DELETE$1,TextOperation.fromJSON=function(data){return new TextOperation(data)};var NOP$1="NOP",DELETE$2="delete",INSERT$1="insert",ArrayOperation=function(Operation$$1){function ArrayOperation(data){if(Operation$$1.call(this),!data||!data.type)throw new Error("Illegal argument: insufficient data.");if(this.type=data.type,this.type!==NOP$1){if(this.type!==INSERT$1&&this.type!==DELETE$2)throw new Error("Illegal type.");if(this.pos=data.pos,this.val=data.val,!isNumber$1(this.pos)||this.pos<0)throw new Error("Illegal argument: expecting positive number as pos.")}}Operation$$1&&(ArrayOperation.__proto__=Operation$$1),ArrayOperation.prototype=Object.create(Operation$$1&&Operation$$1.prototype),ArrayOperation.prototype.constructor=ArrayOperation;var prototypeAccessors={_isArrayOperation:{}};return prototypeAccessors._isArrayOperation.get=function(){return!0},ArrayOperation.prototype.apply=function(array){if(this.type===NOP$1)return array;if(this.type===INSERT$1){if(array.length<this.pos)throw new Error("Provided array is too small.");return array.splice(this.pos,0,this.val),array}if(array.length<this.pos)throw new Error("Provided array is too small.");if(!isEqual$2(array[this.pos],this.val))throw Error("Unexpected value at position "+this.pos+". Expected "+this.val+", found "+array[this.pos]);return array.splice(this.pos,1),array},ArrayOperation.prototype.clone=function(){var data={type:this.type,pos:this.pos,val:cloneDeep$1(this.val)};return new ArrayOperation(data)},ArrayOperation.prototype.invert=function(){var data=this.toJSON();return this.type===NOP$1?data.type=NOP$1:this.type===INSERT$1?data.type=DELETE$2:data.type=INSERT$1,new ArrayOperation(data)},ArrayOperation.prototype.hasConflict=function(other){return ArrayOperation.hasConflict(this,other)},ArrayOperation.prototype.toJSON=function(){var result={type:this.type};return this.type===NOP$1?result:(result.pos=this.pos,result.val=cloneDeep$1(this.val),result)},ArrayOperation.prototype.isInsert=function(){return this.type===INSERT$1},ArrayOperation.prototype.isDelete=function(){return this.type===DELETE$2},ArrayOperation.prototype.getOffset=function(){return this.pos},ArrayOperation.prototype.getValue=function(){return this.val},ArrayOperation.prototype.isNOP=function(){return this.type===NOP$1},ArrayOperation.prototype.toString=function(){return["(",this.isInsert()?INSERT$1:DELETE$2,",",this.getOffset(),",'",this.getValue(),"')"].join("")},Object.defineProperties(ArrayOperation.prototype,prototypeAccessors),ArrayOperation}(Operation),hasConflict$2=function(a,b){return a.type!==NOP$1&&b.type!==NOP$1&&(a.type===INSERT$1&&b.type===INSERT$1&&a.pos===b.pos)},transform$2=function(a,b,options){if(options=options||{},options["no-conflict"]&&hasConflict$2(a,b))throw new Conflict(a,b);return options.inplace||(a=a.clone(),b=b.clone()),a.type===NOP$1||b.type===NOP$1||(a.type===INSERT$1&&b.type===INSERT$1?transform_insert_insert$1(a,b):a.type===DELETE$2&&b.type===DELETE$2?transform_delete_delete$2(a,b):transform_insert_delete$1(a,b)),[a,b]};ArrayOperation.transform=transform$2,ArrayOperation.hasConflict=hasConflict$2,ArrayOperation.Insert=function(pos,val){return new ArrayOperation({type:INSERT$1,pos:pos,val:val})},ArrayOperation.Delete=function(pos,val){return new ArrayOperation({type:DELETE$2,pos:pos,val:val})},ArrayOperation.fromJSON=function(data){return new ArrayOperation(data)},ArrayOperation.NOP=NOP$1,ArrayOperation.DELETE=DELETE$2,ArrayOperation.INSERT=INSERT$1;var NOP="NOP",CREATE="create",DELETE="delete",UPDATE="update",SET="set",ObjectOperation=function(Operation$$1){function ObjectOperation(data){if(Operation$$1.call(this),!data)throw new Error("Data of ObjectOperation is missing.");if(!data.type)throw new Error("Invalid data: type is mandatory.");if(this.type=data.type,data.type!==NOP){if(this.path=data.path,!data.path)throw new Error("Invalid data: path is mandatory.");if(this.type===CREATE||this.type===DELETE){if(!data.val)throw new Error("Invalid data: value is missing.");this.val=data.val}else if(this.type===UPDATE){if(!data.diff)throw new Error("Invalid data: diff is mandatory for update operation.");if(this.diff=data.diff,data.diff._isTextOperation)this.propertyType="string";else{if(!data.diff._isArrayOperation)throw new Error("Invalid data: diff must be a TextOperation or an ArrayOperation.");this.propertyType="array"}}else{if(this.type!==SET)throw new Error("Invalid type: "+data.type);this.val=data.val,this.original=data.original}}}Operation$$1&&(ObjectOperation.__proto__=Operation$$1),ObjectOperation.prototype=Object.create(Operation$$1&&Operation$$1.prototype),ObjectOperation.prototype.constructor=ObjectOperation;var prototypeAccessors={_isObjectOperation:{}};return prototypeAccessors._isObjectOperation.get=function(){return!0},ObjectOperation.prototype.apply=function(obj){if(this.type===NOP)return obj;var adapter;if(adapter=obj._isDataObject?obj:new DataObject(obj),this.type===CREATE)return adapter.set(this.path,cloneDeep$1(this.val)),obj;if(this.type===DELETE)adapter.delete(this.path,"strict");else if(this.type===UPDATE){var newVal,diff=this.diff,oldVal=adapter.get(this.path);newVal=diff._isArrayOperation?diff.apply(oldVal):diff.apply(oldVal),adapter.set(this.path,newVal)}else adapter.set(this.path,cloneDeep$1(this.val));return obj},ObjectOperation.prototype.clone=function(){var data={type:this.type,path:this.path};return this.val&&(data.val=cloneDeep$1(this.val)),this.diff&&(data.diff=this.diff.clone()),new ObjectOperation(data)},ObjectOperation.prototype.isNOP=function(){return this.type===NOP||(this.type===UPDATE?this.diff.isNOP():void 0)},ObjectOperation.prototype.isCreate=function(){return this.type===CREATE},ObjectOperation.prototype.isDelete=function(){return this.type===DELETE},ObjectOperation.prototype.isUpdate=function(propertyType){return propertyType?this.type===UPDATE&&this.propertyType===propertyType:this.type===UPDATE},ObjectOperation.prototype.isSet=function(){return this.type===SET},ObjectOperation.prototype.invert=function(){if(this.type===NOP)return new ObjectOperation({type:NOP});var result=new ObjectOperation(this);if(this.type===CREATE)result.type=DELETE;else if(this.type===DELETE)result.type=CREATE;else if(this.type===UPDATE){var invertedDiff;invertedDiff=this.diff._isTextOperation?TextOperation.fromJSON(this.diff.toJSON()).invert():ArrayOperation.fromJSON(this.diff.toJSON()).invert(),result.diff=invertedDiff}else result.val=this.original,result.original=this.val;return result},ObjectOperation.prototype.hasConflict=function(other){return ObjectOperation.hasConflict(this,other)},ObjectOperation.prototype.toJSON=function(){if(this.type===NOP)return{type:NOP};var data={type:this.type,path:this.path};return this.type===CREATE||this.type===DELETE?data.val=this.val:this.type===UPDATE?(this.diff._isArrayOperation?data.propertyType="array":data.propertyType="string",data.diff=this.diff.toJSON()):(data.val=this.val,data.original=this.original),data},ObjectOperation.prototype.getType=function(){return this.type},ObjectOperation.prototype.getPath=function(){return this.path},ObjectOperation.prototype.getValue=function(){return this.val},ObjectOperation.prototype.getOldValue=function(){return this.original},ObjectOperation.prototype.getValueOp=function(){return this.diff},ObjectOperation.prototype.toString=function(){switch(this.type){case CREATE:return["(+,",JSON.stringify(this.path),JSON.stringify(this.val),")"].join("");case DELETE:return["(-,",JSON.stringify(this.path),JSON.stringify(this.val),")"].join("");case UPDATE:return["(>>,",JSON.stringify(this.path),this.propertyType,this.diff.toString(),")"].join("");case SET:return["(=,",JSON.stringify(this.path),this.val,this.original,")"].join("");case NOP:return"NOP";default:throw new Error("Invalid type")}},Object.defineProperties(ObjectOperation.prototype,prototypeAccessors),ObjectOperation}(Operation),hasConflict=function(a,b){return a.type!==NOP&&b.type!==NOP&&isEqual$2(a.path,b.path)},transform_delete_delete=function(a,b){a.type=NOP,b.type=NOP},transform_create_create=function(){throw new Error("Can not transform two concurring creates of the same property")},transform_delete_create=function(){throw new Error("Illegal state: can not create and delete a value at the same time.")},transform_delete_update=function(a,b,flipped){if(a.type!==DELETE)return transform_delete_update(b,a,!0);var op;op="string"===b.propertyType?TextOperation.fromJSON(b.diff):ArrayOperation.fromJSON(b.diff),flipped?(a.val=op.apply(a.val),b.type=NOP):(a.type=NOP,b.type=CREATE,b.val=op.apply(a.val))},transform_create_update=function(){throw new Error("Can not transform a concurring create and update of the same property")},transform_update_update=function(a,b){var op_a,op_b,t;"string"===b.propertyType?(op_a=TextOperation.fromJSON(a.diff),op_b=TextOperation.fromJSON(b.diff),t=TextOperation.transform(op_a,op_b,{inplace:!0})):(op_a=ArrayOperation.fromJSON(a.diff),op_b=ArrayOperation.fromJSON(b.diff),t=ArrayOperation.transform(op_a,op_b,{inplace:!0})),a.diff=t[0],b.diff=t[1]},transform_create_set=function(){throw new Error("Illegal state: can not create and set a value at the same time.")},transform_delete_set=function(a,b,flipped){return a.type!==DELETE?transform_delete_set(b,a,!0):void(flipped?(a.val=b.val,b.type=NOP):(a.type=NOP,b.type=CREATE,b.original=void 0))},transform_update_set=function(){throw new Error("Unresolvable conflict: update + set.")},transform_set_set=function(a,b){a.type=NOP,b.original=a.val},_NOP=0,_CREATE=1,_DELETE=2,_UPDATE=4,_SET=8,CODE={};CODE[NOP]=_NOP,CODE[CREATE]=_CREATE,CODE[DELETE]=_DELETE,CODE[UPDATE]=_UPDATE,CODE[SET]=_SET;var __transform__=[];__transform__[_DELETE|_DELETE]=transform_delete_delete,__transform__[_DELETE|_CREATE]=transform_delete_create,__transform__[_DELETE|_UPDATE]=transform_delete_update,__transform__[_CREATE|_CREATE]=transform_create_create,__transform__[_CREATE|_UPDATE]=transform_create_update,__transform__[_UPDATE|_UPDATE]=transform_update_update,__transform__[_CREATE|_SET]=transform_create_set,__transform__[_DELETE|_SET]=transform_delete_set,__transform__[_UPDATE|_SET]=transform_update_set,__transform__[_SET|_SET]=transform_set_set;var transform=function(a,b,options){if(options=options||{},options["no-conflict"]&&hasConflict(a,b))throw new Conflict(a,b);if(options.inplace||(a=a.clone(),b=b.clone()),a.isNOP()||b.isNOP())return[a,b];var sameProp=isEqual$2(a.path,b.path);return sameProp&&__transform__[CODE[a.type]|CODE[b.type]](a,b),[a,b]};ObjectOperation.transform=transform,ObjectOperation.hasConflict=hasConflict,ObjectOperation.Create=function(idOrPath,val){var path;return path=isString$1(idOrPath)?[idOrPath]:idOrPath,new ObjectOperation({type:CREATE,path:path,val:val})},ObjectOperation.Delete=function(idOrPath,val){var path;return path=isString$1(idOrPath)?[idOrPath]:idOrPath,new ObjectOperation({type:DELETE,path:path,val:val})},ObjectOperation.Update=function(path,op){return new ObjectOperation({type:UPDATE,path:path,diff:op})},ObjectOperation.Set=function(path,oldVal,newVal){return new ObjectOperation({type:SET,path:path,val:cloneDeep$1(newVal),original:cloneDeep$1(oldVal)})},ObjectOperation.fromJSON=function(data){if(data=cloneDeep$1(data),"update"===data.type)switch(data.propertyType){case"string":data.diff=TextOperation.fromJSON(data.diff);break;case"array":data.diff=ArrayOperation.fromJSON(data.diff);break;default:throw new Error("Unsupported update diff:"+JSON.stringify(data.diff))}var op=new ObjectOperation(data);return op},ObjectOperation.NOP=NOP,ObjectOperation.CREATE=CREATE,ObjectOperation.DELETE=DELETE,ObjectOperation.UPDATE=UPDATE,ObjectOperation.SET=SET;var OperationSerializer=function(){this.SEPARATOR="\t"};OperationSerializer.prototype.serialize=function(op){var out=[];switch(op.type){case"create":out.push("c"),out.push(op.val.id),out.push(op.val);break;case"delete":out.push("d"),out.push(op.val.id),out.push(op.val);break;case"set":out.push("s"),out.push(op.path.join(".")),out.push(op.val),out.push(op.original);break;case"update":out.push("u"),out.push(op.path.join(".")),Array.prototype.push.apply(out,this.serializePrimitiveOp(op.diff));break;default:throw new Error("Unsupported operation type.")}return out},OperationSerializer.prototype.serializePrimitiveOp=function(op){var out=[];if(op._isTextOperation)op.isInsert()?out.push("t+"):op.isDelete()&&out.push("t-"),out.push(op.pos),out.push(op.str);else{if(!op._isArrayOperation)throw new Error("Unsupported operation type.");op.isInsert()?out.push("a+"):op.isDelete()&&out.push("a-"),out.push(op.pos),out.push(op.val)}return out},OperationSerializer.prototype.deserialize=function(str,tokenizer){tokenizer||(tokenizer=new Tokenizer(str,this.SEPARATOR));var op,path,val,oldVal,diff,type=tokenizer.getString();switch(type){case"c":path=tokenizer.getPath(),val=tokenizer.getObject(),op=ObjectOperation.Create(path,val);break;case"d":path=tokenizer.getPath(),val=tokenizer.getObject(),op=ObjectOperation.Delete(path,val);break;case"s":path=tokenizer.getPath(),val=tokenizer.getAny(),oldVal=tokenizer.getAny(),op=ObjectOperation.Set(path,oldVal,val);break;case"u":path=tokenizer.getPath(),diff=this.deserializePrimitiveOp(str,tokenizer),op=ObjectOperation.Update(path,diff);break;default:throw new Error("Illegal type for ObjectOperation: "+type)}return op},OperationSerializer.prototype.deserializePrimitiveOp=function(str,tokenizer){tokenizer||(tokenizer=new Tokenizer(str,this.SEPARATOR));var op,pos,val,type=tokenizer.getString();switch(type){case"t+":pos=tokenizer.getNumber(),val=tokenizer.getString(),op=TextOperation.Insert(pos,val);break;case"t-":pos=tokenizer.getNumber(),val=tokenizer.getString(),op=TextOperation.Delete(pos,val);break;case"a+":pos=tokenizer.getNumber(),val=tokenizer.getAny(),op=ArrayOperation.Insert(pos,val);break;case"a-":pos=tokenizer.getNumber(),val=tokenizer.getAny(),op=ArrayOperation.Delete(pos,val);break;default:throw new Error("Unsupported operation type: "+type)}return op};var Tokenizer=function(str,sep){isArray$1(arguments[0])?this.tokens=arguments[0]:this.tokens=str.split(sep),this.pos=-1};Tokenizer.prototype.error=function(msg){throw new Error("Parsing error: "+msg+"\n"+this.tokens[this.pos])},Tokenizer.prototype.getString=function(){this.pos++;var str=this.tokens[this.pos];return'"'===str[0]&&(str=str.slice(1,-1)),str},Tokenizer.prototype.getNumber=function(){this.pos++;var number,token=this.tokens[this.pos];try{return number=isNumber$1(token)?token:parseInt(this.tokens[this.pos],10)}catch(err){this.error("expected number")}},Tokenizer.prototype.getObject=function(){this.pos++;var obj,token=this.tokens[this.pos];try{return obj=isObject$1(token)?token:JSON.parse(this.tokens[this.pos])}catch(err){this.error("expected object")}},Tokenizer.prototype.getAny=function(){this.pos++;var token=this.tokens[this.pos];return token},Tokenizer.prototype.getPath=function(){var str=this.getString();return str.split(".")},OperationSerializer.Tokenizer=Tokenizer;var Coordinate=function(EventEmitter$$1){function Coordinate(path,offset,after){if(EventEmitter$$1.call(this),"SKIP"!==arguments[0]){if(this.path=path,this.offset=offset,this.after=after,!isArray$1(path))throw new Error("Invalid arguments: path should be an array.");if(!isNumber$1(offset)||offset<0)throw new Error("Invalid arguments: offset must be a positive number.");Object.isFrozen(path)||Object.freeze(path)}}EventEmitter$$1&&(Coordinate.__proto__=EventEmitter$$1),Coordinate.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),Coordinate.prototype.constructor=Coordinate;var prototypeAccessors={_isCoordinate:{}};return prototypeAccessors._isCoordinate.get=function(){return!0},Coordinate.prototype.equals=function(other){return other===this||isEqual$2(other.path,this.path)&&other.offset===this.offset},Coordinate.prototype.withCharPos=function(offset){return new Coordinate(this.path,offset)},Coordinate.prototype.getNodeId=function(){return this.path[0]},Coordinate.prototype.getPath=function(){return this.path},Coordinate.prototype.getOffset=function(){return this.offset},Coordinate.prototype.toJSON=function(){return{path:this.path,offset:this.offset,after:this.after}},Coordinate.prototype.toString=function(){return"("+this.path.join(".")+", "+this.offset+")"},Coordinate.prototype.isPropertyCoordinate=function(){return this.path.length>1},Coordinate.prototype.isNodeCoordinate=function(){return 1===this.path.length},Object.defineProperties(Coordinate.prototype,prototypeAccessors),Coordinate}(EventEmitter),Anchor=function(Coordinate$$1){function Anchor(){Coordinate$$1.apply(this,arguments)}return Coordinate$$1&&(Anchor.__proto__=Coordinate$$1),Anchor.prototype=Object.create(Coordinate$$1&&Coordinate$$1.prototype),Anchor.prototype.constructor=Anchor,Anchor.prototype.isAnchor=function(){
return!0},Anchor}(Coordinate),Selection=function(){var _internal={};Object.defineProperty(this,"_internal",{enumerable:!1,value:_internal}),_internal.doc=null},prototypeAccessors$1={_isSelection:{}};prototypeAccessors$1._isSelection.get=function(){return!0},Selection.prototype.clone=function(){var newSel=this._clone();return this._internal.doc&&newSel.attach(this._internal.doc),newSel},Selection.prototype.getDocument=function(){var doc=this._internal.doc;if(!doc)throw new Error("Selection is not attached to a document.");return doc},Selection.prototype.isAttached=function(){return Boolean(this._internal.doc)},Selection.prototype.attach=function(doc){return this._internal.doc=doc,this},Selection.prototype.isNull=function(){return!1},Selection.prototype.isPropertySelection=function(){return!1},Selection.prototype.isContainerSelection=function(){return!1},Selection.prototype.isNodeSelection=function(){return!1},Selection.prototype.isCustomSelection=function(){return!1},Selection.prototype.isCollapsed=function(){return!0},Selection.prototype.isReverse=function(){return!1},Selection.prototype.getType=function(){throw new Error("Selection.getType() is abstract.")},Selection.prototype.equals=function(other){return this===other||!!other&&(this.isNull()===other.isNull()&&this.getType()===other.getType())},Selection.prototype.toString=function(){return"null"},Selection.prototype.toJSON=function(){throw new Error("This method is abstract.")},Selection.prototype.getFragments=function(){return[]},Object.defineProperties(Selection.prototype,prototypeAccessors$1);var NullSelection=function(Selection){function NullSelection(){Selection.apply(this,arguments)}return Selection&&(NullSelection.__proto__=Selection),NullSelection.prototype=Object.create(Selection&&Selection.prototype),NullSelection.prototype.constructor=NullSelection,NullSelection.prototype.isNull=function(){return!0},NullSelection.prototype.getType=function(){return"null"},NullSelection.prototype.toJSON=function(){return null},NullSelection.prototype.clone=function(){return this},NullSelection}(Selection);Selection.nullSelection=Object.freeze(new NullSelection);var SelectionFragment=function(EventEmitter$$1){function SelectionFragment(path,startOffset,endOffset,full){EventEmitter$$1.call(this),this.type="selection-fragment",this.path=path,this.startOffset=startOffset,this.endOffset=endOffset||startOffset,this.full=Boolean(full)}return EventEmitter$$1&&(SelectionFragment.__proto__=EventEmitter$$1),SelectionFragment.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),SelectionFragment.prototype.constructor=SelectionFragment,SelectionFragment.prototype.isAnchor=function(){return!1},SelectionFragment.prototype.isInline=function(){return!1},SelectionFragment.prototype.isPropertyFragment=function(){return!0},SelectionFragment.prototype.isNodeFragment=function(){return!1},SelectionFragment.prototype.isFull=function(){return this.full},SelectionFragment.prototype.isPartial=function(){return!this.full},SelectionFragment.prototype.getNodeId=function(){return this.path[0]},SelectionFragment}(EventEmitter);Selection.Fragment=SelectionFragment;var NodeFragment=function(EventEmitter$$1){function NodeFragment(nodeId){EventEmitter$$1.call(this),this.type="node-fragment",this.nodeId=nodeId,this.path=[nodeId]}return EventEmitter$$1&&(NodeFragment.__proto__=EventEmitter$$1),NodeFragment.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),NodeFragment.prototype.constructor=NodeFragment,NodeFragment.prototype.isAnchor=function(){return!1},NodeFragment.prototype.isInline=function(){return!1},NodeFragment.prototype.isPropertyFragment=function(){return!1},NodeFragment.prototype.isNodeFragment=function(){return!0},NodeFragment.prototype.isFull=function(){return!0},NodeFragment.prototype.isPartial=function(){return!1},NodeFragment.prototype.getNodeId=function(){return this.nodeId},NodeFragment}(EventEmitter);Selection.NodeFragment=NodeFragment;var Cursor=function(Anchor$$1){function Cursor(path,offset){Anchor$$1.call(this,path,offset),this.type="cursor"}return Anchor$$1&&(Cursor.__proto__=Anchor$$1),Cursor.prototype=Object.create(Anchor$$1&&Anchor$$1.prototype),Cursor.prototype.constructor=Cursor,Cursor.prototype.isPropertyFragment=function(){return!1},Cursor.prototype.isNodeFragment=function(){return!1},Cursor}(Anchor);Selection.Cursor=Cursor;var Range=function(start,end,reverse,containerId){"SKIP"!==arguments[0]&&(this.start=start,this.end=end,this.reverse=Boolean(reverse),this.containerId=containerId)},prototypeAccessors$2={_isRange:{}};prototypeAccessors$2._isRange.get=function(){return!0},Range.prototype.isCollapsed=function(){return this.start.equals(this.end)},Range.prototype.equals=function(other){return this===other||this.containerId===other.containerId&&this.start.equals(other.start)&&this.end.equals(other.end)},Range.prototype.isReverse=function(){return this.reverse},Range.prototype.toString=function(){var str=[this.start.toString(),"->",this.end.toString()];return this.isReverse()&&str.push("(reverse)"),str.join("")},Object.defineProperties(Range.prototype,prototypeAccessors$2);var PropertySelection=function(Selection$$1){function PropertySelection(path,startOffset,endOffset,reverse,containerId,surfaceId){if(Selection$$1.call(this),this.path=path,this.startOffset=startOffset,this.endOffset=endOffset,this.reverse=Boolean(reverse),this.containerId=containerId,this.surfaceId=surfaceId,!path||!isNumber$1(startOffset))throw new Error("Invalid arguments: `path` and `startOffset` are mandatory");this._internal.start=new CoordinateAdapter(this,"path","startOffset"),this._internal.end=new CoordinateAdapter(this,"path","endOffset"),this._internal.range=new RangeAdapter(this)}return Selection$$1&&(PropertySelection.__proto__=Selection$$1),PropertySelection.prototype=Object.create(Selection$$1&&Selection$$1.prototype),PropertySelection.prototype.constructor=PropertySelection,PropertySelection.prototype.toJSON=function(){return{type:"property",path:this.path,startOffset:this.startOffset,endOffset:this.endOffset,reverse:this.reverse,containerId:this.containerId,surfaceId:this.surfaceId}},PropertySelection.prototype.isPropertySelection=function(){return!0},PropertySelection.prototype.getType=function(){return"property"},PropertySelection.prototype.isNull=function(){return!1},PropertySelection.prototype.isCollapsed=function(){return this.startOffset===this.endOffset},PropertySelection.prototype.isReverse=function(){return this.reverse},PropertySelection.prototype.equals=function(other){return Selection$$1.prototype.equals.call(this,other)&&this.start.equals(other.start)&&this.end.equals(other.end)},PropertySelection.prototype.toString=function(){return["PropertySelection(",JSON.stringify(this.path),", ",this.startOffset," -> ",this.endOffset,this.reverse?", reverse":"",this.surfaceId?", "+this.surfaceId:"",")"].join("")},PropertySelection.prototype.collapse=function(direction){var offset;return offset="left"===direction?this.startOffset:this.endOffset,this.createWithNewRange(offset,offset)},PropertySelection.prototype.getRange=function(){return this.range},PropertySelection.prototype.getPath=function(){return this.path},PropertySelection.prototype.getNodeId=function(){return this.path[0]},PropertySelection.prototype.getStartOffset=function(){return this.startOffset},PropertySelection.prototype.getEndOffset=function(){return this.endOffset},PropertySelection.prototype.isInsideOf=function(other,strict){return!other.isNull()&&(other.isContainerSelection()?other.contains(this,strict):strict?isEqual$2(this.path,other.path)&&this.startOffset>other.startOffset&&this.endOffset<other.endOffset:isEqual$2(this.path,other.path)&&this.startOffset>=other.startOffset&&this.endOffset<=other.endOffset)},PropertySelection.prototype.contains=function(other,strict){return!other.isNull()&&other.isInsideOf(this,strict)},PropertySelection.prototype.overlaps=function(other,strict){return!other.isNull()&&(other.isContainerSelection()?other.overlaps(this):!!isEqual$2(this.path,other.path)&&(strict?!(this.startOffset>=other.endOffset||this.endOffset<=other.startOffset):!(this.startOffset>other.endOffset||this.endOffset<other.startOffset)))},PropertySelection.prototype.isRightAlignedWith=function(other){return!other.isNull()&&(other.isContainerSelection()?other.isRightAlignedWith(this):isEqual$2(this.path,other.path)&&this.endOffset===other.endOffset)},PropertySelection.prototype.isLeftAlignedWith=function(other){return!other.isNull()&&(other.isContainerSelection()?other.isLeftAlignedWith(this):isEqual$2(this.path,other.path)&&this.startOffset===other.startOffset)},PropertySelection.prototype.expand=function(other){if(other.isNull())return this;if(other.isContainerSelection())return other.expand(this);if(!isEqual$2(this.path,other.path))throw new Error("Can not expand PropertySelection to a different property.");var newStartOffset=Math.min(this.startOffset,other.startOffset),newEndOffset=Math.max(this.endOffset,other.endOffset);return this.createWithNewRange(newStartOffset,newEndOffset)},PropertySelection.prototype.truncateWith=function(other){if(other.isNull())return this;if(other.isInsideOf(this,"strict"))throw new Error("Can not truncate with a contained selections");if(!this.overlaps(other))return this;var otherStartOffset,otherEndOffset;if(other.isPropertySelection())otherStartOffset=other.startOffset,otherEndOffset=other.endOffset;else{if(!other.isContainerSelection())return this;otherStartOffset=isEqual$2(other.startPath,this.path)?other.startOffset:this.startOffset,otherEndOffset=isEqual$2(other.endPath,this.path)?other.endOffset:this.endOffset}var newStartOffset,newEndOffset;if(this.startOffset>otherStartOffset&&this.endOffset>otherEndOffset)newStartOffset=otherEndOffset,newEndOffset=this.endOffset;else if(this.startOffset<otherStartOffset&&this.endOffset<otherEndOffset)newStartOffset=this.startOffset,newEndOffset=otherStartOffset;else if(this.startOffset===otherStartOffset){if(this.endOffset<=otherEndOffset)return Selection$$1.nullSelection;newStartOffset=otherEndOffset,newEndOffset=this.endOffset}else{if(this.endOffset!==otherEndOffset){if(other.contains(this))return Selection$$1.nullSelection;throw new Error("Illegal state.")}if(this.startOffset>=otherStartOffset)return Selection$$1.nullSelection;newStartOffset=this.startOffset,newEndOffset=otherStartOffset}return this.createWithNewRange(newStartOffset,newEndOffset)},PropertySelection.prototype.createWithNewRange=function(startOffset,endOffset){var sel=new PropertySelection(this.path,startOffset,endOffset,(!1),this.containerId,this.surfaceId),doc=this._internal.doc;return doc&&sel.attach(doc),sel},PropertySelection.prototype.getFragments=function(){if(this._internal.fragments)return this._internal.fragments;var fragments;return fragments=this.isCollapsed()?[new Selection$$1.Cursor(this.path,this.startOffset)]:[new Selection$$1.Fragment(this.path,this.startOffset,this.endOffset)],this._internal.fragments=fragments,fragments},PropertySelection.prototype._clone=function(){return new PropertySelection(this.path,this.startOffset,this.endOffset,this.reverse,this.containerId,this.surfaceId)},PropertySelection}(Selection);Object.defineProperties(PropertySelection.prototype,{start:{get:function(){return this._internal.start},set:function(){throw new Error("PropertySelection.prototype.start is read-only.")},enumerable:!1},end:{get:function(){return this._internal.end},set:function(){throw new Error("PropertySelection.prototype.end is read-only.")},enumerable:!1},range:{get:function(){return this._internal.range},set:function(){throw new Error("PropertySelection.prototype.range is read-only.")},enumerable:!1},startPath:{get:function(){return this.path},set:function(){throw new Error("immutable.")},enumerable:!1},endPath:{get:function(){return this.path},set:function(){throw new Error("immutable.")},enumerable:!1}}),PropertySelection.fromJSON=function(json){var path=json.path,startOffset=json.startOffset,endOffset=json.hasOwnProperty("endOffset")?json.endOffset:json.startOffset,reverse=json.reverse,containerId=json.containerId,surfaceId=json.surfaceId;return new PropertySelection(path,startOffset,endOffset,reverse,containerId,surfaceId)};var CoordinateAdapter=function(Coordinate$$1){function CoordinateAdapter(propertySelection,pathProperty,offsetProperty){Coordinate$$1.call(this,"SKIP"),this._sel=propertySelection,this._pathProp=pathProperty,this._offsetProp=offsetProperty,Object.freeze(this)}return Coordinate$$1&&(CoordinateAdapter.__proto__=Coordinate$$1),CoordinateAdapter.prototype=Object.create(Coordinate$$1&&Coordinate$$1.prototype),CoordinateAdapter.prototype.constructor=CoordinateAdapter,CoordinateAdapter}(Coordinate);Object.defineProperties(CoordinateAdapter.prototype,{path:{get:function(){return this._sel[this._pathProp]},set:function(path){this._sel[this._pathProp]=path}},offset:{get:function(){return this._sel[this._offsetProp]},set:function(offset){this._sel[this._offsetProp]=offset}}}),PropertySelection.CoordinateAdapter=CoordinateAdapter;var RangeAdapter=function(Range$$1){function RangeAdapter(sel){Range$$1.call(this,"SKIP"),this._sel=sel,this.start=sel.start,this.end=sel.end,Object.freeze(this)}return Range$$1&&(RangeAdapter.__proto__=Range$$1),RangeAdapter.prototype=Object.create(Range$$1&&Range$$1.prototype),RangeAdapter.prototype.constructor=RangeAdapter,RangeAdapter}(Range);Object.defineProperties(RangeAdapter.prototype,{reverse:{get:function(){return this._sel.reverse},set:function(reverse){this._sel.reverse=reverse}},containerId:{get:function(){return this._sel.containerId},set:function(containerId){this._sel.containerId=containerId}},surfaceId:{get:function(){return this._sel.surfaceId},set:function(surfaceId){this._sel.surfaceId=surfaceId}}}),PropertySelection.RangeAdapter=RangeAdapter;var CoordinateAdapter$1=PropertySelection.CoordinateAdapter,RangeAdapter$1=PropertySelection.RangeAdapter,ContainerSelection=function(Selection$$1){function ContainerSelection(containerId,startPath,startOffset,endPath,endOffset,reverse,surfaceId){if(Selection$$1.call(this),this.containerId=containerId,this.startPath=startPath,this.startOffset=startOffset,this.endPath=endPath,this.endOffset=endOffset,this.reverse=Boolean(reverse),this.surfaceId=surfaceId,!(this.containerId&&this.startPath&&isNumber$1(this.startOffset)&&this.endPath&&isNumber$1(this.endOffset)))throw new Error("Invalid arguments: `containerId`, `startPath`, `startOffset`, `endPath`, and `endOffset` are mandatory");this._internal.start=new CoordinateAdapter$1(this,"startPath","startOffset"),this._internal.end=new CoordinateAdapter$1(this,"endPath","endOffset"),this._internal.range=new RangeAdapter$1(this)}Selection$$1&&(ContainerSelection.__proto__=Selection$$1),ContainerSelection.prototype=Object.create(Selection$$1&&Selection$$1.prototype),ContainerSelection.prototype.constructor=ContainerSelection;var prototypeAccessors={_isContainerSelection:{}};return prototypeAccessors._isContainerSelection.get=function(){return!0},ContainerSelection.prototype.toJSON=function(){return{type:"container",containerId:this.containerId,startPath:this.startPath,startOffset:this.startOffset,endPath:this.endPath,endOffset:this.endOffset,reverse:this.reverse,surfaceId:this.surfaceId}},ContainerSelection.prototype.isContainerSelection=function(){return!0},ContainerSelection.prototype.getType=function(){return"container"},ContainerSelection.prototype.isNull=function(){return!1},ContainerSelection.prototype.isCollapsed=function(){return this.start.equals(this.end)},ContainerSelection.prototype.isReverse=function(){return this.reverse},ContainerSelection.prototype.equals=function(other){return Selection$$1.prototype.equals.call(this,other)&&this.containerId===other.containerId&&this.start.equals(other.start)&&this.end.equals(other.end)},ContainerSelection.prototype.toString=function(){return["ContainerSelection(",this.containerId,", ",JSON.stringify(this.startPath),", ",this.startOffset," -> ",JSON.stringify(this.startPath),", ",this.endOffset,this.reverse?", reverse":"",this.surfaceId?", "+this.surfaceId:"",")"].join("")},ContainerSelection.prototype.getContainer=function(){return this._internal.container||(this._internal.container=this.getDocument().get(this.containerId)),this._internal.container},ContainerSelection.prototype.isInsideOf=function(other,strict){if(other.isNull())return!1;strict=Boolean(strict);var r1=this._range(this),r2=this._range(other);return r2.start.isBefore(r1.start,strict)&&r1.end.isBefore(r2.end,strict)},ContainerSelection.prototype.contains=function(other,strict){if(other.isNull())return!1;strict=Boolean(strict);var r1=this._range(this),r2=this._range(other);return r1.start.isBefore(r2.start,strict)&&r2.end.isBefore(r1.end,strict)},ContainerSelection.prototype.containsNodeFragment=function(nodeId,strict){var container=this.getContainer(),coor=new Coordinate([nodeId],0),address=container.getAddress(coor),r=this._range(this),contained=r.start.isBefore(address,strict);return contained&&(address.offset=1,contained=r.end.isAfter(address,strict)),contained},ContainerSelection.prototype.overlaps=function(other){var r1=this._range(this),r2=this._range(other);return!(r1.end.isBefore(r2.start,!1)||r2.end.isBefore(r1.start,!1))},ContainerSelection.prototype.isLeftAlignedWith=function(other){var r1=this._range(this),r2=this._range(other);return r1.start.isEqual(r2.start)},ContainerSelection.prototype.isRightAlignedWith=function(other){var r1=this._range(this),r2=this._range(other);return r1.end.isEqual(r2.end)},ContainerSelection.prototype.containsNode=function(nodeId){var container=this.getContainer(),startPos=container.getPosition(this.startPath[0]),endPos=container.getPosition(this.endPath[0]),pos=container.getPosition(nodeId);return!(startPos>pos||endPos<pos||startPos===pos&&1===this.startPath.length&&this.startOffset>0||endPos===pos&&1===this.endPath.length&&this.endOffset<1)},ContainerSelection.prototype.collapse=function(direction){var coor;return coor="left"===direction?this.start:this.end,_createNewSelection(this,coor,coor)},ContainerSelection.prototype.expand=function(other){var start,end,r1=this._range(this),r2=this._range(other);return start=r1.start.isEqual(r2.start)?new Coordinate(this.start.path,Math.min(this.start.offset,other.start.offset)):r1.start.isAfter(r2.start)?new Coordinate(other.start.path,other.start.offset):this.start,end=r1.end.isEqual(r2.end)?new Coordinate(this.end.path,Math.max(this.end.offset,other.end.offset)):r1.end.isBefore(r2.end,!1)?new Coordinate(other.end.path,other.end.offset):this.end,_createNewSelection(this,start,end)},ContainerSelection.prototype.truncateWith=function(other){if(other.isInsideOf(this,"strict"))throw new Error("Can not truncate with a contained selections");if(!this.overlaps(other))return this;var start,end,r1=this._range(this),r2=this._range(other);if(r2.start.isBefore(r1.start,"strict")&&r2.end.isBefore(r1.end,"strict"))start=other.end,end=this.end;else if(r1.start.isBefore(r2.start,"strict")&&r1.end.isBefore(r2.end,"strict"))start=this.start,end=other.start;else if(r1.start.isEqual(r2.start)){if(!r2.end.isBefore(r1.end,"strict"))return Selection$$1.nullSelection;start=other.end,end=this.end}else{if(!r1.end.isEqual(r2.end)){if(this.isInsideOf(other))return Selection$$1.nullSelection;throw new Error("Could not determine coordinates for truncate. Check input")}if(!r1.start.isBefore(r2.start,"strict"))return Selection$$1.nullSelection;start=this.start,end=other.start}return _createNewSelection(this,start,end)},ContainerSelection.prototype.getFragments=function(){if(this._internal.fragments)return this._internal.fragments;var coor,node,nodeId,fragment,path,offset,text,fragments=[],doc=this.getDocument(),container=this.getContainer(),startPos=container.getPosition(this.startPath[0]),endPos=container.getPosition(this.endPath[0]);if(startPos!==endPos){if(coor=this.start,path=coor.path,offset=coor.offset,nodeId=path[0],node=doc.get(nodeId),!node)throw new Error("Node does not exist:"+nodeId);coor.isPropertyCoordinate()?(text=doc.get(path),fragment=new Selection$$1.Fragment(path,offset,text.length,0===offset),fragments.push(fragment)):coor.isNodeCoordinate()&&0===offset&&fragments.push(new Selection$$1.NodeFragment(node.id));for(var pos=startPos+1;pos<endPos;pos++)node=container.getChildAt(pos),node.isText()?(path=[node.id,"content"],text=doc.get(path),fragments.push(new Selection$$1.Fragment(path,0,text.length,(!0)))):fragments.push(new Selection$$1.NodeFragment(container.nodes[pos]));if(coor=this.end,path=coor.path,offset=coor.offset,nodeId=path[0],node=doc.get(nodeId),!node)throw new Error("Node does not exist:"+nodeId);coor.isPropertyCoordinate()?(text=doc.get(path),fragment=new Selection$$1.Fragment(path,0,offset,offset===text.length),fragments.push(fragment)):coor.isNodeCoordinate()&&offset>0&&fragments.push(new Selection$$1.NodeFragment(node.id))}else{path=this.start.path,nodeId=path[0],node=doc.get(nodeId);var startIsNodeCoordinate=this.start.isNodeCoordinate(),endIsNodeCoordinate=this.end.isNodeCoordinate();node.isText()?startIsNodeCoordinate&&endIsNodeCoordinate&&this.startOffset<this.endOffset?fragments.push(new Selection$$1.NodeFragment(nodeId)):!startIsNodeCoordinate&&endIsNodeCoordinate&&this.endOffset>0?(text=doc.get(this.startPath),fragments.push(new Selection$$1.Fragment(path,this.startOffset,text.length,0===this.startOffset))):startIsNodeCoordinate&&!endIsNodeCoordinate&&0===this.startOffset?(text=doc.get(this.endPath),fragments.push(new Selection$$1.Fragment(path,0,this.endOffset,this.endOffset===text.length))):startIsNodeCoordinate||endIsNodeCoordinate||(text=doc.get(this.startPath),fragments.push(new Selection$$1.Fragment(path,this.startOffset,this.endOffset,0===this.startOffset&&this.endOffset===text.length))):fragments.push(new Selection$$1.NodeFragment(nodeId))}return this._internal.fragments=fragments,fragments},ContainerSelection.prototype.splitIntoPropertySelections=function(){var sels=[],fragments=this.getFragments();return fragments.forEach(function(fragment){fragment instanceof Selection$$1.Fragment&&sels.push(new PropertySelection(fragment.path,fragment.startOffset,fragment.endOffset,(!1),this.containerId,this.surfaceId))}.bind(this)),sels},ContainerSelection.prototype._clone=function(){return new ContainerSelection(this.containerId,this.startPath,this.startOffset,this.endPath,this.endOffset,this.reverse,this.surfaceId)},ContainerSelection.prototype._range=function(sel){if(sel._internal.addressRange)return sel._internal.addressRange;var endAddress,container=this.getContainer(),startAddress=container.getAddress(sel.start);endAddress=sel.isCollapsed()?startAddress:container.getAddress(sel.end);var addressRange={start:startAddress,end:endAddress};return sel._isContainerSelection&&(sel._internal.addressRange=addressRange),addressRange},Object.defineProperties(ContainerSelection.prototype,prototypeAccessors),ContainerSelection}(Selection);Object.defineProperties(ContainerSelection.prototype,{path:{get:function(){throw new Error("ContainerSelection has no path property. Use startPath and endPath instead")},set:function(){throw new Error("ContainerSelection has no path property. Use startPath and endPath instead.")}},start:{get:function(){return this._internal.start},set:function(){throw new Error("ContainerSelection.prototype.start is read-only.")}},end:{get:function(){return this._internal.end},set:function(){throw new Error("ContainerSelection.prototype.end is read-only.")}},range:{get:function(){return this._internal.range},set:function(){throw new Error("ContainerSelection.prototype.range is read-only.")}}}),ContainerSelection.fromJSON=function(properties){var containerId=properties.containerId,startPath=properties.startPath,endPath=properties.endPath||properties.startPath,startOffset=properties.startOffset,endOffset=properties.endOffset,reverse=Boolean(properties.reverse),surfaceId=properties.surfaceId,sel=new ContainerSelection(containerId,startPath,startOffset,endPath,endOffset,reverse,surfaceId);return sel};var NodeSelection=function(Selection$$1){function NodeSelection(containerId,nodeId,mode,reverse,surfaceId){if(Selection$$1.call(this),!isString$1(containerId))throw new Error("'containerId' is mandatory.");if(!isString$1(nodeId))throw new Error("'nodeId' is mandatory.");if(["full","before","after"].indexOf(mode)<0)throw new Error("'mode' is mandatory.");this.containerId=containerId,this.nodeId=nodeId,this.mode=mode,this.reverse=Boolean(reverse),this.surfaceId=surfaceId}Selection$$1&&(NodeSelection.__proto__=Selection$$1),NodeSelection.prototype=Object.create(Selection$$1&&Selection$$1.prototype),NodeSelection.prototype.constructor=NodeSelection;var prototypeAccessors={_isNodeSelection:{}};return prototypeAccessors._isNodeSelection.get=function(){return!0},NodeSelection.prototype.equals=function(other){return Selection$$1.prototype.equals.call(this,other)&&this.nodeId===other.nodeId&&this.mode===other.mode},NodeSelection.prototype.isNodeSelection=function(){return!0},NodeSelection.prototype.getType=function(){return"node"},NodeSelection.prototype.getNodeId=function(){return this.nodeId},NodeSelection.prototype.isFull=function(){return"full"===this.mode},NodeSelection.prototype.isBefore=function(){return"before"===this.mode},NodeSelection.prototype.isAfter=function(){return"after"===this.mode},NodeSelection.prototype.isCollapsed=function(){return"full"!==this.mode},NodeSelection.prototype.toJSON=function(){return{containerId:this.containerId,nodeId:this.nodeId,mode:this.mode,reverse:this.reverse,surfaceId:this.surfaceId}},NodeSelection.prototype.toString=function(){return["NodeSelection(",this.containerId,".",this.nodeId,", ",this.mode,", ",this.reverse?", reverse":"",this.surfaceId?", "+this.surfaceId:"",")"].join("")},NodeSelection.prototype.collapse=function(direction){if("left"===direction)return this.isBefore()?this:new NodeSelection(this.containerId,this.nodeId,"before",this.reverse,this.surfaceId);if("right"===direction)return this.isAfter()?this:new NodeSelection(this.containerId,this.nodeId,"after",this.reverse,this.surfaceId);throw new Error("'direction' must be either 'left' or 'right'")},NodeSelection.prototype._getCoordinate=function(){return"before"===this.mode?new Coordinate([this.nodeId],0):"after"===this.mode?new Coordinate([this.nodeId],1):void 0},NodeSelection.prototype._clone=function(){return new NodeSelection(this.containerId,this.nodeId,this.mode,this.reverse,this.surfaceId)},Object.defineProperties(NodeSelection.prototype,prototypeAccessors),NodeSelection}(Selection);NodeSelection.fromJSON=function(json){return new NodeSelection(json.containerId,json.nodeId,json.mode,json.reverse)},NodeSelection._createFromRange=function(range){var mode,containerId=range.containerId,nodeId=range.start.getNodeId(),startOffset=range.start.offset,endOffset=range.end.offset,reverse=range.reverse;return mode=startOffset===endOffset?0===startOffset?"before":"after":"full",new NodeSelection(containerId,nodeId,mode,reverse)},NodeSelection._createFromCoordinate=function(coor){var containerId=coor.containerId,nodeId=coor.getNodeId(),mode=0===coor.offset?"before":"after";return new NodeSelection(containerId,nodeId,mode,(!1))};var CustomSelection=function(Selection$$1){function CustomSelection(customType,data,surfaceId){Selection$$1.call(this),this.customType=customType,this.data=data,this.surfaceId=surfaceId}return Selection$$1&&(CustomSelection.__proto__=Selection$$1),CustomSelection.prototype=Object.create(Selection$$1&&Selection$$1.prototype),CustomSelection.prototype.constructor=CustomSelection,CustomSelection.prototype.isCustomSelection=function(){return!0},CustomSelection.prototype.getType=function(){return"custom"},CustomSelection.prototype.getCustomType=function(){return this.customType},CustomSelection.prototype.toJSON=function(){return{type:"custom",customType:this.customType,data:cloneDeep$1(this.data),surfaceId:this.surfaceId}},CustomSelection.prototype.toString=function(){return["CustomSelection(",this.customType,", ",JSON.stringify(this.data),")"].join("")},CustomSelection.prototype.equals=function(other){return Selection$$1.prototype.equals.call(this,other)&&other.isCustomSelection()&&isEqual$2(this.data,other.data)},CustomSelection.prototype._clone=function(){return new CustomSelection(this.customType,this.data,this.surfaceId)},CustomSelection}(Selection);CustomSelection.fromJSON=function(json){return new CustomSelection(json.customType,json.data||{},json.surfaceId)};var DocumentChange=function(ops,before,after){if(1===arguments.length&&isObject$1(arguments[0])){var data=arguments[0];this.sha=data.sha,this.timestamp=data.timestamp,this.before=data.before,this.ops=data.ops,this.info=data.info,this.after=data.after}else{if(3!==arguments.length)throw new Error("Illegal arguments.");this.sha=uuid$1(),this.info={},this.timestamp=Date.now(),this.ops=ops.slice(0),this.before=before,this.after=after}this.updated=null,this.created=null,this.deleted=null};DocumentChange.prototype._extractInformation=function(doc){function _checkAnnotation(op){var path,propName,node=op.val;switch(op.type){case"create":case"delete":node.hasOwnProperty("startOffset")&&(path=node.path||node.startPath,updated[path]=!0),node.hasOwnProperty("endPath")&&(path=node.endPath,updated[path]=!0);break;case"update":case"set":node=doc.get(op.path[0]),node&&(propName=op.path[1],node.isPropertyAnnotation()?"path"!==propName&&"startOffset"!==propName&&"endOffset"!==propName||deleted[node.path[0]]||(updated[node.path]=!0):node.isContainerAnnotation()&&("startPath"!==propName&&"startOffset"!==propName&&"endPath"!==propName&&"endOffset"!==propName||affectedContainerAnnos.push(node)));break;default:throw new Error("Illegal state")}}for(var ops=this.ops,created={},deleted={},updated={},affectedContainerAnnos=[],i=0;i<ops.length;i++){var op=ops[i];"create"===op.type&&(created[op.val.id]=op.val,delete deleted[op.val.id]),"delete"===op.type&&(delete created[op.val.id],deleted[op.val.id]=op.val),"set"!==op.type&&"update"!==op.type||(updated[op.path]=!0),_checkAnnotation(op)}affectedContainerAnnos.forEach(function(anno){for(var container=doc.get(anno.containerId,"strict"),startPos=container.getPosition(anno.startPath[0]),endPos=container.getPosition(anno.endPath[0]),pos=startPos;pos<=endPos;pos++){var path,node=container.getChildAt(pos);path=node.isText()?[node.id,"content"]:[node.id],deleted[node.id]||(updated[path]=!0)}}),Object.keys(deleted).length>0&&forEach$2(updated,function(_,key){var nodeId=key.split(",")[0];deleted[nodeId]&&delete updated[key]}),this.created=created,this.deleted=deleted,this.updated=updated},DocumentChange.prototype.invert=function(){var this$1=this,copy=this.toJSON();copy.ops=[];var tmp=copy.before;copy.before=copy.after,copy.after=tmp;for(var inverted=DocumentChange.fromJSON(copy),ops=[],i=this.ops.length-1;i>=0;i--)ops.push(this$1.ops[i].invert());return inverted.ops=ops,inverted},DocumentChange.prototype.isAffected=function(path){return this.updated[path]},DocumentChange.prototype.isUpdated=function(path){return this.isAffected(path)},DocumentChange.prototype.serialize=function(){var opSerializer=new OperationSerializer,data=this.toJSON();return data.ops=this.ops.map(function(op){return opSerializer.serialize(op)}),JSON.stringify(data)},DocumentChange.prototype.clone=function(){return DocumentChange.fromJSON(this.toJSON())},DocumentChange.prototype.toJSON=function(){var data={sha:this.sha,before:clone$2(this.before),ops:map$2(this.ops,function(op){return op.toJSON()}),info:this.info,after:clone$2(this.after)};data.after.selection=void 0,data.before.selection=void 0;var sel=this.before.selection;return sel&&sel._isSelection&&(data.before.selection=sel.toJSON()),sel=this.after.selection,sel&&sel._isSelection&&(data.after.selection=sel.toJSON()),data},DocumentChange.deserialize=function(str){var opSerializer=new OperationSerializer,data=JSON.parse(str);return data.ops=data.ops.map(function(opData){
return opSerializer.deserialize(opData)}),data.before.selection&&(data.before.selection=fromJSON(data.before.selection)),data.after.selection&&(data.after.selection=fromJSON(data.after.selection)),new DocumentChange(data)},DocumentChange.fromJSON=function(data){var change=cloneDeep$1(data);return change.ops=data.ops.map(function(opData){return ObjectOperation.fromJSON(opData)}),change.before.selection=fromJSON(data.before.selection),change.after.selection=fromJSON(data.after.selection),new DocumentChange(change)},DocumentChange.transformInplace=function(A,B){_transformInplaceBatch(A,B)},DocumentChange.transformSelection=function(sel,a){var newSel=sel.clone(),hasChanged=_transformSelectionInplace(newSel,a);return hasChanged?newSel:sel};var CollabEngine=function(EventEmitter$$1){function CollabEngine(documentEngine){EventEmitter$$1.call(this),this.documentEngine=documentEngine,this._collaborators={}}return EventEmitter$$1&&(CollabEngine.__proto__=EventEmitter$$1),CollabEngine.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),CollabEngine.prototype.constructor=CollabEngine,CollabEngine.prototype._register=function(collaboratorId,documentId,selection,collaboratorInfo){var collaborator=this._collaborators[collaboratorId];collaborator||(collaborator=this._collaborators[collaboratorId]={collaboratorId:collaboratorId,documents:{}}),collaborator.info=collaboratorInfo,collaborator.documents[documentId]={selection:selection}},CollabEngine.prototype._unregister=function(collaboratorId,documentId){var collaborator=this._collaborators[collaboratorId];delete collaborator.documents[documentId];var docCount=Object.keys(collaborator.documents).length;0===docCount&&delete this._collaborators[collaboratorId]},CollabEngine.prototype._updateSelection=function(collaboratorId,documentId,sel){var docEntry=this._collaborators[collaboratorId].documents[documentId];docEntry.selection=sel},CollabEngine.prototype.getDocumentIds=function(collaboratorId){var collaborator=this._collaborators[collaboratorId];return collaborator?Object.keys(collaborator.documents):[]},CollabEngine.prototype.getCollaborators=function(documentId,collaboratorId){var collaborators={};return forEach$2(this._collaborators,function(collab){var doc=collab.documents[documentId];if(doc&&collab.collaboratorId!==collaboratorId){var entry={selection:doc.selection,collaboratorId:collab.collaboratorId};entry=extend$1({},collab.info,entry),collaborators[collab.collaboratorId]=entry}}),collaborators},CollabEngine.prototype.getCollaboratorIds=function(documentId,collaboratorId){var collaborators=this.getCollaborators(documentId,collaboratorId);return map$2(collaborators,function(c){return c.collaboratorId})},CollabEngine.prototype.sync=function(args,cb){this._sync(args,function(err,result){return err?cb(err):(this._register(args.collaboratorId,args.documentId,result.change.after.selection,args.collaboratorInfo),void cb(null,result))}.bind(this))},CollabEngine.prototype._sync=function(args,cb){this.documentEngine.getVersion(args.documentId,function(err,serverVersion){serverVersion===args.version?this._syncFF(args,cb):serverVersion>args.version?this._syncRB(args,cb):cb(new SubstanceError("InvalidVersionError",{message:"Client version greater than server version"}))}.bind(this))},CollabEngine.prototype._updateCollaboratorSelections=function(documentId,change){var collaborators=this.getCollaborators(documentId);forEach$2(collaborators,function(collaborator){if(collaborator.selection){var sel=fromJSON(collaborator.selection);change=this.deserializeChange(change),sel=DocumentChange.transformSelection(sel,change),this._updateSelection(collaborator.collaboratorId,documentId,sel.toJSON())}}.bind(this))},CollabEngine.prototype._syncFF=function(args,cb){return this._updateCollaboratorSelections(args.documentId,args.change),0===args.change.ops.length?cb(null,{change:args.change,serverChange:null,version:args.version}):void this.documentEngine.addChange({documentId:args.documentId,change:args.change,documentInfo:args.documentInfo},function(err,serverVersion){return err?cb(err):void cb(null,{change:args.change,serverChange:null,version:serverVersion})})},CollabEngine.prototype._syncRB=function(args,cb){this._rebaseChange({documentId:args.documentId,change:args.change,version:args.version},function(err,rebased){return err?cb(err):(this._updateCollaboratorSelections(args.documentId,rebased.change),0===args.change.ops.length?cb(null,{change:rebased.change,serverChange:rebased.serverChange,version:rebased.version}):void this.documentEngine.addChange({documentId:args.documentId,change:rebased.change,documentInfo:args.documentInfo},function(err,serverVersion){return err?cb(err):void cb(null,{change:rebased.change,serverChange:rebased.serverChange,version:serverVersion})}))}.bind(this))},CollabEngine.prototype._rebaseChange=function(args,cb){this.documentEngine.getChanges({documentId:args.documentId,sinceVersion:args.version},function(err,result){var B=result.changes.map(this.deserializeChange),a=this.deserializeChange(args.change);DocumentChange.transformInplace(a,B);var ops=B.reduce(function(ops,change){return ops.concat(change.ops)},[]),serverChange=new DocumentChange(ops,{},{});cb(null,{change:this.serializeChange(a),serverChange:this.serializeChange(serverChange),version:result.version})}.bind(this))},CollabEngine.prototype.disconnect=function(args){this._unregister(args.collaboratorId,args.documentId)},CollabEngine.prototype.serializeChange=function(change){return change.toJSON()},CollabEngine.prototype.deserializeChange=function(serializedChange){var ch=DocumentChange.fromJSON(serializedChange);return ch},CollabEngine}(EventEmitter),Server=function(EventEmitter$$1){function Server(config){EventEmitter$$1.call(this),this.config=config,this._onConnection=this._onConnection.bind(this)}return EventEmitter$$1&&(Server.__proto__=EventEmitter$$1),Server.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),Server.prototype.constructor=Server,Server.prototype.bind=function(wss){if(this.wss)throw new Error("Server is already bound to a websocket");this.wss=wss,this._connections=new WeakMap,this._collaborators={},this.wss.on("connection",this._onConnection);var interval=this.config.heartbeat;interval&&(this._heartbeat=setInterval(this._sendHeartbeat.bind(this),interval)),this._bound=!0},Server.prototype.unbind=function(){if(!this._bound)throw new Error("Server is not yet bound to a websocket.");this.wss.off("connection",this._onConnection)},Server.prototype.onConnection=function(){},Server.prototype.onDisconnect=function(){},Server.prototype.authenticate=function(req,res){req.setAuthenticated(),this.next(req,res)},Server.prototype.authorize=function(req,res){req.setAuthorized(),this.next(req,res)},Server.prototype.enhanceRequest=function(req,res){req.setEnhanced(),this.next(req,res)},Server.prototype.execute=function(){throw new Error("This method needs to be specified")},Server.prototype.enhanceResponse=function(req,res){res.setEnhanced(),this.next(req,res)},Server.prototype._onConnection=function(ws){var collaboratorId=uuid$1(),connection={collaboratorId:collaboratorId};this._connections.set(ws,connection),this._collaborators[collaboratorId]={connection:ws},ws.on("message",this._onMessage.bind(this,ws)),ws.on("close",this._onClose.bind(this,ws))},Server.prototype._onClose=function(ws){var conn=this._connections.get(ws),collaboratorId=conn.collaboratorId;this.onDisconnect(collaboratorId),delete this._collaborators[collaboratorId],this._connections.delete(ws)},Server.prototype.__initial=function(req,res){return!req.isAuthenticated&&!req.isAuthorized&&!res.isReady},Server.prototype.__authenticated=function(req,res){return req.isAuthenticated&&!req.isAuthorized&&!res.isReady},Server.prototype.__authorized=function(req,res){return req.isAuthenticated&&req.isAuthorized&&!req.isEnhanced&&!res.isReady},Server.prototype.__requestEnhanced=function(req,res){return req.isAuthenticated&&req.isAuthorized&&req.isEnhanced&&!res.isReady},Server.prototype.__executed=function(req,res){return req.isAuthenticated&&req.isAuthorized&&res.isReady&&res.data&&!res.isEnhanced},Server.prototype.__enhanced=function(req,res){return res.isReady&&res.isEnhanced&&!res.isSent},Server.prototype.__error=function(req,res){return res.err&&!res.isSent},Server.prototype.__done=function(req,res){return res.isSent},Server.prototype.next=function(req,res){this.__initial(req,res)?this.authenticate(req,res):this.__authenticated(req,res)?this.authorize(req,res):this.__authorized(req,res)?this.enhanceRequest(req,res):this.__requestEnhanced(req,res)?this.execute(req,res):this.__executed(req,res)?this.enhanceResponse(req,res):this.__enhanced(req,res)?this.sendResponse(req,res):this.__error(req,res)?this.sendError(req,res):this.__done(req,res)},Server.prototype.sendError=function(req,res){var collaboratorId=req.message.collaboratorId,msg=res.err;this.send(collaboratorId,msg),res.setSent(),this.next(req,res)},Server.prototype._sendHeartbeat=function(){Object.keys(this._collaborators).forEach(function(collaboratorId){this.send(collaboratorId,{type:"highfive",scope:"_internal"})}.bind(this))},Server.prototype.sendResponse=function(req,res){var collaboratorId=req.message.collaboratorId;this.send(collaboratorId,res.data),res.setSent(),this.next(req,res)},Server.prototype._isWebsocketOpen=function(ws){return ws&&1===ws.readyState},Server.prototype.send=function(collaboratorId,message){!message.scope&&this.config.scope&&(message.scope=this.config.scope);var ws=this._collaborators[collaboratorId].connection;this._isWebsocketOpen(ws)?ws.send(this.serializeMessage(message)):console.error("Server#send: Websocket for collaborator",collaboratorId,"is no longer open",message)},Server.prototype.broadCast=function(collaborators,message){collaborators.forEach(function(collaboratorId){this.send(collaboratorId,message)}.bind(this))},Server.prototype._processRequest=function(req){var res=new ServerResponse;this.next(req,res)},Server.prototype._onMessage=function(ws,msg){var conn=this._connections.get(ws);if(msg=this.deserializeMessage(msg),msg.scope===this.scope){msg.collaboratorId=conn.collaboratorId;var req=new ServerRequest(msg,ws);this._processRequest(req)}},Server.prototype.serializeMessage=function(msg){return JSON.stringify(msg)},Server.prototype.deserializeMessage=function(msg){return JSON.parse(msg)},Server}(EventEmitter),ServerRequest=function(message,ws){this.message=message,this.ws=ws,this.isAuthenticated=!1,this.isAuhorized=!1};ServerRequest.prototype.setAuthenticated=function(session){this.isAuthenticated=!0,this.session=session},ServerRequest.prototype.setAuthorized=function(authorizationData){this.isAuthorized=!0,this.authorizationData=authorizationData},ServerRequest.prototype.setEnhanced=function(){this.isEnhanced=!0};var ServerResponse=function(){this.isReady=!1,this.isEnhanced=!1,this.isSent=!1,this.err=null,this.data=null};ServerResponse.prototype.error=function(err){this.err=err,this.isReady=!0},ServerResponse.prototype.send=function(data){this.data=data,this.isReady=!0},ServerResponse.prototype.setEnhanced=function(){this.isEnhanced=!0},ServerResponse.prototype.setSent=function(){this.isSent=!0};var CollabServer=function(Server$$1){function CollabServer(config){Server$$1.call(this,config),this.scope="substance/collab",this.documentEngine=config.documentEngine,this.collabEngine=new CollabEngine(this.documentEngine)}return Server$$1&&(CollabServer.__proto__=Server$$1),CollabServer.prototype=Object.create(Server$$1&&Server$$1.prototype),CollabServer.prototype.constructor=CollabServer,CollabServer.prototype._error=function(req,res,err){res.error({type:"error",error:{name:req.message.type+"Error",cause:{name:err.name}},documentId:req.message.documentId}),this.next(req,res)},CollabServer.prototype.authenticate=function(req,res){this.config.authenticate?this.config.authenticate(req,function(err,session){return err?(console.error(err),void this._error(req,res,new SubstanceError("AuthenticationError",{cause:err}))):(req.setAuthenticated(session),void this.next(req,res))}.bind(this)):Server$$1.prototype.authenticate.apply(this,arguments)},CollabServer.prototype.enhanceRequest=function(req,res){this.config.enhanceRequest?this.config.enhanceRequest(req,function(err){return err?(console.error("enhanceRequest returned an error",err),void this._error(req,res,err)):(req.setEnhanced(),void this.next(req,res))}.bind(this)):Server$$1.prototype.enhanceRequest.apply(this,arguments)},CollabServer.prototype.onDisconnect=function(collaboratorId){var documentIds=this.collabEngine.getDocumentIds(collaboratorId);documentIds.forEach(function(documentId){this._disconnectDocument(collaboratorId,documentId)}.bind(this))},CollabServer.prototype.execute=function(req,res){var msg=req.message,method=this[msg.type];method?method.call(this,req,res):console.error("Method",msg.type,"not implemented for CollabServer")},CollabServer.prototype.sync=function(req,res){var args=req.message;this.collabEngine.sync(args,function(err,result){if(err)return void this._error(req,res,err);var collaborators=this.collabEngine.getCollaborators(args.documentId,args.collaboratorId);res.send({scope:this.scope,type:"syncDone",documentId:args.documentId,version:result.version,serverChange:result.serverChange,collaborators:collaborators}),forEach$2(collaborators,function(collaborator){this.send(collaborator.collaboratorId,{scope:this.scope,type:"update",documentId:args.documentId,version:result.version,change:result.change,collaborators:this.collabEngine.getCollaborators(args.documentId,collaborator.collaboratorId)})}.bind(this)),this.next(req,res)}.bind(this))},CollabServer.prototype.disconnect=function(req,res){var args=req.message,collaboratorId=args.collaboratorId,documentId=args.documentId;this._disconnectDocument(collaboratorId,documentId),res.send({scope:this.scope,type:"disconnectDone",documentId:args.documentId}),this.next(req,res)},CollabServer.prototype._disconnectDocument=function(collaboratorId,documentId){var collaboratorIds=this.collabEngine.getCollaboratorIds(documentId,collaboratorId),collaborators={};collaborators[collaboratorId]=null,this.broadCast(collaboratorIds,{scope:this.scope,type:"update",documentId:documentId,collaborators:collaborators}),this.collabEngine.disconnect({documentId:documentId,collaboratorId:collaboratorId})},CollabServer}(Server),now=createCommonjsModule(function(module){function now(){return Date.now()}module.exports=now}),now$1=interopDefault(now),require$$1$29=Object.freeze({default:now$1}),debounce=createCommonjsModule(function(module){function debounce(func,wait,options){function invokeFunc(time){var args=lastArgs,thisArg=lastThis;return lastArgs=lastThis=void 0,lastInvokeTime=time,result=func.apply(thisArg,args)}function leadingEdge(time){return lastInvokeTime=time,timerId=setTimeout(timerExpired,wait),leading?invokeFunc(time):result}function remainingWait(time){var timeSinceLastCall=time-lastCallTime,timeSinceLastInvoke=time-lastInvokeTime,result=wait-timeSinceLastCall;return maxing?nativeMin(result,maxWait-timeSinceLastInvoke):result}function shouldInvoke(time){var timeSinceLastCall=time-lastCallTime,timeSinceLastInvoke=time-lastInvokeTime;return void 0===lastCallTime||timeSinceLastCall>=wait||timeSinceLastCall<0||maxing&&timeSinceLastInvoke>=maxWait}function timerExpired(){var time=now();return shouldInvoke(time)?trailingEdge(time):void(timerId=setTimeout(timerExpired,remainingWait(time)))}function trailingEdge(time){return timerId=void 0,trailing&&lastArgs?invokeFunc(time):(lastArgs=lastThis=void 0,result)}function cancel(){lastInvokeTime=0,lastArgs=lastCallTime=lastThis=timerId=void 0}function flush(){return void 0===timerId?result:trailingEdge(now())}function debounced(){var time=now(),isInvoking=shouldInvoke(time);if(lastArgs=arguments,lastThis=this,lastCallTime=time,isInvoking){if(void 0===timerId)return leadingEdge(lastCallTime);if(maxing)return timerId=setTimeout(timerExpired,wait),invokeFunc(lastCallTime)}return void 0===timerId&&(timerId=setTimeout(timerExpired,wait)),result}var lastArgs,lastThis,maxWait,result,timerId,lastCallTime,lastInvokeTime=0,leading=!1,maxing=!1,trailing=!0;if("function"!=typeof func)throw new TypeError(FUNC_ERROR_TEXT);return wait=toNumber(wait)||0,isObject(options)&&(leading=!!options.leading,maxing="maxWait"in options,maxWait=maxing?nativeMax(toNumber(options.maxWait)||0,wait):maxWait,trailing="trailing"in options?!!options.trailing:trailing),debounced.cancel=cancel,debounced.flush=flush,debounced}var isObject=interopDefault(require$$2$3),now=interopDefault(require$$1$29),toNumber=interopDefault(require$$0$40),FUNC_ERROR_TEXT="Expected a function",nativeMax=Math.max,nativeMin=Math.min;module.exports=debounce}),debounce$1=interopDefault(debounce),isPlainObject=createCommonjsModule(function(module){function isPlainObject(value){if(!isObjectLike(value)||objectToString.call(value)!=objectTag||isHostObject(value))return!1;var proto=getPrototype(value);if(null===proto)return!0;var Ctor=hasOwnProperty.call(proto,"constructor")&&proto.constructor;return"function"==typeof Ctor&&Ctor instanceof Ctor&&funcToString.call(Ctor)==objectCtorString}var getPrototype=interopDefault(require$$1$2),isHostObject=interopDefault(require$$1$11),isObjectLike=interopDefault(require$$0$4),objectTag="[object Object]",objectProto=Object.prototype,funcToString=Function.prototype.toString,hasOwnProperty=objectProto.hasOwnProperty,objectCtorString=funcToString.call(Object),objectToString=objectProto.toString;module.exports=isPlainObject}),isPlainObject$1=interopDefault(isPlainObject),each$1$1=createCommonjsModule(function(module){module.exports=interopDefault(require$$0)}),each$2=interopDefault(each$1$1),TreeNode=function(){},TreeIndex=function(){};TreeIndex.prototype.get=function(path){return arguments.length>1&&(path=Array.prototype.slice(arguments,0)),isString$1(path)&&(path=[path]),get$2$1(this,path)},TreeIndex.prototype.getAll=function(path){if(arguments.length>1&&(path=Array.prototype.slice(arguments,0)),isString$1(path)&&(path=[path]),!isArray$1(path))throw new Error("Illegal argument for TreeIndex.get()");var node=get$2$1(this,path);return this._collectValues(node)},TreeIndex.prototype.set=function(path,value){isString$1(path)&&(path=[path]),setWith$1(this,path,value,function(val){if(!val)return new TreeNode})},TreeIndex.prototype.delete=function(path){if(isString$1(path))delete this[path];else if(1===path.length)delete this[path[0]];else{var key=path[path.length-1];path=path.slice(0,-1);var parent=get$2$1(this,path);parent&&delete parent[key]}},TreeIndex.prototype.clear=function(){var root=this;for(var key in root)root.hasOwnProperty(key)&&delete root[key]},TreeIndex.prototype.traverse=function(fn){this._traverse(this,[],fn)},TreeIndex.prototype.forEach=function(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];(ref=this).traverse.apply(ref,args);var ref},TreeIndex.prototype._traverse=function(root,path,fn){var id,this$1=this;for(id in root)if(root.hasOwnProperty(id)){var child=root[id],childPath=path.concat([id]);child instanceof TreeNode?this$1._traverse(child,childPath,fn):fn(child,childPath)}},TreeIndex.prototype._collectValues=function(root){var vals={};return this._traverse(root,[],function(val,path){var key=path[path.length-1];vals[key]=val}),vals};var TreeIndexArrays=function(TreeIndex){function TreeIndexArrays(){TreeIndex.apply(this,arguments)}return TreeIndex&&(TreeIndexArrays.__proto__=TreeIndex),TreeIndexArrays.prototype=Object.create(TreeIndex&&TreeIndex.prototype),TreeIndexArrays.prototype.constructor=TreeIndexArrays,TreeIndexArrays.prototype.get=function(path){var val=TreeIndex.prototype.get.call(this,path);return val instanceof TreeNode&&(val=val.__values__||[]),val},TreeIndexArrays.prototype.set=function(){throw new Error("TreeIndex.set() is not supported for array type.")},TreeIndexArrays.prototype.add=function(path,value){if(isString$1(path)&&(path=[path]),!isArray$1(path))throw new Error("Illegal arguments.");var arr;setWith$1(this,path.concat(["__values__","__dummy__"]),void 0,function(val,key){return"__values__"===key?(val||(val=[]),arr=val):val||(val=new TreeNode),val}),delete arr.__dummy__,arr.push(value)},TreeIndexArrays.prototype.remove=function(path,value){var arr=get$2$1(this,path);arr instanceof TreeNode&&deleteFromArray(arr.__values__,value)},TreeIndexArrays.prototype._collectValues=function(root){var vals=[];return this._traverse(root,[],function(val){vals.push(val)}),vals=Array.prototype.concat.apply([],vals)},TreeIndexArrays}(TreeIndex);TreeIndex.Arrays=TreeIndexArrays;var NodeIndex=function(){this.index=new TreeIndex,this._property="id"},prototypeAccessors$3={property:{}};NodeIndex.prototype.get=function(path){return this.index.get(path)||{}},NodeIndex.prototype.getAll=function(path){return this.index.getAll(path)},prototypeAccessors$3.property.get=function(){return this._property},prototypeAccessors$3.property.set=function(p){this._property=p},NodeIndex.prototype.select=function(node){return!this.type||node.isInstanceOf(this.type)},NodeIndex.prototype.create=function(node){var values=node[this.property];isArray$1(values)||(values=[values]),each$2(values,function(value){this.index.set([value,node.id],node)}.bind(this))},NodeIndex.prototype.delete=function(node){var values=node[this.property];isArray$1(values)||(values=[values]),each$2(values,function(value){this.index.delete([value,node.id])}.bind(this))},NodeIndex.prototype.update=function(node,path,newValue,oldValue){if(this.select(node)&&path[1]===this.property){var values=oldValue;isArray$1(values)||(values=[values]),each$2(values,function(value){this.index.delete([value,node.id])}.bind(this)),values=newValue,isArray$1(values)||(values=[values]),each$2(values,function(value){this.index.set([value,node.id],node)}.bind(this))}},NodeIndex.prototype.set=function(node,path,newValue,oldValue){this.update(node,path,newValue,oldValue)},NodeIndex.prototype.reset=function(data){this.index.clear(),this._initialize(data)},NodeIndex.prototype.clone=function clone(){var NodeIndexClass=this.constructor,clone=new NodeIndexClass;return clone},NodeIndex.prototype._initialize=function(data){each$2(data.getNodes(),function(node){this.select(node)&&this.create(node)}.bind(this))},Object.defineProperties(NodeIndex.prototype,prototypeAccessors$3),NodeIndex.create=function(prototype){var index=Object.assign(new NodeIndex,prototype);return index.clone=function(){return NodeIndex.create(prototype)},index},NodeIndex.filterByType=function(type){return function(node){return node.isInstanceOf(type)}};var DocumentIndex=function(NodeIndex$$1){function DocumentIndex(){NodeIndex$$1.apply(this,arguments)}return NodeIndex$$1&&(DocumentIndex.__proto__=NodeIndex$$1),DocumentIndex.prototype=Object.create(NodeIndex$$1&&NodeIndex$$1.prototype),DocumentIndex.prototype.constructor=DocumentIndex,DocumentIndex}(NodeIndex),_arrayFilter=createCommonjsModule(function(module){function arrayFilter(array,predicate){for(var index=-1,length=array?array.length:0,resIndex=0,result=[];++index<length;){var value=array[index];predicate(value,index,array)&&(result[resIndex++]=value)}return result}module.exports=arrayFilter}),_arrayFilter$1=interopDefault(_arrayFilter),require$$3$15=Object.freeze({default:_arrayFilter$1}),_baseFilter=createCommonjsModule(function(module){function baseFilter(collection,predicate){var result=[];return baseEach(collection,function(value,index,collection){predicate(value,index,collection)&&result.push(value)}),result}var baseEach=interopDefault(require$$0$1);module.exports=baseFilter}),_baseFilter$1=interopDefault(_baseFilter),require$$2$27=Object.freeze({default:_baseFilter$1}),filter$1=createCommonjsModule(function(module){function filter(collection,predicate){var func=isArray(collection)?arrayFilter:baseFilter;return func(collection,baseIteratee(predicate,3))}var arrayFilter=interopDefault(require$$3$15),baseFilter=interopDefault(require$$2$27),baseIteratee=interopDefault(require$$2$6),isArray=interopDefault(require$$0$5);module.exports=filter}),filter$2=interopDefault(filter$1),AnnotationIndex=function(DocumentIndex$$1){function AnnotationIndex(){DocumentIndex$$1.call(this),this.byPath=new TreeIndex,this.byType=new TreeIndex}DocumentIndex$$1&&(AnnotationIndex.__proto__=DocumentIndex$$1),AnnotationIndex.prototype=Object.create(DocumentIndex$$1&&DocumentIndex$$1.prototype),AnnotationIndex.prototype.constructor=AnnotationIndex;var prototypeAccessors={property:{}};return prototypeAccessors.property.get=function(){return"path"},AnnotationIndex.prototype.select=function(node){return Boolean(node._isPropertyAnnotation)},AnnotationIndex.prototype.reset=function(data){this.byPath.clear(),this.byType.clear(),this._initialize(data)},AnnotationIndex.prototype.get=function(path,start,end,type){var annotations;return annotations=isString$1(path)||1===path.length?this.byPath.getAll(path)||{}:this.byPath.get(path),annotations=map$2(annotations),isNumber$1(start)&&(annotations=filter$2(annotations,AnnotationIndex.filterByRange(start,end))),type&&(annotations=filter$2(annotations,DocumentIndex$$1.filterByType(type))),annotations},AnnotationIndex.prototype.create=function(anno){this.byType.set([anno.type,anno.id],anno),this.byPath.set(anno.path.concat([anno.id]),anno)},AnnotationIndex.prototype.delete=function(anno){this.byType.delete([anno.type,anno.id]),this.byPath.delete(anno.path.concat([anno.id]))},AnnotationIndex.prototype.update=function(node,path,newValue,oldValue){this.select(node)&&path[1]===this.property&&(this.delete({id:node.id,type:node.type,path:oldValue}),this.create(node))},Object.defineProperties(AnnotationIndex.prototype,prototypeAccessors),AnnotationIndex}(DocumentIndex);AnnotationIndex.filterByRange=function(start,end){return function(anno){var aStart=anno.startOffset,aEnd=anno.endOffset,overlap=aEnd>=start;return isNumber$1(end)&&(overlap=overlap&&aStart<=end),overlap}};var ContainerAnnotationIndex=function(DocumentIndex$$1){function ContainerAnnotationIndex(){DocumentIndex$$1.call(this),this.byId=new TreeIndex}return DocumentIndex$$1&&(ContainerAnnotationIndex.__proto__=DocumentIndex$$1),ContainerAnnotationIndex.prototype=Object.create(DocumentIndex$$1&&DocumentIndex$$1.prototype),ContainerAnnotationIndex.prototype.constructor=ContainerAnnotationIndex,ContainerAnnotationIndex.prototype.select=function(node){return Boolean(node._isContainerAnnotation)},ContainerAnnotationIndex.prototype.reset=function(data){this.byId.clear(),this._initialize(data)},ContainerAnnotationIndex.prototype.get=function(containerId,type){var annotations=map$2(this.byId.get(containerId));return isString$1(type)&&(annotations=filter$2(annotations,DocumentIndex$$1.filterByType)),annotations},ContainerAnnotationIndex.prototype.create=function(anno){this.byId.set([anno.containerId,anno.id],anno)},ContainerAnnotationIndex.prototype.delete=function(anno){this.byId.delete([anno.containerId,anno.id])},ContainerAnnotationIndex.prototype.update=function(node,path,newValue,oldValue){},ContainerAnnotationIndex}(DocumentIndex),AnchorIndex=function(DocumentIndex$$1){function AnchorIndex(doc){DocumentIndex$$1.call(this),this.doc=doc,this.byPath=new TreeIndex.Arrays,this.byId={}}return DocumentIndex$$1&&(AnchorIndex.__proto__=DocumentIndex$$1),AnchorIndex.prototype=Object.create(DocumentIndex$$1&&DocumentIndex$$1.prototype),AnchorIndex.prototype.constructor=AnchorIndex,AnchorIndex.prototype.select=function(node){return node._isContainerAnnotation},AnchorIndex.prototype.reset=function(data){this.byPath.clear(),this.byId={},this._initialize(data)},AnchorIndex.prototype.get=function(path,containerName){var anchors=this.byPath.getAll(path);return containerName?filter$2(anchors,function(anchor){return anchor.containerId===containerName}):anchors.slice(0)},AnchorIndex.prototype.create=function(containerAnno){var startAnchor=containerAnno.getStartAnchor(),endAnchor=containerAnno.getEndAnchor();this.byPath.add(startAnchor.path,startAnchor),this.byPath.add(endAnchor.path,endAnchor),this.byId[containerAnno.id]=containerAnno},AnchorIndex.prototype.delete=function(containerAnno){var startAnchor=containerAnno.getStartAnchor(),endAnchor=containerAnno.getEndAnchor();this.byPath.remove(startAnchor.path,startAnchor),this.byPath.remove(endAnchor.path,endAnchor),delete this.byId[containerAnno.id]},AnchorIndex.prototype.update=function(node,path,newValue,oldValue){if(this.select(node)){var anchor=null;if("startPath"===path[1])anchor=node.getStartAnchor();else{if("endPath"!==path[1])return;anchor=node.getEndAnchor()}this.byPath.remove(oldValue,anchor),this.byPath.add(anchor.path,anchor)}},AnchorIndex}(DocumentIndex),PathEventProxy=function(doc){this.listeners=new TreeIndex.Arrays,this._list=[],this.doc=doc};PathEventProxy.prototype.on=function(path,method,context){this._add(context,path,method)},PathEventProxy.prototype.off=function(context,path,method){this._remove(context,path,method)},PathEventProxy.prototype.connect=function(listener,path,method){console.warn("DEPRECATED: use proxy.on(path, this.onPropertyChange, this) instead"),this.on(path,method,listener)},PathEventProxy.prototype.disconnect=function(listener){console.warn("DEPRECATED: use proxy.off(this) instead"),this.off(listener)},PathEventProxy.prototype.onDocumentChanged=function(change,info,doc){if(0!==this._list.length){var listeners=this.listeners;forEach$2(change.updated,function(_,pathStr){var scopedListeners=listeners.get(pathStr.split(","));isArray$1(scopedListeners)&&(scopedListeners=scopedListeners.slice(0)),forEach$2(scopedListeners,function(entry){entry.method.call(entry.listener,change,info,doc)})})}},PathEventProxy.prototype._add=function(listener,path,method){if(!method)throw new Error("Invalid argument: expected function but got "+method);var entry={listener:listener,path:path,method:method};this.listeners.add(path,entry),this._list.push(entry)},PathEventProxy.prototype._remove=function(listener,path,method){for(var this$1=this,i=0;i<this._list.length;i++){var item=this$1._list[i],match=(!path||isEqual$2(item.path,path))&&(!listener||item.listener===listener)&&(!method||item.method!==method);if(match){var entry=this$1._list[i];this$1._list.splice(i,1),this$1.listeners.remove(entry.path,entry)}}};var NodeFactory=function(nodeRegistry){this.nodeRegistry=nodeRegistry};NodeFactory.prototype.create=function(nodeType,nodeData){var NodeClass=this.nodeRegistry.get(nodeType);if(!NodeClass)throw new Error("No Node registered by that name: "+nodeType);return new NodeClass(nodeData)};var Data=function(EventEmitter$$1){function Data(schema,options){EventEmitter$$1.call(this),options=options||{},this.schema=schema,this.nodes=new DataObject,this.indexes={},this.options=options||{},this.nodeFactory=options.nodeFactory||new NodeFactory(schema.nodeRegistry),this.__QUEUE_INDEXING__=!1,this.queue=[]}return EventEmitter$$1&&(Data.__proto__=EventEmitter$$1),Data.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),Data.prototype.constructor=Data,Data.prototype.contains=function(id){return this.nodes.contains(id)},Data.prototype.get=function(path,strict){if(!path)throw new Error("Path or id required");var result=this.nodes.get(path);if(strict&&void 0===result)throw isString$1(path)?new Error("Could not find node with id '"+path+"'."):new Error("Property for path '"+path+"' us undefined.");return result},Data.prototype.getNodes=function(){return this.nodes},Data.prototype.create=function(nodeData){var node=this.nodeFactory.create(nodeData.type,nodeData);if(!node)throw new Error("Illegal argument: could not create node for data:",nodeData);if(this.contains(node.id))throw new Error("Node already exists: "+node.id);if(!node.id||!node.type)throw new Error("Node id and type are mandatory.");this.nodes[node.id]=node;var change={type:"create",node:node};return this.__QUEUE_INDEXING__?this.queue.push(change):this._updateIndexes(change),node},Data.prototype.delete=function(nodeId){var node=this.nodes[nodeId];
node.dispose(),delete this.nodes[nodeId];var change={type:"delete",node:node};return this.__QUEUE_INDEXING__?this.queue.push(change):this._updateIndexes(change),node},Data.prototype.set=function(path,newValue){var node=this.get(path[0]),oldValue=this.nodes.get(path);this.nodes.set(path,newValue);var change={type:"set",node:node,path:path,newValue:newValue,oldValue:oldValue};return this.__QUEUE_INDEXING__?this.queue.push(change):this._updateIndexes(change),oldValue},Data.prototype.update=function(path,diff){var newValue,oldValue=this.nodes.get(path);if(diff.isOperation)newValue=diff.apply(oldValue);else{var start,end,pos,val;if(isString$1(oldValue))if(diff.delete)start=diff.delete.start,end=diff.delete.end,newValue=oldValue.split("").splice(start,end-start).join("");else{if(!diff.insert)throw new Error("Diff is not supported:",JSON.stringify(diff));pos=diff.insert.offset,val=diff.insert.value,newValue=[oldValue.substring(0,pos),val,oldValue.substring(pos)].join("")}else{if(!isArray$1(oldValue))throw new Error("Diff is not supported:",JSON.stringify(diff));if(newValue=oldValue.slice(0),diff.delete)pos=diff.delete.offset,newValue.splice(pos,1);else{if(!diff.insert)throw new Error("Diff is not supported:",JSON.stringify(diff));pos=diff.insert.offset,val=diff.insert.value,newValue.splice(pos,0,val)}}}this.nodes.set(path,newValue);var node=this.get(path[0]),change={type:"update",node:node,path:path,newValue:newValue,oldValue:oldValue};return this.__QUEUE_INDEXING__?this.queue.push(change):this._updateIndexes(change),oldValue},Data.prototype.toJSON=function(){return{schema:[this.schema.id,this.schema.version],nodes:cloneDeep$1(this.nodes)}},Data.prototype.reset=function(){this.nodes.clear()},Data.prototype.addIndex=function(name,index){return this.indexes[name]&&console.error("Index with name %s already exists.",name),index.reset(this),this.indexes[name]=index,index},Data.prototype.getIndex=function(name){return this.indexes[name]},Data.prototype._updateIndexes=function(change){change&&!this.__QUEUE_INDEXING__&&each$2(this.indexes,function(index){index.select(change.node)&&(index[change.type]||console.error("Contract: every NodeIndex must implement "+change.type),index[change.type](change.node,change.path,change.newValue,change.oldValue))})},Data.prototype._stopIndexing=function(){this.__QUEUE_INDEXING__=!0},Data.prototype._startIndexing=function(){var this$1=this;for(this.__QUEUE_INDEXING__=!1;this.queue.length>0;){var change=this$1.queue.shift();this$1._updateIndexes(change)}},Data}(EventEmitter),IncrementalData=function(Data$$1){function IncrementalData(){Data$$1.apply(this,arguments)}return Data$$1&&(IncrementalData.__proto__=Data$$1),IncrementalData.prototype=Object.create(Data$$1&&Data$$1.prototype),IncrementalData.prototype.constructor=IncrementalData,IncrementalData.prototype.create=function(nodeData){var op=ObjectOperation.Create([nodeData.id],nodeData);return this.apply(op),op},IncrementalData.prototype.delete=function(nodeId){var op=null,node=this.get(nodeId);if(node){var nodeData=node.toJSON();op=ObjectOperation.Delete([nodeId],nodeData),this.apply(op)}return op},IncrementalData.prototype.update=function(path,diff){var diffOp=this._getDiffOp(path,diff),op=ObjectOperation.Update(path,diffOp);return this.apply(op),op},IncrementalData.prototype.set=function(path,newValue){var oldValue=this.get(path),op=ObjectOperation.Set(path,oldValue,newValue);return this.apply(op),op},IncrementalData.prototype.apply=function(op){if(op.type!==ObjectOperation.NOP){if(op.type===ObjectOperation.CREATE)Data$$1.prototype.create.call(this,cloneDeep$1(op.val));else if(op.type===ObjectOperation.DELETE)Data$$1.prototype.delete.call(this,op.val.id);else if(op.type===ObjectOperation.UPDATE){var oldVal=this.get(op.path),diff=op.diff;if("array"===op.propertyType)diff._isArrayOperation||(diff=ArrayOperation.fromJSON(diff)),diff.apply(oldVal);else{if("string"!==op.propertyType)throw new Error("Unsupported type for operational update.");diff._isTextOperation||(diff=TextOperation.fromJSON(diff));var newVal=diff.apply(oldVal);Data$$1.prototype.set.call(this,op.path,newVal)}}else{if(op.type!==ObjectOperation.SET)throw new Error("Illegal state.");Data$$1.prototype.set.call(this,op.path,op.val)}this.emit("operation:applied",op,this)}},IncrementalData.prototype._getDiffOp=function(path,diff){var diffOp=null;if(diff.isOperation)diffOp=diff;else{var start,end,pos,val,value=this.get(path);if(null===value||void 0===value)throw new Error("Property has not been initialized: "+JSON.stringify(path));isString$1(value)?diff.delete?(start=diff.delete.start,end=diff.delete.end,diffOp=TextOperation.Delete(start,value.substring(start,end))):diff.insert&&(pos=diff.insert.offset,val=diff.insert.value,diffOp=TextOperation.Insert(pos,val)):isArray$1(value)&&(diff.delete?(pos=diff.delete.offset,diffOp=ArrayOperation.Delete(pos,value[pos])):diff.insert&&(pos=diff.insert.offset,val=diff.insert.value,diffOp=ArrayOperation.Insert(pos,val)))}if(!diffOp)throw new Error("Unsupported diff: "+JSON.stringify(diff));return diffOp},IncrementalData}(Data),DocumentNodeFactory=function(doc){this.doc=doc};DocumentNodeFactory.prototype.create=function(nodeType,nodeData){var NodeClass=this.doc.schema.getNodeClass(nodeType);if(!NodeClass)throw new Error("No node registered by that name: "+nodeType);return new NodeClass(this.doc,nodeData)};var documentHelpers={};documentHelpers.isContainerAnnotation=function(doc,type){var schema=doc.getSchema();return schema.isInstanceOf(type,"container-annotation")},documentHelpers.getPropertyAnnotationsForSelection=function(doc,sel,options){if(options=options||{},!sel.isPropertySelection())return[];var annotations=doc.getIndex("annotations").get(sel.path,sel.startOffset,sel.endOffset);return options.type&&(annotations=filter$2(annotations,DocumentIndex.filterByType(options.type))),annotations},documentHelpers.getContainerAnnotationsForSelection=function(doc,sel,containerId,options){if(!containerId)throw new Error("'containerId' is required.");options=options||{};var index=doc.getIndex("container-annotations"),annotations=index.get(containerId,options.type);return annotations=filter$2(annotations,function(anno){return sel.overlaps(anno.getSelection())})},documentHelpers.getAnnotationsForSelection=function(doc,sel,annotationType,containerId){var annos,isContainerAnno=documentHelpers.isContainerAnnotation(doc,annotationType);if(isContainerAnno){var container=doc.get(containerId,"strict");annos=documentHelpers.getContainerAnnotationsForSelection(doc,sel,container,{type:annotationType})}else annos=documentHelpers.getPropertyAnnotationsForSelection(doc,sel,{type:annotationType});return annos},documentHelpers.getTextForSelection=function(doc,sel){var text;if(!sel||sel.isNull())return"";if(sel.isPropertySelection())return text=doc.get(sel.start.path),text.substring(sel.start.offset,sel.end.offset);if(sel.isContainerSelection()){var result=[],fragments=sel.getFragments();return fragments.forEach(function(fragment){if(fragment instanceof Selection.Fragment){var text=doc.get(fragment.path);isString$1(text)&&result.push(text.substring(fragment.startOffset,fragment.endOffset))}}),result.join("\n")}};var JSONConverter=function(){};JSONConverter.prototype.importDocument=function(doc,json){if(!json.schema||!isArray$1(json.nodes))throw new Error("Invalid JSON format.");var schema=doc.getSchema();if(schema.name!==json.schema.name)throw new Error("Incompatible schema.");schema.version!==json.schema.version&&console.error("Different schema version. Conversion might be problematic.");var nodes=json.nodes;return doc.import(function(tx){forEach$2(nodes,function(node){tx.get(node.id)&&tx.delete(node.id),tx.create(node)})}),doc},JSONConverter.prototype.exportDocument=function(doc){var schema=doc.getSchema(),json={schema:{name:schema.name,version:schema.version},nodes:[]};return forEach$2(doc.getNodes(),function(node){node._isDocumentNode&&json.nodes.push(node.toJSON())}),json};var converter=new JSONConverter,__id__$4=0,Document=function(EventEmitter$$1){function Document(schema){if(EventEmitter$$1.call(this),"SKIP"!==arguments[0]){if(this.__id__=__id__$4++,!schema)throw new Error("A document needs a schema for reflection.");this.schema=schema,this.nodeFactory=new DocumentNodeFactory(this),this.data=new IncrementalData(schema,{nodeFactory:this.nodeFactory}),this.addIndex("type",DocumentIndex.create({property:"type"})),this.addIndex("annotations",new AnnotationIndex),this.addIndex("container-annotations",new ContainerAnnotationIndex),this.addIndex("container-annotation-anchors",new AnchorIndex),this.eventProxies={path:new PathEventProxy(this)},this.on("document:changed",this._updateEventProxies,this)}}EventEmitter$$1&&(Document.__proto__=EventEmitter$$1),Document.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),Document.prototype.constructor=Document;var prototypeAccessors={_isDocument:{}};return prototypeAccessors._isDocument.get=function(){return!0},Document.prototype.getSchema=function(){return this.schema},Document.prototype.contains=function(id){return this.data.contains(id)},Document.prototype.get=function(path,strict){return this.data.get(path,strict)},Document.prototype.getNodes=function(){return this.data.getNodes()},Document.prototype.import=function(importer){try{this.data._stopIndexing(),importer(this),this.data._startIndexing()}finally{this.data.queue=[],this.data._startIndexing()}},Document.prototype.create=function(nodeData){nodeData.id||(nodeData.id=uuid$1(nodeData.type));var op=this._create(nodeData),change=new DocumentChange([op],{},{});return change._extractInformation(this),this._notifyChangeListeners(change),this.data.get(nodeData.id)},Document.prototype.delete=function(nodeId){var node=this.get(nodeId),op=this._delete(nodeId),change=new DocumentChange([op],{},{});return change._extractInformation(this),this._notifyChangeListeners(change),node},Document.prototype.set=function(path,value){var oldValue=this.get(path),op=this._set(path,value),change=new DocumentChange([op],{},{});return change._extractInformation(this),this._notifyChangeListeners(change),oldValue},Document.prototype.update=function(path,diff){var op=this._update(path,diff),change=new DocumentChange([op],{},{});return change._extractInformation(this),this._notifyChangeListeners(change),op},Document.prototype.addIndex=function(name,index){return this.data.addIndex(name,index)},Document.prototype.getIndex=function(name){return this.data.getIndex(name)},Document.prototype.createSelection=function(){var sel=_createSelection.apply(this,arguments);return sel.isNull()||sel.attach(this),sel},Document.prototype.getEventProxy=function(name){return this.eventProxies[name]},Document.prototype.newInstance=function(){var DocumentClass=this.constructor;return new DocumentClass(this.schema)},Document.prototype.createSnippet=function(){var snippet=this.newInstance(),snippetContainer=snippet.create({type:"container",id:Document.SNIPPET_ID});return snippet.getContainer=function(){return snippetContainer},snippet.show=function(){snippetContainer.show.apply(snippetContainer,arguments)},snippet},Document.prototype.fromSnapshot=function(data){var doc=this.newInstance();return doc.loadSeed(data),doc},Document.prototype.getDocumentMeta=function(){return this.get("document")},Document.prototype._apply=function(documentChange){each$2(documentChange.ops,function(op){this.data.apply(op),this.emit("operation:applied",op)}.bind(this)),documentChange._extractInformation(this)},Document.prototype._notifyChangeListeners=function(change,info){info=info||{},this.emit("document:changed",change,info,this)},Document.prototype._updateEventProxies=function(change,info){each$2(this.eventProxies,function(proxy){proxy.onDocumentChanged(change,info,this)}.bind(this))},Document.prototype.loadSeed=function(seed){each$2(this.data.nodes,function(node){this.delete(node.id)}.bind(this)),each$2(seed.nodes,function(nodeData){this.create(nodeData)}.bind(this))},Document.prototype.toJSON=function(){return converter.exportDocument(this)},Document.prototype.getTextForSelection=function(sel){return console.warn("DEPRECATED: use docHelpers.getTextForSelection() instead."),documentHelpers.getTextForSelection(this,sel)},Document.prototype.setText=function(path,text,annotations){var idx,this$1=this,oldAnnos=this.getIndex("annotations").get(path);for(idx=0;idx<oldAnnos.length;idx++)this$1.delete(oldAnnos[idx].id);for(this.set(path,text),idx=0;idx<annotations.length;idx++)this$1.create(annotations[idx])},Document.prototype._create=function(nodeData){var op=this.data.create(nodeData);return op},Document.prototype._delete=function(nodeId){var op=this.data.delete(nodeId);return op},Document.prototype._update=function(path,diff){var op=this.data.update(path,diff);return op},Document.prototype._set=function(path,value){var op=this.data.set(path,value);return op},Object.defineProperties(Document.prototype,prototypeAccessors),Document}(EventEmitter);Document.SNIPPET_ID="snippet",Document.TEXT_SNIPPET_ID="text-snippet";var __id__$3=0,TransactionDocument=function(Document$$1){function TransactionDocument(document,session){Document$$1.call(this,"SKIP"),this.__id__="TX_"+__id__$3++,this.schema=document.schema,this.nodeFactory=new DocumentNodeFactory(this),this.data=new IncrementalData(this.schema,{nodeFactory:this.nodeFactory}),this.document=document,this.session=session,this.ops=[],this.before={},each$2(document.data.indexes,function(index,name){this.data.addIndex(name,index.clone())}.bind(this)),this.loadSeed(document.toJSON())}Document$$1&&(TransactionDocument.__proto__=Document$$1),TransactionDocument.prototype=Object.create(Document$$1&&Document$$1.prototype),TransactionDocument.prototype.constructor=TransactionDocument;var prototypeAccessors={isTransactionDocument:{}};return prototypeAccessors.isTransactionDocument.get=function(){return!0},TransactionDocument.prototype.reset=function(){this.ops=[],this.before={}},TransactionDocument.prototype.create=function(nodeData){if(nodeData.id||(nodeData.id=uuid$1(nodeData.type)),!nodeData.type)throw new Error("No node type provided");var op=this.data.create(nodeData);if(op)return this.ops.push(op),this.data.get(nodeData.id)},TransactionDocument.prototype.delete=function(nodeId){var op=this.data.delete(nodeId);if(op)return this.ops.push(op),op},TransactionDocument.prototype.set=function(path,value){var op=this.data.set(path,value);if(op)return this.ops.push(op),op},TransactionDocument.prototype.update=function(path,diffOp){var op=this.data.update(path,diffOp);if(op)return this.ops.push(op),op},TransactionDocument.prototype.cancel=function(){this._cancelTransaction()},TransactionDocument.prototype.getOperations=function(){return this.ops},TransactionDocument.prototype._apply=function(documentChange){documentChange.ops.forEach(function(op){this.data.apply(op)}.bind(this))},TransactionDocument.prototype._transaction=function(transformation){if(!isFunction$1(transformation))throw new Error("Document.transaction() requires a transformation function.");this._startTransaction();try{if(transformation(this,{}),!this._isCancelled)return this._saveTransaction()}finally{this._isSaved||this.cancel(),this.session.isTransacting=!1}},TransactionDocument.prototype._startTransaction=function(){this.before={},this.after={},this.info={},this._isCancelled=!1,this._isSaved=!1,this.document.emit("transaction:started",this)},TransactionDocument.prototype._saveTransaction=function(){if(!this._isCancelled){var change,beforeState=this.before,afterState=extend$1({},beforeState,this.after),ops=this.ops;return ops.length>0&&(change=new DocumentChange(ops,beforeState,afterState)),this._isSaved=!0,this.reset(),change}},TransactionDocument.prototype._cancelTransaction=function(){for(var this$1=this,i=this.ops.length-1;i>=0;i--)this$1.data.apply(this$1.ops[i].invert());this._isCancelled=!0,this.reset()},TransactionDocument.prototype.newInstance=function(){return this.document.newInstance()},Object.defineProperties(TransactionDocument.prototype,prototypeAccessors),TransactionDocument}(Document),DefaultChangeCompressor=function(){};DefaultChangeCompressor.prototype.shouldMerge=function(lastChange,newChange){return!1},DefaultChangeCompressor.prototype.merge=function(first,second){var firstOp=first.ops[0],secondOp=second.ops[0],firstDiff=firstOp.diff,secondDiff=secondOp.diff,mergedOp=!1;return firstDiff.isInsert()?firstDiff.pos+firstDiff.getLength()===secondDiff.pos&&(mergedOp=firstOp.toJSON(),mergedOp.diff.str+=secondDiff.str):firstDiff.isDelete()&&(firstDiff.pos===secondDiff.pos?(mergedOp=firstOp.toJSON(),mergedOp.diff.str+=secondDiff.str):secondDiff.pos+secondDiff.getLength()===firstDiff.pos&&(mergedOp=firstOp.toJSON(),mergedOp.diff=secondDiff,mergedOp.diff.str+=firstDiff.str)),!!mergedOp&&(first.ops[0]=ObjectOperation.fromJSON(mergedOp),first.ops.length>1&&(first.ops=first.ops.concat(second.ops.slice(1)),first.after=second.after),!0)};var SelectionState=function(doc){this.document=doc,this.selection=Selection.nullSelection,this._state={},this._resetState()};SelectionState.prototype.setSelection=function(sel){return sel?sel.attach(this.document):sel=Selection.nullSelection,this._deriveState(sel),this.selection=sel,!0},SelectionState.prototype.getSelection=function(){return this.selection},SelectionState.prototype.getAnnotationsForType=function(type){var state=this._state;return state.annosByType?state.annosByType.get(type)||[]:[]},SelectionState.prototype.isInlineNodeSelection=function(){return this._state.isInlineNodeSelection},SelectionState.prototype._deriveState=function(sel){var doc=this.document;this._resetState();var state=this._state,annosByType=new TreeIndex.Arrays,propAnnos=documentHelpers.getPropertyAnnotationsForSelection(doc,sel);propAnnos.forEach(function(anno){annosByType.add(anno.type,anno)}),1===propAnnos.length&&propAnnos[0].isInline()&&(state.isInlineNodeSelection=propAnnos[0].getSelection().equals(sel));var containerId=sel.containerId;if(containerId){var containerAnnos=documentHelpers.getContainerAnnotationsForSelection(doc,sel,containerId);containerAnnos.forEach(function(anno){annosByType.add(anno.type,anno)})}state.annosByType=annosByType},SelectionState.prototype._resetState=function(){return this._state={annosByType:null,isNodeSelection:!1,nodeId:null,nodeSelectionMode:"",isInlineNodeSelection:!1},this._state};var __id__$2=0,DocumentSession=function(EventEmitter$$1){function DocumentSession(doc,options){EventEmitter$$1.call(this),this.__id__=__id__$2++,options=options||{},this.doc=doc,this.selectionState=new SelectionState(doc),this.stage=new TransactionDocument(this.doc,this),this.isTransacting=!1,this.doneChanges=[],this.undoneChanges=[],this._lastChange=null,this.compressor=options.compressor||new DefaultChangeCompressor,this.saveHandler=options.saveHandler,this.doc.on("document:changed",this.onDocumentChange,this,{priority:1e3})}return EventEmitter$$1&&(DocumentSession.__proto__=EventEmitter$$1),DocumentSession.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),DocumentSession.prototype.constructor=DocumentSession,DocumentSession.prototype.getDocument=function(){return this.doc},DocumentSession.prototype.getSelection=function(){return this.selectionState.getSelection()},DocumentSession.prototype.setSelection=function(sel){sel&&isPlainObject$1(sel)&&(sel=this.doc.createSelection(sel));var selectionHasChanged=this._setSelection(sel);selectionHasChanged&&this._triggerUpdateEvent({selection:sel})},DocumentSession.prototype.createSelection=function(){return this.doc.createSelection.apply(this.doc,arguments)},DocumentSession.prototype.getSelectionState=function(){return this.selectionState},DocumentSession.prototype.setSaveHandler=function(saveHandler){this.saveHandler=saveHandler},DocumentSession.prototype.getCollaborators=function(){return null},DocumentSession.prototype.canUndo=function(){return this.doneChanges.length>0},DocumentSession.prototype.canRedo=function(){return this.undoneChanges.length>0},DocumentSession.prototype.undo=function(){this._undoRedo("undo")},DocumentSession.prototype.redo=function(){this._undoRedo("redo")},DocumentSession.prototype._undoRedo=function(which){var from,to;"redo"===which?(from=this.undoneChanges,to=this.doneChanges):(from=this.doneChanges,to=this.undoneChanges);var change=from.pop();if(change){this.stage._apply(change),this.doc._apply(change);var sel=change.after.selection;sel&&sel.attach(this.doc);var selectionHasChanged=this._setSelection(sel);to.push(change.invert());var update={change:change};selectionHasChanged&&(update.selection=sel),this._triggerUpdateEvent(update,{replay:!0})}else console.warn("No change can be %s.","undo"===which?"undone":"redone")},DocumentSession.prototype.transaction=function(transformation,info){if(this.isTransacting)throw new Error("Nested transactions are not supported.");this.isTransacting=!0,this.stage.reset();var sel=this.getSelection();info=info||{};var surfaceId=sel.surfaceId,change=this.stage._transaction(function(tx){tx.before.selection=sel;var args={selection:sel},result=transformation(tx,args)||{};sel=result.selection||sel,!sel._isSelection||sel.isNull()||sel.surfaceId||(sel.surfaceId=surfaceId),tx.after.selection=sel,extend$1(info,tx.info)});return change?(this.isTransacting=!1,this._commit(change,info),change):void(this.isTransacting=!1)},DocumentSession.prototype.onDocumentChange=function(change,info){if(info&&info.session!==this){this.stage._apply(change),this._transformLocalChangeHistory(change,info);var update={change:change},newSelection=this._transformSelection(change,info),selectionHasChanged=this._setSelection(newSelection);selectionHasChanged&&(update.selection=newSelection)}},DocumentSession.prototype._setSelection=function(sel){return this.selectionState.setSelection(sel)},DocumentSession.prototype._transformLocalChangeHistory=function(externalChange){var clone={ops:externalChange.ops.map(function(op){return op.clone()})};DocumentChange.transformInplace(clone,this.doneChanges),DocumentChange.transformInplace(clone,this.undoneChanges)},DocumentSession.prototype._transformSelection=function(change){var oldSelection=this.getSelection(),newSelection=DocumentChange.transformSelection(oldSelection,change);return newSelection},DocumentSession.prototype._commit=function(change,info){var selectionHasChanged=this._commitChange(change),update={change:change};selectionHasChanged&&(update.selection=this.getSelection()),this._triggerUpdateEvent(update,info)},DocumentSession.prototype._commitChange=function(change){change.timestamp=Date.now(),this.doc._apply(change);var currentChange=this._currentChange,merged=!1;currentChange&&this.compressor.shouldMerge(currentChange,change)&&(merged=this.compressor.merge(currentChange,change)),merged||(this._currentChange=change,this.doneChanges.push(change.invert())),this.undoneChanges=[];var newSelection=change.after.selection||Selection.nullSelection,selectionHasChanged=this._setSelection(newSelection);return newSelection.isNull()||(newSelection.surfaceId=change.after.surfaceId),selectionHasChanged},DocumentSession.prototype.isDirty=function(){return this._dirty},DocumentSession.prototype.save=function(){var doc=this.getDocument(),saveHandler=this.saveHandler;if(this._dirty&&!this._isSaving)if(this._isSaving=!0,saveHandler){var changes=[];saveHandler.saveDocument(doc,changes,function(err){this._isSaving=!1,err?console.error("Error during save"):(this._dirty=!1,this._triggerUpdateEvent({},{force:!0}))}.bind(this))}else console.error("Document saving is not handled at the moment. Make sure saveHandler instance provided to documentSession")},DocumentSession.prototype._triggerUpdateEvent=function(update,info){info=info||{},info.session=this,update.change&&update.change.ops.length>0?(this.doc._notifyChangeListeners(update.change,info),this._dirty=!0):delete update.change,(Object.keys(update).length>0||info.force)&&(this.emit("update",update,info),this.emit("didUpdate",update,info))},DocumentSession}(EventEmitter),CollabSession=function(DocumentSession$$1){function CollabSession(doc,config){if(DocumentSession$$1.call(this,doc,config),config=config||{},this.config=config,this.collabClient=config.collabClient,config.docVersion&&console.warn("config.docVersion is deprecated: Use config.version instead"),config.docVersion&&console.warn("config.docId is deprecated: Use config.documentId instead"),this.version=config.version,this.documentId=config.documentId||config.docId,void 0!==config.autoSync?this.autoSync=config.autoSync:this.autoSync=!0,!this.documentId)throw new SubstanceError("InvalidArgumentsError",{message:"documentId is mandatory"});if(void 0===typeof this.version)throw new SubstanceError("InvalidArgumentsError",{message:"version is mandatory"});this._connected=!1,this._nextChange=null,this._pendingChange=null,this._error=null,this.doc.on("document:changed",this.afterDocumentChange,this,{priority:-10}),this._broadCastSelectionUpdateDebounced=debounce$1(this._broadCastSelectionUpdate,250),this.collaborators={},this.collabClient.on("connected",this.onCollabClientConnected,this),this.collabClient.on("disconnected",this.onCollabClientDisconnected,this),this.__maxColors=5,this.__nextColorIndex=0,this.collabClient.on("message",this._onMessage.bind(this)),this.collabClient.isConnected()&&this.autoSync&&this.sync()}return DocumentSession$$1&&(CollabSession.__proto__=DocumentSession$$1),CollabSession.prototype=Object.create(DocumentSession$$1&&DocumentSession$$1.prototype),CollabSession.prototype.constructor=CollabSession,CollabSession.prototype.dispose=function(){this.disconnect(),this.collabClient.off(this)},CollabSession.prototype.disconnect=function(){var msg={type:"disconnect",documentId:this.documentId};this._abortSync(),this._send(msg)},CollabSession.prototype.sync=function(){if(this.__canSync()){var nextChange=this._getNextChange(),msg={type:"sync",documentId:this.documentId,version:this.version,change:this.serializeChange(nextChange)};this._send(msg),this._pendingChange=nextChange,this.emit("sync"),this._nextChange=null,this._error=null}else console.error("Can not sync. Either collabClient is not connected or we are already syncing")},CollabSession.prototype.setSelection=function(sel){var beforeSel=this.selection;DocumentSession$$1.prototype.setSelection.call(this,sel),this._broadCastSelectionUpdateDebounced(beforeSel,sel)},CollabSession.prototype.getCollaborators=function(){return this.collaborators},CollabSession.prototype.isConnected=function(){return this._connected},CollabSession.prototype.serializeChange=function(change){return change.toJSON()},CollabSession.prototype.deserializeChange=function(serializedChange){return DocumentChange.fromJSON(serializedChange)},CollabSession.prototype._onMessage=function(msg){if(msg.documentId!==this.documentId)return!1;switch(msg=cloneDeep$1(msg),msg.type){case"syncDone":this.syncDone(msg);break;case"syncError":this.syncError(msg);break;case"update":this.update(msg);break;case"disconnectDone":this.disconnectDone(msg);break;case"error":this.error(msg);break;default:return console.error("CollabSession: unsupported message",msg.type,msg),!1}return!0},CollabSession.prototype._send=function(msg){return this.collabClient.isConnected()?(this.collabClient.send(msg),!0):(console.warn("Try not to call _send when disconnected. Skipping message",msg),!1)},CollabSession.prototype.update=function update(args){var serverChange=args.change,collaborators=args.collaborators,serverVersion=args.version;if(!this._nextChange&&!this._pendingChange){var oldSelection=this.selection;serverChange&&(serverChange=this.deserializeChange(serverChange),this._applyRemoteChange(serverChange));var newSelection=this.selection;serverVersion&&(this.version=serverVersion);var update={change:serverChange};newSelection!==oldSelection&&(update.selection=newSelection);var collaboratorsChange=this._updateCollaborators(collaborators);collaboratorsChange&&(update.collaborators=collaboratorsChange,this.emit("collaborators:changed")),this._triggerUpdateEvent(update,{remote:!0})}},CollabSession.prototype.syncDone=function(args){var serverChange=args.serverChange,collaborators=args.collaborators,serverVersion=args.version;serverChange&&(serverChange=this.deserializeChange(serverChange),this._applyRemoteChange(serverChange)),this.version=serverVersion;var collaboratorsChange=this._updateCollaborators(collaborators);this._nextChange&&this._transformCollaboratorSelections(this._nextChange),this._pendingChange=null,this._error=null,this._connected=!0;var update={change:serverChange};collaboratorsChange&&(update.collaborators=collaboratorsChange),this._triggerUpdateEvent(update,{remote:!0}),this.emit("connected"),this._requestSync()},CollabSession.prototype.syncError=function(error){error("Sync error:",error),this._abortSync()},CollabSession.prototype.disconnectDone=function(){this._afterDisconnected()},CollabSession.prototype.error=function error(message){var error=message.error,errorFn=this[error.name],err=SubstanceError.fromJSON(error);return errorFn?(this.emit("error",err),errorFn=errorFn.bind(this),void errorFn(err)):(error("CollabSession: unsupported error",error.name),!1)},CollabSession.prototype.afterDocumentChange=function(change,info){info.remote||this._recordChange(change)},CollabSession.prototype.onCollabClientConnected=function(){this.autoSync&&this.sync()},CollabSession.prototype.onCollabClientDisconnected=function(){this._abortSync(),this._connected&&this._afterDisconnected()},CollabSession.prototype._commit=function(change,info){var selectionHasChanged=this._commitChange(change),collaboratorsChange=null;forEach$2(this.getCollaborators(),function(collaborator){var id=collaborator.collaboratorId,oldSelection=collaborator.selection,newSelection=DocumentChange.transformSelection(oldSelection,change);oldSelection!==newSelection&&(collaboratorsChange=collaboratorsChange||{},collaborator=clone$2(collaborator),collaborator.selection=newSelection,collaboratorsChange[id]=collaborator)});var update={change:change};selectionHasChanged&&(update.selection=this.getSelection()),collaboratorsChange&&(update.collaborators=collaboratorsChange),this._triggerUpdateEvent(update,info)},CollabSession.prototype._applyRemoteChange=function(change){change.ops.length>0&&(this.stage._apply(change),this.doc._apply(change),this._transformLocalChangeHistory(change),this.selection=this._transformSelection(change))},CollabSession.prototype._recordChange=function(change){this._nextChange?(this._nextChange.ops=this._nextChange.ops.concat(change.ops),this._nextChange.after=change.after):this._nextChange=change,this._requestSync()},CollabSession.prototype._getNextChange=function(){var nextChange=this._nextChange;return nextChange||(nextChange=this._getChangeForSelection(this.selection,this.selection)),nextChange},CollabSession.prototype._broadCastSelectionUpdate=function(beforeSel,afterSel){this._nextChange?this._nextChange.after.selection=afterSel:this._nextChange=this._getChangeForSelection(beforeSel,afterSel),this._requestSync()},CollabSession.prototype.__canSync=function(){return this.collabClient.isConnected()&&!this._pendingChange},CollabSession.prototype._requestSync=function(){this._nextChange&&this.__canSync()&&this.sync()},CollabSession.prototype._abortSync=function(){var newNextChange=this._nextChange;this._pendingChange&&(newNextChange=this._pendingChange,this._nextChange&&(newNextChange.ops=newNextChange.ops.concat(this._nextChange.ops),newNextChange.after=this._nextChange.after),this._pendingChange=null),this._error=null,this._nextChange=newNextChange},CollabSession.prototype._transformCollaboratorSelections=function(change){var collaborators=this.getCollaborators();collaborators&&forEach$2(collaborators,function(collaborator){DocumentChange.transformSelection(collaborator.selection,change)})},CollabSession.prototype._updateCollaborators=function(collaborators){var collaboratorsChange={};if(forEach$2(collaborators,function(collaborator,collaboratorId){if(collaborator){var oldSelection,old=this.collaborators[collaboratorId];
old&&(oldSelection=old.selection);var newSelection=fromJSON(collaborator.selection);newSelection.attach(this.doc),collaborator.colorIndex=old?old.colorIndex:this._getNextColorIndex(),collaborator.selection=newSelection,this.collaborators[collaboratorId]=collaborator,newSelection.equals(oldSelection)||(collaboratorsChange[collaboratorId]=collaborator)}else collaboratorsChange[collaboratorId]=null,delete this.collaborators[collaboratorId]}.bind(this)),Object.keys(collaboratorsChange).length>0)return collaboratorsChange},CollabSession.prototype._afterDisconnected=function(){var oldCollaborators=this.collaborators;this.collaborators={};var collaboratorIds=Object.keys(oldCollaborators);if(collaboratorIds.length>0){var collaboratorsChange={};collaboratorIds.forEach(function(collaboratorId){collaboratorsChange[collaboratorId]=null}),this._triggerUpdateEvent({collaborators:collaboratorsChange})}this._connected=!1,this.emit("disconnected")},CollabSession.prototype._getChangeForSelection=function(beforeSel,afterSel){var change=new DocumentChange([],{selection:beforeSel},{selection:afterSel});return change},CollabSession.prototype._hasLocalChanges=function(){return this._nextChange&&this._nextChange.ops.length>0},CollabSession.prototype._getNextColorIndex=function(){var colorIndex=this.__nextColorIndex;return this.__nextColorIndex=(this.__nextColorIndex+1)%this.__maxColors,colorIndex+1},CollabSession}(DocumentSession),DocumentClient=function(config){this.config=config};DocumentClient.prototype.createDocument=function(newDocument,cb){request("POST",this.config.httpUrl,newDocument,cb)},DocumentClient.prototype.getDocument=function(documentId,cb){request("GET",this.config.httpUrl+documentId,null,cb)},DocumentClient.prototype.deleteDocument=function(documentId,cb){request("DELETE",this.config.httpUrl+documentId,null,cb)};var converter$1=new JSONConverter,SnapshotEngine=function(config){this.configurator=config.configurator,this.changeStore=config.changeStore,this.documentStore=config.documentStore,this.snapshotStore=config.snapshotStore,this.frequency=config.frequency||1};SnapshotEngine.prototype.getSnapshot=function(args,cb){return args&&args.documentId?void this._computeSnapshot(args,cb):cb(new SubstanceError("InvalidArgumentsError",{message:"args requires a documentId"}))},SnapshotEngine.prototype.requestSnapshot=function(documentId,version,cb){this.snapshotStore&&version%this.frequency===0?this.createSnapshot({documentId:documentId},cb):cb(null)},SnapshotEngine.prototype.createSnapshot=function(args,cb){if(!this.snapshotStore)throw new SubstanceError("SnapshotStoreRequiredError",{message:"You must provide a snapshot store to be able to create snapshots"});this._computeSnapshot(args,function(err,snapshot){return err?cb(err):void this.snapshotStore.saveSnapshot(snapshot,cb)}.bind(this))},SnapshotEngine.prototype._computeSnapshot=function(args,cb){this.documentStore.getDocument(args.documentId,function(err,docRecord){return err?cb(err):(void 0===args.version&&(args.version=docRecord.version),args.docRecord=docRecord,void(this.snapshotStore&&0!==args.version?this._computeSnapshotSmart(args,cb):this._computeSnapshotDumb(args,cb)))}.bind(this))},SnapshotEngine.prototype._computeSnapshotSmart=function(args,cb){var doc,documentId=args.documentId,version=args.version,docRecord=args.docRecord;this.snapshotStore.getSnapshot({documentId:documentId,version:version,findClosest:!0},function(err,snapshot){if(err)return cb(err);if(snapshot&&version===snapshot.version)return cb(null,snapshot);var knownVersion;knownVersion=snapshot?snapshot.version:0,doc=this._createDocumentInstance(docRecord.schemaName),snapshot&&(doc=converter$1.importDocument(doc,snapshot.data)),this.changeStore.getChanges({documentId:documentId,sinceVersion:knownVersion,toVersion:version},function(err,result){err&&cb(err),this._applyChanges(doc,result.changes);var snapshot={documentId:documentId,version:version,data:converter$1.exportDocument(doc)};cb(null,snapshot)}.bind(this))}.bind(this))},SnapshotEngine.prototype._computeSnapshotDumb=function(args,cb){var doc,documentId=args.documentId,version=args.version,docRecord=args.docRecord;this.changeStore.getChanges({documentId:documentId,sinceVersion:0},function(err,result){err&&cb(err),doc=this._createDocumentInstance(docRecord.schemaName),this._applyChanges(doc,result.changes);var snapshot={documentId:documentId,version:version,data:converter$1.exportDocument(doc)};cb(null,snapshot)}.bind(this))},SnapshotEngine.prototype._createDocumentInstance=function(schemaName){var schema=this.configurator.getSchema();if(schema.name!==schemaName)throw new SubstanceError("SnapshotEngine.SchemaNotFoundError",{message:"Schema "+schemaName+" not found"});var doc=this.configurator.createArticle();return doc},SnapshotEngine.prototype._applyChanges=function(doc,changes){each$2(changes,function(change){each$2(change.ops,function(op){doc.data.apply(op)})})};var DocumentEngine=function(EventEmitter$$1){function DocumentEngine(config){EventEmitter$$1.call(this),this.configurator=config.configurator,this.documentStore=config.documentStore,this.changeStore=config.changeStore,this.snapshotEngine=config.snapshotEngine||new SnapshotEngine({configurator:this.configurator,documentStore:this.documentStore,changeStore:this.changeStore})}return EventEmitter$$1&&(DocumentEngine.__proto__=EventEmitter$$1),DocumentEngine.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),DocumentEngine.prototype.constructor=DocumentEngine,DocumentEngine.prototype.createDocument=function(args,cb){var schema=this.configurator.getSchema();if(!schema)return cb(new SubstanceError("SchemaNotFoundError",{message:"Schema not found for "+args.schemaName}));var doc=this.configurator.createArticle();this.documentStore.createDocument({schemaName:schema.name,schemaVersion:schema.version,documentId:args.documentId,version:0,info:args.info},function(err,docRecord){if(err)return cb(new SubstanceError("CreateError",{cause:err}));var converter=new JSONConverter;cb(null,{documentId:docRecord.documentId,data:converter.exportDocument(doc),version:0})}.bind(this))},DocumentEngine.prototype.getDocument=function(args,cb){this.snapshotEngine.getSnapshot(args,cb)},DocumentEngine.prototype.deleteDocument=function(documentId,cb){this.changeStore.deleteChanges(documentId,function(err){return err?cb(new SubstanceError("DeleteError",{cause:err})):void this.documentStore.deleteDocument(documentId,function(err,doc){return err?cb(new SubstanceError("DeleteError",{cause:err})):void cb(null,doc)})}.bind(this))},DocumentEngine.prototype.documentExists=function(documentId,cb){this.documentStore.documentExists(documentId,cb)},DocumentEngine.prototype.getChanges=function(args,cb){this.documentExists(args.documentId,function(err,exists){return err||!exists?cb(new SubstanceError("ReadError",{message:exists?null:"Document does not exist",cause:err})):void this.changeStore.getChanges(args,cb)}.bind(this))},DocumentEngine.prototype.getVersion=function(documentId,cb){this.documentExists(documentId,function(err,exists){return err||!exists?cb(new SubstanceError("ReadError",{message:exists?null:"Document does not exist",cause:err})):void this.changeStore.getVersion(documentId,cb)}.bind(this))},DocumentEngine.prototype.addChange=function(args,cb){this.documentExists(args.documentId,function(err,exists){return err||!exists?cb(new SubstanceError("ReadError",{message:exists?null:"Document does not exist",cause:err})):void this.changeStore.addChange(args,function(err,newVersion){return err?cb(err):void this.documentStore.updateDocument(args.documentId,{version:newVersion,info:args.documentInfo},function(err){return err?cb(err):void this.snapshotEngine.requestSnapshot(args.documentId,newVersion,function(){cb(null,newVersion)})}.bind(this))}.bind(this))}.bind(this))},DocumentEngine}(EventEmitter),DocumentServer=function(config){this.engine=config.documentEngine,this.path=config.path};DocumentServer.prototype.bind=function(app){app.post(this.path,this._createDocument.bind(this)),app.get(this.path+"/:id",this._getDocument.bind(this)),app.delete(this.path+"/:id",this._deleteDocument.bind(this))},DocumentServer.prototype._createDocument=function(req,res,next){var args=req.body,newDoc={schemaName:args.schemaName,info:args.info};this.engine.createDocument(newDoc,function(err,result){return err?next(err):void res.json(result)})},DocumentServer.prototype._getDocument=function(req,res,next){var documentId=req.params.id;this.engine.getDocument({documentId:documentId},function(err,result){return err?next(err):void res.json(result)})},DocumentServer.prototype._deleteDocument=function(req,res,next){var documentId=req.params.id;this.engine.deleteDocument(documentId,function(err,result){return err?next(err):void res.json(result)})};var DocumentStore=function(config){this.config=config};DocumentStore.prototype.createDocument=function(params,cb){params.documentId||(params.documentId=uuid$1());var exists=this._documentExists(params.documentId);return exists?cb(new SubstanceError("DocumentStore.CreateError",{message:"Could not create because document already exists."})):void this._createDocument(params)},DocumentStore.prototype.getDocument=function(documentId,cb){var doc=this._getDocument(documentId);return doc?void cb(null,doc):cb(new SubstanceError("DocumentStore.ReadError",{message:"Document could not be found."}))},DocumentStore.prototype.updateDocument=function(documentId,newparams,cb){var exists=this._documentExists(documentId);return exists?(this._updateDocument(documentId,newparams),void cb(null,this._getDocument(documentId))):cb(new SubstanceError("DocumentStore.UpdateError",{message:"Document does not exist."}))},DocumentStore.prototype.deleteDocument=function(documentId,cb){var doc=this._getDocument(documentId);return doc?(this._deleteDocument(documentId),void cb(null,doc)):cb(new SubstanceError("DocumentStore.DeleteError",{message:"Document does not exist."}))},DocumentStore.prototype.documentExists=function(documentId,cb){cb(null,this._documentExists(documentId))},DocumentStore.prototype.seed=function(documents,cb){return this._documents=documents,cb&&cb(null),this},DocumentStore.prototype._createDocument=function(params){this._documents[params.documentId]=params},DocumentStore.prototype._deleteDocument=function(documentId){delete this._documents[documentId]},DocumentStore.prototype._getDocument=function(documentId){return this._documents[documentId]},DocumentStore.prototype._updateDocument=function(documentId,params){var doc=this._documents[documentId];extend$1(doc,params)},DocumentStore.prototype._documentExists=function(documentId){return Boolean(this._documents[documentId])};var SnapshotStore=function(config){this.config=config,this._snapshots={}};SnapshotStore.prototype.getSnapshot=function(args,cb){if(!args||!args.documentId)return cb(new SubstanceError("InvalidArgumentsError",{message:"args require a documentId"}));var result,documentId=args.documentId,version=args.version,docEntry=this._snapshots[documentId];if(!docEntry)return cb(null,void 0);var availableVersions=Object.keys(docEntry);if(0===availableVersions.length)return cb(null,void 0);if(version){if(result=docEntry[version],!result&&args.findClosest){var smallerVersions=availableVersions.filter(function(v){return parseInt(v,10)<version}),clostestVersion=Math.max.apply(null,smallerVersions);result=docEntry[clostestVersion]}}else{var latestVersion=Math.max.apply(null,availableVersions);result=docEntry[latestVersion]}cb(null,result)},SnapshotStore.prototype.saveSnapshot=function(args,cb){var documentId=args.documentId,version=args.version,data=args.data,docEntry=this._snapshots[documentId];docEntry||(docEntry=this._snapshots[documentId]={}),docEntry[version]={documentId:documentId,version:version,data:data},cb(null,docEntry[version])},SnapshotStore.prototype.deleteSnaphot=function(documentId,version,cb){var docEntry=this._snapshots[documentId];if(!docEntry||!docEntry[version])return cb(new SubstanceError("DeleteError",{message:"Snapshot could not be found"}));var snapshot=this._snapshots[documentId][version];delete this._snapshots[documentId][version],cb(null,snapshot)},SnapshotStore.prototype.deleteSnapshotsForDocument=function(documentId,cb){var docEntry=this._snapshots[documentId],deleteCount=0;docEntry&&(deleteCount=Object.keys(docEntry).length),delete this._snapshots[documentId],cb(null,deleteCount)},SnapshotStore.prototype.snapshotExists=function(documentId,version,cb){var exists=!1,docRecord=this._snapshots[documentId];docRecord&&(exists=docRecord[version]),cb(null,exists)},SnapshotStore.prototype.seed=function(snapshots,cb){return this._snapshots=snapshots,cb&&cb(null),this};var WebSocketConnection=function(ClientConnection$$1){function WebSocketConnection(){ClientConnection$$1.apply(this,arguments)}return ClientConnection$$1&&(WebSocketConnection.__proto__=ClientConnection$$1),WebSocketConnection.prototype=Object.create(ClientConnection$$1&&ClientConnection$$1.prototype),WebSocketConnection.prototype.constructor=WebSocketConnection,WebSocketConnection.prototype._createWebSocket=function(){return new window.WebSocket(this.config.wsUrl)},WebSocketConnection}(ClientConnection),_indexOfNaN=createCommonjsModule(function(module){function indexOfNaN(array,fromIndex,fromRight){for(var length=array.length,index=fromIndex+(fromRight?1:-1);fromRight?index--:++index<length;){var other=array[index];if(other!==other)return index}return-1}module.exports=indexOfNaN}),_indexOfNaN$1=interopDefault(_indexOfNaN),require$$0$54=Object.freeze({default:_indexOfNaN$1}),_baseIndexOf=createCommonjsModule(function(module){function baseIndexOf(array,value,fromIndex){if(value!==value)return indexOfNaN(array,fromIndex);for(var index=fromIndex-1,length=array.length;++index<length;)if(array[index]===value)return index;return-1}var indexOfNaN=interopDefault(require$$0$54);module.exports=baseIndexOf}),_baseIndexOf$1=interopDefault(_baseIndexOf),require$$4$13=Object.freeze({default:_baseIndexOf$1}),_arrayIncludes=createCommonjsModule(function(module){function arrayIncludes(array,value){var length=array?array.length:0;return!!length&&baseIndexOf(array,value,0)>-1}var baseIndexOf=interopDefault(require$$4$13);module.exports=arrayIncludes}),_arrayIncludes$1=interopDefault(_arrayIncludes),require$$4$12=Object.freeze({default:_arrayIncludes$1}),_arrayIncludesWith=createCommonjsModule(function(module){function arrayIncludesWith(array,value,comparator){for(var index=-1,length=array?array.length:0;++index<length;)if(comparator(value,array[index]))return!0;return!1}module.exports=arrayIncludesWith}),_arrayIncludesWith$1=interopDefault(_arrayIncludesWith),require$$3$16=Object.freeze({default:_arrayIncludesWith$1}),_cacheHas=createCommonjsModule(function(module){function cacheHas(cache,key){return cache.has(key)}module.exports=cacheHas}),_cacheHas$1=interopDefault(_cacheHas),require$$0$55=Object.freeze({default:_cacheHas$1}),noop=createCommonjsModule(function(module){function noop(){}module.exports=noop}),noop$1=interopDefault(noop),require$$1$31=Object.freeze({default:noop$1}),_createSet=createCommonjsModule(function(module){var Set=interopDefault(require$$2$15),noop=interopDefault(require$$1$31),setToArray=interopDefault(require$$0$27),INFINITY=1/0,createSet=Set&&1/setToArray(new Set([,-0]))[1]==INFINITY?function(values){return new Set(values)}:noop;module.exports=createSet}),_createSet$1=interopDefault(_createSet),require$$1$30=Object.freeze({default:_createSet$1}),_baseUniq=createCommonjsModule(function(module){function baseUniq(array,iteratee,comparator){var index=-1,includes=arrayIncludes,length=array.length,isCommon=!0,result=[],seen=result;if(comparator)isCommon=!1,includes=arrayIncludesWith;else if(length>=LARGE_ARRAY_SIZE){var set=iteratee?null:createSet(array);if(set)return setToArray(set);isCommon=!1,includes=cacheHas,seen=new SetCache}else seen=iteratee?[]:result;outer:for(;++index<length;){var value=array[index],computed=iteratee?iteratee(value):value;if(value=comparator||0!==value?value:0,isCommon&&computed===computed){for(var seenIndex=seen.length;seenIndex--;)if(seen[seenIndex]===computed)continue outer;iteratee&&seen.push(computed),result.push(value)}else includes(seen,computed,comparator)||(seen!==result&&seen.push(computed),result.push(value))}return result}var SetCache=interopDefault(require$$5$1),arrayIncludes=interopDefault(require$$4$12),arrayIncludesWith=interopDefault(require$$3$16),cacheHas=interopDefault(require$$0$55),createSet=interopDefault(require$$1$30),setToArray=interopDefault(require$$0$27),LARGE_ARRAY_SIZE=200;module.exports=baseUniq}),_baseUniq$1=interopDefault(_baseUniq),require$$0$53=Object.freeze({default:_baseUniq$1}),uniq=createCommonjsModule(function(module){function uniq(array){return array&&array.length?baseUniq(array):[]}var baseUniq=interopDefault(require$$0$53);module.exports=uniq}),uniq$1=interopDefault(uniq),annotationHelpers={insertedText:insertedText,deletedText:deletedText,transferAnnotations:transferAnnotations},isBoolean=createCommonjsModule(function(module){function isBoolean(value){return value===!0||value===!1||isObjectLike(value)&&objectToString.call(value)==boolTag}var isObjectLike=interopDefault(require$$0$4),boolTag="[object Boolean]",objectProto=Object.prototype,objectToString=objectProto.toString;module.exports=isBoolean}),isBoolean$1=interopDefault(isBoolean),Node=function(EventEmitter$$1){function Node(props){var this$1=this;EventEmitter$$1.call(this);var NodeClass=this.constructor,schema=NodeClass.schema;for(var name in schema)if(schema.hasOwnProperty(name)){var prop=schema[name],propIsGiven=void 0!==props[name],hasDefault=prop.hasOwnProperty("default"),isOptional=prop.optional;if(!isOptional&&!hasDefault&&!propIsGiven)throw new Error("Property "+name+" is mandatory for node type "+this$1.type);propIsGiven?this$1[name]=_checked(prop,props[name]):hasDefault&&(this$1[name]=cloneDeep$1(_checked(prop,prop.default)))}}EventEmitter$$1&&(Node.__proto__=EventEmitter$$1),Node.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),Node.prototype.constructor=Node;var prototypeAccessors={_isNode:{}};return prototypeAccessors._isNode.get=function(){return!0},Node.prototype.dispose=function(){},Node.prototype.isInstanceOf=function(typeName){return Node.isInstanceOf(this.constructor,typeName)},Node.prototype.getTypeNames=function(){for(var typeNames=[],NodeClass=this.constructor;"node"!==NodeClass.type;)typeNames.push(NodeClass.type),NodeClass=Object.getPrototypeOf(NodeClass);return typeNames},Node.prototype.getPropertyType=function(propertyName){var schema=this.constructor.schema;return schema[propertyName].type},Node.prototype.toJSON=function(){var data={type:this.type};return each$2(this.constructor.schema,function(prop,name){data[prop.name]=this[name]}.bind(this)),data},Object.defineProperties(Node.prototype,prototypeAccessors),Node}(EventEmitter);Node.define=Node.defineSchema=function(schema){_defineSchema(this,schema)},Node.define({type:"node",id:"string"}),Object.defineProperty(Node.prototype,"type",{configurable:!1,get:function(){return this.constructor.type},set:function(){throw new Error("read-only")}}),Node.isInstanceOf=function(NodeClass,typeName){for(var type=NodeClass.type;"node"!==type;){if(type===typeName)return!0;var _super=Object.getPrototypeOf(NodeClass.prototype).constructor;if(!_super||!_super.type)break;NodeClass=_super,type=NodeClass.type}return!1};var DocumentNode=function(DataNode){function DocumentNode(doc,props){DataNode.call(this,props),this.document=doc}DataNode&&(DocumentNode.__proto__=DataNode),DocumentNode.prototype=Object.create(DataNode&&DataNode.prototype),DocumentNode.prototype.constructor=DocumentNode;var prototypeAccessors={_isDocumentNode:{}};return prototypeAccessors._isDocumentNode.get=function(){return!0},DocumentNode.prototype.getDocument=function(){return this.document},DocumentNode.prototype.hasParent=function(){return Boolean(this.parent)},DocumentNode.prototype.getParent=function(){return this.document.get(this.parent)},DocumentNode.prototype.hasChildren=function(){return!1},DocumentNode.prototype.getChildIndex=function(child){return-1},DocumentNode.prototype.getChildAt=function(idx){return null},DocumentNode.prototype.getChildCount=function(){return 0},DocumentNode.prototype.getRoot=function(){for(var node=this;node.hasParent();)node=node.getParent();return node},DocumentNode.prototype.setHighlighted=function(highlighted,scope){this.highlighted!==highlighted&&(this.highlightedScope=scope,this.highlighted=highlighted,this.emit("highlighted",highlighted))},DocumentNode.prototype.on=function(eventName,handler,ctx){var match=_matchPropertyEvent(eventName);if(match){var propertyName=match[1];if(this.constructor.schema[propertyName]){var doc=this.getDocument();doc.getEventProxy("path").on([this.id,propertyName],handler,ctx)}}EventEmitter.prototype.on.apply(this,arguments)},DocumentNode.prototype.off=function(ctx,eventName,handler){var doc=this.getDocument(),match=!1;if(eventName?match=_matchPropertyEvent(eventName):doc.getEventProxy("path").off(ctx),match){var propertyName=match[1];doc.getEventProxy("path").off(ctx,[this.id,propertyName],handler)}EventEmitter.prototype.off.apply(this,arguments)},DocumentNode.prototype.connect=function(ctx,handlers){console.warn("DEPRECATED: use Node.on() instead"),each$2(handlers,function(func,name){this.on(name,func,ctx)}.bind(this))},DocumentNode.prototype.disconnect=function(ctx){console.warn("DEPRECATED: use Node.off() instead"),this.off(ctx)},DocumentNode.prototype._onPropertyChange=function(propertyName){var args=[propertyName+":changed"].concat(Array.prototype.slice.call(arguments,1));this.emit.apply(this,args)},DocumentNode.prototype.isBlock=function(){return this.constructor.isBlock},DocumentNode.prototype.isText=function(){return this.constructor.isText},DocumentNode.prototype.isPropertyAnnotation=function(){return this.constructor.isPropertyAnnotation},DocumentNode.prototype.isInline=function(){return this.constructor.isInline},DocumentNode.prototype.isContainerAnnotation=function(){return this.constructor.isContainerAnnotation},Object.defineProperties(DocumentNode.prototype,prototypeAccessors),DocumentNode}(Node);DocumentNode.isBlock=!1,DocumentNode.isText=!1,DocumentNode.isPropertyAnnotation=!1,DocumentNode.isContainerAnnotation=!1,DocumentNode.isInline=!1;var PropertyAnnotation=function(DocumentNode$$1){function PropertyAnnotation(){DocumentNode$$1.apply(this,arguments)}return DocumentNode$$1&&(PropertyAnnotation.__proto__=DocumentNode$$1),PropertyAnnotation.prototype=Object.create(DocumentNode$$1&&DocumentNode$$1.prototype),PropertyAnnotation.prototype.constructor=PropertyAnnotation,PropertyAnnotation.prototype.getText=function(){var doc=this.getDocument();if(!doc)return console.warn("Trying to use an PropertyAnnotation which is not attached to the document."),"";var text=doc.get(this.path);return text.substring(this.startOffset,this.endOffset)},PropertyAnnotation.prototype.canSplit=function(){return!0},PropertyAnnotation.prototype.isAnchor=function(){return!1},PropertyAnnotation.prototype.getSelection=function(){return this.getDocument().createSelection({type:"property",path:this.path,startOffset:this.startOffset,endOffset:this.endOffset})},PropertyAnnotation.prototype.updateRange=function(tx,sel){if(!sel.isPropertySelection())throw new Error("Cannot change to ContainerAnnotation.");isEqual$2(this.startPath,sel.start.path)||tx.set([this.id,"path"],sel.start.path),this.startOffset!==sel.start.offset&&tx.set([this.id,"startOffset"],sel.start.offset),this.endOffset!==sel.end.offset&&tx.set([this.id,"endOffset"],sel.end.offset)},PropertyAnnotation}(DocumentNode);PropertyAnnotation.define({type:"annotation",path:["string"],startOffset:"number",endOffset:"number",_content:{type:"string",optional:!0}}),PropertyAnnotation.isPropertyAnnotation=!0,PropertyAnnotation.prototype._isAnnotation=!0,PropertyAnnotation.prototype._isPropertyAnnotation=!0,Object.defineProperties(PropertyAnnotation.prototype,{startPath:{get:function(){return this.path}},endPath:{get:function(){return this.path}}});var BlockNode=function(DocumentNode$$1){function BlockNode(){DocumentNode$$1.apply(this,arguments)}return DocumentNode$$1&&(BlockNode.__proto__=DocumentNode$$1),BlockNode.prototype=Object.create(DocumentNode$$1&&DocumentNode$$1.prototype),BlockNode.prototype.constructor=BlockNode,BlockNode}(DocumentNode);BlockNode.isBlock=!0;var ParentNodeMixin={hasChildren:function(){return!0},getChildrenProperty:function(){throw new Error("ParentNodeMixin.getChildrenProperty is abstract and must be implemented in "+this.type+".")},getChildIndex:function(child){return this[this.getChildrenProperty()].indexOf(child.id)},getChildren:function(){var doc=this.getDocument(),childrenIds=this[this.getChildrenProperty()];return childrenIds.map(function(id){return doc.get(id)})},getChildAt:function(idx){var children=this[this.getChildrenProperty()];if(idx<0||idx>=children.length)throw new Error("Array index out of bounds: "+idx+", "+children.length);return this.getDocument().get(children[idx])},getChildCount:function(){return this[this.getChildrenProperty()].length},getAddressablePropertyNames:function(){return[this.getChildrenProperty()]}},ContainerAddress=function(pos,offset){this.pos=pos,this.offset=offset};ContainerAddress.prototype.isBefore=function(other,strict){return strict=Boolean(strict),this.pos<other.pos||!(this.pos>other.pos)&&(this.offset<other.offset||!(this.offset>other.offset)&&!strict)},ContainerAddress.prototype.isAfter=function(other,strict){return other.isBefore(this,strict)},ContainerAddress.prototype.isEqual=function(other){return this.pos===other.pos&&this.offset===other.offset},ContainerAddress.prototype.toString=function(){return[this.pos,".",this.offset].join("")};var Container=function(DocumentNode$$1){function Container(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];DocumentNode$$1.apply(this,args),this.document&&!this.document.isTransactionDocument&&this.document.on("document:changed",this._onChange,this)}DocumentNode$$1&&(Container.__proto__=DocumentNode$$1),Container.prototype=Object.create(DocumentNode$$1&&DocumentNode$$1.prototype),Container.prototype.constructor=Container;var prototypeAccessors={_isContainer:{}};return prototypeAccessors._isContainer.get=function(){return!0},Container.prototype.dispose=function(){this.document.off(this)},Container.prototype.getPosition=function(nodeId){if(this.document&&this.document.isTransactionDocument)return this.nodes.indexOf(nodeId);var positions=this._getCachedPositions(),pos=positions[nodeId];return void 0===pos&&(pos=-1),pos},Container.prototype.getNodes=function(){var doc=this.getDocument(),nodes=[];return this.nodes.forEach(function(nodeId){var node=doc.get(nodeId);node?nodes.push(node):console.error("Node does not exist: ",nodeId)}),nodes},Container.prototype.getNodeAt=function(pos){return this.getDocument().get(this.nodes[pos])},Container.prototype.show=function(nodeId,pos){var doc=this.getDocument(),arg1=arguments[0];isString$1(arg1)||arg1._isNode&&(nodeId=arg1.id),isNumber$1(pos)||(pos=this.nodes.length),doc.update(this.getContentPath(),{insert:{offset:pos,value:nodeId}})},Container.prototype.hide=function(nodeId){var doc=this.getDocument(),pos=this.nodes.indexOf(nodeId);pos>=0&&doc.update(this.getContentPath(),{delete:{offset:pos}})},Container.prototype.getAddress=function(coor){if(!coor._isCoordinate)throw new Error("Illegal argument: Container.getAddress(coor) expects a Coordinate instance.");var offset,nodeId=coor.path[0],nodePos=this.getPosition(nodeId);return offset=coor.isNodeCoordinate()?coor.offset>0?Number.MAX_VALUE:0:coor.offset,new ContainerAddress(nodePos,offset)},Container.prototype.getLength=function(){return this.nodes.length},Container.prototype._onChange=function(change){change.isUpdated(this.getContentPath())&&(this.positions=null)},Container.prototype._getCachedPositions=function(){if(!this.positions){var positions={};this.nodes.forEach(function(id,pos){positions[id]=pos}),this.positions=positions}return this.positions},Container.prototype.getContentPath=function(){return[this.id,"nodes"]},Object.defineProperties(Container.prototype,prototypeAccessors),Container}(DocumentNode);extend$1(Container.prototype,ParentNodeMixin),Container.prototype.getChildrenProperty=function(){return"nodes"},Container.define({type:"container",nodes:{type:["id"],default:[]}}),Object.defineProperty(Container.prototype,"length",{get:function(){return console.warn("DEPRECATED: want to get rid of unnecessary properties. Use this.getLength() instead."),this.nodes.length}});var ContainerAnnotation=function(DocumentNode$$1){function ContainerAnnotation(){DocumentNode$$1.apply(this,arguments)}DocumentNode$$1&&(ContainerAnnotation.__proto__=DocumentNode$$1),ContainerAnnotation.prototype=Object.create(DocumentNode$$1&&DocumentNode$$1.prototype),ContainerAnnotation.prototype.constructor=ContainerAnnotation;var prototypeAccessors={_isAnnotation:{},_isContainerAnnotation:{}};return prototypeAccessors._isAnnotation.get=function(){return!0},prototypeAccessors._isContainerAnnotation.get=function(){return!0},ContainerAnnotation.prototype.getText=function(){var doc=this.getDocument();return doc?documentHelpers.getTextForSelection(doc,this.getSelection()):(console.warn("Trying to use a ContainerAnnotation which is not attached to the document."),"")},ContainerAnnotation.prototype.getSelection=function(){var doc=this.getDocument();return doc?doc.createSelection({type:"container",containerId:this.containerId,startPath:this.startPath,startOffset:this.startOffset,endPath:this.endPath,endOffset:this.endOffset}):(console.warn("Trying to use a ContainerAnnotation which is not attached to the document."),Selection.nullSelection())},ContainerAnnotation.prototype.setHighlighted=function(highlighted,scope){this.highlighted!==highlighted&&(this.highlighted=highlighted,this.highlightedScope=scope,this.emit("highlighted",highlighted,scope),each$2(this.fragments,function(frag){frag.emit("highlighted",highlighted,scope)}))},ContainerAnnotation.prototype.updateRange=function(tx,sel){if(!sel.isContainerSelection())throw new Error("Cannot change to ContainerAnnotation.");isEqual$2(this.startPath,sel.start.path)||tx.set([this.id,"startPath"],sel.start.path),this.startOffset!==sel.start.offset&&tx.set([this.id,"startOffset"],sel.start.offset),isEqual$2(this.endPath,sel.end.path)||tx.set([this.id,"endPath"],sel.end.path),this.endOffset!==sel.end.offset&&tx.set([this.id,"endOffset"],sel.end.offset)},ContainerAnnotation.prototype.getFragments=function(){var this$1=this,fragments=[],doc=this.getDocument(),container=doc.get(this.containerId),paths=container.getPathRange(this.startPath,this.endPath);if(1===paths.length)fragments.push(new ContainerAnnotationFragment(this,paths[0],"property"));else if(paths.length>1){fragments.push(new ContainerAnnotationFragment(this,paths[0],"start")),fragments.push(new ContainerAnnotationFragment(this,last$1(paths),"end"));for(var i=1;i<paths.length-1;i++)fragments.push(new ContainerAnnotationFragment(this$1,paths[i],"inner"))}return fragments},ContainerAnnotation.prototype.getStartAnchor=function(){return this._startAnchor||(this._startAnchor=new ContainerAnnotationAnchor(this,"isStart")),this._startAnchor},ContainerAnnotation.prototype.getEndAnchor=function(){return this._endAnchor||(this._endAnchor=new ContainerAnnotationAnchor(this)),this._endAnchor},Object.defineProperties(ContainerAnnotation.prototype,prototypeAccessors),ContainerAnnotation}(DocumentNode);ContainerAnnotation.define({type:"container-annotation",containerId:"string",startPath:["string"],startOffset:"number",endPath:["string"],endOffset:"number"}),ContainerAnnotation.isContainerAnnotation=!0;var ContainerAnnotationAnchor=function(Anchor$$1){function ContainerAnnotationAnchor(anno,isStart){Anchor$$1.call(this,"SKIP"),this.type="container-annotation-anchor",this.anno=anno,this.node=anno,this.id=anno.id,
this.containerId=anno.containerId,this.isStart=Boolean(isStart),Object.freeze(this)}return Anchor$$1&&(ContainerAnnotationAnchor.__proto__=Anchor$$1),ContainerAnnotationAnchor.prototype=Object.create(Anchor$$1&&Anchor$$1.prototype),ContainerAnnotationAnchor.prototype.constructor=ContainerAnnotationAnchor,ContainerAnnotationAnchor.prototype.getTypeNames=function(){return[this.type]},ContainerAnnotationAnchor.prototype.getPath=function(){return this.isStart?this.node.startPath:this.node.endPath},ContainerAnnotationAnchor.prototype.getOffset=function(){return this.isStart?this.node.startOffset:this.node.endOffset},ContainerAnnotationAnchor}(Anchor);Object.defineProperties(ContainerAnnotationAnchor.prototype,{path:{get:function(){return this.getPath()}},offset:{get:function(){return this.getOffset()}}});var ContainerAnnotationFragment=function(EventEmitter$$1){function ContainerAnnotationFragment(anno,path,mode){EventEmitter$$1.call(this),this.type="container-annotation-fragment",this.anno=anno,this.id=anno.id,this.path=path,this.mode=mode}return EventEmitter$$1&&(ContainerAnnotationFragment.__proto__=EventEmitter$$1),ContainerAnnotationFragment.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),ContainerAnnotationFragment.prototype.constructor=ContainerAnnotationFragment,ContainerAnnotationFragment.prototype.getTypeNames=function(){return[this.type]},ContainerAnnotationFragment.prototype.getStartOffset=function(){return"start"===this.mode||"property"===this.mode?this.anno.startOffset:0},ContainerAnnotationFragment.prototype.getEndOffset=function(){var doc=this.anno.getDocument(),textProp=doc.get(this.path),length=textProp.length;return"end"===this.mode||"property"===this.mode?this.anno.endOffset:length},ContainerAnnotationFragment}(EventEmitter);ContainerAnnotationFragment.fragmentation=Number.MAX_VALUE,Object.defineProperties(ContainerAnnotationFragment.prototype,{startOffset:{get:function(){return this.getStartOffset()},set:function(){throw new Error("ContainerAnnotationFragment.startOffset is read-only.")}},endOffset:{get:function(){return this.getEndOffset()},set:function(){throw new Error("ContainerAnnotationFragment.endOffset is read-only.")}},highlighted:{get:function(){return this.anno.highlighted},set:function(){throw new Error("ContainerAnnotationFragment.highlighted is read-only.")}}}),ContainerAnnotation.Anchor=ContainerAnnotationAnchor,ContainerAnnotation.Fragment=ContainerAnnotationFragment;var _obj={},Registry=function(entries,validator){this.entries={},this.names=[],this.validator=validator,entries&&forEach$2(entries,function(entry,name){this.add(name,entry)}.bind(this))},prototypeAccessors$4={_isRegistry:{}};prototypeAccessors$4._isRegistry.get=function(){return!0},Registry.prototype.contains=function(name){return this.entries.hasOwnProperty(name)},Registry.prototype.add=function(name,entry){if(this.validator&&this.validator(entry),_obj[name])throw new Error('Illegal key: "'+name+'" is a property of Object which is thus not allowed as a key.');this.contains(name)&&this.remove(name),this.entries[name]=entry,this.names.push(name)},Registry.prototype.remove=function(name){var pos=this.names.indexOf(name);pos>=0&&this.names.splice(pos,1),delete this.entries[name]},Registry.prototype.clear=function(){this.names=[],this.entries={}},Registry.prototype.get=function(name){return this.entries[name]},Registry.prototype.each=function(callback,ctx){return console.warn("DEPRECATED: use Registry.forEach(cb) instead"),this.forEach(callback.bind(ctx))},Registry.prototype.forEach=function(callback){for(var this$1=this,i=0;i<this.names.length;i++){var name=this$1.names[i],_continue=callback(this$1.entries[name],name);if(_continue===!1)break}},Registry.prototype.map=function(callback){var result=[];return this.forEach(function(entry,name){result.push(callback(entry,name))}),result},Registry.prototype.filter=function(callback){var result=[];return this.forEach(function(entry,name){callback(entry,name)&&result.push(entry)}),result},Object.defineProperties(Registry.prototype,prototypeAccessors$4);var ENTER=1,EXIT=-1,ANCHOR=-2,Fragmenter=function(options){Object.assign(this,options)};Fragmenter.prototype.start=function(rootContext,text,annotations){if(!isString$1(text))throw new Error("Illegal argument: 'text' must be a String, but was "+text);this._start(rootContext,text,annotations)},Fragmenter.prototype.onText=function(context,text,entry){},Fragmenter.prototype.onEnter=function(entry,parentContext){return null},Fragmenter.prototype.onExit=function(entry,context,parentContext){},Fragmenter.prototype._enter=function(entry,parentContext){return entry.counter++,this.onEnter(entry,parentContext)},Fragmenter.prototype._exit=function(entry,context,parentContext){this.onExit(entry,context,parentContext)},Fragmenter.prototype._createText=function(context,text,entry){this.onText(context,text,entry)},Fragmenter.prototype._start=function(rootContext,text,annotations){for(var this$1=this,entries=_extractEntries.call(this,annotations),stack=[{context:rootContext,entry:null}],pos=0,i=0;i<entries.length;i++){var entry=entries[i],textFragment=text.substring(pos,entry.pos);textFragment&&this$1._createText(stack[stack.length-1].context,textFragment,entry),pos=entry.pos;var stackLevel,idx,_entry;if(entry.mode===ENTER||entry.mode===ANCHOR){for(stackLevel=1;stackLevel<stack.length&&!(entry.level<stack[stackLevel].entry.level);stackLevel++);for(idx=stack.length-1;idx>=stackLevel;idx--)_entry=stack[idx].entry,_entry.length=pos-_entry.pos,this$1._exit(_entry,stack[idx].context,stack[idx-1].context);for(stack.splice(stackLevel,0,{entry:entry}),idx=stackLevel;idx<stack.length;idx++)_entry=stack[idx].entry,_entry.pos=pos,stack[idx].context=this$1._enter(_entry,stack[idx-1].context)}if(entry.mode===EXIT||entry.mode===ANCHOR){for(stackLevel=1;stackLevel<stack.length&&stack[stackLevel].entry.node!==entry.node;stackLevel++);for(idx=stack.length-1;idx>=stackLevel;idx--)_entry=stack[idx].entry,_entry.length=pos-_entry.pos,this$1._exit(_entry,stack[idx].context,stack[idx-1].context);for(stack.splice(stackLevel,1),idx=stackLevel;idx<stack.length;idx++)_entry=stack[idx].entry,_entry.pos=pos,stack[idx].context=this$1._enter(_entry,stack[idx-1].context)}}var trailingText=text.substring(pos);trailingText&&this._createText(rootContext,trailingText)},Fragmenter.SHOULD_NOT_SPLIT=0,Fragmenter.NORMAL=10,Fragmenter.ANY=100,Fragmenter.ALWAYS_ON_TOP=Number.MAX_VALUE;var DOMExporter=function(config){if(!config.converters)throw new Error("config.converters is mandatory");config.converters._isRegistry?this.converters=config.converters:(this.converters=new Registry,config.converters.forEach(function(Converter){var converter;return converter="function"==typeof Converter?new Converter:Converter,converter.type?void this.converters.add(converter.type,converter):void console.error("Converter must provide the type of the associated node.",converter)}.bind(this))),this.state={doc:null},this.config=extend$1({idAttribute:"id"},config),this._el=null,this.$$=this.createElement.bind(this)};DOMExporter.prototype.exportDocument=function(doc){return this.convertDocument(doc)},DOMExporter.prototype.convertDocument=function(doc){throw new Error("This method is abstract")},DOMExporter.prototype.convertContainer=function(container){if(!container)throw new Error("Illegal arguments: container is mandatory.");var doc=container.getDocument();this.state.doc=doc;var elements=[];return container.nodes.forEach(function(id){var node=doc.get(id),nodeEl=this.convertNode(node);elements.push(nodeEl)}.bind(this)),elements},DOMExporter.prototype.convertNode=function(node){isString$1(node)?node=this.state.doc.get(node):this.state.doc=node.getDocument();var converter=this.getNodeConverter(node);if(node.isPropertyAnnotation()&&(!converter||!converter.export))return this._convertPropertyAnnotation(node);converter||(converter=this.getDefaultBlockConverter());var el;return el=converter.tagName?this.$$(converter.tagName):this.$$("div"),el.attr(this.config.idAttribute,node.id),el=converter.export?converter.export(node,el,this)||el:this.getDefaultBlockConverter().export(node,el,this)||el},DOMExporter.prototype.convertProperty=function(doc,path,options){this.initialize(doc,options);var wrapper=this.$$("div").append(this.annotatedText(path));return wrapper.innerHTML},DOMExporter.prototype.annotatedText=function(path){var doc=this.state.doc,text=doc.get(path),annotations=doc.getIndex("annotations").get(path);return this._annotatedText(text,annotations)},DOMExporter.prototype.getNodeConverter=function(node){return this.converters.get(node.type)},DOMExporter.prototype.getDefaultBlockConverter=function(){throw new Error("This method is abstract.")},DOMExporter.prototype.getDefaultPropertyAnnotationConverter=function(){throw new Error("This method is abstract.")},DOMExporter.prototype.getDocument=function(){return this.state.doc},DOMExporter.prototype.createElement=function(str){return this._el.createElement(str)},DOMExporter.prototype._annotatedText=function(text,annotations){var self=this,annotator=new Fragmenter;annotator.onText=function(context,text){context.children.push(encodeXMLEntities(text))},annotator.onEnter=function(fragment){var anno=fragment.node;return{annotation:anno,children:[]}},annotator.onExit=function(fragment,context,parentContext){var anno=context.annotation,converter=self.getNodeConverter(anno);converter||(converter=self.getDefaultPropertyAnnotationConverter());var el;el=converter.tagName?this.$$(converter.tagName):this.$$("span"),el.attr(this.config.idAttribute,anno.id),el.append(context.children),converter.export&&(el=converter.export(anno,el,self)||el),parentContext.children.push(el)}.bind(this);var wrapper={children:[]};return annotator.start(wrapper,text,annotations),wrapper.children},DOMExporter.prototype._convertPropertyAnnotation=function(anno){var wrapper=this.$$("div").append(this.annotatedText(anno.path)),el=wrapper.find("["+this.config.idAttribute+'="'+anno.id+'"]');return el};var ArrayIterator=function(arr){this.arr=arr,this.pos=-1},prototypeAccessors$5={_isArrayIterator:{}};prototypeAccessors$5._isArrayIterator.get=function(){return!0},ArrayIterator.prototype.hasNext=function(){return this.pos<this.arr.length-1},ArrayIterator.prototype.next=function next(){this.pos+=1;var next=this.arr[this.pos];return next},ArrayIterator.prototype.back=function(){return this.pos>=0&&(this.pos-=1),this},Object.defineProperties(ArrayIterator.prototype,prototypeAccessors$5);var WS_LEFT=/^\s+/g,WS_LEFT_ALL=/^\s*/g,WS_RIGHT=/\s+$/g,WS_ALL=/\s+/g,SPACE=" ",TABS_OR_NL=/[\t\n\r]+/g,DOMImporter=function DOMImporter(config){if(!config.converters)throw new Error("config.converters is mandatory");this.config=extend$1({idAttribute:"id"},config),this.schema=config.schema,this.state=null,this._defaultBlockConverter=null,this._allConverters=[],this._blockConverters=[],this._propertyAnnotationConverters=[];var schema=this.schema,defaultTextType=schema.getDefaultTextType();config.converters.forEach(function(Converter){var converter;if(converter="function"==typeof Converter?new Converter:Converter,!converter.type)return void console.error("Converter must provide the type of the associated node.",converter);if(!converter.matchElement&&!converter.tagName)return void console.error("Converter must provide a matchElement function or a tagName property.",converter);converter.matchElement||(converter.matchElement=this._defaultElementMatcher.bind(converter));var NodeClass=schema.getNodeClass(converter.type);return NodeClass?(this._defaultBlockConverter||defaultTextType!==converter.type||(this._defaultBlockConverter=converter),this._allConverters.push(converter),void(NodeClass.isPropertyAnnotation?this._propertyAnnotationConverters.push(converter):this._blockConverters.push(converter))):void console.error("No node type defined for converter",converter.type)}.bind(this)),this.state=new DOMImporter.State};DOMImporter.prototype.reset=function(){this.state.reset()},DOMImporter.prototype.createDocument=function(){return this.state.doc=this._createDocument(this.config.schema),this.state.doc},DOMImporter.prototype._createDocument=function(schema){var doc=new this.config.DocumentClass(schema);return doc},DOMImporter.prototype.generateDocument=function(){this.state.doc||(this.state.doc=this.createDocument());var doc=this.state.doc;return this._createNodes(),doc},DOMImporter.prototype._createNodes=function(){var state=this.state,doc=state.doc;state.nodes.forEach(function(node){doc.get(node.id)&&doc.delete(node.id),doc.create(node)}),this._createInlineNodes()},DOMImporter.prototype._createInlineNodes=function(){var state=this.state,doc=state.doc;state.inlineNodes.forEach(function(node){doc.get(node.id)&&doc.delete(node.id),doc.create(node)})},DOMImporter.prototype.convertContainer=function(elements,containerId){var this$1=this,state=this.state;state.container=[],state.containerId=containerId;for(var iterator=new ArrayIterator(elements);iterator.hasNext();){var node,el=iterator.next(),blockTypeConverter=this$1._getConverterForElement(el,"block");if(blockTypeConverter)node=this$1._nodeData(el,blockTypeConverter.type),state.pushContext(el.tagName,blockTypeConverter),node=blockTypeConverter.import(el,node,this$1)||node,state.popContext(),this$1._createAndShow(node);else if(el.isCommentNode());else if(el.isTextNode()){var text=el.textContent;if(/^\s*$/.exec(text))continue;iterator.back(),this$1._wrapInlineElementsIntoBlockElement(iterator)}else el.isElementNode()&&(iterator.back(),this$1._wrapInlineElementsIntoBlockElement(iterator))}var container={type:"container",id:containerId,nodes:this.state.container.slice(0)};return this.createNode(container),container},DOMImporter.prototype.convertElement=function(el){var node,doc=this.state.doc,nodeData=this._convertElement(el);if(doc)node=doc.create(nodeData);else{var NodeClass=this.schema.getNodeClass(nodeData.type);node=new NodeClass(doc,nodeData)}return node},DOMImporter.prototype._convertElement=function(el,mode){var node,converter=this._getConverterForElement(el,mode);if(!converter)throw new Error("No converter found for "+el.tagName);node=this._nodeData(el,converter.type);var NodeClass=this.schema.getNodeClass(node.type);return this.state.pushContext(el.tagName,converter),NodeClass.isInline?this._convertInlineNode(el,node,converter):NodeClass.isPropertyAnnotation?this._convertPropertyAnnotation(el,node):node=converter.import(el,node,this)||node,this.state.popContext(),this.createNode(node),node},DOMImporter.prototype._convertPropertyAnnotation=function(el,node){node.path=[node.id,"_content"],node._content=this.annotatedText(el,node.path),node.startOffset=0,node.endOffset=node._content.length},DOMImporter.prototype._convertInlineNode=function(el,node,converter){return node.path=[node.id,"content"],node._content="$",node.startOffset=0,node.endOffset=1,node=converter.import(el,node,this)},DOMImporter.prototype.createNode=function(node){if(this.state.ids[node.id])throw new Error("Node with id alread exists:"+node.id);return this.state.ids[node.id]=!0,this.state.nodes.push(node),node},DOMImporter.prototype.show=function(node){this.state.container.push(node.id)},DOMImporter.prototype._createAndShow=function(node){this.createNode(node),this.show(node)},DOMImporter.prototype._nodeData=function(el,type){var nodeData={type:type,id:this.getIdForElement(el,type)},NodeClass=this.schema.getNodeClass(type);return forEach$2(NodeClass.schema,function(prop,name){var hasDefault=prop.hasOwnProperty("default");hasDefault&&(nodeData[name]=clone$2(prop.default))}),nodeData},DOMImporter.prototype.annotatedText=function(el,path,options){var state=this.state;if(path)options&&options.preserveWhitespace&&(state.preserveWhitespace=!0),state.stack.push({path:path,offset:0,text:""});else if(0===state.stack.length)throw new Error("Contract: DOMImporter.annotatedText() requires 'path' for non-reentrant call.",el.outerHTML);this.state.lastChar="";var text,iterator=el.getChildNodeIterator();return text=this._annotatedText(iterator),path&&(state.stack.pop(),state.preserveWhitespace=!1),text},DOMImporter.prototype.plainText=function(el){var state=this.state,text=el.textContent;if(state.stack.length>0){var context=last$1(state.stack);context.offset+=text.length,context.text+=context.text.concat(text)}return text},DOMImporter.prototype.customText=function(text){var state=this.state;if(state.stack.length>0){var context=last$1(state.stack);context.offset+=text.length,context.text+=context.text.concat(text)}return text},DOMImporter.prototype.nextId=function(prefix){return this.state.uuid(prefix)},DOMImporter.prototype.getIdForElement=function(el,type){var this$1=this,id=el.getAttribute(this.config.idAttribute);if(id&&!this.state.ids[id])return id;var root=el.getRoot();for(id=this.nextId(type);this.state.ids[id]||root.find("#"+id);)id=this$1.nextId(type);return id},DOMImporter.prototype.defaultConverter=function defaultConverter(el,converter){this.IGNORE_DEFAULT_WARNINGS||console.warn("This element is not handled by the converters you provided. This is the default implementation which just skips conversion. Override DOMImporter.defaultConverter(el, converter) to change this behavior.",el.outerHTML);var defaultTextType=this.schema.getDefaultTextType(),defaultConverter=this._defaultBlockConverter;if(!defaultConverter)throw new Error("Could not find converter for default type ",defaultTextType);var node=this._nodeData(el,defaultTextType);return this.state.pushContext(el.tagName,converter),node=defaultConverter.import(el,node,converter)||node,this.state.popContext(),node},DOMImporter.prototype._defaultElementMatcher=function(el){return el.is(this.tagName)},DOMImporter.prototype._annotatedText=function(iterator){var this$1=this,state=this.state,context=last$1(state.stack);if(!context)throw new Error("Illegal state: context is null.");for(;iterator.hasNext();){var el=iterator.next(),text="";if(el.isTextNode())text=this$1._prepareText(state,el.textContent),text.length&&(context.text=context.text.concat(text),context.offset+=text.length);else{if(el.isCommentNode())continue;if(el.isElementNode()){var inlineTypeConverter=this$1._getConverterForElement(el,"inline");if(!inlineTypeConverter){this$1.IGNORE_DEFAULT_WARNINGS||console.warn("Unsupported inline element. We will not create an annotation for it, but process its children to extract annotated text.",el.outerHTML),this$1.annotatedText(el);continue}var startOffset=context.offset,inlineType=inlineTypeConverter.type,inlineNode=this$1._nodeData(el,inlineType);if(inlineTypeConverter.import){state.stack.push({path:context.path,offset:startOffset,text:""}),state.pushContext(el.tagName,inlineTypeConverter),inlineNode=inlineTypeConverter.import(el,inlineNode,this$1)||inlineNode,state.popContext();var NodeClass=this$1.schema.getNodeClass(inlineType);NodeClass.isInline?this$1.customText("​"):this$1.annotatedText(el);var result=state.stack.pop();context.offset=result.offset,context.text=context.text.concat(result.text)}else this$1.annotatedText(el);var endOffset=context.offset;inlineNode.startOffset=startOffset,inlineNode.endOffset=endOffset,inlineNode.path=context.path.slice(0),state.inlineNodes.push(inlineNode)}else console.warn("Unknown element type. Taking plain text.",el.outerHTML),text=this$1._prepareText(state,el.textContent),context.text=context.text.concat(text),context.offset+=text.length}}return context.text},DOMImporter.prototype._getConverterForElement=function(el,mode){var converters,this$1=this;if("block"===mode){if(!el.tagName)return null;converters=this._blockConverters}else converters="inline"===mode?this._propertyAnnotationConverters:this._allConverters;for(var converter=null,i=0;i<converters.length;i++)if(this$1._converterCanBeApplied(converters[i],el)){converter=converters[i];break}return converter},DOMImporter.prototype._converterCanBeApplied=function(converter,el){return converter.matchElement(el,converter)},DOMImporter.prototype._createElement=function(tagName){return this._el.createElement(tagName)},DOMImporter.prototype._wrapInlineElementsIntoBlockElement=function(childIterator){for(var this$1=this,wrapper=this._createElement("div");childIterator.hasNext();){var el=childIterator.next(),blockTypeConverter=this$1._getConverterForElement(el,"block");if(blockTypeConverter){childIterator.back();break}wrapper.append(el.clone())}var node=this.defaultConverter(wrapper,this);if(node){if(!node.type)throw new Error("Contract: DOMImporter.defaultConverter() must return a node with type.");this._createAndShow(node)}return node},DOMImporter.prototype._createDefaultBlockElement=function(el){var node=this.defaultConverter(el,this);if(node){if(!node.type)throw new Error("Contract: Html.defaultConverter() must return a node with type.",el.outerHTML);node.id=node.id||this.defaultId(el,node.type),this._createAndShow(node)}},DOMImporter.prototype._prepareText=function(state,text){if(state.preserveWhitespace)return text;var repl=SPACE;return text=text.replace(TABS_OR_NL,""),text=state.lastChar===SPACE?text.replace(WS_LEFT_ALL,repl):text.replace(WS_LEFT,repl),text=text.replace(WS_RIGHT,repl),(this.config.REMOVE_INNER_WS||state.removeInnerWhitespace)&&(text=text.replace(WS_ALL,SPACE)),state.lastChar=text[text.length-1]||state.lastChar,text},DOMImporter.prototype._trimTextContent=function(el){var text,trimmed,nodes=el.getChildNodes(),firstNode=nodes[0],lastNode=last$1(nodes);return firstNode&&firstNode.isTextNode()&&(text=firstNode.textContent,trimmed=this._trimLeft(text),firstNode.textContent=trimmed),lastNode&&lastNode.isTextNode()&&(text=lastNode.textContent,trimmed=this._trimRight(text),lastNode.textContent=trimmed),el},DOMImporter.prototype._trimLeft=function(text){return text.replace(WS_LEFT,"")},DOMImporter.prototype._trimRight=function(text){return text.replace(WS_RIGHT,"")};var DOMImporterState=function(){this.reset()};DOMImporterState.prototype.reset=function(){this.preserveWhitespace=!1,this.nodes=[],this.inlineNodes=[],this.containerId=null,this.container=[],this.ids={},this.contexts=[],this.stack=[],this.lastChar="",this.skipTypes={},this.ignoreAnnotations=!1,this.uuid=createCountingIdGenerator()},DOMImporterState.prototype.pushContext=function(tagName,converter){this.contexts.push({tagName:tagName,converter:converter})},DOMImporterState.prototype.popContext=function(){return this.contexts.pop()},DOMImporterState.prototype.getCurrentContext=function(){return last$1(this.contexts)},DOMImporter.State=DOMImporterState;var inBrowser="undefined"!=typeof window,_baseFindIndex=createCommonjsModule(function(module){function baseFindIndex(array,predicate,fromIndex,fromRight){for(var length=array.length,index=fromIndex+(fromRight?1:-1);fromRight?index--:++index<length;)if(predicate(array[index],index,array))return index;return-1}module.exports=baseFindIndex}),_baseFindIndex$1=interopDefault(_baseFindIndex),require$$2$28=Object.freeze({default:_baseFindIndex$1}),findIndex=createCommonjsModule(function(module){function findIndex(array,predicate,fromIndex){var length=array?array.length:0;if(!length)return-1;var index=null==fromIndex?0:toInteger(fromIndex);return index<0&&(index=nativeMax(length+index,0)),baseFindIndex(array,baseIteratee(predicate,3),index)}var baseFindIndex=interopDefault(require$$2$28),baseIteratee=interopDefault(require$$2$6),toInteger=interopDefault(require$$1$25),nativeMax=Math.max;module.exports=findIndex}),findIndex$1=interopDefault(findIndex),require$$0$56=Object.freeze({default:findIndex$1}),NOT_IMPLEMENTED="This method is not implemented.",DOMElement=function(){};DOMElement.prototype.getNativeElement=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.hasClass=function(className){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.addClass=function(classString){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.removeClass=function(classString){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.attr=function(){if(1===arguments.length){if(isString$1(arguments[0]))return this.getAttribute(arguments[0]);isObject$1(arguments[0])&&forEach$2(arguments[0],function(value,name){this.setAttribute(name,value)}.bind(this))}else 2===arguments.length&&this.setAttribute(arguments[0],arguments[1]);return this},DOMElement.prototype.removeAttr=function(name){var names=name.split(/\s+/);return 1===names.length?this.removeAttribute(name):names.forEach(function(name){this.removeAttribute(name)}.bind(this)),this},DOMElement.prototype.getAttribute=function(name){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.setAttribute=function(name,value){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.removeAttribute=function(name){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.getAttributes=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.htmlProp=function(){if(1===arguments.length){if(isString$1(arguments[0]))return this.getProperty(arguments[0]);isObject$1(arguments[0])&&forEach$2(arguments[0],function(value,name){this.setProperty(name,value)}.bind(this))}else 2===arguments.length&&this.setProperty(arguments[0],arguments[1]);return this},DOMElement.prototype.getProperty=function(name){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.setProperty=function(name,value){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.removeProperty=function(name){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.getTagName=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.setTagName=function(tagName){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.getId=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.setId=function(id){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.val=function(value){return 0===arguments.length?this.getValue():(this.setValue(value),this)},DOMElement.prototype.getValue=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.setValue=function(value){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.css=function(){if(1===arguments.length){if(isString$1(arguments[0]))return this.getStyle(arguments[0]);if(!isObject$1(arguments[0]))throw new Error("Illegal arguments.");forEach$2(arguments[0],function(value,name){this.setStyle(name,value)}.bind(this))}else{if(2!==arguments.length)throw new Error("Illegal arguments.");this.setStyle(arguments[0],arguments[1])}return this},DOMElement.prototype.getStyle=function(name){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.setStyle=function(name,value){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.text=function text(text){return 0===arguments.length?this.getTextContent():(this.setTextContent(text),this)},DOMElement.prototype.getTextContent=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.setTextContent=function(text){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.html=function html(html){return 0===arguments.length?this.getInnerHTML():(this.setInnerHTML(html),this)},DOMElement.prototype.getInnerHTML=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.setInnerHTML=function(html){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.getOuterHTML=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.on=function(eventName,handler,context,options){if(!isString$1(eventName))throw new Error('Illegal argument: "event" must be a String.');if(options=options||{},context&&(options.context=context),options.selector&&!isString$1(options.selector))throw new Error("Illegal argument: selector must be a string.");if(!handler||!isFunction$1(handler))throw new Error("Illegal argument: invalid handler function for event "+eventName);return this.addEventListener(eventName,handler,options),this},DOMElement.prototype.off=function(eventName,handler){if(1!==arguments.length||isString$1(eventName))this.removeEventListener(eventName,handler);else{var context=arguments[0];this.getEventListeners().filter(function(l){return l.context===context}).forEach(function(l){this.removeEventListener(l)}.bind(this))}return this},DOMElement.prototype.addEventListener=function(eventName,handler,options){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.removeEventListener=function(eventName,handler){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.getEventListeners=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.getNodeType=function(){if(this.isTextNode())return"text";if(this.isCommentNode())return"comment";if(this.isElementNode())return"element";if(this.isDocumentNode())return"document";throw new Error("Unsupported node type")},DOMElement.prototype.getChildCount=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.getChildNodes=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.getChildren=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.getChildAt=function(pos){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.getChildIndex=function(child){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.getChildNodeIterator=function(){return new ArrayIterator(this.getChildNodes())},DOMElement.prototype.getLastChild=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.getFirstChild=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.getNextSibling=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.getPreviousSibling=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.isTextNode=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.isElementNode=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.isCommentNode=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.isDocumentNode=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.clone=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.createElement=function(str){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.createTextNode=function(text){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.is=function(cssSelector){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.getParent=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.getRoot=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.find=function(cssSelector){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.findAll=function(cssSelector){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.append=function(child){var children;if(1===arguments.length){if(!isArray$1(child))return this.appendChild(child),this;children=child}else children=arguments;return children&&Array.prototype.forEach.call(children,this.appendChild.bind(this)),this},DOMElement.prototype.appendChild=function(child){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.insertAt=function(pos,child){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.insertBefore=function(newChild,before){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.removeAt=function(pos){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.removeChild=function(child){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.replaceChild=function(oldChild,newChild){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.remove=function(){var parent=this.getParent();parent&&parent.removeChild(this)},DOMElement.prototype.empty=function(){throw new Error(NOT_IMPLEMENTED)},DOMElement.prototype.serialize=function(){return this.outerHTML},DOMElement.prototype.isInDocument=function(){return!1},DOMElement.prototype.focus=function(){return this},DOMElement.prototype.blur=function(){return this},DOMElement.prototype.click=function(){return this},DOMElement.prototype.getWidth=function(){return 0},DOMElement.prototype.getHeight=function(){return 0},DOMElement.prototype.getOuterHeight=function(withMargin){return 0},DOMElement.prototype.getOffset=function(){return{top:0,left:0}},DOMElement.prototype.getPosition=function(){return{top:0,left:0}},DOMElement.prototype.getElementFactory=function(){return this.createElement.bind(this)};var _propertyDefinitions={id:{configurable:!0,get:function(){return this.getId();
},set:function(id){this.setId(id)}},tagName:{configurable:!0,get:function(){return this.getTagName()},set:function(tagName){this.setTagName(tagName)}},nodeName:{configurable:!0,get:function(){return this.getTagName()}},nodeType:{configurable:!0,get:function(){return this.getNodeType()},set:function(){throw new Error("ui/DOMElement#nodeType is readonly.")}},textContent:{configurable:!0,get:function(){return this.getTextContent()},set:function(text){this.setTextContent(text)}},innerHTML:{configurable:!0,get:function(){return this.getInnerHTML()},set:function(html){this.setInnerHTML(html)}},outerHTML:{configurable:!0,get:function(){return this.getOuterHTML()},set:function(){throw new Error("ui/DOMElement#outerHTML is readonly.")}},childNodes:{configurable:!0,get:function(){return this.getChildNodes()},set:function(){throw new Error("ui/DOMElement#childNodes is readonly.")}},children:{configurable:!0,get:function(){return this.getChildren()},set:function(){throw new Error("ui/DOMElement#children is readonly.")}},parentNode:{configurable:!0,get:function(){return this.getParent()},set:function(){throw new Error("ui/DOMElement#parentNode is readonly.")}},height:{configurable:!0,get:function(){return this.getHeight()}},width:{configurable:!0,get:function(){return this.getWidth()}}};DOMElement.prototype._isDOMElement=!0,DOMElement._propertyNames=Object.keys(_propertyDefinitions),DOMElement._defineProperties=function(DOMElementClass,propertyNames){propertyNames=propertyNames||DOMElement._propertyNames,propertyNames.forEach(function(name){var def=_propertyDefinitions[name];def&&Object.defineProperty(DOMElementClass.prototype,name,def)})};var DOMElementDelegator=function(DOMElement){function DOMElementDelegator(){DOMElement.call(this),this.el=null}return DOMElement&&(DOMElementDelegator.__proto__=DOMElement),DOMElementDelegator.prototype=Object.create(DOMElement&&DOMElement.prototype),DOMElementDelegator.prototype.constructor=DOMElementDelegator,DOMElementDelegator}(DOMElement),_delegators={getNativeElement:null,hasClass:!1,getAttribute:null,getAttributes:{},getProperty:null,getTagName:"throw",getId:"throw",getValue:null,getStyle:null,getTextContent:"",getInnerHTML:"",getOuterHTML:"",getChildCount:0,getChildNodes:[],getChildren:[],getChildAt:null,getParent:null,getRoot:null,getEventListeners:[],find:null,findAll:[],is:!1,isTextNode:!1,isElementNode:!1,isCommentNode:!1,isDocumentNode:!1,isInDocument:!1,position:null};forEach$2(_delegators,function(defaultValue,method){DOMElementDelegator.prototype[method]=function(){if(!this.el){if("throw"===defaultValue)throw new Error("This component has not been rendered yet.");return defaultValue}return this.el[method].apply(this.el,arguments)}}),["addClass","removeClass","setAttribute","removeAttribute","setProperty","removeProperty","setTagName","setId","setValue","setStyle","setTextContent","setInnerHTML","addEventListener","removeEventListener","appendChild","insertAt","insertBefore","remove","removeAt","removeChild","replaceChild","empty","focus","blur","click"].forEach(function(method){DOMElementDelegator.prototype[method]=function(){if(!this.el)throw new Error("This component has not been rendered yet.");return this.el[method].apply(this.el,arguments),this}}),DOMElement.Delegator=DOMElementDelegator;var DOMEventListener=function(eventName,handler,options){if(!isString$1(eventName)||!isFunction$1(handler))throw new Error("Illegal arguments: 'eventName' must be a String, and 'handler' must be a Function.");options=options||{};var origHandler=handler,context=options.context,capture=Boolean(options.capture);context&&(handler=handler.bind(context)),options.once===!0&&(handler=_once(this,handler)),this.eventName=eventName,this.originalHandler=origHandler,this.handler=handler,this.capture=capture,this.context=context,this.options=options,this._el=null},prototypeAccessors$6={_isDOMEventListener:{}};prototypeAccessors$6._isDOMEventListener.get=function(){return!0},Object.defineProperties(DOMEventListener.prototype,prototypeAccessors$6),DOMEventListener.matches=function(l1,l2){return l1.eventName===l2.eventName&&l1.originalHandler===l2.originalHandler},DOMElement.EventListener=DOMEventListener,DOMElement._findEventListenerIndex=function(eventListeners,eventName,handler){var idx=-1;return idx=arguments[1]._isDOMEventListener?eventListeners.indexOf(arguments[1]):findIndex$1(eventListeners,DOMEventListener.matches.bind(null,{eventName:eventName,originalHandler:handler}))};var TextNode$1=function(){},prototypeAccessors$1$1={_isDOMElement:{}};prototypeAccessors$1$1._isDOMElement.get=function(){return!0},TextNode$1.prototype.isTextNode=function(){return!0},TextNode$1.prototype.getNodeType=function(){return"text"},TextNode$1.prototype.isElementNode=function(){return!1},TextNode$1.prototype.isDocumentNode=function(){return!1},TextNode$1.prototype.isCommentNode=function(){return!1},Object.defineProperties(TextNode$1.prototype,prototypeAccessors$1$1),["getParent","getNextSibling","getPreviousSibling","text","getTextContent","setTextContent","clone"].forEach(function(name){TextNode$1.prototype[name]=DOMElement.prototype[name]}),DOMElement.TextNode=TextNode$1;var BrowserDOMElement=function(DOMElement$$1){function BrowserDOMElement(el){DOMElement$$1.call(this),console.assert(el instanceof window.Node,"Expecting native DOM node."),this.el=el,el._wrapper=this,this.eventListeners=[],this.htmlProps={}}DOMElement$$1&&(BrowserDOMElement.__proto__=DOMElement$$1),BrowserDOMElement.prototype=Object.create(DOMElement$$1&&DOMElement$$1.prototype),BrowserDOMElement.prototype.constructor=BrowserDOMElement;var prototypeAccessors={_isBrowserDOMElement:{}};return prototypeAccessors._isBrowserDOMElement.get=function(){return!0},BrowserDOMElement.prototype.getNativeElement=function(){return this.el},BrowserDOMElement.prototype.hasClass=function(className){return this.el.classList.contains(className)},BrowserDOMElement.prototype.addClass=function(className){return this.el.classList.add(className),this},BrowserDOMElement.prototype.removeClass=function(className){return this.el.classList.remove(className),this},BrowserDOMElement.prototype.getClasses=function(){return this.el.className},BrowserDOMElement.prototype.setClasses=function(classString){return this.el.className=classString,this},BrowserDOMElement.prototype.getAttribute=function(name){return this.el.getAttribute(name)},BrowserDOMElement.prototype.setAttribute=function(name,value){return this.el.setAttribute(name,value),this},BrowserDOMElement.prototype.removeAttribute=function(name){return this.el.removeAttribute(name),this},BrowserDOMElement.prototype.getAttributes=function(){for(var result={},attributes=this.el.attributes,l=attributes.length,i=0;i<l;i++){var attr=attributes.item(i);result[attr.name]=attr.value}return result},BrowserDOMElement.prototype.getProperty=function(name){return this.el[name]},BrowserDOMElement.prototype.setProperty=function(name,value){return this.htmlProps[name]=value,this.el[name]=value,this},BrowserDOMElement.prototype.removeProperty=function(name){return delete this.htmlProps[name],delete this.el[name],this},BrowserDOMElement.prototype.getTagName=function(){if(this.el.tagName)return this.el.tagName.toLowerCase()},BrowserDOMElement.prototype.setTagName=function(tagName){var i,this$1=this,newEl=BrowserDOMElement.createElement(tagName),attributes=this.el.attributes,l=attributes.length;for(i=0;i<l;i++){var attr=attributes.item(i);newEl.setAttribute(attr.name,attr.value)}for(var key in this.htmlProps)this$1.htmlProps.hasOwnProperty(key)&&(newEl[key]=this$1.htmlProps[key]);return this.eventListeners.forEach(function(listener){newEl.addEventListener(listener.eventName,listener.handler,listener.capture)}),newEl.append(this.getChildNodes()),this._replaceNativeEl(newEl.getNativeElement()),this},BrowserDOMElement.prototype.getId=function(){return this.el.id},BrowserDOMElement.prototype.setId=function(id){return this.el.id=id,this},BrowserDOMElement.prototype.getValue=function(){return this.el.value},BrowserDOMElement.prototype.setValue=function(value){return this.el.value=value,this},BrowserDOMElement.prototype.getStyle=function(name){var style=this.getComputedStyle();return style[name]||this.el.style[name]},BrowserDOMElement.prototype.getComputedStyle=function(){return window.getComputedStyle(this.el)},BrowserDOMElement.prototype.setStyle=function(name,value){var _pxStyles={top:!0,bottom:!0,left:!0,right:!0,height:!0,width:!0};return _pxStyles[name]&&isNumber$1(value)&&(value+="px"),this.el.style[name]=value,this},BrowserDOMElement.prototype.getTextContent=function(){return this.el.textContent},BrowserDOMElement.prototype.setTextContent=function(text){return this.el.textContent=text,this},BrowserDOMElement.prototype.getInnerHTML=function(){var innerHTML=this.el.innerHTML;if(!isString$1(innerHTML)){for(var frag=this.el.ownerDocument.createDocumentFragment(),c=this.el.firstChild;c;c=c.nextSibling)frag.appendChild(c.cloneNode(!0));var xs=new window.XMLSerializer;innerHTML=xs.serializeToString(frag)}return innerHTML},BrowserDOMElement.prototype.setInnerHTML=function(html){return this.el.innerHTML=html,this},BrowserDOMElement.prototype.getOuterHTML=function(){var outerHTML=this.el.outerHTML;if(!isString$1(outerHTML)){var xs=new window.XMLSerializer;outerHTML=xs.serializeToString(this.el)}return outerHTML},BrowserDOMElement.prototype.addEventListener=function(eventName,handler,options){var listener;return listener=1===arguments.length&&arguments[0]?arguments[0]:new DOMElement$$1.EventListener(eventName,handler,options),listener.options.selector&&!listener.__hasEventDelegation__&&(listener.handler=this._delegatedHandler(listener),listener.__hasEventDelegation__=!0),this.el.addEventListener(listener.eventName,listener.handler,listener.capture),listener._el=this,this.eventListeners.push(listener),this},BrowserDOMElement.prototype._delegatedHandler=function(listener){var handler=listener.handler,context=listener.context,selector=listener.options.selector,nativeTop=this.getNativeElement();return function(event){for(var nativeEl=event.target;nativeEl;){if(matches(nativeEl,selector)){handler(new DelegatedEvent(context,event.target,event));break}if(nativeEl===nativeTop)break;nativeEl=nativeEl.parentNode}}},BrowserDOMElement.prototype.removeEventListener=function(eventName,handler){var listener=null,idx=-1;return idx=DOMElement$$1._findEventListenerIndex(this.eventListeners,eventName,handler),listener=this.eventListeners[idx],idx>-1&&(this.eventListeners.splice(idx,1),listener._el=null,this.el.removeEventListener(listener.eventName,listener.handler)),this},BrowserDOMElement.prototype.removeAllEventListeners=function(){for(var this$1=this,i=0;i<this.eventListeners.length;i++){var listener=this$1.eventListeners[i];listener._el=null,this$1.el.removeEventListener(listener.eventName,listener.handler)}this.eventListeners=[]},BrowserDOMElement.prototype.getEventListeners=function(){return this.eventListeners},BrowserDOMElement.prototype.getChildCount=function(){return this.el.childNodes.length},BrowserDOMElement.prototype.getChildNodes=function(){for(var childNodes=[],node=this.el.firstChild;node;node=node.nextSibling)childNodes.push(BrowserDOMElement.wrapNativeElement(node));return childNodes},BrowserDOMElement.prototype.getChildren=function(){for(var children=[],node=this.el.firstChild;node;node=node.nextSibling)node.nodeType===window.Node.ELEMENT_NODE&&children.push(BrowserDOMElement.wrapNativeElement(node));return children},BrowserDOMElement.prototype.getChildAt=function(pos){return BrowserDOMElement.wrapNativeElement(this.el.childNodes[pos])},BrowserDOMElement.prototype.getChildIndex=function(child){if(!child._isBrowserDOMElement)throw new Error("Expecting a BrowserDOMElement instance.");return Array.prototype.indexOf.call(this.el.childNodes,child.el)},BrowserDOMElement.prototype.getFirstChild=function(){var firstChild=this.el.firstChild;return firstChild?BrowserDOMElement.wrapNativeElement(firstChild):null},BrowserDOMElement.prototype.getLastChild=function(){var lastChild=this.el.lastChild;return lastChild?BrowserDOMElement.wrapNativeElement(lastChild):null},BrowserDOMElement.prototype.getNextSibling=function(){var next=this.el.nextSibling;return next?BrowserDOMElement.wrapNativeElement(next):null},BrowserDOMElement.prototype.getPreviousSibling=function(){var previous=this.el.previousSibling;return previous?BrowserDOMElement.wrapNativeElement(previous):null},BrowserDOMElement.prototype.isTextNode=function(){return this.el.nodeType===window.Node.TEXT_NODE},BrowserDOMElement.prototype.isElementNode=function(){return this.el.nodeType===window.Node.ELEMENT_NODE},BrowserDOMElement.prototype.isCommentNode=function(){return this.el.nodeType===window.Node.COMMENT_NODE},BrowserDOMElement.prototype.isDocumentNode=function(){return this.el.nodeType===window.Node.DOCUMENT_NODE},BrowserDOMElement.prototype.clone=function clone(){var clone=this.el.cloneNode(!0);return BrowserDOMElement.wrapNativeElement(clone)},BrowserDOMElement.prototype.createElement=function(tagName){var el=this.el.ownerDocument.createElement(tagName);return BrowserDOMElement.wrapNativeElement(el)},BrowserDOMElement.prototype.createTextNode=function(text){var el=this.el.ownerDocument.createTextNode(text);return BrowserDOMElement.wrapNativeElement(el)},BrowserDOMElement.prototype.is=function(cssSelector){var el=this.el;return!!this.isElementNode()&&matches(el,cssSelector)},BrowserDOMElement.prototype.getParent=function(){var parent=this.el.parentNode;return parent?BrowserDOMElement.wrapNativeElement(parent):null},BrowserDOMElement.prototype.getRoot=function(){for(var el=this.el,parent=el;parent;)el=parent,parent=el.parentNode;return BrowserDOMElement.wrapNativeElement(el)},BrowserDOMElement.prototype.find=function(cssSelector){var result=null;return this.el.querySelector&&(result=this.el.querySelector(cssSelector)),result?BrowserDOMElement.wrapNativeElement(result):null},BrowserDOMElement.prototype.findAll=function(cssSelector){var result=[];return this.el.querySelectorAll&&(result=this.el.querySelectorAll(cssSelector)),Array.prototype.map.call(result,function(el){return BrowserDOMElement.wrapNativeElement(el)})},BrowserDOMElement.prototype._normalizeChild=function(child){if(child instanceof window.Node){if(child._wrapper)return child;child=BrowserDOMElement.wrapNativeElement(child)}if(isString$1(child)&&(child=this.createTextNode(child)),!child||!child._isBrowserDOMElement)throw new Error("Illegal child type.");return child.el._wrapper||(child.el._wrapper=child),console.assert(child.el._wrapper===child,"The backlink to the wrapper should be consistent"),child.getNativeElement()},BrowserDOMElement.prototype.appendChild=function(child){var nativeChild=this._normalizeChild(child);return this.el.appendChild(nativeChild),this},BrowserDOMElement.prototype.insertAt=function(pos,child){var nativeChild=this._normalizeChild(child),childNodes=this.el.childNodes;return pos>=childNodes.length?this.el.appendChild(nativeChild):this.el.insertBefore(nativeChild,childNodes[pos]),this},BrowserDOMElement.prototype.insertBefore=function(child,before){if(!before||!before._isBrowserDOMElement)throw new Error('insertBefore(): Illegal arguments. "before" must be a BrowserDOMElement instance.');var nativeChild=this._normalizeChild(child);return this.el.insertBefore(nativeChild,before.el),this},BrowserDOMElement.prototype.removeAt=function(pos){return this.el.removeChild(this.el.childNodes[pos]),this},BrowserDOMElement.prototype.removeChild=function(child){if(!child||!child._isBrowserDOMElement)throw new Error("removeChild(): Illegal arguments. Expecting a BrowserDOMElement instance.");return this.el.removeChild(child.el),this},BrowserDOMElement.prototype.replaceChild=function(oldChild,newChild){if(!(newChild&&oldChild&&newChild._isBrowserDOMElement&&oldChild._isBrowserDOMElement))throw new Error("replaceChild(): Illegal arguments. Expecting BrowserDOMElement instances.");return this.el.replaceChild(newChild.el,oldChild.el),this},BrowserDOMElement.prototype.empty=function(){for(var el=this.el;el.lastChild;)el.removeChild(el.lastChild);return this},BrowserDOMElement.prototype.remove=function(){return this.el.parentNode&&this.el.parentNode.removeChild(this.el),this},BrowserDOMElement.prototype.serialize=function(){var outerHTML=this.el.outerHTML;if(isString$1(outerHTML))return outerHTML;var xs=new window.XMLSerializer;return xs.serializeToString(this.el)},BrowserDOMElement.prototype.isInDocument=function(){for(var el=this.el;el;){if(el.nodeType===window.Node.DOCUMENT_NODE)return!0;el=el.parentNode}},BrowserDOMElement.prototype._replaceNativeEl=function(newEl){console.assert(newEl instanceof window.Node,"Expecting a native element.");var oldEl=this.el,parentNode=oldEl.parentNode;parentNode&&parentNode.replaceChild(newEl,oldEl),this.el=newEl,this.el._wrapper=this},BrowserDOMElement.prototype._getChildNodeCount=function(){return this.el.childNodes.length},BrowserDOMElement.prototype.focus=function(){return this.el.focus(),this},BrowserDOMElement.prototype.blur=function(){return this.el.focus(),this},BrowserDOMElement.prototype.click=function(){return this.el.click(),this},BrowserDOMElement.prototype.getWidth=function(){var rect=this.el.getClientRects()[0];return rect?rect.width:0},BrowserDOMElement.prototype.getHeight=function(){var rect=this.el.getClientRects()[0];return rect?rect.height:0},BrowserDOMElement.prototype.getOffset=function(){var rect=this.el.getBoundingClientRect();return{top:rect.top+document.body.scrollTop,left:rect.left+document.body.scrollLeft}},BrowserDOMElement.prototype.getPosition=function(){return{left:this.el.offsetLeft,top:this.el.offsetTop}},BrowserDOMElement.prototype.getOuterHeight=function(withMargin){var outerHeight=this.el.offsetHeight;if(withMargin){var style=this.getComputedStyle();outerHeight+=parseInt(style.marginTop,10)+parseInt(style.marginBottom,10)}return outerHeight},Object.defineProperties(BrowserDOMElement.prototype,prototypeAccessors),BrowserDOMElement}(DOMElement);DOMElement._defineProperties(BrowserDOMElement,DOMElement._propertyNames),BrowserDOMElement.createTextNode=function(text){return BrowserDOMElement.wrapNativeElement(window.document.createTextNode(text))},BrowserDOMElement.createElement=function(tagName){return BrowserDOMElement.wrapNativeElement(window.document.createElement(tagName))},BrowserDOMElement.parseMarkup=function(str,format,isFullDoc){var doc,nativeEls=[];if(!str)return doc="xml"===format?(new window.DOMParser).parseFromString("<dummy/>","text/xml"):(new window.DOMParser).parseFromString("<html></html>","text/html"),new BrowserDOMElement(doc);var parser=new window.DOMParser;if("html"===format?(isFullDoc=str.search(/<\s*html/i)>=0,doc=parser.parseFromString(str,"text/html")):"xml"===format&&(doc=parser.parseFromString(str,"text/xml")),!doc)throw new Error("Could not parse DOM string.");var parserError=doc.querySelector("parsererror");if(parserError)throw new Error("ParserError: could not parse "+str);if("html"===format)if(isFullDoc)nativeEls=[doc.querySelector("html")];else{var body=doc.querySelector("body");nativeEls=body.childNodes}else"xml"===format&&(nativeEls=isFullDoc?[doc]:doc.childNodes);var elements=Array.prototype.map.call(nativeEls,function(el){return new BrowserDOMElement(el)});return 1===elements.length?elements[0]:elements};var TextNode=function(superclass){function TextNode(nativeEl){superclass.call(this),console.assert(nativeEl instanceof window.Node&&3===nativeEl.nodeType,"Expecting native TextNode."),this.el=nativeEl,nativeEl._wrapper=this;var methods=["getParent","getNextSibling","getPreviousSibling","getTextContent","setTextContent","getInnerHTML","setInnerHTML","getOuterHTML","getNativeElement","clone"];methods.forEach(function(name){this[name]=BrowserDOMElement.prototype[name]}.bind(this))}superclass&&(TextNode.__proto__=superclass),TextNode.prototype=Object.create(superclass&&superclass.prototype),TextNode.prototype.constructor=TextNode;var prototypeAccessors$1={_isBrowserDOMElement:{}};return prototypeAccessors$1._isBrowserDOMElement.get=function(){return!0},Object.defineProperties(TextNode.prototype,prototypeAccessors$1),TextNode}(DOMElement.TextNode);DOMElement._defineProperties(TextNode,["nodeType","textContent","innerHTML","outerHTML","parentNode"]),BrowserDOMElement.TextNode=TextNode,BrowserDOMElement.wrapNativeElement=function(el){return el?el._wrapper?el._wrapper:el instanceof window.Node?3===el.nodeType?new TextNode(el):new BrowserDOMElement(el):el===window?BrowserDOMElement.getBrowserWindow():void 0:null};var BrowserWindow=function(){this.el=window,window.__BrowserDOMElementWrapper__=this,this.eventListeners=[],this.getEventListeners=BrowserDOMElement.prototype.getEventListeners};BrowserWindow.prototype.on=function(){return BrowserDOMElement.prototype.on.apply(this,arguments)},BrowserWindow.prototype.off=function(){return BrowserDOMElement.prototype.off.apply(this,arguments)},BrowserWindow.prototype.addEventListener=function(){return BrowserDOMElement.prototype.addEventListener.apply(this,arguments)},BrowserWindow.prototype.removeEventListener=function(){return BrowserDOMElement.prototype.removeEventListener.apply(this,arguments)},BrowserDOMElement.getBrowserWindow=function(){return window.__BrowserDOMElementWrapper__?window.__BrowserDOMElementWrapper__:new BrowserWindow(window)};var _r1,_r2;BrowserDOMElement.isReverse=function(anchorNode,anchorOffset,focusNode,focusOffset){if(focusNode&&anchorNode){_r1||(_r1=window.document.createRange(),_r2=window.document.createRange()),_r1.setStart(anchorNode.getNativeElement(),anchorOffset),_r2.setStart(focusNode.getNativeElement(),focusOffset);var cmp=_r1.compareBoundaryPoints(window.Range.START_TO_START,_r2);if(1===cmp)return!0}return!1},BrowserDOMElement.getWindowSelection=function(){var nativeSel=window.getSelection(),result={anchorNode:BrowserDOMElement.wrapNativeElement(nativeSel.anchorNode),anchorOffset:nativeSel.anchorOffset,focusNode:BrowserDOMElement.wrapNativeElement(nativeSel.focusNode),focusOffset:nativeSel.focusOffset};return result};var CheerioDOMElement=function(DOMElement$$1){function CheerioDOMElement(el){DOMElement$$1.call(this),this.el=el,this.$el=$(el),el._wrapper=this,this.htmlProps={}}DOMElement$$1&&(CheerioDOMElement.__proto__=DOMElement$$1),CheerioDOMElement.prototype=Object.create(DOMElement$$1&&DOMElement$$1.prototype),CheerioDOMElement.prototype.constructor=CheerioDOMElement;var prototypeAccessors={_isCheerioDOMElement:{}};return prototypeAccessors._isCheerioDOMElement.get=function(){return!0},CheerioDOMElement.prototype.getNativeElement=function(){return this.el},CheerioDOMElement.prototype._wrapNativeElement=function(el){return el._wrapper?el._wrapper:new CheerioDOMElement(el)},CheerioDOMElement.prototype.hasClass=function(className){return this.$el.hasClass(className)},CheerioDOMElement.prototype.addClass=function(className){return this.$el.addClass(className),this},CheerioDOMElement.prototype.removeClass=function(className){return this.$el.removeClass(className),this},CheerioDOMElement.prototype.getClasses=function(){return this.$el.attr("class")},CheerioDOMElement.prototype.setClasses=function(classString){return this.$el.attr("class",classString),this},CheerioDOMElement.prototype.getAttribute=function(name){return this.$el.attr(name)},CheerioDOMElement.prototype.setAttribute=function(name,value){return this.$el.attr(name,value),this},CheerioDOMElement.prototype.removeAttribute=function(name){return this.$el.removeAttr(name),this},CheerioDOMElement.prototype.getAttributes=function(){var attributes=clone$2(this.el.attribs);return attributes},CheerioDOMElement.prototype.getProperty=function(name){return this.$el.prop(name)},CheerioDOMElement.prototype.setProperty=function(name,value){return this.htmlProps[name]=value,this.$el.prop(name,value),this},CheerioDOMElement.prototype.removeProperty=function(name){return delete this.htmlProps[name],delete this.el[name],this},CheerioDOMElement.prototype.getTagName=function(){return"tag"!==this.el.type?"":this.el.name.toLowerCase()},CheerioDOMElement.prototype.setTagName=function(tagName){var newEl=$._createElement(tagName,this.el.root),$newEl=$(newEl);return $newEl.html(this.$el.html()),newEl.attribs=extend$1({},this.el.attribs),this._replaceNativeEl(newEl),this},CheerioDOMElement.prototype.getId=function(){return this.$el.attr("id")},CheerioDOMElement.prototype.setId=function(id){return this.$el.attr("id",id),this},CheerioDOMElement.prototype.getTextContent=function(){return this.$el.text()},CheerioDOMElement.prototype.setTextContent=function(text){return this.$el.text(text),this},CheerioDOMElement.prototype.getInnerHTML=function(){return this.$el.html()},CheerioDOMElement.prototype.setInnerHTML=function(html){return this.$el.html(html),this},CheerioDOMElement.prototype.getOuterHTML=function(){return $._serialize(this.el)},CheerioDOMElement.prototype.getValue=function(){return this.$el.val()},CheerioDOMElement.prototype.setValue=function(value){return this.$el.val(value),this},CheerioDOMElement.prototype.getStyle=function(name){return this.$el.css(name)},CheerioDOMElement.prototype.setStyle=function(name,value){return this.$el.css(name,value),this},CheerioDOMElement.prototype.addEventListener=function(){return this},CheerioDOMElement.prototype.removeEventListener=function(){return this},CheerioDOMElement.prototype.removeAllEventListeners=function(){return this},CheerioDOMElement.prototype.getEventListeners=function(){return[]},CheerioDOMElement.prototype.getChildCount=function(){return this.el.children.length},CheerioDOMElement.prototype.getChildNodes=function(){var childNodes=this.el.children;return childNodes=childNodes.map(function(node){return this._wrapNativeElement(node)}.bind(this))},CheerioDOMElement.prototype.getChildren=function(){var children=this.el.children;return children=children.filter(function(node){return"tag"===node.type}),children=children.map(function(node){return this._wrapNativeElement(node)}.bind(this))},CheerioDOMElement.prototype.getChildAt=function(pos){return this._wrapNativeElement(this.el.children[pos])},CheerioDOMElement.prototype.getChildIndex=function(child){if(!child._isCheerioDOMElement)throw new Error("Expecting a CheerioDOMElement instance.");return this.el.children.indexOf(child.el)},CheerioDOMElement.prototype.getFirstChild=function(){var firstChild=this.el.children[0];return firstChild?CheerioDOMElement.wrapNativeElement(firstChild):null},CheerioDOMElement.prototype.getLastChild=function(){var lastChild=last$1(this.el.children);return lastChild?CheerioDOMElement.wrapNativeElement(lastChild):null},CheerioDOMElement.prototype.getNextSibling=function(){var next=this.el.next;return next?CheerioDOMElement.wrapNativeElement(next):null},CheerioDOMElement.prototype.getPreviousSibling=function(){var previous=this.el.previous;return previous?CheerioDOMElement.wrapNativeElement(previous):null},CheerioDOMElement.prototype.isTextNode=function(){return"text"===this.el.type},CheerioDOMElement.prototype.isElementNode=function(){return"tag"===this.el.type||"script"===this.el.type},CheerioDOMElement.prototype.isCommentNode=function(){return"comment"===this.el.type},CheerioDOMElement.prototype.isDocumentNode=function(){return this.el===this.el.root},CheerioDOMElement.prototype.clone=function(){var clone=this.$el.clone()[0];return this._wrapNativeElement(clone)},CheerioDOMElement.prototype.createElement=function(tagName){var el=$._createElement(tagName,this.el.root);return this._wrapNativeElement(el)},CheerioDOMElement.prototype.createTextNode=function(text){var el=$._createTextNode(text);return this._wrapNativeElement(el)},CheerioDOMElement.prototype.is=function(cssSelector){return this.$el.is(cssSelector)},CheerioDOMElement.prototype.getParent=function(){var parent=this.el.parent;return parent?this._wrapNativeElement(parent):null},CheerioDOMElement.prototype.getRoot=function(){for(var el=this.el,parent=el;parent;)el=parent,parent=el.parent;return this._wrapNativeElement(el)},CheerioDOMElement.prototype.find=function(cssSelector){var result=this.$el.find(cssSelector);return result.length>0?this._wrapNativeElement(result[0]):null},CheerioDOMElement.prototype.findAll=function(cssSelector){var result=this.$el.find(cssSelector);return result.length>0?map$2(result,function(el){return this._wrapNativeElement(el)}.bind(this)):[]},CheerioDOMElement.prototype._normalizeChild=function(child){if(isString$1(child)&&(child=this.createTextNode(child)),child._wrapper&&(child=child._wrapper),!child||!child._isCheerioDOMElement)throw new Error("Illegal argument: only String and CheerioDOMElement instances are valid.");return console.assert(child.el._wrapper===child,"Expecting a backlink between native element and CheerioDOMElement"),child.getNativeElement()},CheerioDOMElement.prototype.appendChild=function(child){return child=this._normalizeChild(child),this.el.children.push(child),child.parent=this.el,this},CheerioDOMElement.prototype.insertAt=function(pos,child){child=this._normalizeChild(child);var children=this.el.children;return pos>=children.length?children.push(child):children.splice(pos,0,child),child.parent=this.el,this},CheerioDOMElement.prototype.insertBefore=function(child,before){var pos=this.el.children.indexOf(before.el);if(pos>-1)return this.insertAt(pos,child);throw new Error("insertBefore(): reference node is not a child of this element.")},CheerioDOMElement.prototype.removeAt=function(pos){if(pos<0||pos>=this.el.children.length)throw new Error("removeAt(): Index out of bounds.");var child=this.el.children[pos];return child.parent=null,this.el.children.splice(pos,1),this},CheerioDOMElement.prototype.removeChild=function(child){if(!child||!child._isCheerioDOMElement)throw new Error("removeChild(): Illegal arguments. Expecting a CheerioDOMElement instance.");var idx=this.el.children.indexOf(child.el);if(idx<0)throw new Error("removeChild(): element is not a child.");return this.removeAt(idx),this},CheerioDOMElement.prototype.replaceChild=function(oldChild,newChild){if(!(newChild&&oldChild&&newChild._isCheerioDOMElement&&oldChild._isCheerioDOMElement))throw new Error("replaceChild(): Illegal arguments. Expecting BrowserDOMElement instances.");var idx=this.el.children.indexOf(oldChild.el);return idx>-1&&(this.removeAt(idx),this.insertAt(idx,newChild.el)),this},CheerioDOMElement.prototype.empty=function(){return this.$el.empty(),this},CheerioDOMElement.prototype.remove=function(){return this.$el.remove(),this},CheerioDOMElement.prototype._replaceNativeEl=function(newEl){var $newEl=$(newEl);this.$el.replaceWith($newEl),this.el=newEl,this.$el=$newEl,this.el._wrapper=this},CheerioDOMElement.prototype.isInDocument=function(){for(var el=this.el;el;){if(el===el.root)return!0;el=el.parent}return!1},CheerioDOMElement.prototype.click=function(){this.emit("click")},Object.defineProperties(CheerioDOMElement.prototype,prototypeAccessors),CheerioDOMElement}(DOMElement);EventEmitter.mixin(CheerioDOMElement),DOMElement._defineProperties(CheerioDOMElement,DOMElement._propertyNames),CheerioDOMElement.createTextNode=function(text){return CheerioDOMElement.wrapNativeElement($._createTextNode(text))},CheerioDOMElement.createElement=function(tagName){return CheerioDOMElement.wrapNativeElement($("<"+tagName+">")[0])},CheerioDOMElement.parseMarkup=function(str,format){var doc,nativeEls=[];if(!str)return doc="xml"===format?$.parseXML(""):$.parseHTML(""),new CheerioDOMElement(doc);nativeEls="xml"===format?$.parseXML(str):$.parseHTML(str);var elements=nativeEls.map(function(el){return new CheerioDOMElement(el)});return 1===elements.length?elements[0]:elements},CheerioDOMElement.wrapNativeElement=function(el){return el._wrapper?el._wrapper:new CheerioDOMElement(el)};var DOMElementImpl;DOMElementImpl=inBrowser?BrowserDOMElement:CheerioDOMElement;var DefaultDOMElement={};DefaultDOMElement.createTextNode=function(text){return DOMElementImpl.createTextNode(text)},DefaultDOMElement.createElement=function(tagName){
return DOMElementImpl.createElement(tagName)},DefaultDOMElement._create=function(el){return new DOMElementImpl(el)},DefaultDOMElement.getBrowserWindow=function(){return inBrowser?DOMElementImpl.getBrowserWindow():DefaultDOMElement.createElement("div")},DefaultDOMElement.parseHTML=function(html){return DOMElementImpl.parseMarkup(html,"html")},DefaultDOMElement.parseXML=function(xml,fullDoc){return DOMElementImpl.parseMarkup(xml,"xml",fullDoc)},DefaultDOMElement.wrapNativeElement=function(el){return el?inBrowser&&(el instanceof window.Node||el===window)?BrowserDOMElement.wrapNativeElement(el):el.root&&"root"===el.root.type?CheerioDOMElement.wrapNativeElement(el):void 0:null},DefaultDOMElement.isReverse=function(anchorNode,anchorOffset,focusNode,focusOffset){if(inBrowser)return BrowserDOMElement.isReverse(anchorNode,anchorOffset,focusNode,focusOffset);throw new Error("Not implemented.")};var defaultAnnotationConverter={tagName:"span",export:function(node,el){el.tagName="span",el.attr("data-type",node.type);var properties=node.toJSON();each$2(properties,function(value,name){"id"!==name&&"type"!==name&&(isString$1(value)||isNumber$1(value)||isBoolean$1(value))&&el.attr("data-"+name,value)})}},defaultBlockConverter={export:function(node,el,converter){el.attr("data-type",node.type);var properties=node.toJSON();each$2(properties,function(value,name){if("id"!==name&&"type"!==name){var prop=converter.$$("div").attr("property",name);"string"===node.getPropertyType(name)&&value?prop.append(converter.annotatedText([node.id,name])):prop.text(value),el.append(prop)}})}},HTMLExporter=function(DOMExporter$$1){function HTMLExporter(config){DOMExporter$$1.call(this,Object.assign({idAttribute:"data-id"},config)),this._el=DefaultDOMElement.parseHTML("<html></html>")}return DOMExporter$$1&&(HTMLExporter.__proto__=DOMExporter$$1),HTMLExporter.prototype=Object.create(DOMExporter$$1&&DOMExporter$$1.prototype),HTMLExporter.prototype.constructor=HTMLExporter,HTMLExporter.prototype.exportDocument=function(doc){var htmlEl=DefaultDOMElement.parseHTML("<html><head></head><body></body></html>");return this.convertDocument(doc,htmlEl)},HTMLExporter.prototype.getDefaultBlockConverter=function(){return defaultBlockConverter},HTMLExporter.prototype.getDefaultPropertyAnnotationConverter=function(){return defaultAnnotationConverter},HTMLExporter}(DOMExporter),HTMLImporter=function(DOMImporter$$1){function HTMLImporter(config){DOMImporter$$1.call(this,Object.assign({idAttribute:"data-id"},config)),this._el=DefaultDOMElement.parseHTML("<html></html>")}return DOMImporter$$1&&(HTMLImporter.__proto__=DOMImporter$$1),HTMLImporter.prototype=Object.create(DOMImporter$$1&&DOMImporter$$1.prototype),HTMLImporter.prototype.constructor=HTMLImporter,HTMLImporter.prototype.importDocument=function(html){this.reset();var parsed=DefaultDOMElement.parseHTML(html);return this.convertDocument(parsed),this.generateDocument(),this.state.doc},HTMLImporter.prototype.convertDocument=function(documentEl){throw new Error("This method is abstract")},HTMLImporter}(DOMImporter),InlineNode=function(PropertyAnnotation$$1){function InlineNode(){PropertyAnnotation$$1.apply(this,arguments)}return PropertyAnnotation$$1&&(InlineNode.__proto__=PropertyAnnotation$$1),InlineNode.prototype=Object.create(PropertyAnnotation$$1&&PropertyAnnotation$$1.prototype),InlineNode.prototype.constructor=InlineNode,InlineNode}(PropertyAnnotation);InlineNode.isInline=!0;var TextNode$2=function(DocumentNode$$1){function TextNode(){DocumentNode$$1.apply(this,arguments)}return DocumentNode$$1&&(TextNode.__proto__=DocumentNode$$1),TextNode.prototype=Object.create(DocumentNode$$1&&DocumentNode$$1.prototype),TextNode.prototype.constructor=TextNode,TextNode.prototype.getTextPath=function(){return[this.id,"content"]},TextNode.prototype.getText=function(){return this.content},TextNode.prototype.isEmpty=function(){return!this.content},TextNode}(DocumentNode);TextNode$2.isText=!0,TextNode$2.define({type:"text",content:"text"});var TextBlock=function(TextNode){function TextBlock(){TextNode.apply(this,arguments)}return TextNode&&(TextBlock.__proto__=TextNode),TextBlock.prototype=Object.create(TextNode&&TextNode.prototype),TextBlock.prototype.constructor=TextBlock,TextBlock}(TextNode$2);TextBlock.isBlock=!0;var defaultAnnotationConverter$1={tagName:"annotation",export:function(node,el){el.attr("type",node.type);var properties=node.toJSON();forEach$2(properties,function(value,name){"id"!==name&&"type"!==name&&(isString$1(value)||isNumber$1(value)||isBoolean$1(value))&&el.attr(name,value)})}},defaultBlockConverter$1={tagName:"block",export:function(node,el,converter){el.attr("type",node.type);var properties=node.toJSON();forEach$2(properties,function(value,name){if("id"!==name&&"type"!==name){var prop=converter.$$(name);"string"===node.getPropertyType(name)?prop.append(converter.annotatedText([node.id,name])):prop.text(value),el.append(prop)}})}},XMLExporter=function(DOMExporter$$1){function XMLExporter(config){DOMExporter$$1.call(this,Object.assign({idAttribute:"id"},config)),this._el=DefaultDOMElement.parseXML("<dummy></dummy>")}return DOMExporter$$1&&(XMLExporter.__proto__=DOMExporter$$1),XMLExporter.prototype=Object.create(DOMExporter$$1&&DOMExporter$$1.prototype),XMLExporter.prototype.constructor=XMLExporter,XMLExporter.prototype.getDefaultBlockConverter=function(){return defaultBlockConverter$1},XMLExporter.prototype.getDefaultPropertyAnnotationConverter=function(){return defaultAnnotationConverter$1},XMLExporter}(DOMExporter),XMLImporter=function(DOMImporter$$1){function XMLImporter(config){DOMImporter$$1.call(this,Object.assign({idAttribute:"id"},config)),this._el=DefaultDOMElement.parseXML("<dummy></dummy>")}return DOMImporter$$1&&(XMLImporter.__proto__=DOMImporter$$1),XMLImporter.prototype=Object.create(DOMImporter$$1&&DOMImporter$$1.prototype),XMLImporter.prototype.constructor=XMLImporter,XMLImporter.prototype.importDocument=function(xml){this.reset();var articleElement=DefaultDOMElement.parseXML(xml);this.convertDocument(articleElement);var doc=this.generateDocument();return doc},XMLImporter}(DOMImporter),merge$1=function(tx,args){var containerId=args.containerId,path=args.path,direction=args.direction;if(!containerId||!path||!direction)throw new Error("Insufficient arguments! mandatory fields: `containerId`, `path`, `direction`");var tmp,container=tx.get(containerId),nodeId=path[0],node=tx.get(nodeId),nodePos=container.getPosition(nodeId),l=container.getLength();if("right"===direction&&nodePos<l-1){var nextNodeId=container.nodes[nodePos+1],nextNode=tx.get(nextNodeId);node.isText()&&0===node.getText().length?(deleteNode(tx,{nodeId:nodeId,containerId:containerId}),nextNode.isText()?args.selection=tx.createSelection(nextNodeId,0):args.selection=tx.createSelection({type:"node",nodeId:nextNodeId,containerId:containerId,mode:"full"})):(tmp=_mergeNodes(tx,extend$1({},args,{containerId:containerId,firstNodeId:nodeId,secondNodeId:nextNodeId})),args.selection=tmp.selection)}else if("left"===direction&&nodePos>0){var previousNodeId=container.nodes[nodePos-1],previousNode=tx.get(previousNodeId);node.isText()&&0===node.getText().length?(deleteNode(tx,{nodeId:nodeId,containerId:containerId}),previousNode.isText()?args.selection=tx.createSelection(previousNode.getTextPath(),previousNode.getText().length):args.selection=tx.createSelection({type:"node",nodeId:previousNodeId,containerId:containerId,mode:"full"})):(tmp=_mergeNodes(tx,extend$1({},args,{containerId:containerId,firstNodeId:previousNodeId,secondNodeId:nodeId})),args.selection=tmp.selection)}return args},deleteCharacter=function(tx,args){var sel=args.selection;if(!sel)throw new Error("'selection' is mandatory.");if(!sel.isCollapsed())throw new Error('selection must be collapsed for transformation "deleteCharacter"');return sel.isPropertySelection()?_deleteCharacterInProperty(tx,args):sel.isNodeSelection()?_deleteCharacterWithNodeSelection(tx,args):(console.warn("'deleteChar' can not be used with the given selection",sel.toString()),args)},insertText=function(tx,args){var sel=args.selection,text=args.text;if(!sel)throw new Error("Argument `selection` is mandatory for transformation `insertText`.");if(!text)throw new Error("Argument `text` is mandatory for transformation `insertText`.");if(!sel.isPropertySelection()&&!sel.isContainerSelection())return console.error("Selection must be a Property- or ContainerSelection."),args;if(!sel.isCollapsed())return replaceText(tx,args);void 0===tx.get(sel.startPath)&&tx.set(sel.startPath,"");var op=tx.update(sel.startPath,{insert:{offset:sel.startOffset,value:text}});return updateAnnotations(tx,{op:op}),args.selection=tx.createSelection(sel.startPath,sel.startOffset+text.length),args},paste$1$1=function(tx,args){args.text=args.text||"";var sel=args.selection;if(!sel||sel.isNull())return console.error("Can not paste, without selection."),args;var inContainer=Boolean(args.containerId),pasteDoc=args.doc;if(!pasteDoc){if(!inContainer)return insertText(tx,args);args.doc=pasteDoc=_convertPlainTextToDocument(tx,args)}if(!sel.isCollapsed()){var tmp=deleteSelection(tx,args);args.selection=tmp.selection}var nodes=pasteDoc.get(Document.SNIPPET_ID).nodes,schema=tx.getSchema();if(nodes.length>0){var first=pasteDoc.get(nodes[0]);schema.isInstanceOf(first.type,"text")&&(args=_pasteAnnotatedText(tx,args),nodes.shift()),nodes.length>0&&(args=_pasteDocument(tx,args))}return args},Command=function(config){if(this.config=config||{},this.name=this.config.name,!this.name)throw new Error("'name' is required")},prototypeAccessors$7={_isCommand:{}};prototypeAccessors$7._isCommand.get=function(){return!0},Command.prototype.getName=function(){return this.name},Command.prototype.getCommandState=function(params,context){throw new Error("Command.getCommandState() is abstract.")},Command.prototype.execute=function(params,context){throw new Error("Command.execute() is abstract.")},Command.prototype._getDocumentSession=function(params,context){var docSession=params.documentSession||context.documentSession;if(!docSession)throw new Error("'documentSession' is required.");return docSession},Command.prototype._getSelection=function(params){var sel=params.selection||params.selectionState.getSelection();if(!sel)throw new Error("'selection' is required.");return sel},Object.defineProperties(Command.prototype,prototypeAccessors$7);var Undo=function(Command$$1){function Undo(){Command$$1.apply(this,arguments)}return Command$$1&&(Undo.__proto__=Command$$1),Undo.prototype=Object.create(Command$$1&&Command$$1.prototype),Undo.prototype.constructor=Undo,Undo.prototype.getCommandState=function(params){var docSession=params.documentSession;return{disabled:!docSession.canUndo(),active:!1}},Undo.prototype.execute=function(params){var docSession=params.documentSession;return!!docSession.canUndo()&&(docSession.undo(),!0)},Undo}(Command),Redo=function(Command$$1){function Redo(){Command$$1.apply(this,arguments)}return Command$$1&&(Redo.__proto__=Command$$1),Redo.prototype=Object.create(Command$$1&&Command$$1.prototype),Redo.prototype.constructor=Redo,Redo.prototype.getCommandState=function(params){var docSession=params.documentSession;return{disabled:!docSession.canRedo(),active:!1}},Redo.prototype.execute=function(params){var docSession=params.documentSession;return!!docSession.canRedo()&&(docSession.redo(),!0)},Redo}(Command),_castSlice=createCommonjsModule(function(module){function castSlice(array,start,end){var length=array.length;return end=void 0===end?length:end,!start&&end>=length?array:baseSlice(array,start,end)}var baseSlice=interopDefault(require$$0$52);module.exports=castSlice}),_castSlice$1=interopDefault(_castSlice),require$$3$17=Object.freeze({default:_castSlice$1}),_reHasComplexSymbol=createCommonjsModule(function(module){var rsAstralRange="\\ud800-\\udfff",rsComboMarksRange="\\u0300-\\u036f\\ufe20-\\ufe23",rsComboSymbolsRange="\\u20d0-\\u20f0",rsVarRange="\\ufe0e\\ufe0f",rsZWJ="\\u200d",reHasComplexSymbol=RegExp("["+rsZWJ+rsAstralRange+rsComboMarksRange+rsComboSymbolsRange+rsVarRange+"]");module.exports=reHasComplexSymbol}),_reHasComplexSymbol$1=interopDefault(_reHasComplexSymbol),require$$2$29=Object.freeze({default:_reHasComplexSymbol$1}),_stringToArray=createCommonjsModule(function(module){function stringToArray(string){return string.match(reComplexSymbol)}var rsAstralRange="\\ud800-\\udfff",rsComboMarksRange="\\u0300-\\u036f\\ufe20-\\ufe23",rsComboSymbolsRange="\\u20d0-\\u20f0",rsVarRange="\\ufe0e\\ufe0f",rsAstral="["+rsAstralRange+"]",rsCombo="["+rsComboMarksRange+rsComboSymbolsRange+"]",rsFitz="\\ud83c[\\udffb-\\udfff]",rsModifier="(?:"+rsCombo+"|"+rsFitz+")",rsNonAstral="[^"+rsAstralRange+"]",rsRegional="(?:\\ud83c[\\udde6-\\uddff]){2}",rsSurrPair="[\\ud800-\\udbff][\\udc00-\\udfff]",rsZWJ="\\u200d",reOptMod=rsModifier+"?",rsOptVar="["+rsVarRange+"]?",rsOptJoin="(?:"+rsZWJ+"(?:"+[rsNonAstral,rsRegional,rsSurrPair].join("|")+")"+rsOptVar+reOptMod+")*",rsSeq=rsOptVar+reOptMod+rsOptJoin,rsSymbol="(?:"+[rsNonAstral+rsCombo+"?",rsCombo,rsRegional,rsSurrPair,rsAstral].join("|")+")",reComplexSymbol=RegExp(rsFitz+"(?="+rsFitz+")|"+rsSymbol+rsSeq,"g");module.exports=stringToArray}),_stringToArray$1=interopDefault(_stringToArray),require$$1$32=Object.freeze({default:_stringToArray$1}),_createCaseFirst=createCommonjsModule(function(module){function createCaseFirst(methodName){return function(string){string=toString(string);var strSymbols=reHasComplexSymbol.test(string)?stringToArray(string):void 0,chr=strSymbols?strSymbols[0]:string.charAt(0),trailing=strSymbols?castSlice(strSymbols,1).join(""):string.slice(1);return chr[methodName]()+trailing}}var castSlice=interopDefault(require$$3$17),reHasComplexSymbol=interopDefault(require$$2$29),stringToArray=interopDefault(require$$1$32),toString=interopDefault(require$$0$31);module.exports=createCaseFirst}),_createCaseFirst$1=interopDefault(_createCaseFirst),require$$0$58=Object.freeze({default:_createCaseFirst$1}),upperFirst=createCommonjsModule(function(module){var createCaseFirst=interopDefault(require$$0$58),upperFirst=createCaseFirst("toUpperCase");module.exports=upperFirst}),upperFirst$1=interopDefault(upperFirst),require$$0$57=Object.freeze({default:upperFirst$1}),capitalize=createCommonjsModule(function(module){function capitalize(string){return upperFirst(toString(string).toLowerCase())}var toString=interopDefault(require$$0$31),upperFirst=interopDefault(require$$0$57);module.exports=capitalize}),capitalize$1=interopDefault(capitalize),substanceGlobals={},_global="undefined"!=typeof global?global:window;_global.hasOwnProperty("Substance")?(console.warn("global.Substance is already defined."),substanceGlobals=_global.Substance):_global.Substance=substanceGlobals;var substanceGlobals$1=substanceGlobals,_isFlattenable=createCommonjsModule(function(module){function isFlattenable(value){return isArray(value)||isArguments(value)}var isArguments=interopDefault(require$$1$3),isArray=interopDefault(require$$0$5);module.exports=isFlattenable}),_isFlattenable$1=interopDefault(_isFlattenable),require$$0$59=Object.freeze({default:_isFlattenable$1}),_baseFlatten=createCommonjsModule(function(module){function baseFlatten(array,depth,predicate,isStrict,result){var index=-1,length=array.length;for(predicate||(predicate=isFlattenable),result||(result=[]);++index<length;){var value=array[index];depth>0&&predicate(value)?depth>1?baseFlatten(value,depth-1,predicate,isStrict,result):arrayPush(result,value):isStrict||(result[result.length]=value)}return result}var arrayPush=interopDefault(require$$2$21),isFlattenable=interopDefault(require$$0$59);module.exports=baseFlatten}),_baseFlatten$1=interopDefault(_baseFlatten),require$$4$14=Object.freeze({default:_baseFlatten$1}),flattenDeep=createCommonjsModule(function(module){function flattenDeep(array){var length=array?array.length:0;return length?baseFlatten(array,INFINITY):[]}var baseFlatten=interopDefault(require$$4$14),INFINITY=1/0;module.exports=flattenDeep}),flattenDeep$1=interopDefault(flattenDeep),isNil=createCommonjsModule(function(module){function isNil(value){return null==value}module.exports=isNil}),isNil$1=interopDefault(isNil),_baseUnary=createCommonjsModule(function(module){function baseUnary(func){return function(value){return func(value)}}module.exports=baseUnary}),_baseUnary$1=interopDefault(_baseUnary),require$$1$33=Object.freeze({default:_baseUnary$1}),_baseDifference=createCommonjsModule(function(module){function baseDifference(array,values,iteratee,comparator){var index=-1,includes=arrayIncludes,isCommon=!0,length=array.length,result=[],valuesLength=values.length;if(!length)return result;iteratee&&(values=arrayMap(values,baseUnary(iteratee))),comparator?(includes=arrayIncludesWith,isCommon=!1):values.length>=LARGE_ARRAY_SIZE&&(includes=cacheHas,isCommon=!1,values=new SetCache(values));outer:for(;++index<length;){var value=array[index],computed=iteratee?iteratee(value):value;if(value=comparator||0!==value?value:0,isCommon&&computed===computed){for(var valuesIndex=valuesLength;valuesIndex--;)if(values[valuesIndex]===computed)continue outer;result.push(value)}else includes(values,computed,comparator)||result.push(value)}return result}var SetCache=interopDefault(require$$5$1),arrayIncludes=interopDefault(require$$4$12),arrayIncludesWith=interopDefault(require$$3$16),arrayMap=interopDefault(require$$0$36),baseUnary=interopDefault(require$$1$33),cacheHas=interopDefault(require$$0$55),LARGE_ARRAY_SIZE=200;module.exports=baseDifference}),_baseDifference$1=interopDefault(_baseDifference),require$$2$30=Object.freeze({default:_baseDifference$1}),_basePick=createCommonjsModule(function(module){function basePick(object,props){return object=Object(object),arrayReduce(props,function(result,key){return key in object&&(result[key]=object[key]),result},{})}var arrayReduce=interopDefault(require$$0$47);module.exports=basePick}),_basePick$1=interopDefault(_basePick),require$$3$18=Object.freeze({default:_basePick$1}),_getSymbolsIn=createCommonjsModule(function(module){var arrayPush=interopDefault(require$$2$21),getPrototype=interopDefault(require$$1$2),getSymbols=interopDefault(require$$0$44),getOwnPropertySymbols=Object.getOwnPropertySymbols,getSymbolsIn=getOwnPropertySymbols?function(object){for(var result=[];object;)arrayPush(result,getSymbols(object)),object=getPrototype(object);return result}:getSymbols;module.exports=getSymbolsIn}),_getSymbolsIn$1=interopDefault(_getSymbolsIn),require$$1$34=Object.freeze({default:_getSymbolsIn$1}),_getAllKeysIn=createCommonjsModule(function(module){function getAllKeysIn(object){return baseGetAllKeys(object,keysIn,getSymbolsIn)}var baseGetAllKeys=interopDefault(require$$2$20),getSymbolsIn=interopDefault(require$$1$34),keysIn=interopDefault(require$$0$41);module.exports=getAllKeysIn}),_getAllKeysIn$1=interopDefault(_getAllKeysIn),require$$2$31=Object.freeze({default:_getAllKeysIn$1}),omit=createCommonjsModule(function(module){var arrayMap=interopDefault(require$$0$36),baseDifference=interopDefault(require$$2$30),baseFlatten=interopDefault(require$$4$14),basePick=interopDefault(require$$3$18),getAllKeysIn=interopDefault(require$$2$31),rest=interopDefault(require$$0$38),toKey=interopDefault(require$$0$33),omit=rest(function(object,props){return null==object?{}:(props=arrayMap(baseFlatten(props,1),toKey),basePick(object,baseDifference(getAllKeysIn(object),props)))});module.exports=omit}),omit$1=interopDefault(omit),without=createCommonjsModule(function(module){var baseDifference=interopDefault(require$$2$30),isArrayLikeObject=interopDefault(require$$1$4),rest=interopDefault(require$$0$38),without=rest(function(array,values){return isArrayLikeObject(array)?baseDifference(array,values):[]});module.exports=without}),without$1=interopDefault(without),VirtualElement=function(DOMElement$$1){function VirtualElement(owner){DOMElement$$1.call(this),this.parent=null,this._owner=owner,this._ref=null}DOMElement$$1&&(VirtualElement.__proto__=DOMElement$$1),VirtualElement.prototype=Object.create(DOMElement$$1&&DOMElement$$1.prototype),VirtualElement.prototype.constructor=VirtualElement;var prototypeAccessors={_isVirtualElement:{}};return prototypeAccessors._isVirtualElement.get=function(){return!0},VirtualElement.prototype.getParent=function(){return this.parent},VirtualElement.prototype.ref=function ref(ref){if(!ref)throw new Error("Illegal argument");return this._ref=ref,this._context&&(this._context.refs[ref]=this),this},Object.defineProperties(VirtualElement.prototype,prototypeAccessors),VirtualElement}(DOMElement);DOMElement._defineProperties(VirtualElement,without$1(DOMElement._propertyNames,"children"));var VirtualHTMLElement=function(VirtualElement){function VirtualHTMLElement(tagName){VirtualElement.call(this),this._tagName=tagName,this.classNames=null,this.attributes=null,this.htmlProps=null,this.style=null,this.eventListeners=null,this.children=[]}VirtualElement&&(VirtualHTMLElement.__proto__=VirtualElement),VirtualHTMLElement.prototype=Object.create(VirtualElement&&VirtualElement.prototype),VirtualHTMLElement.prototype.constructor=VirtualHTMLElement;var prototypeAccessors$1={_isVirtualHTMLElement:{}};return prototypeAccessors$1._isVirtualHTMLElement.get=function(){return!0},VirtualHTMLElement.prototype.getTagName=function(){return this._tagName},VirtualHTMLElement.prototype.setTagName=function(tagName){return this._tagName=tagName,this},VirtualHTMLElement.prototype.hasClass=function(className){return!!this.classNames&&this.classNames.indexOf(className)>-1},VirtualHTMLElement.prototype.addClass=function(className){return this.classNames||(this.classNames=[]),this.classNames.push(className),this},VirtualHTMLElement.prototype.removeClass=function(className){return this.classNames&&(this.classNames=without$1(this.classNames,className)),this},VirtualHTMLElement.prototype.removeAttr=function(attr){return this.attributes&&(isString$1(attr)?delete this.attributes[attr]:this.attributes=omit$1(this.attributes,attr)),this},VirtualHTMLElement.prototype.getAttribute=function(name){if(this.attributes)return this.attributes[name]},VirtualHTMLElement.prototype.setAttribute=function(name,value){return this.attributes||(this.attributes={}),this.attributes[name]=value,this},VirtualHTMLElement.prototype.getAttributes=function(){var attributes={};return this.attributes&&extend$1(attributes,this.attributes),this.classNames&&(attributes.class=this.classNames.join(" ")),this.style&&(attributes.style=map$2(this.style,function(val,key){return key+":"+val}).join(";")),attributes},VirtualHTMLElement.prototype.getId=function(){return this.getAttribute("id")},VirtualHTMLElement.prototype.setId=function(id){return this.setAttribute("id",id),this},VirtualHTMLElement.prototype.setTextContent=function(text){if(!isString$1(text))throw new Error("Illegal argument: expecting a string.");return text=text||"",this.empty(),this.appendChild(text),this},VirtualHTMLElement.prototype.setInnerHTML=function(html){return html=html||"",this.empty(),this._innerHTMLString=html,this},VirtualHTMLElement.prototype.getInnerHTML=function(){if(this.hasOwnProperty("_innerHTMLString"))return this._innerHTMLString;throw new Error("Not supported.")},VirtualHTMLElement.prototype.getValue=function(){return this.htmlProp("value")},VirtualHTMLElement.prototype.setValue=function(value){return this.htmlProp("value",value),this},VirtualHTMLElement.prototype.getChildNodes=function(){return this.children},VirtualHTMLElement.prototype.getChildren=function(){return this.children.filter(function(child){return"text"!==child.getNodeType()})},VirtualHTMLElement.prototype.isTextNode=function(){return!1},VirtualHTMLElement.prototype.isElementNode=function(){return!0},VirtualHTMLElement.prototype.isCommentNode=function(){return!1},VirtualHTMLElement.prototype.isDocumentNode=function(){return!1},VirtualHTMLElement.prototype.append=function(){if(this._innerHTMLString)throw Error("It is not possible to mix $$.html() with $$.append(). You can call $$.empty() to reset this virtual element.");return this._append(this.children,arguments),this},VirtualHTMLElement.prototype.appendChild=function(child){if(this._innerHTMLString)throw Error("It is not possible to mix $$.html() with $$.append(). You can call $$.empty() to reset this virtual element.");return this._appendChild(this.children,child),this},VirtualHTMLElement.prototype.insertAt=function(pos,child){if(child=this._normalizeChild(child),!child)throw new Error("Illegal child: "+child);if(!child._isVirtualElement)throw new Error("Illegal argument for $$.insertAt():"+child);if(pos<0||pos>this.children.length)throw new Error("insertAt(): index out of bounds.");return this._insertAt(this.children,pos,child),this},VirtualHTMLElement.prototype.insertBefore=function(child,before){var pos=this.children.indexOf(before);if(!(pos>-1))throw new Error("insertBefore(): reference node is not a child of this element.");return this.insertAt(pos,child),this},VirtualHTMLElement.prototype.removeAt=function(pos){if(pos<0||pos>=this.children.length)throw new Error("removeAt(): Index out of bounds.");return this._removeAt(pos),this},VirtualHTMLElement.prototype.removeChild=function(child){if(!child||!child._isVirtualElement)throw new Error("removeChild(): Illegal arguments. Expecting a CheerioDOMElement instance.");var idx=this.children.indexOf(child);if(idx<0)throw new Error("removeChild(): element is not a child.");return this.removeAt(idx),this},VirtualHTMLElement.prototype.replaceChild=function(oldChild,newChild){if(!(newChild&&oldChild&&newChild._isVirtualElement&&oldChild._isVirtualElement))throw new Error("replaceChild(): Illegal arguments. Expecting BrowserDOMElement instances.");var idx=this.children.indexOf(oldChild);if(idx<0)throw new Error("replaceChild(): element is not a child.");return this.removeAt(idx),this.insertAt(idx,newChild),this},VirtualHTMLElement.prototype.empty=function(){for(var children=this.children;children.length;){var child=children.pop();child.parent=null}return delete this._innerHTMLString,this},VirtualHTMLElement.prototype.getProperty=function(name){if(this.htmlProps)return this.htmlProps[name]},VirtualHTMLElement.prototype.setProperty=function(name,value){return this.htmlProps||(this.htmlProps={}),this.htmlProps[name]=value,this},VirtualHTMLElement.prototype.removeProperty=function(name){return this.htmlProps&&delete this.htmlProps[name],this},VirtualHTMLElement.prototype.getStyle=function(name){if(this.style)return this.style[name]},VirtualHTMLElement.prototype.setStyle=function(name,value){return this.style||(this.style={}),this.style[name]=value,this},VirtualHTMLElement.prototype.addEventListener=function(eventName,handler,options){var listener;return 1===arguments.length&&arguments[0]._isDOMEventListener?listener=arguments[0]:(options=options||{},options.context=options.context||this._owner._comp,listener=new DOMElement.EventListener(eventName,handler,options)),this.eventListeners||(this.eventListeners=[]),this.eventListeners.push(listener),this},VirtualHTMLElement.prototype.removeEventListener=function(eventName,handler){return this.eventListeners&&DOMElement._findEventListenerIndex(this.eventListeners,eventName,handler),this},VirtualHTMLElement.prototype.getEventListeners=function(){return this.eventListeners},VirtualHTMLElement.prototype.getNodeType=function(){return"element"},VirtualHTMLElement.prototype.hasInnerHTML=function(){return Boolean(this._innerHTMLString)},VirtualHTMLElement.prototype._normalizeChild=function(child){return isString$1(child)&&(child=new VirtualTextNode(child)),child},VirtualHTMLElement.prototype._append=function(outlet,args){if(1===args.length&&!isArray$1(args[0]))return void this._appendChild(outlet,args[0]);var children;if(isArray$1(args[0]))children=args[0];else{if(!(arguments.length>1))return;children=Array.prototype.slice.call(args,0)}children.forEach(this._appendChild.bind(this,outlet))},VirtualHTMLElement.prototype._appendChild=function(outlet,child){if(child=this._normalizeChild(child))return outlet.push(child),this._attach(child),child},VirtualHTMLElement.prototype._insertAt=function(outlet,pos,child){child&&(outlet.splice(pos,0,child),this._attach(child))},VirtualHTMLElement.prototype._removeAt=function(outlet,pos){var child=outlet[pos];outlet.splice(pos,1),this._detach(child)},VirtualHTMLElement.prototype._attach=function(child){child.parent=this,this._context&&child._owner!==this._owner&&child._ref&&(this._context.foreignRefs[child._ref]=child)},VirtualHTMLElement.prototype._detach=function(child){child.parent=null,this._context&&child._owner!==this._owner&&child._ref&&delete this.context.foreignRefs[child._ref]},VirtualHTMLElement.prototype._mergeHTMLConfig=function(other){other.classNames&&(this.classNames||(this.classNames=[]),this.classNames=this.classNames.concat(other.classNames)),other.attributes&&(this.attributes||(this.attributes={}),extend$1(this.attributes,other.attributes)),other.htmlProps&&(this.htmlProps||(this.htmlProps={}),extend$1(this.htmlProps,other.htmlProps)),other.style&&(this.style||(this.style={}),extend$1(this.style,other.style)),other.eventListeners&&(this.eventListeners||(this.eventListeners=[]),this.eventListeners=this.eventListeners.concat(other.eventListeners))},Object.defineProperties(VirtualHTMLElement.prototype,prototypeAccessors$1),VirtualHTMLElement}(VirtualElement),VirtualComponent=function(VirtualHTMLElement){function VirtualComponent(ComponentClass,props){VirtualHTMLElement.call(this),props=props||{},this.ComponentClass=ComponentClass,this.props=props,props.children||(props.children=[]),this.children=props.children}VirtualHTMLElement&&(VirtualComponent.__proto__=VirtualHTMLElement),VirtualComponent.prototype=Object.create(VirtualHTMLElement&&VirtualHTMLElement.prototype),VirtualComponent.prototype.constructor=VirtualComponent;var prototypeAccessors$2={_isVirtualComponent:{}};return prototypeAccessors$2._isVirtualComponent.get=function(){return!0},VirtualComponent.prototype.getComponent=function(){return this._comp},VirtualComponent.prototype.getChildren=function(){return this.props.children},VirtualComponent.prototype.getNodeType=function(){return"component"},VirtualComponent.prototype.outlet=function(name){return new Outlet(this,name)},VirtualComponent.prototype._attach=function(child){child._preliminaryParent=this},VirtualComponent.prototype._detach=function(child){child._preliminaryParent=null},VirtualComponent.prototype._copyHTMLConfig=function(){return{classNames:clone$2(this.classNames),attributes:clone$2(this.attributes),htmlProps:clone$2(this.htmlProps),style:clone$2(this.style),eventListeners:clone$2(this.eventListeners)}},Object.defineProperties(VirtualComponent.prototype,prototypeAccessors$2),VirtualComponent}(VirtualHTMLElement),Outlet=function(virtualEl,name){this.virtualEl=virtualEl,this.name=name,Object.freeze(this)};Outlet.prototype._getOutlet=function(){var outlet=this.virtualEl.props[this.name];return outlet||(outlet=[],this.virtualEl.props[this.name]=outlet),outlet},Outlet.prototype.append=function(){var outlet=this._getOutlet();return this.virtualEl._append(outlet,arguments),this},Outlet.prototype.empty=function(){var arr=this.virtualEl.props[this.name];return arr.forEach(function(el){this._detach(el)}.bind(this)),arr.splice(0,arr.length),this};var VirtualTextNode=function(VirtualElement){function VirtualTextNode(text){VirtualElement.call(this),this.text=text}VirtualElement&&(VirtualTextNode.__proto__=VirtualElement),VirtualTextNode.prototype=Object.create(VirtualElement&&VirtualElement.prototype),VirtualTextNode.prototype.constructor=VirtualTextNode;var prototypeAccessors$3={_isVirtualTextNode:{}};return prototypeAccessors$3._isVirtualTextNode.get=function(){return!0},Object.defineProperties(VirtualTextNode.prototype,prototypeAccessors$3),VirtualTextNode}(VirtualElement);VirtualElement.Component=VirtualComponent,VirtualElement.TextNode=VirtualTextNode,VirtualElement.createElement=function(){var content,type,_first=arguments[0],_second=arguments[1];
if(isString$1(_first))type="element";else{if(!isFunction$1(_first)||!_first.prototype._isComponent)throw isNil$1(_first)?new Error("$$(null): provided argument was null or undefined."):new Error("Illegal usage of $$()");type="component"}var classNames,ref,props={},eventHandlers=[];for(var key in _second)if(_second.hasOwnProperty(key)){var val=_second[key];switch(key){case"class":classNames=val;break;case"ref":ref=val;break;default:"on"===key.slice(0,2)?eventHandlers.push({name:key.slice(2),handler:val}):props[key]=val}}return"element"===type?(content=new VirtualHTMLElement(_first),content.attr(props)):content=new VirtualComponent(_first,props),content._owner=this.owner,classNames&&content.addClass(classNames),ref&&content.ref(ref),eventHandlers.forEach(function(h){if(isFunction$1(h.handler))content.on(h.name,h.handler);else{if(!isPlainObject$1(h.handler))throw new Error("Illegal arguments for $$(_,{ on"+h.name+"})");var params=h.handler;content.on(h.name,params.handler,params.context,params)}}),arguments.length>2&&content.append(flattenDeep$1(Array.prototype.slice.call(arguments,2))),content};var RenderingEngine=function(){};RenderingEngine.prototype._render=function(comp,oldProps,oldState){var vel=_createWrappingVirtualComponent(comp),state=new RenderingEngine.State;oldProps&&state.setOldProps(vel,oldProps),oldState&&state.setOldState(vel,oldState);try{_capture(state,vel,"forceCapture"),vel._isVirtualComponent?_render$1$1(state,vel._content):_render$1$1(state,vel),_triggerUpdate(state,vel)}finally{state.dispose()}},RenderingEngine.prototype._renderChild=function(comp,vel){var state=new RenderingEngine.State;vel.parent={_comp:comp};try{return _capture(state,vel),_render$1$1(state,vel),vel._comp}finally{state.dispose()}};var DescendingContext=function(state,captureContext){this.state=state,this.owner=captureContext.owner,this.refs={},this.foreignRefs={},this.elements=captureContext.elements,this.pos=0,this.updates=captureContext.components.length,this.remaining=this.updates,this.$$=this._createComponent.bind(this)};DescendingContext.prototype._createComponent=function(){var state=this.state,vel=this.elements[this.pos++];return!state.isCaptured(vel)&&vel._isVirtualComponent&&vel.parent&&state.isCaptured(vel.parent)&&(_capture(state,vel),this.updates++,this.remaining--),vel=VirtualElement.createElement.apply(this,arguments),vel._context=this,vel._owner=this.owner,vel._attach=function(){},vel._detach=function(){},vel},DescendingContext.prototype.hasPendingCaptures=function(){return this.updates>0&&this.remaining>0},DescendingContext.prototype.reset=function(){this.pos=0,this.updates=0},DescendingContext.prototype._ancestorsReady=function(vel){for(var this$1=this;vel;){if(this$1.state.isCaptured(vel)||vel===this$1.owner||vel===this$1.owner._content)return!0;vel=vel.parent}return!1},RenderingEngine._internal={_capture:_capture,_wrap:_createWrappingVirtualComponent};var CaptureContext=function(owner){this.owner=owner,this.refs={},this.foreignRefs={},this.elements=[],this.components=[],this.$$=this._createComponent.bind(this),this.$$.capturing=!0};CaptureContext.prototype._createComponent=function(){var vel=VirtualElement.createElement.apply(this,arguments);return vel._context=this,vel._owner=this.owner,vel._isVirtualComponent&&this.components.push(vel),this.elements.push(vel),vel},RenderingEngine.createContext=function(comp){var vel=_createWrappingVirtualComponent(comp);return new CaptureContext(vel)};var RenderingState=function(){this.poluted=[],this.id="__"+uuid$1()};RenderingState.prototype.dispose=function(){var id=this.id;this.poluted.forEach(function(obj){delete obj[id]})},RenderingState.prototype.set=function(obj,key,val){var info=obj[this.id];info||(info={},obj[this.id]=info,this.poluted.push(obj)),info[key]=val},RenderingState.prototype.get=function(obj,key){var info=obj[this.id];if(info)return info[key]},RenderingState.prototype.setMapped=function(c){this.set(c,"mapped",!0)},RenderingState.prototype.isMapped=function(c){return Boolean(this.get(c,"mapped"))},RenderingState.prototype.setRelocated=function(c){this.set(c,"relocated",!0)},RenderingState.prototype.isRelocated=function(c){return Boolean(this.get(c,"relocated"))},RenderingState.prototype.setDetached=function(c){this.set(c,"detached",!0)},RenderingState.prototype.isDetached=function(c){return Boolean(this.get(c,"detached"))},RenderingState.prototype.setCaptured=function(vc){this.set(vc,"captured",!0)},RenderingState.prototype.isCaptured=function(vc){return Boolean(this.get(vc,"captured"))},RenderingState.prototype.setNew=function(vc){this.set(vc,"created",!0)},RenderingState.prototype.isNew=function(vc){return Boolean(this.get(vc,"created"))},RenderingState.prototype.setUpdated=function(vc){this.set(vc,"updated",!0)},RenderingState.prototype.isUpdated=function(vc){return Boolean(this.get(vc,"updated"))},RenderingState.prototype.setSkipped=function(vc){this.set(vc,"skipped",!0)},RenderingState.prototype.isSkipped=function(vc){return Boolean(this.get(vc,"skipped"))},RenderingState.prototype.setRendered=function(vc){this.set(vc,"rendered",!0)},RenderingState.prototype.isRendered=function(vc){return Boolean(this.get(vc,"rendered"))},RenderingState.prototype.setOldProps=function(vc,oldProps){this.set(vc,"oldProps",oldProps)},RenderingState.prototype.getOldProps=function(vc){return this.get(vc,"oldProps")},RenderingState.prototype.setOldState=function(vc,oldState){this.set(vc,"oldState",oldState)},RenderingState.prototype.getOldState=function(vc){return this.get(vc,"oldState")},RenderingEngine.State=RenderingState;var __id__$5=0,Component=function(superclass){function Component(parent,props){superclass.call(this),"SKIP"!==arguments[0]&&(this.__id__=__id__$5++,this.parent=parent,this.el=null,this.refs={},this.__foreignRefs__={},this._actionHandlers={},this.context=this._getContext()||{},Object.freeze(this.context),this.props=props||{},Object.freeze(this.props),this.state=this.getInitialState()||{},Object.freeze(this.state))}return superclass&&(Component.__proto__=superclass),Component.prototype=Object.create(superclass&&superclass.prototype),Component.prototype.constructor=Component,Component.prototype.getChildContext=function(){return this.childContext||{}},Component.prototype.getInitialState=function(){return{}},Component.prototype.getParent=function(){return this.parent},Component.prototype.getRoot=function(){for(var comp=this,parent=comp;parent;)comp=parent,parent=comp.getParent();return comp},Component.prototype.getNativeElement=function(){return this.el.getNativeElement()},Component.prototype.getLabel=function(name){var labelProvider=this.context.labelProvider;if(!labelProvider)throw new Error("Missing labelProvider.");return labelProvider.getLabel(name)},Component.prototype.getComponent=function(nodeType,maybe){var componentRegistry=this.getComponentRegistry();if(!componentRegistry)throw new Error("Missing componentRegistry.");var ComponentClass=componentRegistry.get(nodeType);if(!maybe&&!ComponentClass)throw new Error("No Component registered with name "+nodeType);return ComponentClass},Component.prototype.getComponentRegistry=function(){return this.context.componentRegistry},Component.prototype.render=function($$){return $$("div")},Component.prototype.mount=function(el){if(!el)throw new Error("Element is required.");return this.el||this._render(),el._isDOMElement||(el=DefaultDOMElement.wrapNativeElement(el)),el.appendChild(this.el),el.isInDocument()&&this.triggerDidMount(!0),this},Component.prototype.shouldRerender=function(newProps){return!0},Component.prototype.rerender=function(){this._rerender(this.props,this.state)},Component.prototype._rerender=function(oldProps,oldState){this._render(oldProps,oldState),this.isMounted()||this.didUpdate(oldProps,oldState)},Component.prototype._render=function(oldProps,oldState){if(this.__isRendering__)throw new Error("Component is rendering already.");this.__isRendering__=!0;try{var engine=new RenderingEngine;engine._render(this,oldProps,oldState)}finally{delete this.__isRendering__}},Component.prototype.triggerDidMount=function(){this.getChildren().forEach(function(child){child.triggerDidMount(!0)}),this.__isMounted__||(this.__isMounted__=!0,this.didMount())},Component.prototype.didMount=function(){},Component.prototype.didUpdate=function(){},Component.prototype.isMounted=function(){return this.__isMounted__},Component.prototype.triggerDispose=function(){this.getChildren().forEach(function(child){child.triggerDispose()}),this.dispose(),this.__isMounted__=!1},Component.prototype.dispose=function(){},Component.prototype._setParent=function(newParent){this.parent=newParent,this.context=this._getContext()||{},Object.freeze(this.context)},Component.prototype.send=function(action){for(var arguments$1=arguments,comp=this;comp;){if(comp._actionHandlers&&comp._actionHandlers[action])return comp._actionHandlers[action].apply(comp,Array.prototype.slice.call(arguments$1,1)),!0;comp=comp.getParent()}return console.warn("Action",action,"was not handled."),!1},Component.prototype.handleActions=function(actionHandlers){return each$2(actionHandlers,function(method,actionName){this.handleAction(actionName,method)}.bind(this)),this},Component.prototype.handleAction=function(name,handler){if(!name||!handler||!isFunction$1(handler))throw new Error("Illegal arguments.");handler=handler.bind(this),this._actionHandlers[name]=handler},Component.prototype.getState=function(){return this.state},Component.prototype.setState=function(newState){var oldProps=this.props,oldState=this.state,needRerender=!this.__isSettingProps__&&this.shouldRerender(this.getProps(),newState);this.willUpdateState(newState),this.state=newState||{},Object.freeze(this.state),needRerender?this._rerender(oldProps,oldState):this.__isSettingProps__||this.didUpdate(oldProps,oldState)},Component.prototype.extendState=function(newState){newState=extend$1({},this.state,newState),this.setState(newState)},Component.prototype.willUpdateState=function(newState){},Component.prototype.getProps=function(){return this.props},Component.prototype.setProps=function(newProps){var oldProps=this.props,oldState=this.state,needRerender=this.shouldRerender(newProps,this.state);this._setProps(newProps),needRerender?this._rerender(oldProps,oldState):this.didUpdate(oldProps,oldState)},Component.prototype._setProps=function(newProps){newProps=newProps||{},this.__isSettingProps__=!0;try{this.willReceiveProps(newProps),this.props=newProps||{},Object.freeze(newProps)}finally{delete this.__isSettingProps__}},Component.prototype.extendProps=function(updatedProps){var newProps=extend$1({},this.props,updatedProps);this.setProps(newProps)},Component.prototype.willReceiveProps=function(newProps){},Component.prototype.getChildNodes=function(){if(!this.el)return[];var childNodes=this.el.getChildNodes();return childNodes=childNodes.map(_unwrapComp).filter(notNull)},Component.prototype.getChildren=function(){if(!this.el)return[];var children=this.el.getChildren();return children=children.map(_unwrapComp).filter(notNull)},Component.prototype.getChildAt=function(pos){var node=this.el.getChildAt(pos);return _unwrapCompStrict(node)},Component.prototype.find=function(cssSelector){var el=this.el.find(cssSelector);return _unwrapComp(el)},Component.prototype.findAll=function(cssSelector){var els=this.el.findAll(cssSelector);return els.map(_unwrapComp).filter(notNull)},Component.prototype.appendChild=function(child){this.insertAt(this.getChildCount(),child)},Component.prototype.insertAt=function(pos,childEl){if(isString$1(childEl)&&(childEl=new VirtualElement.TextNode(childEl)),!childEl._isVirtualElement)throw new Error('Invalid argument: "child" must be a VirtualElement.');var child=(new RenderingEngine)._renderChild(this,childEl);this.el.insertAt(pos,child.el),_mountChild(this,child)},Component.prototype.removeAt=function(pos){var childEl=this.el.getChildAt(pos);if(childEl){var child=_unwrapCompStrict(childEl);_disposeChild(child),this.el.removeAt(pos)}},Component.prototype.removeChild=function(child){if(!child||!child._isComponent)throw new Error("removeChild(): Illegal arguments. Expecting a Component instance.");_disposeChild(child),this.el.removeChild(child.el)},Component.prototype.replaceChild=function(oldChild,newChild){if(!(newChild&&oldChild&&newChild._isComponent&&oldChild._isComponent))throw new Error("replaceChild(): Illegal arguments. Expecting BrowserDOMElement instances.");_disposeChild(oldChild),this.el.replaceChild(newChild.el,oldChild.el),this.isMounted()&&newChild.triggerDidMount(!0)},Component.prototype.empty=function(){return this.el&&(this.getChildNodes().forEach(function(child){_disposeChild(child)}),this.el.empty()),this},Component.prototype.remove=function(){_disposeChild(this),this.el.remove()},Component.prototype._getContext=function(){var context={},parent=this.getParent();return parent&&(context=extend$1(context,parent.context),parent.getChildContext)?extend$1(context,parent.getChildContext()):context},Component.prototype.addEventListener=function(){throw new Error("Not supported.")},Component.prototype.removeEventListener=function(){throw new Error("Not supported.")},Component.prototype.insertBefore=function(){throw new Error("Not supported.")},Component}(DOMElement.Delegator);Component.prototype._isComponent=!0,EventEmitter.mixin(Component),DOMElement._defineProperties(Component,DOMElement._propertyNames),Component.unwrap=_unwrapComp,Component.render=function(props){props=props||{};var ComponentClass=this,comp=new ComponentClass(null,props);return comp._render(),comp},Component.mount=function(props,el){if(1===arguments.length&&(props={},el=arguments[0]),!el)throw new Error("'el' is required.");if(isString$1(el)){var selector=el;if(!inBrowser)throw new Error("This selector is not supported on server side.");el=window.document.querySelector(selector)}el._isDOMElement||(el=new DefaultDOMElement.wrapNativeElement(el));var ComponentClass=this,comp=new ComponentClass(null,props);return comp.mount(el),comp},Object.defineProperty(Component,"$$",{get:function(){throw new Error(["With Substance Beta 4 we introduced a breaking change.","We needed to turn the former static Component.$$ into a contextualized implementation, which is now served via Component.render($$).","FIX: change your signature of 'this.render()' in all your Components to 'this.render($$)"].join("\n"))}}),Component.unwrapDOMElement=function(el){return _unwrapComp(el)},Component.getComponentFromNativeElement=function(nativeEl){return _unwrapComp(DefaultDOMElement.wrapNativeElement(nativeEl))};var ElementComponent=function(Component){function ElementComponent(parent,virtualComp){if(Component.call(this,"SKIP"),!parent._isComponent)throw new Error("Illegal argument: 'parent' must be a Component.");if(!virtualComp._isVirtualHTMLElement)throw new Error("Illegal argument: 'virtualComp' must be a VirtualHTMLElement.");this.parent=parent,this.context=this._getContext()||{},Object.freeze(this.context)}return Component&&(ElementComponent.__proto__=Component),ElementComponent.prototype=Object.create(Component&&Component.prototype),ElementComponent.prototype.constructor=ElementComponent,ElementComponent}(Component);ElementComponent.prototype._isElementComponent=!0;var TextNodeComponent=function(Component){function TextNodeComponent(parent,virtualComp){if(Component.call(this,"SKIP"),!parent._isComponent)throw new Error("Illegal argument: 'parent' must be a Component.");if(!virtualComp._isVirtualTextNode)throw new Error("Illegal argument: 'virtualComp' must be a VirtualTextNode.");this.parent=parent}return Component&&(TextNodeComponent.__proto__=Component),TextNodeComponent.prototype=Object.create(Component&&Component.prototype),TextNodeComponent.prototype.constructor=TextNodeComponent,TextNodeComponent.prototype.setTextContent=function(text){if(!this.el)throw new Error("Component must be rendered first.");if(this.el.textContent!==text){var newEl=this.el.createTextNode(text);this.el._replaceNativeEl(newEl.getNativeElement())}},TextNodeComponent.prototype.getChildNodes=function(){return[]},TextNodeComponent.prototype.getChildren=function(){return[]},TextNodeComponent}(Component);TextNodeComponent.prototype._isTextNodeComponent=!0,Component.Element=ElementComponent,Component.TextNode=TextNodeComponent;var Button=function(Component$$1){function Button(){Component$$1.apply(this,arguments)}return Component$$1&&(Button.__proto__=Component$$1),Button.prototype=Object.create(Component$$1&&Component$$1.prototype),Button.prototype.constructor=Button,Button.prototype.render=function($$){var el=$$("button").addClass("sc-button");return this.props.icon&&el.append(this.renderIcon($$)),this.props.label&&el.append(this.renderLabel($$)),this.props.hint&&el.append(this.renderHint($$)),this.props.active&&el.addClass("sm-active"),this.props.style?el.addClass("sm-style-"+this.props.style):el.addClass("sm-style-outline"),this.props.disabled?el.attr("tabindex",-1).attr("disabled",!0):el.attr("tabindex",1),el.append(this.props.children),el},Button.prototype.renderIcon=function($$){var iconEl=this.context.iconProvider.renderIcon($$,this.props.icon);return iconEl},Button.prototype.renderLabel=function($$){return $$("div").addClass("se-label").append(this.getLabel(this.props.label))},Button.prototype.renderHint=function($$){return $$("div").addClass("se-hint").append(this.getLabel(this.props.hint))},Button.prototype.getLabel=function(name){var labelProvider=this.context.labelProvider;return labelProvider.getLabel(name)},Button}(Component),Tool=function(Component$$1){function Tool(){Component$$1.apply(this,arguments)}Component$$1&&(Tool.__proto__=Component$$1),Tool.prototype=Object.create(Component$$1&&Component$$1.prototype),Tool.prototype.constructor=Tool;var prototypeAccessors={_isTool:{}};return prototypeAccessors._isTool.get=function(){return!0},Tool.prototype.render=function($$){var el=$$("div").addClass("se-tool"),customClassNames=this.getClassNames();customClassNames&&el.addClass(customClassNames);var title=this.getTitle();return title&&(el.attr("title",title),el.attr("aria-label",title)),el.append(this.renderButton($$)),el},Tool.prototype.renderButton=function($$){var btn=$$(Button,{icon:this.props.icon,label:this.props.label,hint:this.props.hint,active:this.props.active,disabled:this.props.disabled,style:this.props.style}).on("click",this.onClick);return btn},Tool.prototype.getClassNames=function(){return""},Tool.prototype.getTitle=function(){var labelProvider=this.context.labelProvider,title=this.props.title||labelProvider.getLabel(this.getName());return this.props.mode&&(title=[capitalize$1(this.props.mode),title].join(" ")),title},Tool.prototype.getCommandName=function(){return this.getName()},Tool.prototype.getName=function(){return this.props.name},Tool.prototype.onClick=function(e){e.preventDefault(),e.stopPropagation(),this.props.disabled||this.executeCommand()},Tool.prototype.executeCommand=function(props){this.context.commandManager.executeCommand(this.getCommandName(),extend$1({mode:this.props.mode},props))},Object.defineProperties(Tool.prototype,prototypeAccessors),Tool}(Component),ToolGroup=function(Component$$1){function ToolGroup(){Component$$1.apply(this,arguments)}return Component$$1&&(ToolGroup.__proto__=Component$$1),ToolGroup.prototype=Object.create(Component$$1&&Component$$1.prototype),ToolGroup.prototype.constructor=ToolGroup,ToolGroup.prototype.render=function($$){var tools=this.props.tools,commandStates=this.props.commandStates,el=$$("div").addClass("sc-tool-group");return el.addClass("sm-target-"+this.props.name),tools.forEach(function(tool,name){var toolProps=Object.assign({},commandStates[name]);toolProps.name=name,toolProps.icon=name,toolProps.style="outline",el.append($$(tool.Class,toolProps))}),el},ToolGroup}(Component),platform={inBrowser:inBrowser,isIE:!1,isFF:!1,isWebkit:!1,version:-1,isWindows:inBrowser&&void 0!==window.navigator&&window.navigator.appVersion&&window.navigator.appVersion.indexOf("Win")!==-1};if("undefined"!=typeof window){var ua=window.navigator.userAgent,msie=ua.indexOf("MSIE "),trident=ua.indexOf("Trident/"),edge=ua.indexOf("Edge/");msie>0?(platform.isIE=!0,platform.version=10):trident>0?(platform.isIE=!0,platform.version=11,platform.isTrident=!0):edge>0&&(platform.isIE=!0,platform.isEdge=!0,platform.version=12,parseInt(ua.substring(edge+5,ua.indexOf(".",edge)),10)),platform.isFF=window.navigator.userAgent.toLowerCase().indexOf("firefox")>-1,platform.isWebkit=!platform.isFF&&!platform.isIE}var Scrollbar=function(Component$$1){function Scrollbar(){Component$$1.apply(this,arguments)}return Component$$1&&(Scrollbar.__proto__=Component$$1),Scrollbar.prototype=Object.create(Component$$1&&Component$$1.prototype),Scrollbar.prototype.constructor=Scrollbar,Scrollbar.prototype.didMount=function(){DefaultDOMElement.getBrowserWindow().on("resize",this.onResize,this),this.props.scrollPane.on("scroll",this.onScroll,this),setTimeout(function(){this.updatePositions()}.bind(this))},Scrollbar.prototype.dispose=function(){DefaultDOMElement.getBrowserWindow().off(this),this.props.scrollPane.off(this)},Scrollbar.prototype.didUpdate=function(){this.updatePositions()},Scrollbar.prototype.render=function($$){var el=$$("div").addClass("sc-scrollbar").on("mousedown",this.onMouseDown);if(this.props.highlights){var highlightEls=[];each$2(this.props.highlights,function(highlights,scope){each$2(highlights,function(h){highlightEls.push($$("div").ref(h).addClass("se-highlight sm-"+scope))})}),el.append($$("div").ref("highlights").addClass("se-highlights").append(highlightEls))}return el.append($$("div").ref("thumb").addClass("se-thumb")),el},Scrollbar.prototype.updatePositions=function(){var scrollPane=this.props.scrollPane,scrollableEl=scrollPane.getScrollableElement(),contentHeight=scrollPane.getContentHeight(),scrollPaneHeight=scrollPane.getHeight(),scrollTop=scrollPane.getScrollPosition(),contentEl=scrollPane.getContentElement();this.factor=contentHeight/scrollPaneHeight,this.refs.thumb.css({top:scrollTop/this.factor,height:scrollPaneHeight/this.factor}),this.props.highlights&&each$2(this.props.highlights,function(highlights){each$2(highlights,function(nodeId){var nodeEl=scrollableEl.find('*[data-id="'+nodeId+'"]');if(nodeEl){var rect=getRelativeBoundingRect(nodeEl.getNativeElement(),contentEl.getNativeElement()),top=rect.top/this.factor,height=rect.height/this.factor;height<Scrollbar.overlayMinHeight&&(height=Scrollbar.overlayMinHeight);var highlightEl=this.refs[nodeId];highlightEl?this.refs[nodeId].css({top:top,height:height}):console.warn("no ref found for highlight",nodeId)}}.bind(this))}.bind(this))},Scrollbar.prototype.getScrollableElement=function(){return this.props.scrollPane.getScrollableElement()},Scrollbar.prototype.onResize=function(){this.rerender()},Scrollbar.prototype.onScroll=function(){this.updatePositions()},Scrollbar.prototype.onMouseDown=function(e){e.stopPropagation(),e.preventDefault(),this._mouseDown=!0;var _window=DefaultDOMElement.getBrowserWindow();_window.on("mousemove",this.onMouseMove,this),_window.on("mouseup",this.onMouseUp,this);var scrollBarOffset=this.el.getOffset().top,y=e.pageY-scrollBarOffset,thumbEl=this.refs.thumb.el;e.target!==thumbEl.getNativeElement()?(this.offset=thumbEl.height/2,this.onMouseMove(e)):this.offset=y-thumbEl.getPosition().top},Scrollbar.prototype.onMouseUp=function(){this._mouseDown=!1;var _window=DefaultDOMElement.getBrowserWindow();_window.off("mousemove",this.onMouseMove,this),_window.off("mouseup",this.onMouseUp,this)},Scrollbar.prototype.onMouseMove=function(e){if(this._mouseDown){var scrollPane=this.props.scrollPane,scrollableEl=scrollPane.getScrollableElement(),scrollBarOffset=this.el.getOffset().top,y=e.pageY-scrollBarOffset,scroll=(y-this.offset)*this.factor;scrollableEl.setProperty("scrollTop",scroll)}},Scrollbar}(Component);Scrollbar.overlayMinHeight=2;var OverlayContainer=function(Component$$1){function OverlayContainer(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];Component$$1.apply(this,args),this.commandStates=this._getCommandStates()}return Component$$1&&(OverlayContainer.__proto__=Component$$1),OverlayContainer.prototype=Object.create(Component$$1&&Component$$1.prototype),OverlayContainer.prototype.constructor=OverlayContainer,OverlayContainer.prototype.render=function($$){var el=$$("div").addClass("sc-overlay-container sm-hidden"),commandStates=this.context.commandManager.getCommandStates(),ComponentClass=this.props.overlay;return el.append($$(ComponentClass,{commandStates:commandStates}).ref("overlayContent")),el},OverlayContainer.prototype.didMount=function(){this.context.documentSession.on("didUpdate",this._onSessionDidUpdate,this)},OverlayContainer.prototype.dispose=function(){this.context.documentSession.off(this)},OverlayContainer.prototype.position=function(hints){var content=this.refs.overlayContent;content.isVisible()&&(this._position(hints),this.el.removeClass("sm-hidden"))},OverlayContainer.prototype._onSessionDidUpdate=function(){this.shouldRerender()&&this.rerender()},OverlayContainer.prototype._getCommandStates=function(){return this.context.commandManager.getCommandStates()},OverlayContainer.prototype._position=function(hints){if(hints){var contentWidth=this.el.htmlProp("offsetWidth"),selectionMaxWidth=hints.rectangle.width;this.el.css("top",hints.rectangle.top+hints.rectangle.height);var leftPos=hints.rectangle.left+selectionMaxWidth/2-contentWidth/2;leftPos=Math.max(leftPos,0);var maxLeftPos=hints.rectangle.left+selectionMaxWidth+hints.rectangle.right-contentWidth;leftPos=Math.min(leftPos,maxLeftPos),this.el.css("left",leftPos)}},OverlayContainer}(Component),GutterContainer=function(Component$$1){function GutterContainer(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];Component$$1.apply(this,args)}return Component$$1&&(GutterContainer.__proto__=Component$$1),GutterContainer.prototype=Object.create(Component$$1&&Component$$1.prototype),GutterContainer.prototype.constructor=GutterContainer,GutterContainer.prototype.render=function($$){var el=$$("div").addClass("sc-gutter-container sm-hidden"),gutterEl=this.props.gutter;return gutterEl.ref("gutter"),el.append(gutterEl),el},GutterContainer.prototype.didMount=function(){this.context.documentSession.on("didUpdate",this._onSessionDidUpdate,this)},GutterContainer.prototype.dispose=function(){this.context.documentSession.off(this)},GutterContainer.prototype.position=function(hints){var gutterEl=this.el.children[0]._comp;gutterEl.isVisible()&&(this._position(hints),this.el.removeClass("sm-hidden"))},GutterContainer.prototype._onSessionDidUpdate=function(){this.shouldRerender()&&this.rerender()},GutterContainer.prototype._position=function(hints){hints&&(this.el.css("top",hints.rectangle.top+hints.rectangle.height-hints.rectangle.height/2),this.el.css("left",0))},GutterContainer}(Component),ScrollPane=function(Component$$1){function ScrollPane(){Component$$1.apply(this,arguments)}return Component$$1&&(ScrollPane.__proto__=Component$$1),ScrollPane.prototype=Object.create(Component$$1&&Component$$1.prototype),ScrollPane.prototype.constructor=ScrollPane,ScrollPane.prototype.getChildContext=function(){return{scrollPane:this}},ScrollPane.prototype.didMount=function(){this.refs.scrollbar&&this.props.highlights&&this.props.highlights.on("highlights:updated",this.onHighlightsUpdated,this),this.refs.scrollbar&&this.context.doc.on("document:changed",this.onDocumentChange,this,{priority:-1}),this.handleActions({updateOverlayHints:this._updateOverlayHints})},ScrollPane.prototype.dispose=function(){this.props.highlights&&this.props.highlights.off(this),this.context.doc.off(this)},ScrollPane.prototype.render=function($$){var overlay,gutter,el=$$("div").addClass("sc-scroll-pane");return platform.isFF&&el.addClass("sm-firefox"),"substance"===this.props.scrollbarType&&(el.addClass("sm-substance-scrollbar"),el.addClass("sm-scrollbar-position-"+this.props.scrollbarPosition),el.append($$(Scrollbar,{scrollPane:this}).ref("scrollbar").attr("id","content-scrollbar")),el.append($$("div").ref("scanline").addClass("se-scanline"))),this.props.overlay&&(overlay=$$(OverlayContainer,{overlay:this.props.overlay}).ref("overlay")),this.props.gutter&&(gutter=$$(GutterContainer,{gutter:this.props.gutter}).ref("gutter")),el.append($$("div").ref("scrollable").addClass("se-scrollable").append($$("div").ref("content").addClass("se-content").append(overlay).append(gutter).append(this.props.children)).on("scroll",this.onScroll)),el},ScrollPane.prototype._updateOverlayHints=function(overlayHints){var overlay=this.refs.overlay,gutter=this.refs.gutter;overlay&&overlay.position(overlayHints),gutter&&gutter.position(overlayHints)},ScrollPane.prototype.onDocumentChange=function(){this.refs.scrollbar.updatePositions()},ScrollPane.prototype.onHighlightsUpdated=function(highlights){this.refs.scrollbar.extendProps({highlights:highlights})},ScrollPane.prototype.onScroll=function(){var scrollPos=this.getScrollPosition(),scrollable=this.refs.scrollable;this.props.onScroll&&this.props.onScroll(scrollPos,scrollable),this.props.tocProvider&&this.props.tocProvider.markActiveEntry(this),this.emit("scroll",scrollPos,scrollable)},ScrollPane.prototype.getHeight=function(){var scrollableEl=this.getScrollableElement();return scrollableEl.height},ScrollPane.prototype.getContentHeight=function(){var contentHeight=0,contentEl=this.refs.content.el;return contentEl.childNodes.forEach(function(el){contentHeight+=el.getOuterHeight()}),contentHeight},ScrollPane.prototype.getContentElement=function(){return this.refs.content.el},ScrollPane.prototype.getScrollableElement=function(){return this.refs.scrollable.el},ScrollPane.prototype.getScrollPosition=function(){var scrollableEl=this.getScrollableElement();return Math.floor(scrollableEl.getProperty("scrollTop")+1)},ScrollPane.prototype.getPanelOffsetForElement=function(el){var nativeEl=el.el,contentContainerEl=this.refs.content.el.el,rect=getRelativeBoundingRect(nativeEl,contentContainerEl);return rect.top},ScrollPane.prototype.scrollTo=function(componentId,onlyIfNotVisible){var scrollableEl=this.getScrollableElement(),targetNode=scrollableEl.find('*[data-id="'+componentId+'"]');if(targetNode){var offset=this.getPanelOffsetForElement(targetNode),shouldScroll=!0;if(onlyIfNotVisible){var height=scrollableEl.height,oldOffset=scrollableEl.getProperty("scrollTop");shouldScroll=offset<oldOffset||oldOffset+height<offset}shouldScroll&&scrollableEl.setProperty("scrollTop",offset)}else console.warn(componentId,"not found in scrollable container")},ScrollPane}(Component),ScrollPanePackage={name:"scroll-pane",configure:function(config){config.addComponent("scroll-pane",ScrollPane)}},SplitPane=function(Component$$1){function SplitPane(){Component$$1.apply(this,arguments)}return Component$$1&&(SplitPane.__proto__=Component$$1),SplitPane.prototype=Object.create(Component$$1&&Component$$1.prototype),SplitPane.prototype.constructor=SplitPane,SplitPane.prototype.render=function($$){if(2!==this.props.children.length)throw new Error("SplitPane only works with exactly two child elements");var el=$$("div").addClass("sc-split-pane");"horizontal"===this.props.splitType?el.addClass("sm-horizontal"):el.addClass("sm-vertical");var paneA=this.props.children[0],paneB=this.props.children[1];return this.props.sizeB?(paneB.addClass("se-pane sm-sized"),paneB.css(this.getSizedStyle(this.props.sizeB)),paneA.addClass("se-pane sm-auto-fill")):(paneA.addClass("se-pane sm-sized"),paneA.css(this.getSizedStyle(this.props.sizeA)),paneB.addClass("se-pane sm-auto-fill")),el.append(paneA,paneB),el},SplitPane.prototype.getSizedStyle=function(size){return size&&"inherit"!==size?"horizontal"===this.props.splitType?{height:size}:{width:size}:{}},SplitPane}(Component),SplitPanePackage={name:"split-pane",configure:function(config){config.addComponent("split-pane",SplitPane)}},TabbedPane=function(Component$$1){function TabbedPane(){Component$$1.apply(this,arguments)}return Component$$1&&(TabbedPane.__proto__=Component$$1),
TabbedPane.prototype=Object.create(Component$$1&&Component$$1.prototype),TabbedPane.prototype.constructor=TabbedPane,TabbedPane.prototype.render=function($$){var el=$$("div").addClass("sc-tabbed-pane"),tabsEl=$$("div").addClass("se-tabs");return each$2(this.props.tabs,function(tab){var tabEl=$$("a").addClass("se-tab").attr({href:"#","data-id":tab.id}).on("click",this.onTabClicked);tab.id===this.props.activeTab&&tabEl.addClass("sm-active"),tabEl.append($$("span").addClass("label").append(tab.name)),tabsEl.append(tabEl)}.bind(this)),el.append(tabsEl),el.append($$("div").addClass("se-tab-content").ref("tabContent").append(this.props.children)),el},TabbedPane.prototype.onTabClicked=function(e){e.preventDefault();var tabId=e.currentTarget.dataset.id;this.send("switchTab",tabId)},TabbedPane}(Component),TabbedPanePackage={name:"tabbed-pane",configure:function(config){config.addComponent("tabbed-pane",TabbedPane)}},ScrollbarPackage={name:"scrollbar",configure:function(config){config.addComponent("scrollbar",Scrollbar)}},Grid=function(Component$$1){function Grid(){Component$$1.apply(this,arguments)}return Component$$1&&(Grid.__proto__=Component$$1),Grid.prototype=Object.create(Component$$1&&Component$$1.prototype),Grid.prototype.constructor=Grid,Grid.prototype.render=function($$){var el=$$("div").addClass("sc-grid");return this.props.mobile&&el.addClass("sm-mobile"),el.append(this.props.children),el},Grid}(Component),Row=function(Component$$1){function Row(){Component$$1.apply(this,arguments)}return Component$$1&&(Row.__proto__=Component$$1),Row.prototype=Object.create(Component$$1&&Component$$1.prototype),Row.prototype.constructor=Row,Row.prototype.render=function($$){var el=$$("div").addClass("se-row");return el.append(this.props.children),el},Row}(Component),Cell=function(Component$$1){function Cell(){Component$$1.apply(this,arguments)}return Component$$1&&(Cell.__proto__=Component$$1),Cell.prototype=Object.create(Component$$1&&Component$$1.prototype),Cell.prototype.constructor=Cell,Cell.prototype.render=function($$){var el=$$("div").addClass("se-cell");return el.addClass("sm-column-"+this.props.columns),el.append(this.props.children),el},Cell}(Component);Grid.Row=Row,Grid.Cell=Cell;var GridPackage={name:"grid",configure:function(config){config.addComponent("grid",Grid)}},Modal=function(Component$$1){function Modal(){Component$$1.apply(this,arguments)}return Component$$1&&(Modal.__proto__=Component$$1),Modal.prototype=Object.create(Component$$1&&Component$$1.prototype),Modal.prototype.constructor=Modal,Modal.prototype.render=function($$){var el=$$("div").addClass("sc-modal");return el.on("click",this._closeModal),this.props.width&&el.addClass("sm-width-"+this.props.width),el.append($$("div").addClass("se-body").append(this.props.children)),el},Modal.prototype._closeModal=function(e){var closeSurfaceClick=e.target.classList.contains("sc-modal");closeSurfaceClick&&this.send("closeModal")},Modal}(Component),ModalPackage={name:"modal",configure:function(config){config.addComponent("modal",Modal)}},Input=function(Component$$1){function Input(){Component$$1.apply(this,arguments)}return Component$$1&&(Input.__proto__=Component$$1),Input.prototype=Object.create(Component$$1&&Component$$1.prototype),Input.prototype.constructor=Input,Input.prototype._onChange=function(){var documentSession=this.context.documentSession,path=this.props.path,newVal=this.el.val();documentSession.transaction(function(tx){tx.set(path,newVal)})},Input.prototype.render=function($$){var val;if(this.props.path){var documentSession=this.context.documentSession,doc=documentSession.getDocument();val=doc.get(this.props.path)}else val=this.props.value;var el=$$("input").attr({value:val,type:this.props.type,placeholder:this.props.placeholder}).addClass("sc-input");return this.props.path&&el.on("change",this._onChange),this.props.centered&&el.addClass("sm-centered"),el},Input}(Component),InputPackage={name:"input",configure:function(config){config.addComponent("input",Input)}},ButtonPackage={name:"button",configure:function(config){config.addComponent("button",Button)}},isMatch=createCommonjsModule(function(module){function isMatch(object,source){return object===source||baseIsMatch(object,source,getMatchData(source))}var baseIsMatch=interopDefault(require$$1$5),getMatchData=interopDefault(require$$0$29);module.exports=isMatch}),_isMatch=interopDefault(isMatch),_createFind=createCommonjsModule(function(module){function createFind(findIndexFunc){return function(collection,predicate,fromIndex){var iterable=Object(collection);if(predicate=baseIteratee(predicate,3),!isArrayLike(collection))var props=keys(collection);var index=findIndexFunc(props||collection,function(value,key){return props&&(key=value,value=iterable[key]),predicate(value,key,iterable)},fromIndex);return index>-1?collection[props?props[index]:index]:void 0}}var baseIteratee=interopDefault(require$$2$6),isArrayLike=interopDefault(require$$3),keys=interopDefault(require$$0$3);module.exports=createFind}),_createFind$1=interopDefault(_createFind),require$$1$35=Object.freeze({default:_createFind$1}),find$1=createCommonjsModule(function(module){var createFind=interopDefault(require$$1$35),findIndex=interopDefault(require$$0$56),find=createFind(findIndex);module.exports=find}),_find=interopDefault(find$1),SwitchTextTypeCommand=function(Command$$1){function SwitchTextTypeCommand(){Command$$1.apply(this,arguments)}return Command$$1&&(SwitchTextTypeCommand.__proto__=Command$$1),SwitchTextTypeCommand.prototype=Object.create(Command$$1&&Command$$1.prototype),SwitchTextTypeCommand.prototype.constructor=SwitchTextTypeCommand,SwitchTextTypeCommand.prototype.getTextTypes=function(params){var surface=params.surface;return surface&&surface.isContainerEditor()?surface.getTextTypes():[]},SwitchTextTypeCommand.prototype.getTextType=function(params){var textTypes=this.getTextTypes(params);return _find(textTypes,function(t){return t.name===params.textType})},SwitchTextTypeCommand.prototype.getCurrentTextType=function(params,node){var currentTextType,textTypes=this.getTextTypes(params);return textTypes.forEach(function(textType){var nodeProps=clone$2(textType.data);delete nodeProps.type,_isMatch(node,nodeProps)&&node.type===textType.data.type&&(currentTextType=textType)}),currentTextType},SwitchTextTypeCommand.prototype.getCommandState=function(params){var node,doc=params.documentSession.getDocument(),sel=params.selection,surface=params.surface,newState={disabled:!1,textTypes:this.getTextTypes(params)};if(surface&&surface.isEnabled()&&!sel.isNull())if(sel.isContainerSelection())newState.disabled=!0,newState.currentTextType={name:"container-selection"};else if(sel.isPropertySelection()){var path=sel.getPath();node=doc.get(path[0]),node&&(node.isText()&&node.isBlock()&&(newState.currentTextType=this.getCurrentTextType(params,node)),newState.currentTextType||(newState.currentTextType={name:[node.type,path[1]].join(".")},newState.disabled=!0))}else sel.isNodeSelection()?(node=doc.get(sel.getNodeId()),newState.currentTextType={name:node.type},newState.disabled=!0):sel.isCustomSelection()&&(newState.currentTextType={name:"custom"},newState.disabled=!0);else newState.disabled=!0;return newState},SwitchTextTypeCommand.prototype.execute=function(params){var textType=this.getTextType(params),nodeData=textType.data,surface=params.surface;return surface?(surface.transaction(function(tx,args){return args.data=nodeData,surface.switchType(tx,args)}),nodeData):void console.warn("No focused surface. Stopping command execution.")},SwitchTextTypeCommand}(Command),keys$2={UNDEFINED:0,BACKSPACE:8,DELETE:46,LEFT:37,RIGHT:39,UP:38,DOWN:40,ENTER:13,END:35,HOME:36,TAB:9,PAGEUP:33,PAGEDOWN:34,ESCAPE:27,SHIFT:16,SPACE:32},SwitchTextTypeTool=function(Tool$$1){function SwitchTextTypeTool(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];Tool$$1.apply(this,args),this._navIdx=-1}return Tool$$1&&(SwitchTextTypeTool.__proto__=Tool$$1),SwitchTextTypeTool.prototype=Object.create(Tool$$1&&Tool$$1.prototype),SwitchTextTypeTool.prototype.constructor=SwitchTextTypeTool,SwitchTextTypeTool.prototype.didMount=function(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];(ref=Tool$$1.prototype).didMount.apply(this,args),this._focusToggle();var ref},SwitchTextTypeTool.prototype.render=function($$){var labelProvider=this.context.labelProvider,textTypeName="No selection";this.props.currentTextType&&(textTypeName=this.props.currentTextType.name);var el=$$("div").addClass("sc-switch-text-type"),toggleButton=$$("button").ref("toggle").addClass("se-toggle").attr("title",labelProvider.getLabel("switch_text")).append(labelProvider.getLabel(textTypeName)).on("click",this.toggleAvailableTextTypes);if(this.props.disabled||!this.props.currentTextType?(el.addClass("sm-disabled"),toggleButton.attr("tabindex",-1)):toggleButton.attr("tabindex",1),el.append(toggleButton),this.state.open){el.addClass("sm-open");var options=$$("div").addClass("se-options").ref("options");each$2(this.props.textTypes,function(textType){var button=$$("button").addClass("se-option sm-"+textType.name).attr("data-type",textType.name).append(labelProvider.getLabel(textType.name)).on("click",this.handleClick);options.append(button)}.bind(this)),el.append(options),el.on("keydown",this.onKeydown)}return el},SwitchTextTypeTool.prototype.didUpdate=function(){this._focusToggle()},SwitchTextTypeTool.prototype._focusToggle=function(){this.state.open&&this.refs.toggle.focus()},SwitchTextTypeTool.prototype.executeCommand=function(textType){this.context.commandManager.executeCommand(this.getCommandName(),{textType:textType})},SwitchTextTypeTool.prototype.getTextCommands=function(){var surface=this.getSurface();return!this.textCommands&&surface&&(this.textCommands=surface.getTextCommands()),this.textCommands||{}},SwitchTextTypeTool.prototype.handleClick=function(e){e.preventDefault(),this.executeCommand(e.currentTarget.dataset.type)},SwitchTextTypeTool.prototype.onKeydown=function(event){var handled=!1;switch(event.keyCode){case keys$2.UP:this._nav(-1),handled=!0;break;case keys$2.DOWN:this._nav(1),handled=!0;break;case keys$2.ESCAPE:this.toggleDropdown(),handled=!0}handled&&(event.preventDefault(),event.stopPropagation())},SwitchTextTypeTool.prototype.toggleAvailableTextTypes=function(e){e.preventDefault(),e.stopPropagation(),this.props.disabled||this.toggleDropdown()},SwitchTextTypeTool.prototype.toggleDropdown=function(){this._navIdx=-1,this.extendState({open:!this.state.open})},SwitchTextTypeTool.prototype._nav=function(step){if(this._navIdx+=step,this._navIdx=Math.max(0,this._navIdx),this._navIdx=Math.min(this._getOptionsCount()-1,this._navIdx),this._navIdx>=0){var option=this.refs.options.children[this._navIdx];option.focus()}},SwitchTextTypeTool.prototype._getOptionsCount=function(){return this.refs.options.children.length},SwitchTextTypeTool}(Tool);SwitchTextTypeTool.command="switch-text-type";var SwitchTextTypePackage={name:"switch-text-type",configure:function(config){config.addCommand("switch-text-type",SwitchTextTypeCommand),config.addTool("switch-text-type",SwitchTextTypeTool,{target:"text"})}},Layout=function(Component$$1){function Layout(){Component$$1.apply(this,arguments)}return Component$$1&&(Layout.__proto__=Component$$1),Layout.prototype=Object.create(Component$$1&&Component$$1.prototype),Layout.prototype.constructor=Layout,Layout.prototype.render=function($$){var el=$$("div").addClass("sc-layout");return el.addClass("sm-width-"+this.props.width),this.props.textAlign&&el.addClass("sm-text-align-"+this.props.textAlign),this.props.noPadding&&el.addClass("sm-no-padding"),el.append(this.props.children),el},Layout}(Component),LayoutPackage={name:"layout",configure:function(config){config.addComponent("layout",Layout)}},BasePackage={name:"base",configure:function(config){config.import(SwitchTextTypePackage),config.import(ScrollPanePackage),config.import(SplitPanePackage),config.import(TabbedPanePackage),config.import(ScrollbarPackage),config.import(GridPackage),config.import(ModalPackage),config.import(InputPackage),config.import(ButtonPackage),config.import(LayoutPackage),config.addComponent("tool-target-text",ToolGroup),config.addComponent("tool-target-document",ToolGroup),config.addCommand("undo",Undo),config.addCommand("redo",Redo),config.addTool("undo",Tool,{target:"document"}),config.addTool("redo",Tool,{target:"document"}),config.addIcon("undo",{fontawesome:"fa-undo"}),config.addIcon("redo",{fontawesome:"fa-repeat"}),config.addIcon("edit",{fontawesome:"fa-cog"}),config.addIcon("delete",{fontawesome:"fa-times"}),config.addIcon("expand",{fontawesome:"fa-arrows-h"}),config.addIcon("truncate",{fontawesome:"fa-arrows-h"}),config.addLabel("undo",{en:"Undo",de:"Rückgängig"}),config.addLabel("redo",{en:"Redo",de:"Wiederherstellen"}),config.addLabel("container-selection",{en:"Container",de:"Container"}),config.addLabel("container",{en:"Container",de:"Container"}),config.addLabel("insert-container",{en:"Insert Container",de:"Container einfügen"})}},Blockquote=function(TextBlock$$1){function Blockquote(){TextBlock$$1.apply(this,arguments)}return TextBlock$$1&&(Blockquote.__proto__=TextBlock$$1),Blockquote.prototype=Object.create(TextBlock$$1&&TextBlock$$1.prototype),Blockquote.prototype.constructor=Blockquote,Blockquote}(TextBlock);Blockquote.type="blockquote";var NodeComponent=function(Component$$1){function NodeComponent(){Component$$1.apply(this,arguments)}return Component$$1&&(NodeComponent.__proto__=Component$$1),NodeComponent.prototype=Object.create(Component$$1&&Component$$1.prototype),NodeComponent.prototype.constructor=NodeComponent,NodeComponent.prototype.render=function($$){var tagName=this.getTagName(),el=$$(tagName).attr("data-id",this.props.node.id).addClass(this.getClassNames());return el},NodeComponent.prototype.getTagName=function(){return"div"},NodeComponent.prototype.getClassNames=function(){return""},NodeComponent}(Component),AnnotationComponent=function(Component$$1){function AnnotationComponent(){Component$$1.apply(this,arguments)}return Component$$1&&(AnnotationComponent.__proto__=Component$$1),AnnotationComponent.prototype=Object.create(Component$$1&&Component$$1.prototype),AnnotationComponent.prototype.constructor=AnnotationComponent,AnnotationComponent.prototype.didMount=function(){var node=this.props.node;node.on("highlighted",this.onHighlightedChanged,this)},AnnotationComponent.prototype.dispose=function(){var node=this.props.node;node.off(this)},AnnotationComponent.prototype.render=function($$){var el=$$("span").attr("data-id",this.props.node.id).addClass(this.getClassNames());return this.props.node.highlighted&&el.addClass("sm-highlighted"),el.append(this.props.children),el},AnnotationComponent.prototype.getClassNames=function(){return"sc-"+this.props.node.type},AnnotationComponent.prototype.onHighlightedChanged=function(){this.props.node.highlighted?this.el.addClass("sm-highlighted"):this.el.removeClass("sm-highlighted")},AnnotationComponent}(Component),_baseClamp=createCommonjsModule(function(module){function baseClamp(number,lower,upper){return number===number&&(void 0!==upper&&(number=number<=upper?number:upper),void 0!==lower&&(number=number>=lower?number:lower)),number}module.exports=baseClamp}),_baseClamp$1=interopDefault(_baseClamp),require$$3$19=Object.freeze({default:_baseClamp$1}),startsWith=createCommonjsModule(function(module){function startsWith(string,target,position){return string=toString(string),position=baseClamp(toInteger(position),0,string.length),string.lastIndexOf(baseToString(target),position)==position}var baseClamp=interopDefault(require$$3$19),baseToString=interopDefault(require$$2$17),toInteger=interopDefault(require$$1$25),toString=interopDefault(require$$0$31);module.exports=startsWith}),startsWith$1=interopDefault(startsWith),IsolatedNodeComponent=function(Component$$1){function IsolatedNodeComponent(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];Component$$1.apply(this,args),this.name=this.props.node.id,this._id=createSurfaceId(this),this._state={selectionFragment:null},this.handleAction("escape",this._escape),this.ContentClass=this._getContentClass(this.props.node)||Component$$1}Component$$1&&(IsolatedNodeComponent.__proto__=Component$$1),IsolatedNodeComponent.prototype=Object.create(Component$$1&&Component$$1.prototype),IsolatedNodeComponent.prototype.constructor=IsolatedNodeComponent;var prototypeAccessors={_isIsolatedNodeComponent:{},__elementTag:{},__slugChar:{}};return prototypeAccessors._isIsolatedNodeComponent.get=function(){return!0},prototypeAccessors.__elementTag.get=function(){return"div"},prototypeAccessors.__slugChar.get=function(){return"|"},IsolatedNodeComponent.prototype.getChildContext=function(){return{surfaceParent:this}},IsolatedNodeComponent.prototype.getInitialState=function(){var selState=this.context.documentSession.getSelectionState();return this._deriveStateFromSelectionState(selState)},IsolatedNodeComponent.prototype.didMount=function(){Component$$1.prototype.didMount.call(this);var docSession=this.context.documentSession;docSession.on("update",this.onSessionUpdate,this)},IsolatedNodeComponent.prototype.dispose=function(){Component$$1.prototype.dispose.call(this);var docSession=this.context.documentSession;docSession.off(this)},IsolatedNodeComponent.prototype.getClassNames=function(){return"sc-isolated-node"},IsolatedNodeComponent.prototype.render=function($$){var node=this.props.node,ContentClass=this.ContentClass,el=Component$$1.prototype.render.apply(this,arguments);el.tagName=this.__elementTag,el.addClass(this.getClassNames()).addClass("sm-"+this.props.node.type).attr("data-id",node.id);var disabled=this.isDisabled();this.state.mode?el.addClass("sm-"+this.state.mode):el.addClass("sm-not-selected"),ContentClass.noStyle||el.addClass("sm-default-style"),el.on("keydown",this.onKeydown).on("mousedown",this._stopPropagation).on("keypress",this._stopPropagation).on("keyup",this._stopPropagation).on("compositionstart",this._stopPropagation).on("textInput",this._stopPropagation),el.append($$(this.__elementTag).addClass("se-slug").addClass("sm-before").ref("before").append(this.__slugChar));var level=this._getLevel(),container=$$(this.__elementTag).addClass("se-container").attr("contenteditable",!1).css({"z-index":2*level});if(ContentClass.fullWidth&&container.addClass("sm-full-width"),"cursor"===this.state.mode&&"before"===this.state.position&&container.append($$(this.__elementTag).addClass("se-cursor").addClass("sm-before").attr("contenteditable",!1)),container.append(this.renderContent($$,node)),disabled){if(container.addClass("sm-disabled"),this.shouldRenderBlocker()){var blocker=$$(this.__elementTag).addClass("se-blocker").css({"z-index":2*level+1});container.append(blocker)}this.shouldSelectOnClick()&&el.on("click",this.onClick)}return this.context.dragManager&&"focused"!==this.state.mode&&"co-focused"!==this.state.mode&&(el.attr("draggable",!0),el.on("dragstart",this.onDragStart).on("dragenter",this.onDragEnter).on("dragover",this.onDragOver).on("drop",this.onDrop)),"cursor"===this.state.mode&&"after"===this.state.position&&container.append($$(this.__elementTag).addClass("se-cursor").addClass("sm-after").attr("contenteditable",!1)),el.append(container),el.append($$(this.__elementTag).addClass("se-slug").addClass("sm-after").ref("after").append(this.__slugChar)),el},IsolatedNodeComponent.prototype.renderContent=function($$,node){var ComponentClass=this.ContentClass;if(ComponentClass){var props={node:node,disabled:this.isDisabled(),isolatedNodeState:this.state.mode};return"focused"===this.state.mode&&(props.focused=!0),$$(ComponentClass,props).ref("content")}return console.error("Could not resolve a component for type: "+node.type),$$(this.__elementTag)},IsolatedNodeComponent.prototype.shouldRenderBlocker=function(){return!0},IsolatedNodeComponent.prototype.shouldSelectOnClick=function(){return"focused"!==this.state.mode&&"co-focused"!==this.state.mpde},IsolatedNodeComponent.prototype.getId=function(){return this._id},IsolatedNodeComponent.prototype.getMode=function(){return this.state.mode},IsolatedNodeComponent.prototype.isNotSelected=function(){return!this.state.mode},IsolatedNodeComponent.prototype.isSelected=function(){return"selected"===this.state.mode},IsolatedNodeComponent.prototype.isCoSelected=function(){return"co-selected"===this.state.mode},IsolatedNodeComponent.prototype.isFocused=function(){return"focused"===this.state.mode},IsolatedNodeComponent.prototype.isCoFocused=function(){return"co-focused"===this.state.mode},IsolatedNodeComponent.prototype._getContentClass=function(node){var componentRegistry=this.context.componentRegistry,ComponentClass=componentRegistry.get(node.type);return ComponentClass},IsolatedNodeComponent.prototype.isDisabled=function(){return!this.state.mode||["co-selected","cursor"].indexOf(this.state.mode)>-1},IsolatedNodeComponent.prototype._getSurfaceParent=function(){return this.context.surface},IsolatedNodeComponent.prototype._getLevel=function(){for(var level=1,parent=this._getSurfaceParent();parent;)level++,parent=parent._getSurfaceParent();return level},IsolatedNodeComponent.prototype.onSessionUpdate=function(update){if(update.selection){var documentSession=this.context.documentSession,newState=this._deriveStateFromSelectionState(documentSession.getSelectionState());!newState&&this.state.mode?this.extendState({mode:null}):newState&&newState.mode!==this.state.mode&&this.extendState(newState)}},IsolatedNodeComponent.prototype._deriveStateFromSelectionState=function(selState){var sel=selState.getSelection(),surfaceId=sel.surfaceId;if(surfaceId){var id=this.getId(),nodeId=this.props.node.id,parentId=this._getSurfaceParent().getId(),inParentSurface=surfaceId===parentId;if(inParentSurface){if(sel.isNodeSelection()&&sel.getNodeId()===nodeId){if(sel.isFull())return{mode:"selected"};if(sel.isBefore())return{mode:"cursor",position:"before"};if(sel.isAfter())return{mode:"cursor",position:"after"}}if(sel.isContainerSelection()&&sel.containsNodeFragment(nodeId))return{mode:"co-selected"}}else{if(sel.isCustomSelection()&&id===surfaceId)return{mode:"focused"};if(startsWith$1(surfaceId,id)){var path1=id.split("/"),path2=surfaceId.split("/"),len1=path1.length,len2=path2.length;return len2>len1&&path1[len1-1]===path2[len1-1]?len2===len1+1?{mode:"focused"}:{mode:"co-focused"}:null}}}},IsolatedNodeComponent.prototype.onMousedown=function(event){event.stopPropagation()},IsolatedNodeComponent.prototype.onClick=function(event){event.preventDefault(),this._selectNode()},IsolatedNodeComponent.prototype.onKeydown=function(event){event.stopPropagation(),event.keyCode===keys$2.ESCAPE&&"focused"===this.state.mode&&(event.preventDefault(),this._escape())},IsolatedNodeComponent.prototype.onDragStart=function(event){this.context.dragManager.onDragStart(event,this)},IsolatedNodeComponent.prototype.onDragEnter=function(event){event.preventDefault()},IsolatedNodeComponent.prototype.onDragOver=function(event){event.preventDefault()},IsolatedNodeComponent.prototype.onDrop=function(event){this.context.dragManager.onDrop(event,this)},IsolatedNodeComponent.prototype._escape=function(){this._selectNode()},IsolatedNodeComponent.prototype._stopPropagation=function(event){event.stopPropagation()},IsolatedNodeComponent.prototype._selectNode=function(){var surface=this.context.surface,doc=surface.getDocument(),nodeId=this.props.node.id;surface.setSelection(doc.createSelection({type:"node",containerId:surface.getContainerId(),nodeId:nodeId,mode:"full"}))},Object.defineProperties(IsolatedNodeComponent.prototype,prototypeAccessors),IsolatedNodeComponent}(Component);IsolatedNodeComponent.prototype._isDisabled=IsolatedNodeComponent.prototype.isDisabled,IsolatedNodeComponent.getCoordinate=function(surfaceEl,node){var parent=node.getParent();if(node.isTextNode()&&parent.is(".se-slug")){var boundary=parent,isolatedNodeEl=boundary.getParent(),nodeId=isolatedNodeEl.getAttribute("data-id");if(nodeId){var charPos=boundary.is("sm-after")?1:0;return new Coordinate([nodeId],charPos)}console.error("FIXME: expecting a data-id attribute on IsolatedNodeComponent")}return null},IsolatedNodeComponent.getDOMCoordinate=function(comp,coor){var domCoor;return domCoor=0===coor.offset?{container:comp.refs.before.getNativeElement(),offset:0}:{container:comp.refs.after.getNativeElement(),offset:1}},IsolatedNodeComponent.getDOMCoordinates=function(comp){return{start:{container:comp.refs.before.getNativeElement(),offset:0},end:{container:comp.refs.after.getNativeElement(),offset:1}}};var InlineNodeComponent=function(IsolatedNodeComponent$$1){function InlineNodeComponent(){IsolatedNodeComponent$$1.apply(this,arguments)}IsolatedNodeComponent$$1&&(InlineNodeComponent.__proto__=IsolatedNodeComponent$$1),InlineNodeComponent.prototype=Object.create(IsolatedNodeComponent$$1&&IsolatedNodeComponent$$1.prototype),InlineNodeComponent.prototype.constructor=InlineNodeComponent;var prototypeAccessors={_isInlineNodeComponent:{},__elementTag:{},__slugChar:{}};return prototypeAccessors._isInlineNodeComponent.get=function(){return!0},prototypeAccessors.__elementTag.get=function(){return"span"},prototypeAccessors.__slugChar.get=function(){return"\ufeff"},InlineNodeComponent.prototype.getClassNames=function(){return"sc-inline-node"},InlineNodeComponent.prototype.render=function($$){var el=IsolatedNodeComponent$$1.prototype.render.call(this,$$);return el.attr("data-inline","1"),el},InlineNodeComponent.prototype._deriveStateFromSelectionState=function(selState){var sel=selState.getSelection(),surfaceId=sel.surfaceId;if(surfaceId){var id=this.getId(),node=this.props.node,parentId=this._getSurfaceParent().getId(),inParentSurface=surfaceId===parentId;if(inParentSurface){if(sel.isPropertySelection()&&!sel.isCollapsed()&&isEqual$2(sel.path,node.path)){var nodeSel=node.getSelection();if(nodeSel.equals(sel))return{mode:"selected"};if(sel.contains(nodeSel))return{mode:"co-selected"}}}else if(startsWith$1(surfaceId,id)){var p1=id.split("/"),p2=surfaceId.split("/");return p2.length>=p1.length&&p2.length<=p1.length+1?{mode:"focused"}:{mode:"co-focused"}}}},InlineNodeComponent.prototype._selectNode=function(){var surface=this.context.surface,doc=surface.getDocument(),node=this.props.node;surface.setSelection(doc.createSelection({type:"property",path:node.path,startOffset:node.startOffset,endOffset:node.endOffset}))},Object.defineProperties(InlineNodeComponent.prototype,prototypeAccessors),InlineNodeComponent}(IsolatedNodeComponent);InlineNodeComponent.getCoordinate=function(el){var parent=el.getParent();if(el.isTextNode()&&parent.is(".se-slug")){var slug=parent,nodeEl=slug.getParent();if(nodeEl.is(".sc-inline-node")){var startOffset=Number(nodeEl.getAttribute("data-offset")),len=Number(nodeEl.getAttribute("data-length")),charPos=startOffset;slug.is("sm-after")&&(charPos+=len);for(var path;nodeEl=nodeEl.getParent();){var pathStr=nodeEl.getAttribute("data-path");if(pathStr){path=pathStr.split(".");var coor=new Coordinate(path,charPos);return coor.__inInlineNode__=!0,coor.__startOffset__=startOffset,coor.__endOffset__=startOffset+len,coor}}}}return null};var AnnotatedTextComponent=function(Component$$1){function AnnotatedTextComponent(){Component$$1.apply(this,arguments)}return Component$$1&&(AnnotatedTextComponent.__proto__=Component$$1),AnnotatedTextComponent.prototype=Object.create(Component$$1&&Component$$1.prototype),AnnotatedTextComponent.prototype.constructor=AnnotatedTextComponent,AnnotatedTextComponent.prototype.render=function($$){var el=this._renderContent($$).addClass("sc-annotated-text").css({whiteSpace:"pre-wrap"});return el},AnnotatedTextComponent.prototype.getText=function(){return this.getDocument().get(this.props.path)||""},AnnotatedTextComponent.prototype.getAnnotations=function(){return this.getDocument().getIndex("annotations").get(this.props.path)},AnnotatedTextComponent.prototype._renderContent=function($$){var text=this.getText(),annotations=this.getAnnotations(),el=$$(this.props.tagName||"span");if(annotations&&annotations.length>0){var fragmenter=new Fragmenter({onText:this._renderTextNode.bind(this),onEnter:this._renderFragment.bind(this,$$),onExit:this._finishFragment.bind(this)});fragmenter.start(el,text,annotations)}else el.append(text);return el},AnnotatedTextComponent.prototype._renderTextNode=function(context,text){text&&text.length>0&&context.append(text)},AnnotatedTextComponent.prototype._renderFragment=function($$,fragment){var doc=this.getDocument(),componentRegistry=this.getComponentRegistry(),node=fragment.node;if("container-annotation-fragment"===node.type)return $$(AnnotationComponent,{doc:doc,node:node}).addClass("se-annotation-fragment").addClass(node.anno.getTypeNames().join(" ").replace(/_/g,"-"));if("container-annotation-anchor"===node.type)return $$(AnnotationComponent,{doc:doc,node:node}).addClass("se-anchor").addClass(node.anno.getTypeNames().join(" ").replace(/_/g,"-")).addClass(node.isStart?"start-anchor":"end-anchor");var ComponentClass=componentRegistry.get(node.type)||AnnotationComponent;!node.constructor.isInline||ComponentClass.isCustom||ComponentClass.prototype._isInlineNodeComponent||(ComponentClass=InlineNodeComponent);var el=$$(ComponentClass,{doc:doc,node:node});return el},AnnotatedTextComponent.prototype._finishFragment=function(fragment,context,parentContext){parentContext.append(context)},AnnotatedTextComponent.prototype.getDocument=function(){return this.props.doc||this.context.doc},AnnotatedTextComponent.prototype.getComponentRegistry=function(){return this.props.componentRegistry||this.context.componentRegistry},AnnotatedTextComponent}(Component),CursorComponent=function(Component$$1){function CursorComponent(){Component$$1.apply(this,arguments)}return Component$$1&&(CursorComponent.__proto__=Component$$1),CursorComponent.prototype=Object.create(Component$$1&&Component$$1.prototype),CursorComponent.prototype.constructor=CursorComponent,CursorComponent.prototype.render=function($$){var el=$$("span").addClass("se-cursor");if(el.append("\ufeff"),el.append($$("div").addClass("se-cursor-inner")),this.props.collaborator){var collaboratorIndex=this.props.collaborator.colorIndex;el.addClass("sm-collaborator-"+collaboratorIndex)}else el.addClass("sm-local-user");return el},CursorComponent}(Component),SelectionFragmentComponent=function(Component$$1){function SelectionFragmentComponent(){Component$$1.apply(this,arguments)}return Component$$1&&(SelectionFragmentComponent.__proto__=Component$$1),SelectionFragmentComponent.prototype=Object.create(Component$$1&&Component$$1.prototype),SelectionFragmentComponent.prototype.constructor=SelectionFragmentComponent,SelectionFragmentComponent.prototype.render=function($$){var el=$$("span").addClass("se-selection-fragment");if(this.props.collaborator){var collaboratorIndex=this.props.collaborator.colorIndex;el.addClass("sm-collaborator-"+collaboratorIndex)}else el.addClass("sm-local-user");return el.append(this.props.children),el},SelectionFragmentComponent}(Component),TextPropertyComponent=function(AnnotatedTextComponent$$1){function TextPropertyComponent(){AnnotatedTextComponent$$1.apply(this,arguments)}AnnotatedTextComponent$$1&&(TextPropertyComponent.__proto__=AnnotatedTextComponent$$1),TextPropertyComponent.prototype=Object.create(AnnotatedTextComponent$$1&&AnnotatedTextComponent$$1.prototype),TextPropertyComponent.prototype.constructor=TextPropertyComponent;var prototypeAccessors={_isTextPropertyComponent:{}};return prototypeAccessors._isTextPropertyComponent.get=function(){return!0},TextPropertyComponent.prototype.didMount=function(){AnnotatedTextComponent$$1.prototype.didMount.call(this);var surface=this.getSurface();surface&&surface._registerTextProperty(this)},TextPropertyComponent.prototype.dispose=function(){AnnotatedTextComponent$$1.prototype.dispose.call(this);var surface=this.getSurface();surface&&surface._unregisterTextProperty(this)},TextPropertyComponent.prototype.render=function($$){var path=this.getPath(),el=this._renderContent($$).addClass("sc-text-property").attr({
"data-path":path.join("."),spellCheck:!1}).css({"white-space":"pre-wrap"});return this.context.dragManager&&el.on("dragenter",this.onDragEnter).on("dragover",this.onDragOver).on("drop",this.onDrop),this.props.withoutBreak||el.append($$("br")),el},TextPropertyComponent.prototype._renderFragment=function($$,fragment){var el,node=fragment.node,id=node.id;return"cursor"===node.type?el=$$(CursorComponent,{collaborator:node.collaborator}):"selection-fragment"===node.type?el=$$(SelectionFragmentComponent,{collaborator:node.collaborator}):(el=AnnotatedTextComponent$$1.prototype._renderFragment.apply(this,arguments),node.constructor.isInline?el.ref(id):this.context.config&&this.context.config.preservativeTextPropertyRendering&&el.ref(id+"@"+fragment.counter)),el.attr("data-offset",fragment.pos),el},TextPropertyComponent.prototype.onDragEnter=function(event){event.preventDefault()},TextPropertyComponent.prototype.onDragOver=function(event){event.preventDefault()},TextPropertyComponent.prototype.onDrop=function(event){this.context.dragManager.onDrop(event,this)},TextPropertyComponent.prototype.getPath=function(){return this.props.path},TextPropertyComponent.prototype.getText=function(){return this.getDocument().get(this.getPath())},TextPropertyComponent.prototype.getAnnotations=function(){var path=this.getPath(),annotations=this.getDocument().getIndex("annotations").get(path),fragments=this.props.fragments;return fragments&&(annotations=annotations.concat(fragments)),annotations},TextPropertyComponent.prototype.getDocument=function(){return this.props.doc||this.context.doc},TextPropertyComponent.prototype.getController=function(){return this.props.controller||this.context.controller},TextPropertyComponent.prototype.getSurface=function(){return this.props.surface||this.context.surface},TextPropertyComponent.prototype.isEditable=function(){return this.getSurface().isEditable()},TextPropertyComponent.prototype.isReadonly=function(){return this.getSurface().isReadonly()},TextPropertyComponent.prototype.getDOMCoordinate=function(charPos){return this._getDOMCoordinate(this.el,charPos)},TextPropertyComponent.prototype._finishFragment=function(fragment,context,parentContext){context.attr("data-length",fragment.length),parentContext.append(context)},TextPropertyComponent.prototype._getDOMCoordinate=function(el,charPos){var l,this$1=this,idx=0;if(0===charPos)return{container:el.getNativeElement(),offset:0};for(var child=el.getFirstChild();child;child=child.getNextSibling(),idx++)if(child.isTextNode()){if(l=child.textContent.length,l>=charPos)return{container:child.getNativeElement(),offset:charPos};charPos-=l}else if(child.isElementNode()){var length=child.getAttribute("data-length");if(!length)return console.error("FIXME: Can not map to DOM coordinates."),null;if(l=parseInt(length,10),l>=charPos){if(child.attr("data-inline")){var nextSibling=child.getNextSibling();return nextSibling&&nextSibling.isTextNode()?{container:nextSibling.getNativeElement(),offset:0}:{container:el.getNativeElement(),offset:el.getChildIndex(child)+1}}return this$1._getDOMCoordinate(child,charPos,idx)}charPos-=l}},Object.defineProperties(TextPropertyComponent.prototype,prototypeAccessors),TextPropertyComponent}(AnnotatedTextComponent);TextPropertyComponent.getCoordinate=function(root,node,offset){var context=_getPropertyContext(root,node,offset);if(!context)return null;node=context.node,offset=context.offset;var charPos=_getCharPos(context.node,context.offset);return isNumber$1(charPos)?new Coordinate(context.path,charPos):null};var TextBlockComponent=function(NodeComponent$$1){function TextBlockComponent(){NodeComponent$$1.apply(this,arguments)}return NodeComponent$$1&&(TextBlockComponent.__proto__=NodeComponent$$1),TextBlockComponent.prototype=Object.create(NodeComponent$$1&&NodeComponent$$1.prototype),TextBlockComponent.prototype.constructor=TextBlockComponent,TextBlockComponent.prototype.render=function($$){var el=NodeComponent$$1.prototype.render.call(this,$$);return el.append($$(TextPropertyComponent,{path:[this.props.node.id,"content"]})),el},TextBlockComponent}(NodeComponent),BlockquoteComponent=function(TextBlockComponent$$1){function BlockquoteComponent(){TextBlockComponent$$1.apply(this,arguments)}return TextBlockComponent$$1&&(BlockquoteComponent.__proto__=TextBlockComponent$$1),BlockquoteComponent.prototype=Object.create(TextBlockComponent$$1&&TextBlockComponent$$1.prototype),BlockquoteComponent.prototype.constructor=BlockquoteComponent,BlockquoteComponent.prototype.render=function($$){var el=TextBlockComponent$$1.prototype.render.call(this,$$);return el.addClass("sc-blockquote")},BlockquoteComponent}(TextBlockComponent),BlockquoteHTMLConverter={type:"blockquote",tagName:"blockquote",import:function(el,node,converter){node.content=converter.annotatedText(el,[node.id,"content"])},export:function(node,el,converter){el.append(converter.annotatedText([node.id,"content"]))}},BlockquotePackage={name:"blockquote",configure:function(config){config.addNode(Blockquote),config.addComponent(Blockquote.type,BlockquoteComponent),config.addConverter("html",BlockquoteHTMLConverter),config.addConverter("xml",BlockquoteHTMLConverter),config.addTextType({name:"blockquote",data:{type:"blockquote"}}),config.addLabel("blockquote",{en:"Blockquote",de:"Blockzitat"})},Blockquote:Blockquote,BlockquoteComponent:BlockquoteComponent,BlockquoteHTMLConverter:BlockquoteHTMLConverter},Code=function(PropertyAnnotation$$1){function Code(){PropertyAnnotation$$1.apply(this,arguments)}return PropertyAnnotation$$1&&(Code.__proto__=PropertyAnnotation$$1),Code.prototype=Object.create(PropertyAnnotation$$1&&PropertyAnnotation$$1.prototype),Code.prototype.constructor=Code,Code}(PropertyAnnotation);Code.type="code";var CodeHTMLConverter={type:"code",tagName:"code"},AnnotationCommand=function(Command$$1){function AnnotationCommand(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];if(Command$$1.apply(this,args),!this.config.nodeType)throw new Error("'nodeType' is required")}return Command$$1&&(AnnotationCommand.__proto__=Command$$1),AnnotationCommand.prototype=Object.create(Command$$1&&Command$$1.prototype),AnnotationCommand.prototype.constructor=AnnotationCommand,AnnotationCommand.prototype.getAnnotationType=function(){return this.config.nodeType},AnnotationCommand.prototype.getAnnotationData=function(){return{}},AnnotationCommand.prototype.isDisabled=function(sel){return!(sel&&!sel.isNull()&&sel.isAttached()&&!sel.isCustomSelection()&&!sel.isNodeSelection()&&!sel.isContainerSelection())},AnnotationCommand.prototype.canCreate=function(annos,sel){return 0===annos.length&&!sel.isCollapsed()},AnnotationCommand.prototype.canFuse=function(annos,sel){return annos.length>=2&&!sel.isCollapsed()},AnnotationCommand.prototype.canDelete=function(annos,sel){if(1!==annos.length)return!1;var annoSel=annos[0].getSelection();return sel.isInsideOf(annoSel)},AnnotationCommand.prototype.canExpand=function(annos,sel){if(1!==annos.length)return!1;var annoSel=annos[0].getSelection();return sel.overlaps(annoSel)&&!sel.isInsideOf(annoSel)},AnnotationCommand.prototype.canTruncate=function(annos,sel){if(1!==annos.length)return!1;var annoSel=annos[0].getSelection();return(sel.isLeftAlignedWith(annoSel)||sel.isRightAlignedWith(annoSel))&&!sel.contains(annoSel)&&!sel.isCollapsed()},AnnotationCommand.prototype.getCommandState=function(params){var sel=this._getSelection(params);if(this.isDisabled(sel))return{disabled:!0};var annos=this._getAnnotationsForSelection(params),newState={disabled:!1,active:!1,mode:null};return this.canCreate(annos,sel)?newState.mode="create":this.canFuse(annos,sel)?newState.mode="fuse":this.canTruncate(annos,sel)?(newState.active=!0,newState.mode="truncate"):this.canExpand(annos,sel)?newState.mode="expand":this.canDelete(annos,sel)?(newState.active=!0,newState.mode="delete"):newState.disabled=!0,newState},AnnotationCommand.prototype.execute=function(params){var commandState=params.commandState;if(commandState.disabled)return!1;switch(commandState.mode){case"create":return this.executeCreate(params);case"fuse":return this.executeFuse(params);case"truncate":return this.executeTruncate(params);case"expand":return this.executeExpand(params);case"delete":return this.executeDelete(params);default:return console.warn("Command.execute(): unknown mode",commandState.mode),!1}},AnnotationCommand.prototype.executeCreate=function(params){var annos=this._getAnnotationsForSelection(params);this._checkPrecondition(params,annos,this.canCreate);var newAnno=this._applyTransform(params,function(tx){var node=this.getAnnotationData();return node.type=this.getAnnotationType(),createAnnotation(tx,{node:node,selection:params.selection})}.bind(this));return{mode:"create",anno:newAnno}},AnnotationCommand.prototype.executeFuse=function(params){var annos=this._getAnnotationsForSelection(params);this._checkPrecondition(params,annos,this.canFuse);var fusedAnno=this._applyTransform(params,function(tx){var result=fuseAnnotation(tx,{annos:annos});return{result:result.node}});return{mode:"fuse",anno:fusedAnno}},AnnotationCommand.prototype.executeTruncate=function(params){var annos=this._getAnnotationsForSelection(params),anno=annos[0];return this._checkPrecondition(params,annos,this.canTruncate),this._applyTransform(params,function(tx){return truncateAnnotation(tx,{selection:params.selection,anno:anno})}),{mode:"truncate",anno:anno}},AnnotationCommand.prototype.executeExpand=function(params){var annos=this._getAnnotationsForSelection(params),anno=annos[0];return this._checkPrecondition(params,annos,this.canExpand),this._applyTransform(params,function(tx){expandAnnotation(tx,{selection:params.selection,anno:anno})}),{mode:"expand",anno:anno}},AnnotationCommand.prototype.executeDelete=function(params){var annos=this._getAnnotationsForSelection(params),anno=annos[0];return this._checkPrecondition(params,annos,this.canDelete),this._applyTransform(params,function(tx){return tx.delete(anno.id)}),{mode:"delete",annoId:anno.id}},AnnotationCommand.prototype._checkPrecondition=function(params,annos,checker){var sel=this._getSelection(params);if(!checker.call(this,annos,sel))throw new Error("AnnotationCommand: can't execute command for selection "+sel.toString())},AnnotationCommand.prototype._getAnnotationsForSelection=function(params){return params.selectionState.getAnnotationsForType(this.getAnnotationType())},AnnotationCommand.prototype._applyTransform=function(params,transformFn){var sel=this._getSelection(params),documentSession=this._getDocumentSession(params),surface=params.surface;params.selection=sel;var result;if(!sel.isNull())return documentSession.transaction(function(tx){tx.before.selection=sel,surface&&(tx.before.surfaceId=surface.getId());var out=transformFn(tx,params);return out&&(result=out.result),out}),result},AnnotationCommand}(Command),AnnotationTool=function(Tool$$1){function AnnotationTool(){Tool$$1.apply(this,arguments)}return Tool$$1&&(AnnotationTool.__proto__=Tool$$1),AnnotationTool.prototype=Object.create(Tool$$1&&Tool$$1.prototype),AnnotationTool.prototype.constructor=AnnotationTool,AnnotationTool.prototype.render=function($$){var el=Tool$$1.prototype.render.call(this,$$);return el.addClass("sm-annotation-tool"),el},AnnotationTool.prototype.renderButton=function($$){var el=Tool$$1.prototype.renderButton.call(this,$$);return el.append(this.renderMode($$)),el},AnnotationTool.prototype.renderMode=function($$){var mode=this.props.mode,el=$$("div").addClass("se-mode"),iconEl=this.context.iconProvider.renderIcon($$,mode);return iconEl&&el.append(iconEl),el},AnnotationTool}(Tool),CodePackage={name:"code",configure:function(config){config.addNode(Code),config.addConverter("html",CodeHTMLConverter),config.addConverter("xml",CodeHTMLConverter),config.addComponent("code",AnnotationComponent),config.addCommand("code",AnnotationCommand,{nodeType:Code.type}),config.addTool("code",AnnotationTool,{target:"annotations"}),config.addIcon("code",{fontawesome:"fa-code"}),config.addLabel("code",{en:"Code",de:"Code"})},Code:Code,CodeHTMLConverter:CodeHTMLConverter},Emphasis=function(PropertyAnnotation$$1){function Emphasis(){PropertyAnnotation$$1.apply(this,arguments)}return PropertyAnnotation$$1&&(Emphasis.__proto__=PropertyAnnotation$$1),Emphasis.prototype=Object.create(PropertyAnnotation$$1&&PropertyAnnotation$$1.prototype),Emphasis.prototype.constructor=Emphasis,Emphasis}(PropertyAnnotation);Emphasis.type="emphasis",Emphasis.fragmentation=Fragmenter.ANY;var EmphasisHTMLConverter={type:"emphasis",tagName:"em",matchElement:function(el){return el.is("em, i")}},EmphasisPackage={name:"emphasis",configure:function(config,options){config.addNode(Emphasis),config.addConverter("html",EmphasisHTMLConverter),config.addConverter("xml",EmphasisHTMLConverter),config.addComponent("emphasis",AnnotationComponent),config.addCommand("emphasis",AnnotationCommand,{nodeType:Emphasis.type}),config.addTool("emphasis",AnnotationTool,{target:options.toolTarget||"annotations"}),config.addIcon("emphasis",{fontawesome:"fa-italic"}),config.addLabel("emphasis",{en:"Emphasis",de:"Betonung"})},Emphasis:Emphasis,EmphasisHTMLConverter:EmphasisHTMLConverter},Image=function(DocumentNode$$1){function Image(){DocumentNode$$1.apply(this,arguments)}return DocumentNode$$1&&(Image.__proto__=DocumentNode$$1),Image.prototype=Object.create(DocumentNode$$1&&DocumentNode$$1.prototype),Image.prototype.constructor=Image,Image}(DocumentNode);Image.define({type:"image",src:{type:"string",default:"http://"},previewSrc:{type:"string",optional:!0}});var ImageComponent=function(NodeComponent$$1){function ImageComponent(){NodeComponent$$1.apply(this,arguments)}return NodeComponent$$1&&(ImageComponent.__proto__=NodeComponent$$1),ImageComponent.prototype=Object.create(NodeComponent$$1&&NodeComponent$$1.prototype),ImageComponent.prototype.constructor=ImageComponent,ImageComponent.prototype.didMount=function(){NodeComponent$$1.prototype.didMount.call(this);var node=this.props.node;node.on("src:changed",this.rerender,this),node.on("upload:started",this.onUploadStarted,this),node.on("upload:progress",this.onUploadProgress,this),node.on("upload:finished",this.onUploadFinished,this)},ImageComponent.prototype.dispose=function(){NodeComponent$$1.prototype.dispose.call(this),this.props.node.off(this)},ImageComponent.prototype.render=function($$){var el=NodeComponent$$1.prototype.render.call(this,$$);if(el.addClass("sc-image"),el.append($$("img").attr({src:this.props.node.src}).ref("image")),this.state.uploading){var progressBar=$$("div").addClass("se-progress-bar").ref("progressBar").append("Uploading: "+percentage(this.state.progress));el.append(progressBar)}return el},ImageComponent.prototype.onUploadStarted=function(){this.setState({uploading:!0,progress:0})},ImageComponent.prototype.onUploadProgress=function(progress){this.setState({uploading:!0,progress:progress})},ImageComponent.prototype.onUploadFinished=function(){this.setState({})},ImageComponent}(NodeComponent),ImageHTMLConverter={type:"image",tagName:"img",import:function(el,node){node.src=el.attr("src"),node.previewSrc=el.attr("data-preview-src")},export:function(node,el){el.attr("src",node.src),node.previewSrc&&el.attr("data-preview-src",node.previewSrc)}},ImageXMLConverter={type:"image",tagName:"image",import:function(el,node){node.src=el.attr("src"),node.previewSrc=el.attr("preview-src")},export:function(node,el){el.attr("src",node.src),node.previewSrc&&el.attr("preview-src",node.previewSrc)}},ImageCommand=function(Command$$1){function ImageCommand(){Command$$1.call(this,{name:"insert-image"})}return Command$$1&&(ImageCommand.__proto__=Command$$1),ImageCommand.prototype=Object.create(Command$$1&&Command$$1.prototype),ImageCommand.prototype.constructor=ImageCommand,ImageCommand.prototype.getCommandState=function(params){var sel=params.selection,surface=params.surface,newState={disabled:!0,active:!1};return sel&&!sel.isNull()&&!sel.isCustomSelection()&&surface&&surface.isContainerEditor()&&(newState.disabled=!1),newState},ImageCommand.prototype.execute=function(params,context){var state=this.getCommandState(params);if(!state.disabled){var documentSession=params.documentSession,sel=params.selection,surface=params.surface,fileClient=context.fileClient,files=params.files;if(surface.isContainerEditor()){var doc=surface.getDocument(),snippet=doc.createSnippet(),items=files.map(function(file){var node=snippet.create({type:"image"});return snippet.show(node),{file:file,nodeId:node.id}});return surface.transaction(function(tx){return tx.before.selection=sel,paste$1$1(tx,{selection:sel,containerId:surface.getContainerId(),doc:snippet})}),items.forEach(function(item){var nodeId=item.nodeId,file=item.file,node=doc.get(nodeId);node.emit("upload:started");var channel=fileClient.uploadFile(file,function(err,url){err&&(url="error");var node=doc.get(nodeId);node&&(node.emit("upload:finished"),documentSession.transaction(function(tx){tx.set([nodeId,"src"],url)}))});channel.on("progress",function(progress){node.emit("upload:progress",progress)})}),{status:"file-upload-process-started"}}}},ImageCommand}(Command),InsertImageTool=function(Tool$$1){function InsertImageTool(){Tool$$1.apply(this,arguments)}return Tool$$1&&(InsertImageTool.__proto__=Tool$$1),InsertImageTool.prototype=Object.create(Tool$$1&&Tool$$1.prototype),InsertImageTool.prototype.constructor=InsertImageTool,InsertImageTool.prototype.getClassNames=function(){return"sc-insert-image-tool"},InsertImageTool.prototype.renderButton=function($$){var button=Tool$$1.prototype.renderButton.call(this,$$),input=$$("input").attr("type","file").ref("input").on("change",this.onFileSelect);return[button,input]},InsertImageTool.prototype.onClick=function(){this.refs.input.click()},InsertImageTool.prototype.onFileSelect=function(e){var files=e.currentTarget.files;this.executeCommand({files:Array.prototype.slice.call(files)})},InsertImageTool}(Tool),DragAndDropHandler=function(){},prototypeAccessors$8={_isDragAndDropHandler:{}};prototypeAccessors$8._isDragAndDropHandler.get=function(){return!0},DragAndDropHandler.prototype.dragStart=function(params,context){},DragAndDropHandler.prototype.drop=function(params,context){},DragAndDropHandler.prototype.dragEnd=function(params,context){},Object.defineProperties(DragAndDropHandler.prototype,prototypeAccessors$8);var DropImage=function(DragAndDropHandler$$1){function DropImage(){DragAndDropHandler$$1.apply(this,arguments)}return DragAndDropHandler$$1&&(DropImage.__proto__=DragAndDropHandler$$1),DropImage.prototype=Object.create(DragAndDropHandler$$1&&DragAndDropHandler$$1.prototype),DropImage.prototype.constructor=DropImage,DropImage.prototype.drop=function(params,context){var target=params.target,surface=target.surface,selection=target.selection,files=params.data.files;if(surface&&selection&&files&&0!==files.length&&(files=files.filter(function(file){return startsWith$1(file.type,"image")}),0!==files.length))return context.commandManager.executeCommand(ImageCommand.type,{surface:surface,selection:selection,files:files}),!0},DropImage}(DragAndDropHandler),ImagePackage={name:"image",configure:function(config){config.addNode(Image),config.addComponent("image",ImageComponent),config.addConverter("html",ImageHTMLConverter),config.addConverter("xml",ImageXMLConverter),config.addCommand("insert-image",ImageCommand),config.addTool("insert-image",InsertImageTool),config.addIcon("insert-image",{fontawesome:"fa-image"}),config.addLabel("image",{en:"Image",de:"Bild"}),config.addLabel("insert-image",{en:"Insert image",de:"Bild einfügen"}),config.addDragAndDrop(DropImage)},ImageNode:Image,ImageComponent:ImageComponent,ImageHTMLConverter:ImageHTMLConverter,InsertImageCommand:ImageCommand,InsertImageTool:InsertImageTool,DropImage:DropImage},InlineWrapper=function(InlineNode$$1){function InlineWrapper(){InlineNode$$1.apply(this,arguments)}return InlineNode$$1&&(InlineWrapper.__proto__=InlineNode$$1),InlineWrapper.prototype=Object.create(InlineNode$$1&&InlineNode$$1.prototype),InlineWrapper.prototype.constructor=InlineWrapper,InlineWrapper.prototype.getWrappedNode=function(){return this.getDocument().get(this.wrappedNode)},InlineWrapper}(InlineNode);InlineWrapper.define({type:"inline-wrapper",wrappedNode:"id"});var InlineWrapperComponent=function(InlineNodeComponent$$1){function InlineWrapperComponent(){InlineNodeComponent$$1.apply(this,arguments)}return InlineNodeComponent$$1&&(InlineWrapperComponent.__proto__=InlineNodeComponent$$1),InlineWrapperComponent.prototype=Object.create(InlineNodeComponent$$1&&InlineNodeComponent$$1.prototype),InlineWrapperComponent.prototype.constructor=InlineWrapperComponent,InlineWrapperComponent.prototype.getClassNames=function(){return"sc-inline-wrapper sc-inline-node"},InlineWrapperComponent.prototype.renderContent=function($$){var el,node=this.props.node,doc=node.getDocument(),wrappedNode=doc.get(node.wrappedNode);if(wrappedNode){var componentRegistry=this.context.componentRegistry,ComponentClass=componentRegistry.get(wrappedNode.type);ComponentClass?el=$$(ComponentClass,{disabled:this.isDisabled(),node:wrappedNode}).ref("wrappedNode"):console.error("No component registered for node type"+wrappedNode.type)}else console.error("Could not find wrapped node: "+node.wrappedNode);return el},InlineWrapperComponent}(InlineNodeComponent),InlineWrapperConverter={type:"inline-wrapper",matchElement:function(el,converter){var blockConverter=converter._getConverterForElement(el,"block");return Boolean(blockConverter)},import:function(el,node,converter){node.id=converter.nextId("inline-wrapper");var state=converter.state;state.popElementContext(),state.pushElementContext(state.getCurrentElementContext().tagName),node.wrappedNode=converter.convertElement(el).id},export:function(node,el,converter){return converter.convertNode(node.wrappedNode)}},InlineWrapperPackage={name:"inline-wrapper",configure:function(config,options){config.addNode(InlineWrapper),config.addComponent(InlineWrapper.type,InlineWrapperComponent),options.converters&&options.converters.forEach(function(name){config.addConverter(name,InlineWrapperConverter)})},InlineWrapper:InlineWrapper,InlineWrapperComponent:InlineWrapperComponent,InlineWrapperConverter:InlineWrapperConverter},Paragraph=function(TextBlock$$1){function Paragraph(){TextBlock$$1.apply(this,arguments)}return TextBlock$$1&&(Paragraph.__proto__=TextBlock$$1),Paragraph.prototype=Object.create(TextBlock$$1&&TextBlock$$1.prototype),Paragraph.prototype.constructor=Paragraph,Paragraph}(TextBlock);Paragraph.type="paragraph";var ParagraphComponent=function(TextBlockComponent$$1){function ParagraphComponent(){TextBlockComponent$$1.apply(this,arguments)}return TextBlockComponent$$1&&(ParagraphComponent.__proto__=TextBlockComponent$$1),ParagraphComponent.prototype=Object.create(TextBlockComponent$$1&&TextBlockComponent$$1.prototype),ParagraphComponent.prototype.constructor=ParagraphComponent,ParagraphComponent.prototype.render=function($$){var el=TextBlockComponent$$1.prototype.render.call(this,$$);return el.addClass("sc-paragraph")},ParagraphComponent}(TextBlockComponent),ParagraphHTMLConverter={type:"paragraph",tagName:"p",import:function(el,node,converter){node.content=converter.annotatedText(el,[node.id,"content"])},export:function(node,el,converter){el.append(converter.annotatedText([node.id,"content"]))}},ParagraphPackage={name:"paragraph",configure:function(config){config.addNode(Paragraph),config.addComponent(Paragraph.type,ParagraphComponent),config.addConverter("html",ParagraphHTMLConverter),config.addConverter("xml",ParagraphHTMLConverter),config.addTextType({name:"paragraph",data:{type:"paragraph"}}),config.addLabel("paragraph",{en:"Paragraph",de:"Paragraph"}),config.addLabel("paragraph.content",{en:"Paragraph",de:"Paragraph"})},Paragraph:Paragraph,ParagraphComponent:ParagraphComponent,ParagraphHTMLConverter:ParagraphHTMLConverter},SaveCommand=function(Command$$1){function SaveCommand(){Command$$1.call(this,{name:"save"})}return Command$$1&&(SaveCommand.__proto__=Command$$1),SaveCommand.prototype=Object.create(Command$$1&&Command$$1.prototype),SaveCommand.prototype.constructor=SaveCommand,SaveCommand.prototype.getCommandState=function(params){var dirty=params.documentSession.isDirty();return{disabled:!dirty,active:!1}},SaveCommand.prototype.execute=function(params){var documentSession=params.documentSession;return documentSession.save(),{status:"saving-process-started"}},SaveCommand}(Command),PersistencePackage={name:"persistence",configure:function(config){config.addCommand("save",SaveCommand),config.addTool("save",Tool,{target:"document"}),config.addIcon("save",{fontawesome:"fa-save"}),config.addLabel("save",{en:"Save",de:"Speichern"})},SaveCommand:SaveCommand},Strong=function(PropertyAnnotation$$1){function Strong(){PropertyAnnotation$$1.apply(this,arguments)}return PropertyAnnotation$$1&&(Strong.__proto__=PropertyAnnotation$$1),Strong.prototype=Object.create(PropertyAnnotation$$1&&PropertyAnnotation$$1.prototype),Strong.prototype.constructor=Strong,Strong}(PropertyAnnotation);Strong.type="strong",Strong.fragmentation=Fragmenter.ANY;var StrongHTMLConverter={type:"strong",tagName:"strong",matchElement:function(el){return el.is("strong, b")}},StrongPackage={name:"strong",configure:function(config,options){options=options||{},config.addNode(Strong),config.addConverter("html",StrongHTMLConverter),config.addConverter("xml",StrongHTMLConverter),config.addComponent("strong",AnnotationComponent),config.addCommand("strong",AnnotationCommand,{nodeType:"strong"}),config.addTool("strong",AnnotationTool,{target:options.toolTarget||"annotations"}),config.addIcon("strong",{fontawesome:"fa-bold"}),config.addLabel("strong",{en:"Strong emphasis",de:"Starke Betonung"})},Strong:Strong,StrongHTMLConverter:StrongHTMLConverter},Subscript=function(PropertyAnnotation$$1){function Subscript(){PropertyAnnotation$$1.apply(this,arguments)}return PropertyAnnotation$$1&&(Subscript.__proto__=PropertyAnnotation$$1),Subscript.prototype=Object.create(PropertyAnnotation$$1&&PropertyAnnotation$$1.prototype),Subscript.prototype.constructor=Subscript,Subscript}(PropertyAnnotation);Subscript.type="subscript",Subscript.fragmentation=Fragmenter.ANY;var SubscriptHTMLConverter={type:"subscript",tagName:"sub"},SubscriptPackage={name:"subscript",configure:function(config){config.addNode(Subscript),config.addConverter("html",SubscriptHTMLConverter),config.addConverter("xml",SubscriptHTMLConverter),config.addComponent("subscript",AnnotationComponent),config.addCommand("subscript",AnnotationCommand,{nodeType:"subscript"}),config.addTool("subscript",AnnotationTool,{target:"annotations"}),config.addIcon("subscript",{fontawesome:"fa-subscript"}),config.addLabel("subscript",{en:"Subscript",de:"Tiefgestellt"})},Subscript:Subscript,SubscriptHTMLConverter:SubscriptHTMLConverter},Superscript=function(PropertyAnnotation$$1){function Superscript(){PropertyAnnotation$$1.apply(this,arguments)}return PropertyAnnotation$$1&&(Superscript.__proto__=PropertyAnnotation$$1),Superscript.prototype=Object.create(PropertyAnnotation$$1&&PropertyAnnotation$$1.prototype),Superscript.prototype.constructor=Superscript,Superscript}(PropertyAnnotation);Superscript.type="superscript",Superscript.fragmentation=Fragmenter.ANY;var SuperscriptHTMLConverter={type:"superscript",tagName:"sup"},SuperscriptPackage={name:"superscript",configure:function(config){config.addNode(Superscript),config.addConverter("html",SuperscriptHTMLConverter),config.addConverter("xml",SuperscriptHTMLConverter),config.addComponent("superscript",AnnotationComponent),config.addCommand("superscript",AnnotationCommand,{nodeType:"superscript"}),config.addTool("superscript",AnnotationTool,{target:"annotations"}),config.addIcon("superscript",{fontawesome:"fa-superscript"}),config.addLabel("superscript",{en:"Superscript",de:"Hochgestellt"})},Superscript:Superscript,SuperscriptHTMLConverter:SuperscriptHTMLConverter},Heading=function(TextBlock$$1){function Heading(){TextBlock$$1.apply(this,arguments)}return TextBlock$$1&&(Heading.__proto__=TextBlock$$1),Heading.prototype=Object.create(TextBlock$$1&&TextBlock$$1.prototype),Heading.prototype.constructor=Heading,Heading}(TextBlock);Heading.define({type:"heading",level:{type:"number",default:1}});var HeadingComponent=function(TextBlockComponent$$1){function HeadingComponent(){TextBlockComponent$$1.apply(this,arguments)}return TextBlockComponent$$1&&(HeadingComponent.__proto__=TextBlockComponent$$1),HeadingComponent.prototype=Object.create(TextBlockComponent$$1&&TextBlockComponent$$1.prototype),HeadingComponent.prototype.constructor=HeadingComponent,HeadingComponent.prototype.render=function($$){var el=TextBlockComponent$$1.prototype.render.call(this,$$);return el.addClass("sc-heading sm-level-"+this.props.node.level)},HeadingComponent}(TextBlockComponent),HeadingHTMLConverter={type:"heading",matchElement:function(el){return/^h\d$/.exec(el.tagName)},import:function(el,node,converter){node.level=Number(el.tagName[1]),node.content=converter.annotatedText(el,[node.id,"content"])},export:function(node,el,converter){el.tagName="h"+node.level,el.append(converter.annotatedText([node.id,"content"]))}},HeadingPackage={name:"heading",configure:function(config){config.addNode(Heading),config.addComponent(Heading.type,HeadingComponent),config.addConverter("html",HeadingHTMLConverter),config.addConverter("xml",HeadingHTMLConverter),config.addTextType({name:"heading1",data:{type:"heading",level:1}}),config.addTextType({name:"heading2",data:{type:"heading",level:2}}),config.addTextType({name:"heading3",data:{type:"heading",level:3}}),config.addLabel("heading1",{en:"Heading 1",de:"Überschrift 1"}),config.addLabel("heading2",{en:"Heading 2",de:"Überschrift 2"}),config.addLabel("heading3",{en:"Heading 3",de:"Überschrift 3"})},Heading:Heading,HeadingComponent:HeadingComponent,HeadingHTMLConverter:HeadingHTMLConverter},HeadingMacro={appliesTo:["paragraph"],execute:function(props,context){if(this.appliesTo.indexOf(props.node.type)===-1)return!1;var match=/^#\s/.exec(props.text);if(match){var surface=context.surfaceManager.getSurface(props.selection.surfaceId);return surface.transaction(function(tx,args){var deleteSel=tx.createSelection(props.path,0,match[0].length);deleteSelection(tx,{selection:deleteSel});var switchTextResult=switchTextType(tx,{selection:props.selection,containerId:args.containerId,data:{type:"heading",level:1}});if("type"===props.action)return{selection:tx.createSelection(switchTextResult.node.getTextPath(),0)}}),!0}}},Codeblock=function(TextBlock$$1){function Codeblock(){TextBlock$$1.apply(this,arguments)}return TextBlock$$1&&(Codeblock.__proto__=TextBlock$$1),Codeblock.prototype=Object.create(TextBlock$$1&&TextBlock$$1.prototype),Codeblock.prototype.constructor=Codeblock,Codeblock}(TextBlock);Codeblock.type="codeblock";var CodeblockComponent=function(TextBlockComponent$$1){function CodeblockComponent(){TextBlockComponent$$1.apply(this,arguments)}return TextBlockComponent$$1&&(CodeblockComponent.__proto__=TextBlockComponent$$1),CodeblockComponent.prototype=Object.create(TextBlockComponent$$1&&TextBlockComponent$$1.prototype),CodeblockComponent.prototype.constructor=CodeblockComponent,CodeblockComponent.prototype.render=function($$){var el=TextBlockComponent$$1.prototype.render.call(this,$$);return el.addClass("sc-codeblock")},CodeblockComponent}(TextBlockComponent),CodeblockHTMLConverter={type:"codeblock",tagName:"pre",import:function(el,node,converter){var codeEl=el.find("code");codeEl&&(node.content=converter.annotatedText(codeEl,[node.id,"content"],{preserveWhitespace:!0}))},export:function(node,el,converter){var $$=converter.$$;el.append($$("code").append(converter.annotatedText([node.id,"content"])))}},CodeblockPackage={name:"codeblock",configure:function(config){config.addNode(Codeblock),config.addComponent("codeblock",CodeblockComponent),config.addConverter("html",CodeblockHTMLConverter),config.addConverter("xml",CodeblockHTMLConverter),config.addTextType({
name:"codeblock",data:{type:"codeblock"}}),config.addLabel("codeblock",{en:"Codeblock",de:"Codeblock"})},Codeblock:Codeblock,CodeblockComponent:CodeblockComponent,CodeblockHTMLConverter:CodeblockHTMLConverter},Link=function(PropertyAnnotation$$1){function Link(){PropertyAnnotation$$1.apply(this,arguments)}return PropertyAnnotation$$1&&(Link.__proto__=PropertyAnnotation$$1),Link.prototype=Object.create(PropertyAnnotation$$1&&PropertyAnnotation$$1.prototype),Link.prototype.constructor=Link,Link}(PropertyAnnotation);Link.define({type:"link",title:{type:"string",optional:!0},url:{type:"string",default:""}}),Link.fragmentation=Fragmenter.SHOULD_NOT_SPLIT;var LinkComponent=function(AnnotationComponent$$1){function LinkComponent(){AnnotationComponent$$1.apply(this,arguments)}return AnnotationComponent$$1&&(LinkComponent.__proto__=AnnotationComponent$$1),LinkComponent.prototype=Object.create(AnnotationComponent$$1&&AnnotationComponent$$1.prototype),LinkComponent.prototype.constructor=LinkComponent,LinkComponent.prototype.didMount=function(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];(ref=AnnotationComponent$$1.prototype).didMount.apply(this,args);var node=this.props.node;node.on("properties:changed",this.rerender,this);var ref},LinkComponent.prototype.dispose=function(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];(ref=AnnotationComponent$$1.prototype).dispose.apply(this,args);var node=this.props.node;node.off(this);var ref},LinkComponent.prototype.render=function($$){var el=AnnotationComponent$$1.prototype.render.call(this,$$);el.tagName="a",el.attr("href",this.props.node.url);var titleComps=[this.props.node.url];return this.props.node.title&&titleComps.push(this.props.node.title),el.attr("title",titleComps.join(" | "))},LinkComponent}(AnnotationComponent),LinkCommand=function(AnnotationCommand$$1){function LinkCommand(){AnnotationCommand$$1.apply(this,arguments)}return AnnotationCommand$$1&&(LinkCommand.__proto__=AnnotationCommand$$1),LinkCommand.prototype=Object.create(AnnotationCommand$$1&&AnnotationCommand$$1.prototype),LinkCommand.prototype.constructor=LinkCommand,LinkCommand.prototype.canFuse=function(){return!1},LinkCommand.prototype.canDelete=function(){return!1},LinkCommand}(AnnotationCommand),LinkXMLConverter={type:"link",tagName:"a",import:function(el,node){node.url=el.attr("href"),node.title=el.attr("title")},export:function(link,el){el.attr({href:link.url,title:link.title})}},EditLinkTool=function(Tool$$1){function EditLinkTool(){Tool$$1.apply(this,arguments)}return Tool$$1&&(EditLinkTool.__proto__=Tool$$1),EditLinkTool.prototype=Object.create(Tool$$1&&Tool$$1.prototype),EditLinkTool.prototype.constructor=EditLinkTool,EditLinkTool.prototype.getUrlPath=function(){var propPath=this.constructor.urlPropertyPath;return[this.props.node.id].concat(propPath)},EditLinkTool.prototype._openLink=function(){var doc=this.context.documentSession.getDocument();window.open(doc.get(this.getUrlPath()),"_blank")},EditLinkTool.prototype.render=function($$){var Input=this.getComponent("input"),Button=this.getComponent("button"),el=$$("div").addClass("sc-edit-link-tool"),urlPath=this.getUrlPath();return el.append($$(Input,{type:"url",path:urlPath,placeholder:"Paste or type a link url"}),$$(Button,{icon:"open-link",style:this.props.style}).attr("title",this.getLabel("open-link")).on("click",this._openLink),$$(Button,{icon:"delete",style:this.props.style}).attr("title",this.getLabel("delete-link")).on("click",this.onDelete)),el},EditLinkTool.prototype.onDelete=function(e){e.preventDefault();var node=this.props.node,sm=this.context.surfaceManager,surface=sm.getFocusedSurface();surface.transaction(function(tx,args){return tx.delete(node.id),args})},EditLinkTool}(Tool);EditLinkTool.urlPropertyPath=["url"];var EditAnnotationCommand=function(Command$$1){function EditAnnotationCommand(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];if(Command$$1.apply(this,args),!this.config.nodeType)throw new Error("'nodeType' is required")}return Command$$1&&(EditAnnotationCommand.__proto__=Command$$1),EditAnnotationCommand.prototype=Object.create(Command$$1&&Command$$1.prototype),EditAnnotationCommand.prototype.constructor=EditAnnotationCommand,EditAnnotationCommand.prototype.getCommandState=function(params){var sel=this._getSelection(params),annos=this._getAnnotationsForSelection(params),newState={disabled:!0};return 1===annos.length&&sel.isPropertySelection()&&(newState.disabled=!1,newState.node=annos[0]),newState},EditAnnotationCommand.prototype.execute=function(params){},EditAnnotationCommand.prototype._getAnnotationsForSelection=function(params){return params.selectionState.getAnnotationsForType(this.config.nodeType)},EditAnnotationCommand}(Command),LinkPackage={name:"link",configure:function(config,options){config.addNode(Link),config.addComponent("link",LinkComponent),config.addConverter("html",LinkXMLConverter),config.addConverter("xml",LinkXMLConverter),config.addCommand("link",LinkCommand,{nodeType:"link"}),config.addCommand("edit-link",EditAnnotationCommand,{nodeType:"link"}),config.addTool("link",AnnotationTool,{target:options.toolTarget||"annotations"}),config.addTool("edit-link",EditLinkTool,{target:"overlay"}),config.addIcon("link",{fontawesome:"fa-link"}),config.addIcon("open-link",{fontawesome:"fa-external-link"}),config.addLabel("link",{en:"Link",de:"Link"}),config.addLabel("open-link",{en:"Open Link",de:"Link öffnen"}),config.addLabel("delete-link",{en:"Remove Link",de:"Link löschen"})},Link:Link,LinkComponent:LinkComponent,LinkCommand:LinkCommand,EditLinkTool:EditLinkTool},ProseArticle=function(Document$$1){function ProseArticle(schema){Document$$1.call(this,schema),this._initialize()}return Document$$1&&(ProseArticle.__proto__=Document$$1),ProseArticle.prototype=Object.create(Document$$1&&Document$$1.prototype),ProseArticle.prototype.constructor=ProseArticle,ProseArticle.prototype._initialize=function(){this.create({type:"container",id:"body",nodes:[]})},ProseArticle}(Document),ProseEditorPackage={name:"prose-editor",configure:function(config){config.defineSchema({name:"prose-article",ArticleClass:ProseArticle,defaultTextType:"paragraph"}),config.import(BasePackage),config.import(ParagraphPackage),config.import(HeadingPackage),config.import(CodeblockPackage),config.import(BlockquotePackage),config.import(EmphasisPackage),config.import(StrongPackage),config.import(SubscriptPackage),config.import(SuperscriptPackage),config.import(CodePackage),config.import(LinkPackage)}},CommandManager=function(context,commands){if(!context.documentSession)throw new Error("DocumentSession required.");this.documentSession=context.documentSession,this.context=extend$1({},context,{doc:this.documentSession.getDocument()}),this.commandRegistry=new Registry,forEach$2(commands,function(command){if(!command._isCommand)throw new Error("Expecting instances of ui/Command.");this.commandRegistry.add(command.name,command)}.bind(this)),this.documentSession.on("update",this.updateCommandStates,this,{priority:-10}),this.updateCommandStates()};CommandManager.prototype.dispose=function(){this.documentSession.off(this)},CommandManager.prototype.updateCommandStates=function(){var commandStates={},commandContext=this.getCommandContext(),params=this._getCommandParams();this.commandRegistry.forEach(function(cmd){commandStates[cmd.getName()]=cmd.getCommandState(params,commandContext)}),isEqual$2(this.commandStates,commandStates)||(this.commandStates=commandStates)},CommandManager.prototype.executeCommand=function(commandName,userParams){var cmd=this.commandRegistry.get(commandName);if(!cmd)return void console.warn("command",commandName,"not registered");var commandState=this.commandStates[commandName],params=extend$1(this._getCommandParams(),userParams,{commandState:commandState}),info=cmd.execute(params,this.getCommandContext());return void 0===info&&console.warn("command ",commandName,"must return either an info object or true when handled or false when not handled"),info},CommandManager.prototype.getCommandStates=function(){return this.commandStates},CommandManager.prototype.getCommandContext=function(){return this.context},CommandManager.prototype._getCommandParams=function(){var documentSession=this.context.documentSession,selectionState=documentSession.getSelectionState(),sel=selectionState.getSelection(),surface=this.context.surfaceManager.getFocusedSurface();return{documentSession:documentSession,selectionState:selectionState,surface:surface,selection:sel}};var MacroManager=function(context,macros){this.context=context,this.macros=macros,this.context.documentSession.on("update",this.onUpdate,this)};MacroManager.prototype.onUpdate=function(update,info){update.change&&this.executeMacros(update,info)},MacroManager.prototype.executeMacros=function(update,info){var this$1=this,change=update.change;if(change){var nodeId,node,text,path,doc=this.context.documentSession.getDocument();if("type"===info.action){var op=change.ops[0];path=op.path,nodeId=path[0],node=doc.get(nodeId),text=doc.get(path);for(var props={action:info.action,node:node,path:path,text:text,selection:this.context.documentSession.getSelection()},i=0;i<this.macros.length;i++){var macro=this$1.macros[i],executed=macro.execute(props,this$1.context);if(executed)break}}}};var events=["keydown","keyup","keypress","mousedown","mouseup","copy"],GlobalEventHandler=function(documentSession,surfaceManager){this.documentSession=documentSession,this.surfaceManager=surfaceManager,this.listeners=[],this.initialize()};GlobalEventHandler.prototype.initialize=function(){if(inBrowser){var document=DefaultDOMElement.wrapNativeElement(window.document);events.forEach(function(name){document.on(name,this._dispatch.bind(this,name),this)}.bind(this))}},GlobalEventHandler.prototype.dispose=function(){if(inBrowser){var document=DefaultDOMElement.wrapNativeElement(window.document);document.off(this)}},GlobalEventHandler.prototype.addEventListener=function(eventName,handler,options){if(!options.id)throw new Error("GlobalEventHandler can only be used with option 'id'");var listener=new DOMElement.EventListener(eventName,handler,options);this.listeners.push(listener)},GlobalEventHandler.prototype.removeEventListener=function(listener){var idx=this.listeners.indexOf(listener);idx>-1&&this.listeners.splice(idx,1)},GlobalEventHandler.prototype.getEventListeners=function(){return this.listeners},GlobalEventHandler.prototype._getActiveListener=function(eventName){var this$1=this,documentSession=this.documentSession,sel=documentSession.getSelection();if(sel)for(var surfaceId=sel.surfaceId,i=0;i<this.listeners.length;i++){var listener=this$1.listeners[i];if(listener.eventName===eventName&&listener.options.id===surfaceId)return listener}},GlobalEventHandler.prototype._dispatch=function(eventName,e){var listener=this._getActiveListener(eventName);listener&&listener.handler(e)},GlobalEventHandler.prototype.on=DOMElement.prototype.on,GlobalEventHandler.prototype.off=DOMElement.prototype.off;var SurfaceManager=function(documentSession){this.documentSession=documentSession,this.surfaces={},this._state={focusedSurfaceId:null,fragments:{},selection:null,collaborators:{}},this.documentSession.on("update",this.onSessionUpdate,this),this.documentSession.on("didUpdate",this.onSessionDidUpdate,this,{priority:-1e6})};SurfaceManager.prototype.dispose=function(){this.documentSession.off(this)},SurfaceManager.prototype.getSurface=function(name){if(name)return this.surfaces[name]},SurfaceManager.prototype.getFocusedSurface=function(){if(this._state.focusedSurfaceId)return this.getSurface(this._state.focusedSurfaceId)},SurfaceManager.prototype.registerSurface=function(surface){this.surfaces[surface.getId()]=surface},SurfaceManager.prototype.unregisterSurface=function(surface){surface.off(this);var surfaceId=surface.getId(),registeredSurface=this.surfaces[surfaceId];if(registeredSurface===surface){var focusedSurface=this.getFocusedSurface();delete this.surfaces[surfaceId],surface&&focusedSurface===surface&&(this._state.focusedSurfaceId=null)}},SurfaceManager.prototype.onSessionUpdate=function(update){function _fragmentsForSurface(surfaceId){var surfaceFrags=fragments[surfaceId];return surfaceFrags||(surfaceFrags={},fragments[surfaceId]=surfaceFrags),surfaceFrags}function _getFragmentsForSelection(sel,collaborator){var frags=sel.getFragments();return collaborator&&(frags=frags.map(function(frag){return frag.collaborator=collaborator,frag})),frags}function _updateSelectionFragments(oldSel,newSel,collaborator){var oldSurfaceId=oldSel?oldSel.surfaceId:null,newSurfaceId=newSel?newSel.surfaceId:null,owner="local-user";collaborator&&(owner=collaborator.collaboratorId),oldSurfaceId&&oldSurfaceId!==newSurfaceId&&(_fragmentsForSurface(oldSurfaceId)[owner]=[],updatedSurfaces[oldSurfaceId]=!0),newSurfaceId&&(_fragmentsForSurface(newSurfaceId)[owner]=_getFragmentsForSelection(newSel,collaborator),updatedSurfaces[newSurfaceId]=!0)}var _state=this._state,updatedSurfaces={};if(update.selection){var focusedSurface=this.surfaces[update.selection.surfaceId];_state.focusedSurfaceId=update.selection.surfaceId,focusedSurface&&!focusedSurface.isDisabled()?focusedSurface._focus():update.selection.isCustomSelection()&&inBrowser&&(window.getSelection().removeAllRanges(),window.document.activeElement.blur())}update.change&&forEach$2(this.surfaces,function(surface,surfaceId){surface._checkForUpdates(update.change)&&(updatedSurfaces[surfaceId]=!0)});var fragments=_state.fragments||{};update.selection&&(_updateSelectionFragments(_state.selection,update.selection),_state.selection=update.selection),update.collaborators&&forEach$2(update.collaborators,function(collaborator,collaboratorId){var oldSel,newSel,oldCollaborator=_state.collaborators[collaboratorId];oldCollaborator&&(oldSel=oldCollaborator.selection),collaborator&&(newSel=collaborator.selection),oldSel&&oldSel.equals(newSel)||_updateSelectionFragments(oldSel,newSel,collaborator),_state.collaborators[collaboratorId]={collaboratorId:collaboratorId,selection:newSel}}),updatedSurfaces=Object.keys(updatedSurfaces),updatedSurfaces.forEach(function(surfaceId){var surface=this.surfaces[surfaceId];if(surface){var newFragments=fragments[surfaceId];surface.extendProps({fragments:clone$2(newFragments)})}}.bind(this))},SurfaceManager.prototype.onSessionDidUpdate=function(update,info){if(!info.skipSelection){var focusedSurface=this.getFocusedSurface();focusedSurface&&!focusedSurface.isDisabled()&&(focusedSurface.focus(),focusedSurface.rerenderDOMSelection(),focusedSurface._sendOverlayHints())}};var DragManager=function(dndHandlers,context){this.context=context,this.dndHandlers=dndHandlers,this._source=null};DragManager.prototype.dispose=function(){var documentEl=DefaultDOMElement.wrapNativeElement(window.document);documentEl.off(this)},DragManager.prototype.onDragStart=function(event,component){var this$1=this;event.dataTransfer.effectAllowed="all",event.dataTransfer.setData("text/html",event.target.outerHTML),event.stopPropagation(),this._source={component:component};for(var i=0;i<this.dndHandlers.length;i++){var handler=this$1.dndHandlers[i];handler.dragStart(this$1._source,this$1.context)}},DragManager.prototype.onDragEnter=function(event,component){event.stopPropagation()},DragManager.prototype.onDragOver=function(event,component){event.preventDefault(),event.stopPropagation()},DragManager.prototype.onDrop=function(event,component){var this$1=this;event.preventDefault(),event.stopPropagation();var i,handler,params={source:this._source,target:_getTargetInfo(event,component),data:_getData(event)};for(i=0;i<this.dndHandlers.length;i++){handler=this$1.dndHandlers[i];var _break=handler.drop(params,this$1.context);if(_break)break}for(i=0;i<this.dndHandlers.length;i++)handler=this$1.dndHandlers[i],handler.dragEnd(params,this$1.context)},DragManager.prototype._getData=function(event){var dataTransfer=event.dataTransfer;if(dataTransfer)return{types:dataTransfer.types,items:Array.prototype.slice.call(dataTransfer.items),files:Array.prototype.slice.call(dataTransfer.files)}};var AbstractEditor=function(Component$$1){function AbstractEditor(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];Component$$1.apply(this,args),this._initialize(this.props)}return Component$$1&&(AbstractEditor.__proto__=Component$$1),AbstractEditor.prototype=Object.create(Component$$1&&Component$$1.prototype),AbstractEditor.prototype.constructor=AbstractEditor,AbstractEditor.prototype.render=function(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];(ref=Component$$1.prototype).render.apply(this,args);var ref},AbstractEditor.prototype.didMount=function(){this.documentSession.on("didUpdate",this.documentSessionUpdated,this)},AbstractEditor.prototype.willReceiveProps=function(nextProps){var newSession=nextProps.documentSession,shouldDispose=newSession&&newSession!==this.documentSession;shouldDispose&&(this._dispose(),this._initialize(nextProps))},AbstractEditor.prototype.dispose=function(){this._dispose()},AbstractEditor.prototype._dispose=function(){this.surfaceManager.dispose(),this.commandManager.dispose(),this.globalEventHandler.dispose(),this.dragManager.dispose(),this.documentSession.off(this),this.empty()},AbstractEditor.prototype.getChildContext=function(){return{controller:this,iconProvider:this.iconProvider,documentSession:this.documentSession,doc:this.doc,componentRegistry:this.componentRegistry,surfaceManager:this.surfaceManager,commandManager:this.commandManager,tools:this.tools,labelProvider:this.labelProvider,converterRegistry:this.converterRegistry,globalEventHandler:this.globalEventHandler,editingBehavior:this.editingBehavior,dragManager:this.dragManager}},AbstractEditor.prototype._initialize=function(props){var configurator=props.configurator,commands=configurator.getCommands();if(!props.documentSession)throw new Error("DocumentSession instance required");this.documentSession=props.documentSession,this.doc=this.documentSession.getDocument(),this.componentRegistry=configurator.getComponentRegistry(),this.tools=configurator.getTools(),this.surfaceManager=new SurfaceManager(this.documentSession),this.commandManager=new CommandManager(this.getCommandContext(),commands),this.dragManager=new DragManager(configurator.createDragHandlers(),{documentSession:this.documentSession,surfaceManager:this.surfaceManager,commandManager:this.commandManager}),this.macroManager=new MacroManager(this.getMacroContext(),configurator.getMacros()),this.iconProvider=configurator.getIconProvider(),this.converterRegistry=configurator.getConverterRegistry(),this.globalEventHandler=new GlobalEventHandler(this.documentSession,this.surfaceManager),this.editingBehavior=configurator.getEditingBehavior(),this.labelProvider=configurator.getLabelProvider()},AbstractEditor.prototype.getCommandContext=function(){return{documentSession:this.documentSession,surfaceManager:this.surfaceManager}},AbstractEditor.prototype.getMacroContext=function(){return{documentSession:this.documentSession,surfaceManager:this.surfaceManager}},AbstractEditor.prototype.documentSessionUpdated=function(){throw new Error("This method is abstract")},AbstractEditor}(Component),EditingBehavior=function(){this._merge={},this._mergeComponents={},this._break={}};EditingBehavior.prototype.defineMerge=function(firstType,secondType,impl){return this._merge[firstType]||(this._merge[firstType]={}),this._merge[firstType][secondType]=impl,this},EditingBehavior.prototype.canMerge=function(firstType,secondType){return this._merge[firstType]&&this._merge[firstType][secondType]},EditingBehavior.prototype.getMerger=function(firstType,secondType){return this._merge[firstType][secondType]},EditingBehavior.prototype.defineComponentMerge=function(nodeType,impl){this._mergeComponents[nodeType]=impl},EditingBehavior.prototype.canMergeComponents=function(nodeType){return this._mergeComponents[nodeType]},EditingBehavior.prototype.getComponentMerger=function(nodeType){return this._mergeComponents[nodeType]},EditingBehavior.prototype.defineBreak=function(nodeType,impl){return this._break[nodeType]=impl,this},EditingBehavior.prototype.canBreak=function(nodeType){return this._break[nodeType]},EditingBehavior.prototype.getBreaker=function(nodeType){return this._break[nodeType]};var isUndefined=createCommonjsModule(function(module){function isUndefined(value){return void 0===value}module.exports=isUndefined}),isUndefined$1=interopDefault(isUndefined),ClipboardImporter=function(HTMLImporter$$1){function ClipboardImporter(config){if(ClipboardImporter._addConverters(config),!config.schema)throw new Error("Missing argument: config.schema is required.");HTMLImporter$$1.call(this,config),this.IGNORE_DEFAULT_WARNINGS=!0,extend$1(config,{trimWhitespaces:!0,REMOVE_INNER_WS:!0}),this._isWindows=platform.isWindows,this._emptyDoc=this._createDocument(this.schema)}return HTMLImporter$$1&&(ClipboardImporter.__proto__=HTMLImporter$$1),ClipboardImporter.prototype=Object.create(HTMLImporter$$1&&HTMLImporter$$1.prototype),ClipboardImporter.prototype.constructor=ClipboardImporter,ClipboardImporter.prototype.importDocument=function(html){var body,el;if(this._isWindows){var match=/<!--StartFragment\-->(.*)<!--EndFragment-->/.exec(html);match&&(html=match[1])}if(html.search(/meta name=.substance./)>=0){el=DefaultDOMElement.parseHTML(html);var substanceData=el.find('meta[name="substance"]');if(substanceData){var jsonStr=atob(substanceData.attr("content"));jsonStr=decodeURIComponent(jsonStr);try{return this.importFromJSON(jsonStr)}catch(err){console.error(err)}}}if(el=DefaultDOMElement.parseHTML(html),isArray$1(el)?(body=this._createElement("body"),body.append(el)):body=el.find("body"),body||(body=this._createElement("body"),body.append(el)),body=this._fixupGoogleDocsBody(body),!body)return console.warn("Invalid HTML."),null;this.reset(),this.convertBody(body);var doc=this.generateDocument();return doc},ClipboardImporter.prototype._fixupGoogleDocsBody=function(body){if(body){var bold=body.find("b");return bold&&/^docs-internal/.exec(bold.id)?bold:body}},ClipboardImporter.prototype.importFromJSON=function(jsonStr){var doc=this.createDocument(),jsonData=JSON.parse(jsonStr),converter=new JSONConverter;return converter.importDocument(doc,jsonData),doc},ClipboardImporter.prototype.convertBody=function(body){this.convertContainer(body.childNodes,Document.SNIPPET_ID)},ClipboardImporter.prototype._wrapInlineElementsIntoBlockElement=function(childIterator){for(var this$1=this,wrapper=this._createElement("p");childIterator.hasNext();){var el=childIterator.next(),blockTypeConverter=this$1._getConverterForElement(el,"block");if(blockTypeConverter){childIterator.back();break}wrapper.append(el.clone())}wrapper.attr("data-id",Document.TEXT_SNIPPET_ID);var node=this.defaultConverter(wrapper,this);if(node){if(!node.type)throw new Error("Contract: Html.defaultConverter() must return a node with type.");this._createAndShow(node)}return node},ClipboardImporter.prototype.createDocument=function(){return this._emptyDoc.createSnippet()},ClipboardImporter.prototype._getUnsupportedNodeConverter=function(){},ClipboardImporter}(HTMLImporter),_converters={"catch-all-block":{type:"paragraph",matchElement:function(el){return el.is("div")},import:function(el,node,converter){node.content=converter.annotatedText(el,[node.id,"content"])}}};ClipboardImporter._addConverters=function(config){if(config.converters){var registry=new Registry;config.converters.forEach(function(conv,name){registry.add(name,conv)}),forEach$2(_converters,function(converter,name){registry.add(name,converter)}),config.converters=registry}};var ClipboardExporter=function(HtmlExporter){function ClipboardExporter(){HtmlExporter.apply(this,arguments)}return HtmlExporter&&(ClipboardExporter.__proto__=HtmlExporter),ClipboardExporter.prototype=Object.create(HtmlExporter&&HtmlExporter.prototype),ClipboardExporter.prototype.constructor=ClipboardExporter,ClipboardExporter.prototype.exportDocument=function(doc){this.state.doc=doc;var html,elements=this.convertDocument(doc);html=1===elements.length&&elements[0].attr("data-id")===Document.TEXT_SNIPPET_ID?elements[0].innerHTML:elements.map(function(el){return el.outerHTML}).join("");var jsonConverter=new JSONConverter,jsonStr=JSON.stringify(jsonConverter.exportDocument(doc)),meta=["<meta name='substance' content='",btoa(jsonStr),"'>"].join("");return"<html><head>"+meta+"</head><body>"+html+"</body></html>"},ClipboardExporter.prototype.convertDocument=function(doc){var content=doc.get(Document.SNIPPET_ID);if(!content)throw new Error('Illegal clipboard document: could not find container "'+Document.SNIPPET_ID+'"');return this.convertContainer(content)},ClipboardExporter}(HTMLExporter),Clipboard=function(surface,config){this.surface=surface;var doc=surface.getDocument(),schema=doc.getSchema(),htmlConverters=[];config.converterRegistry&&(htmlConverters=config.converterRegistry.get("html")||[]);var _config={schema:schema,DocumentClass:doc.constructor,converters:htmlConverters};this.htmlImporter=new ClipboardImporter(_config),this.htmlExporter=new ClipboardExporter(_config)};Clipboard.prototype.getSurface=function(){return this.surface},Clipboard.prototype.attach=function(el){el.on("copy",this.onCopy,this),el.on("cut",this.onCut,this),platform.isIE&&!platform.isEdge?el.on("beforepaste",this.onBeforePasteShim,this):el.on("paste",this.onPaste,this)},Clipboard.prototype.detach=function(el){el.off(this)},Clipboard.prototype.onCopy=function(event){var clipboardData=this._copy();Clipboard.clipboardData=clipboardData,substanceGlobals$1.clipboardData=clipboardData,substanceGlobals$1._clipboardData=event.clipboardData,event.clipboardData&&clipboardData.doc&&(event.preventDefault(),event.clipboardData.setData("text/plain",clipboardData.text),platform.isIE||platform.isEdge||event.clipboardData.setData("text/html",clipboardData.html))},Clipboard.prototype.onCut=function(event){event.preventDefault(),this.onCopy(event);var surface=this.getSurface();surface&&surface.transaction(function(tx,args){return surface.delete(tx,args)})},Clipboard.prototype.onPaste=function(event){for(var clipboardData=event.clipboardData,types={},i=0;i<clipboardData.types.length;i++)types[clipboardData.types[i]]=!0;event.preventDefault(),event.stopPropagation();var plainText,html;if(types["text/plain"]&&(plainText=clipboardData.getData("text/plain")),types["text/html"]&&(html=clipboardData.getData("text/html")),platform.isEdge&&substanceGlobals$1.clipboardData&&substanceGlobals$1.clipboardData.text===plainText?html=substanceGlobals$1.clipboardData.html:substanceGlobals$1.clipboardData={text:plainText,html:html},platform.isFF&&!html)return void this._pastePlainText(plainText);if(html)if(Clipboard.NO_CATCH)this._pasteHtml(html,plainText);else try{this._pasteHtml(html,plainText)}catch(err){this._pastePlainText(plainText)}else this._pastePlainText(plainText)},Clipboard.prototype._pastePlainText=function(plainText){var surface=this.getSurface();surface.transaction(function(tx,args){return args.text=plainText,surface.paste(tx,args)})},Clipboard.prototype.onBeforePasteShim=function(){var surface=this.getSurface();if(surface){var pasteEl=this._createPasteBin(),el=pasteEl.getNativeElement();el.focus();var range=window.document.createRange();range.setStart(el.firstChild,0),range.setEnd(el.firstChild,1);var wsel=window.getSelection();wsel.removeAllRanges(),wsel.addRange(range)}},Clipboard.prototype._createPasteBin=function(){var el=this.surface.el.createElement("div").attr("contenteditable",!0).attr("tabindex",-1).css({position:"fixed",opacity:"0.0",bottom:"-1000px"}).append(" ").on("beforepaste",function(event){event.stopPropagation()}).on("paste",function(event){this.onPasteShim(el),event.stopPropagation()}.bind(this));return this.surface.el.appendChild(el),el},Clipboard.prototype.onPasteShim=function(pasteEl){window.setTimeout(function(){var html=pasteEl.innerHTML,text=pasteEl.textContent;if(pasteEl.remove(),substanceGlobals$1.clipboardData={text:text,html:html},Clipboard.NO_CATCH)this._pasteHtml(html,text);else try{this._pasteHtml(html,text)}catch(err){this._pastePlainText(text)}}.bind(this))},Clipboard.prototype._copy=function(){var surface=this.getSurface(),sel=surface.getSelection(),doc=surface.getDocument(),clipboardDoc=null,clipboardText="",clipboardHtml="";return sel.isCollapsed()||(clipboardText=documentHelpers.getTextForSelection(doc,sel)||"",clipboardDoc=surface.copy(doc,sel),clipboardHtml=this.htmlExporter.exportDocument(clipboardDoc)),{doc:clipboardDoc,html:clipboardHtml,text:clipboardText}},Clipboard.prototype._pasteHtml=function(html,text){var surface=this.getSurface();if(surface){var content=this.htmlImporter.importDocument(html);return content?(surface.transaction(function(tx,args){return args.text=text,args.doc=content,surface.paste(tx,args)}),!0):void 0}},Clipboard.clipboardData={doc:null,html:"",text:""};var DOMSelection=function(surface){this.surface=surface,this._wrange=window.document.createRange()};DOMSelection.prototype.getSelection=function(options){var range=this.mapDOMSelection(options),doc=this.surface.getDocument();return doc.createSelection(range)},DOMSelection.prototype.getSelectionForDOMRange=function(wrange){var range=this.mapDOMRange(wrange),doc=this.surface.getDocument();return doc.createSelection(range)},DOMSelection.prototype.setSelection=function(sel){var wSel=window.getSelection();if(sel.isNull()||sel.isCustomSelection())return void this.clear();var start,end;if(sel.isPropertySelection()||sel.isContainerSelection()){if(start=this._getDOMCoordinate(sel.start),!start)return console.warn("FIXME: selection seems to be invalid."),void this.clear();if(sel.isCollapsed())end=start;else if(end=this._getDOMCoordinate(sel.end),!end)return console.warn("FIXME: selection seems to be invalid."),void this.clear()}else if(sel.isNodeSelection()){var comp=this.surface.find('*[data-id="'+sel.getNodeId()+'"]');if(!comp)return console.error("Could not find component with id",sel.getNodeId()),void this.clear();if(comp._isIsolatedNodeComponent){var coors=IsolatedNodeComponent.getDOMCoordinates(comp);sel.isFull()?(start=coors.start,end=coors.end):start=end=sel.isBefore()?coors.start:coors.end}else{var _nodeEl=comp.el;start={container:_nodeEl.getNativeElement(),offset:0},end={container:_nodeEl.getNativeElement(),offset:_nodeEl.getChildCount()},sel.isBefore()?end=start:sel.isAfter()&&(start=end)}}var wRange;if(wRange=wSel.rangeCount>0?wSel.getRangeAt(0):this._wrange,wSel.removeAllRanges(),sel.isCollapsed())wRange.setStart(start.container,start.offset),wRange.setEnd(start.container,start.offset),wSel.addRange(wRange);else if(sel.isReverse()){var tmp=start;start=end,end=tmp,wRange.setStart(start.container,start.offset),wRange.setEnd(start.container,start.offset),wSel.addRange(wRange),wSel.extend(end.container,end.offset)}else wRange.setStart(start.container,start.offset),wRange.setEnd(end.container,end.offset),wSel.addRange(wRange)},DOMSelection.prototype._getDOMCoordinate=function(coor){var comp,domCoor=null;return coor.isNodeCoordinate()?(comp=this.surface.find('*[data-id="'+coor.getNodeId()+'"]'),comp&&(domCoor=comp._isIsolatedNodeComponent?IsolatedNodeComponent.getDOMCoordinate(comp,coor):{container:comp.getNativeElement(),offset:coor.offset})):(comp=this.surface._getTextPropertyComponent(coor.path),comp&&(domCoor=comp.getDOMCoordinate(coor.offset))),domCoor},DOMSelection.prototype.mapDOMRange=function(wRange){return this._getRange(DefaultDOMElement.wrapNativeElement(wRange.startContainer),wRange.startOffset,DefaultDOMElement.wrapNativeElement(wRange.endContainer),wRange.endOffset)},DOMSelection.prototype.mapDOMSelection=function(options){var range,wSel=window.getSelection();if(0===wSel.rangeCount)return null;var anchorNode=DefaultDOMElement.wrapNativeElement(wSel.anchorNode);if(wSel.isCollapsed){var coor=this._getCoordinate(anchorNode,wSel.anchorOffset,options);if(!coor)return null;range=coor.__inIsolatedBlockNode__?_createRangeForIsolatedBlockNode(coor.path[0],this.getContainerId()):coor.__inInlineNode__?_createRange(new Coordinate(coor.path,coor.__startOffset__),new Coordinate(coor.path,coor.__endOffset__),!1,this.getContainerId()):_createRange(coor,coor,!1,this.getContainerId());
}else if(anchorNode.isElementNode()&&anchorNode.is(".sc-surface"))range=this._getEnclosingRange(wSel.getRangeAt(0));else{var focusNode=DefaultDOMElement.wrapNativeElement(wSel.focusNode);range=this._getRange(anchorNode,wSel.anchorOffset,focusNode,wSel.focusOffset)}return range},DOMSelection.prototype.clear=function(){window.getSelection().removeAllRanges()},DOMSelection.prototype.collapse=function(dir){var wRange,wSel=window.getSelection();wSel.rangeCount>0&&(wRange=wSel.getRangeAt(0),wRange.collapse("left"===dir),wSel.removeAllRanges(),wSel.addRange(wRange))},DOMSelection.prototype.getContainerId=function(){return this.surface.isContainerEditor()?this.surface.getContainerId():null},DOMSelection.prototype._getRange=function(anchorNode,anchorOffset,focusNode,focusOffset){var end,start=this._getCoordinate(anchorNode,anchorOffset);end=anchorNode===focusNode&&anchorOffset===focusOffset?start:this._getCoordinate(focusNode,focusOffset);var isReverse=DefaultDOMElement.isReverse(anchorNode,anchorOffset,focusNode,focusOffset);return start&&end?_createRange(start,end,isReverse,this.getContainerId()):null},DOMSelection.prototype._getCoordinate=function(nodeEl,offset,options){var surfaceEl=this.surface.el,coor=null;return coor||(coor=InlineNodeComponent.getCoordinate(nodeEl,offset),coor&&(coor.__inInlineNode__=!0)),coor||(coor=TextPropertyComponent.getCoordinate(surfaceEl,nodeEl,offset)),coor||(coor=IsolatedNodeComponent.getCoordinate(surfaceEl,nodeEl,offset),coor&&(coor.__inIsolatedBlockNode__=!0)),coor||(coor=this._searchForCoordinate(nodeEl,offset,options)),coor},DOMSelection.prototype._searchForCoordinate=function(node,offset,options){var this$1=this;options=options||{},options.direction=options.direction||"right";var dir=options.direction;if(node.isElementNode()){var childCount=node.getChildCount();offset=Math.max(0,Math.min(childCount,offset));for(var el=node.getChildAt(offset);el;){var textPropertyEl=void 0;if("right"===dir){if(el.isElementNode()&&(textPropertyEl=el.getAttribute("data-path")?el:el.find("*[data-path]")))return new Coordinate(_getPath(textPropertyEl),0);el=el.getNextSibling()}else{if(el.isElementNode()){if(el.getAttribute("data-path"))textPropertyEl=el;else{var textPropertyEls=el.findAll("*[data-path]");textPropertyEl=last$1(textPropertyEls)}if(textPropertyEl){var path=_getPath(textPropertyEl),doc=this$1.surface.getDocument(),text=doc.get(path);return new Coordinate(path,text.length)}}el=el.getPreviousSibling()}}}if(node!==this.surface.el){var parent=node.getParent(),nodeIdx=parent.getChildIndex(node);return"right"===dir&&nodeIdx++,this._searchForCoordinate(parent,nodeIdx,options)}return null},DOMSelection.prototype._getEnclosingRange=function(wRange){var frag=wRange.cloneContents(),props=frag.querySelectorAll("*[data-path]");if(0===props.length)return null;var text,doc=this.surface.getDocument(),first=props[0],last=props[props.length-1],startPath=_getPath(first);if(first===last)return text=doc.get(startPath),new Range(new Coordinate(startPath,0),new Coordinate(startPath,text.length),(!1));var endPath=_getPath(last);return text=doc.get(endPath),new Range(new Coordinate(startPath,0),new Coordinate(endPath,text.length),(!1))};var UnsupportedNodeComponent=function(Component$$1){function UnsupportedNodeComponent(){Component$$1.apply(this,arguments)}return Component$$1&&(UnsupportedNodeComponent.__proto__=Component$$1),UnsupportedNodeComponent.prototype=Object.create(Component$$1&&Component$$1.prototype),UnsupportedNodeComponent.prototype.constructor=UnsupportedNodeComponent,UnsupportedNodeComponent.prototype.render=function($$){return $$("pre").addClass("content-node unsupported").attr({"data-id":this.props.node.id,contentEditable:!1}).append(JSON.stringify(this.props.node.properties,null,2))},UnsupportedNodeComponent}(Component),Surface=function(Component$$1){function Surface(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];if(Component$$1.apply(this,args),this.documentSession=this.props.documentSession||this.context.documentSession,!this.documentSession)throw new Error("No DocumentSession provided");if(this.name=this.props.name,!this.name)throw new Error("Surface must have a name.");if(this.name.indexOf("/")>-1)throw new Error("Surface.name must not contain '/'");this._surfaceId=createSurfaceId(this),this.clipboard=new Clipboard(this,{converterRegistry:this.context.converterRegistry}),this.domSelection=null,this.domObserver=null,inBrowser&&(this.documentEl=DefaultDOMElement.wrapNativeElement(window.document)),this.undoEnabled=!0,this.textTypes=this.props.textTypes,this._textProperties={},this._state={skipNextFocusEvent:!1,skipNextObservation:!1,isDirty:!1,dirtyProperties:{},fragments:{},cursorFragment:null},Surface.prototype._deriveInternalState.call(this,this.props)}Component$$1&&(Surface.__proto__=Component$$1),Surface.prototype=Object.create(Component$$1&&Component$$1.prototype),Surface.prototype.constructor=Surface;var prototypeAccessors={_isSurface:{}};return prototypeAccessors._isSurface.get=function(){return!0},Surface.prototype.getChildContext=function(){return{surface:this,surfaceParent:this,doc:this.getDocument()}},Surface.prototype.didMount=function(){this.context.surfaceManager&&this.context.surfaceManager.registerSurface(this),!this.isReadonly()&&inBrowser&&(this.domSelection=new DOMSelection(this)),this.documentSession.on("update",this._onSessionUpdate,this)},Surface.prototype.dispose=function(){this.documentSession.off(this),this.domSelection=null,this.domObserver&&this.domObserver.disconnect(),this.context.surfaceManager&&this.context.surfaceManager.unregisterSurface(this)},Surface.prototype.willReceiveProps=function(nextProps){Surface.prototype._deriveInternalState.call(this,nextProps)},Surface.prototype.didUpdate=function(oldProps,oldState){this._update(oldProps,oldState)},Surface.prototype.render=function($$){var tagName=this.props.tagName||"div",el=$$(tagName).addClass("sc-surface").attr("spellCheck",!1).attr("tabindex",2);return this.isDisabled()||(this.isEditable()&&(el.on("keydown",this.onKeyDown),platform.isIE||el.on("compositionstart",this.onCompositionStart),inBrowser&&window.TextEvent&&!platform.isIE?el.on("textInput",this.onTextInput):el.on("keypress",this.onTextInputShim)),this.isReadonly()||(el.on("mousedown",this.onMouseDown),el.on("focus",this.onNativeFocus),el.on("blur",this.onNativeBlur),this.clipboard.attach(el)),this.context.dragManager&&el.on("drop",this.onDrop)),el},Surface.prototype.renderNode=function($$,node){var doc=this.getDocument(),componentRegistry=this.getComponentRegistry(),ComponentClass=componentRegistry.get(node.type);return ComponentClass||(console.error("Could not resolve a component for type: "+node.type),ComponentClass=UnsupportedNodeComponent),$$(ComponentClass,{doc:doc,node:node}).ref(node.id)},Surface.prototype.getComponentRegistry=function(){return this.context.componentRegistry||this.props.componentRegistry},Surface.prototype.getName=function(){return this.name},Surface.prototype.getId=function(){return this._surfaceId},Surface.prototype.isDisabled=function(){return this.props.disabled},Surface.prototype.isEditable=function(){return"full"===this.props.editing||void 0===this.props.editing},Surface.prototype.isSelectable=function(){return"selection"===this.props.editing||"full"===this.props.editing},Surface.prototype.isReadonly=function(){return"readonly"===this.props.editing},Surface.prototype.getElement=function(){return this.el},Surface.prototype.getController=function(){return this.context.controller},Surface.prototype.getDocument=function(){return this.documentSession.getDocument()},Surface.prototype.getDocumentSession=function(){return this.documentSession},Surface.prototype.isEnabled=function(){return!this.state.disabled},Surface.prototype.isContainerEditor=function(){return!1},Surface.prototype.getContainerId=function(){return null},Surface.prototype.transaction=function(transformation,info){var documentSession=this.documentSession,surfaceId=this.getId();return documentSession.transaction(function(tx,args){return tx.before.surfaceId=surfaceId,transformation(tx,args)},info)},Surface.prototype.getSelection=function(){return this.documentSession.getSelection()},Surface.prototype.setSelection=function(sel){sel&&!sel.isNull()&&(sel.surfaceId=this.getId(),sel.containerId=sel.containerId||this.getContainerId()),this._setSelection(sel)},Surface.prototype.blur=function(){this.el&&this.el.blur()},Surface.prototype.focus=function(){this.isDisabled()||(platform.isFF&&(this.domSelection.clear(),this.el.getNativeElement().blur()),this._focus())},Surface.prototype.rerenderDOMSelection=function(){if(!this.isDisabled()&&inBrowser){var sel=this.getSelection();sel.surfaceId===this.getId()&&this.domSelection.setSelection(sel)}},Surface.prototype.getDomNodeForId=function(nodeId){return this.el.getNativeElement().querySelector('*[data-id="'+nodeId+'"]')},Surface.prototype.selectAll=function(){var doc=this.getDocument(),sel=this.getSelection();if(sel.isPropertySelection()){var path=sel.path,text=doc.get(path);sel=doc.createSelection({type:"property",path:path,startOffset:0,endOffset:text.length}),this.setSelection(sel)}},Surface.prototype.insertText=function(tx,args){var sel=args.selection;if(sel.isPropertySelection()||sel.isContainerSelection())return insertText(tx,args)},Surface.prototype.delete=function(tx,args){var sel=args.selection;return sel.isCollapsed()?sel.isPropertySelection()||sel.isNodeSelection()?deleteCharacter(tx,args):void 0:deleteSelection(tx,args)},Surface.prototype.break=function(tx,args){return this.softBreak(tx,args)},Surface.prototype.softBreak=function(tx,args){return args.text="\n",this.insertText(tx,args)},Surface.prototype.copy=function(doc,selection){var result=copySelection(doc,{selection:selection});return result.doc},Surface.prototype.paste=function(tx,args){if(args.text)return this.insertText(tx,args)},Surface.prototype.onKeyDown=function(event){var commandManager=this.context.commandManager;if(229!==event.which){switch(event.keyCode){case keys$2.LEFT:case keys$2.RIGHT:return this._handleLeftOrRightArrowKey(event);case keys$2.UP:case keys$2.DOWN:return this._handleUpOrDownArrowKey(event);case keys$2.ENTER:return this._handleEnterKey(event);case keys$2.SPACE:return this._handleSpaceKey(event);case keys$2.BACKSPACE:case keys$2.DELETE:return this._handleDeleteKey(event);case keys$2.HOME:case keys$2.END:return this._handleHomeOrEndKey(event);case keys$2.PAGEUP:case keys$2.PAGEDOWN:return this._handlePageUpOrDownKey(event)}var handled=!1;(event.ctrlKey||event.metaKey)&&65===event.keyCode?(this.selectAll(),handled=!0):this.undoEnabled&&90===event.keyCode&&(event.metaKey||event.ctrlKey)?(event.shiftKey?commandManager.executeCommand("redo"):commandManager.executeCommand("undo"),handled=!0):66===event.keyCode&&(event.metaKey||event.ctrlKey)?(commandManager.executeCommand("strong"),handled=!0):73===event.keyCode&&(event.metaKey||event.ctrlKey)?(commandManager.executeCommand("emphasis"),handled=!0):75===event.keyCode&&(event.metaKey||event.ctrlKey)&&(commandManager.executeCommand("link"),handled=!0),handled&&(event.preventDefault(),event.stopPropagation())}},Surface.prototype.onTextInput=function(event){event.preventDefault(),event.stopPropagation(),event.data&&(this._state.skipNextObservation=!0,this.transaction(function(tx,args){return this.domSelection&&this.domSelection.clear(),args.text=event.data,this.insertText(tx,args)}.bind(this),{action:"type"}))},Surface.prototype.onCompositionStart=function(){this._state.skipNextObservation=!0},Surface.prototype.onTextInputShim=function(event){if(!(0===event.which||0===event.charCode||event.keyCode===keys$2.TAB||event.keyCode===keys$2.ESCAPE||Boolean(event.metaKey)||Boolean(event.ctrlKey)^Boolean(event.altKey))){var character=String.fromCharCode(event.which);return this._state.skipNextObservation=!0,event.shiftKey||(character=character.toLowerCase()),character.length>0?(this.transaction(function(tx,args){return this.domSelection&&this.domSelection.clear(),args.text=character,this.insertText(tx,args)}.bind(this),{action:"type"}),event.preventDefault(),void event.stopPropagation()):(event.preventDefault(),void event.stopPropagation())}},Surface.prototype.onMouseDown=function(event){if(!(platform.isIE&&platform.version<12)&&event.detail>=3){var sel=this.getSelection();if(sel.isPropertySelection())return this._selectProperty(sel.path),event.preventDefault(),void event.stopPropagation();if(sel.isContainerSelection())return this._selectProperty(sel.startPath),event.preventDefault(),void event.stopPropagation()}1===event.which&&(this._state.skipNextFocusEvent=!0,this.documentEl&&this.documentEl.on("mouseup",this.onMouseUp,this,{once:!0}))},Surface.prototype.onMouseUp=function(){setTimeout(function(){if(this.domSelection){var sel=this.domSelection.getSelection();this.setSelection(sel)}}.bind(this))},Surface.prototype.onDomMutations=function(e){return this._state.skipNextObservation?void(this._state.skipNextObservation=!1):void console.info("We want to enable a DOM MutationObserver which catches all changes made by native interfaces (such as spell corrections, etc). Lookout for this message and try to set Surface.skipNextObservation=true when you know that you will mutate the DOM.",e)},Surface.prototype.onDrop=function(event){this.context.dragManager.onDrop(event,this)},Surface.prototype.onNativeBlur=function(){var _state=this._state;_state.hasNativeFocus=!1},Surface.prototype.onNativeFocus=function(){var _state=this._state;_state.hasNativeFocus=!0},Surface.prototype._deriveInternalState=function(nextProps){var _state=this._state,oldFragments=_state.fragments;oldFragments&&forEach$2(oldFragments,function(frag,key){this._getComponentForKey(key)&&this._markAsDirty(_state,key)}.bind(this));var nextFragments=nextProps.fragments;nextFragments&&this._deriveFragments(nextFragments)},Surface.prototype._deriveFragments=function(newFragments){var _state=this._state;_state.cursorFragment=null;var fragments={};this._forEachFragment(newFragments,function(frag,owner){var key=frag.path.toString();if(frag.key=key,this._getComponentForKey(key)){if("cursor"===frag.type&&"local-user"===owner)return void(_state.cursorFragment=frag);var propertyFrags=fragments[key];propertyFrags||(propertyFrags=[],fragments[key]=propertyFrags),propertyFrags.push(frag),this._markAsDirty(_state,key)}}.bind(this)),_state.fragments=fragments},Surface.prototype._forEachFragment=function(fragments,fn){forEach$2(fragments,function(frags,owner){frags.forEach(function(frag){fn(frag,owner)})})},Surface.prototype._checkForUpdates=function(change){var _state=this._state;return Object.keys(change.updated).forEach(function(key){this._getComponentForKey(key)&&this._markAsDirty(_state,key)}.bind(this)),_state.isDirty},Surface.prototype._update=function(oldProps,oldState){this._updateContentEditableState(oldState),this._updateProperties()},Surface.prototype._updateContentEditableState=function(oldState){if("co-focused"===oldState.mode&&this.el.off("mousedown",this._enableContentEditable,this),this.isEditable()){if(this.state.mode!==oldState.mode)switch(this.state.mode){case"co-focused":this.el.setAttribute("contenteditable",!1),this.el.on("mousedown",this._enableContentEditable,this);break;default:this.el.setAttribute("contenteditable",!0)}}else this.el.setAttribute("contenteditable",!1)},Surface.prototype._enableContentEditable=function(){this.el.setAttribute("contenteditable",!0)},Surface.prototype._updateProperties=function(){for(var this$1=this,_state=this._state,dirtyProperties=Object.keys(_state.dirtyProperties),i=0;i<dirtyProperties.length;i++)this$1._updateProperty(dirtyProperties[i]);_state.isDirty=!1,_state.dirtyProperties={}},Surface.prototype._markAsDirty=function(_state,key){_state.isDirty=!0,_state.dirtyProperties[key]=!0},Surface.prototype._updateProperty=function(key){var _state=this._state,cursorFragment=this._hasNativeFocus()?null:_state.cursorFragment,frags=_state.fragments[key]||[];cursorFragment&&cursorFragment.key===key&&(frags=frags.concat([cursorFragment]));var comp=this._getComponentForKey(key);comp&&comp.extendProps({fragments:frags})},Surface.prototype._onSessionUpdate=function(update){if(update.selection){var newMode=this._deriveModeFromSelection(update.selection);this.state.mode!==newMode&&this.extendState({mode:newMode})}},Surface.prototype._deriveModeFromSelection=function(sel){var mode,surfaceId=sel.surfaceId,id=this.getId();return startsWith$1(surfaceId,id)&&(mode=surfaceId.length===id.length?"focused":"co-focused"),mode},Surface.prototype._getSurfaceParent=function(){return this.context.surfaceParent},Surface.prototype._getComponentForKey=function(key){return this._textProperties[key]},Surface.prototype._focus=function(){this._state.hasNativeFocus=!0,this.el&&!platform.isWebkit&&(this._state.skipNextFocusEvent=!0,this.el.focus(),this._state.skipNextFocusEvent=!1)},Surface.prototype._handleLeftOrRightArrowKey=function(event){event.stopPropagation();var direction=event.keyCode===keys$2.LEFT?"left":"right",selState=this.getDocumentSession().getSelectionState(),sel=selState.getSelection();return selState.isInlineNodeSelection()&&!event.shiftKey?(event.preventDefault(),void this.setSelection(sel.collapse(direction))):void window.setTimeout(function(){if(this.isMounted()){var options={direction:event.keyCode===keys$2.LEFT?"left":"right"};this._updateModelSelection(options)}}.bind(this))},Surface.prototype._handleUpOrDownArrowKey=function(event){event.stopPropagation(),window.setTimeout(function(){if(this.isMounted()){var options={direction:event.keyCode===keys$2.UP?"left":"right"};this._updateModelSelection(options)}}.bind(this))},Surface.prototype._handleHomeOrEndKey=function(event){event.stopPropagation(),window.setTimeout(function(){if(this.isMounted()){var options={direction:event.keyCode===keys$2.HOME?"left":"right"};this._updateModelSelection(options)}}.bind(this))},Surface.prototype._handlePageUpOrDownKey=function(event){event.stopPropagation(),window.setTimeout(function(){if(this.isMounted()){var options={direction:event.keyCode===keys$2.PAGEUP?"left":"right"};this._updateModelSelection(options)}}.bind(this))},Surface.prototype._handleSpaceKey=function(event){event.preventDefault(),event.stopPropagation(),this.transaction(function(tx,args){return this.domSelection.clear(),args.text=" ",this.insertText(tx,args)}.bind(this),{action:"type"})},Surface.prototype._handleEnterKey=function(event){event.preventDefault(),event.stopPropagation(),event.shiftKey?this.transaction(function(tx,args){return this.softBreak(tx,args)}.bind(this),{action:"break"}):this.transaction(function(tx,args){return this.break(tx,args)}.bind(this),{action:"break"})},Surface.prototype._handleDeleteKey=function(event){event.preventDefault(),event.stopPropagation();var direction=event.keyCode===keys$2.BACKSPACE?"left":"right";this.transaction(function(tx,args){return args.direction=direction,this.delete(tx,args)}.bind(this),{action:"delete"})},Surface.prototype._hasNativeFocus=function(){return Boolean(this._state.hasNativeFocus)},Surface.prototype._setSelection=function(sel){!sel.isNull()&&sel.surfaceId===this.getId()&&platform.isFF&&this._focus(),this.documentSession.setSelection(sel)},Surface.prototype._updateModelSelection=function(options){var sel=this.domSelection.getSelection(options);this.setSelection(sel)},Surface.prototype._selectProperty=function(path){var doc=this.getDocument(),text=doc.get(path);this.setSelection(doc.createSelection(path,0,text.length))},Surface.prototype._registerTextProperty=function(textPropertyComponent){var path=textPropertyComponent.getPath();this._textProperties[path]=textPropertyComponent},Surface.prototype._unregisterTextProperty=function(textPropertyComponent){var path=textPropertyComponent.getPath();this._textProperties[path]===textPropertyComponent&&delete this._textProperties[path]},Surface.prototype._getTextPropertyComponent=function(path){return this._textProperties[path]},Surface.prototype._renderNode=function($$,nodeId){var doc=this.getDocument(),node=doc.get(nodeId),componentRegistry=this.context.componentRegistry||this.props.componentRegistry,ComponentClass=componentRegistry.get(node.type);return ComponentClass||(console.error("Could not resolve a component for type: "+node.type),ComponentClass=UnsupportedNodeComponent),$$(ComponentClass,{doc:doc,node:node})},Surface.prototype._prepareArgs=function(args){},Surface.prototype.getSelectionFromEvent=function(event){if(this.domSelection){var domRange=Surface.getDOMRangeFromEvent(event),sel=this.domSelection.getSelectionForDOMRange(domRange);return sel.surfaceId=this.getId(),sel}},Surface.prototype.setSelectionFromEvent=function(event){var sel=this.getSelectionFromEvent(event);sel?(this._state.skipNextFocusEvent=!0,this.setSelection(sel)):console.error("Could not create a selection from event.")},Surface.prototype.getBoundingRectangleForSelection=function(){var sel=this.getSelection();if(this.isDisabled()||!sel||sel.isNull()||sel.isNodeSelection()||sel.isCustomSelection())return{};var containerEl;containerEl=this.context.scrollPane?this.context.scrollPane.refs.content.el.el:document.body;var wrange,wsel=window.getSelection();if(wsel.rangeCount>0&&(wrange=wsel.getRangeAt(0)),wrange&&wrange.collapsed){var span=document.createElement("span");this._state.skipNextObservation=!0,span.appendChild(window.document.createTextNode("​")),wrange.insertNode(span);var rect=getRelativeBoundingRect(span,containerEl),spanParent=span.parentNode;return this._state.skipNextObservation=!0,spanParent.removeChild(span),spanParent.normalize(),platform.isFF&&this.rerenderDOMSelection(),rect}var nativeEl=this.el.el;if(sel.isCollapsed()){var cursorEl=nativeEl.querySelector(".se-cursor");return cursorEl?getRelativeBoundingRect(cursorEl,containerEl):{}}var selFragments=nativeEl.querySelectorAll(".se-selection-fragment");return selFragments.length>0?getRelativeBoundingRect(selFragments,containerEl):(console.warn("FIXME: there should be a rendered selection fragments element."),{})},Surface.prototype._sendOverlayHints=function(){var selectionRect=this.getBoundingRectangleForSelection();this.send("updateOverlayHints",{rectangle:selectionRect})},Object.defineProperties(Surface.prototype,prototypeAccessors),Surface}(Component);Surface.getDOMRangeFromEvent=function(evt){var range,x=evt.clientX,y=evt.clientY;if(document.body.createTextRange)range=document.body.createTextRange(),range.moveToPoint(x,y);else if(!isUndefined$1(document.createRange))if(isUndefined$1(evt.rangeParent))if(document.caretPositionFromPoint){var pos=document.caretPositionFromPoint(x,y);range=document.createRange(),range.setStart(pos.offsetNode,pos.offset),range.collapse(!0)}else document.caretRangeFromPoint&&(range=document.caretRangeFromPoint(x,y));else range=document.createRange(),range.setStart(evt.rangeParent,evt.rangeOffset),range.collapse(!0);return range};var ContainerEditor=function(Surface$$1){function ContainerEditor(parent,props){if(props.containerId=props.containerId||props.node.id,props.name=props.name||props.containerId||props.node.id,Surface$$1.call(this,parent,props),this.containerId=this.props.containerId,!isString$1(this.containerId))throw new Error("Property 'containerId' is mandatory.");var doc=this.getDocument();if(this.container=doc.get(this.containerId),!this.container)throw new Error("Container with id "+this.containerId+" does not exist.");this.editingBehavior=this.context.editingBehavior||new EditingBehavior,ContainerEditor.prototype._deriveInternalState.call(this,this.props)}Surface$$1&&(ContainerEditor.__proto__=Surface$$1),ContainerEditor.prototype=Object.create(Surface$$1&&Surface$$1.prototype),ContainerEditor.prototype.constructor=ContainerEditor;var prototypeAccessors={_isContainerEditor:{}};return prototypeAccessors._isContainerEditor.get=function(){return!0},ContainerEditor.prototype.shouldRerender=function(newProps){return newProps.disabled!==this.props.disabled},ContainerEditor.prototype.willReceiveProps=function(newProps){Surface$$1.prototype.willReceiveProps.apply(this,arguments),ContainerEditor.prototype._deriveInternalState.call(this,newProps)},ContainerEditor.prototype.didMount=function(){Surface$$1.prototype.didMount.apply(this,arguments),this.container.on("nodes:changed",this.onContainerChange,this)},ContainerEditor.prototype.dispose=function(){Surface$$1.prototype.dispose.apply(this,arguments),this.container.off(this)},ContainerEditor.prototype.render=function($$){var el=Surface$$1.prototype.render.call(this,$$),doc=this.getDocument(),containerId=this.getContainerId(),containerNode=doc.get(containerId);return containerNode||console.warn("No container node found for ",containerId),el.addClass("sc-container-editor container-node "+containerId).attr({spellCheck:!1,"data-id":containerId}),this.isEmpty()?el.append($$("a").attr("href","#").append("Start writing").on("click",this.onCreateText)):containerNode.getNodes().forEach(function(node){el.append(this._renderNode($$,node).ref(node.id))}.bind(this)),this.props.disabled||(el.addClass("sm-enabled"),el.setAttribute("contenteditable",!0)),el},ContainerEditor.prototype._renderNode=function($$,node){if(!node)throw new Error("Illegal argument");if(node.isText())return Surface$$1.prototype.renderNode.call(this,$$,node);var componentRegistry=this.context.componentRegistry,ComponentClass=componentRegistry.get(node.type);return ComponentClass.prototype._isIsolatedNodeComponent?$$(ComponentClass,{node:node}).ref(node.id):$$(IsolatedNodeComponent,{node:node}).ref(node.id)},ContainerEditor.prototype._deriveInternalState=function(props){var _state=this._state;!props.hasOwnProperty("enabled")||props.enabled?_state.enabled=!0:_state.enabled=!1},ContainerEditor.prototype._handleUpOrDownArrowKey=function(event){event.stopPropagation();var direction=event.keyCode===keys$2.UP?"left":"right",selState=this.getDocumentSession().getSelectionState(),sel=selState.getSelection();if(sel.isNodeSelection()&&sel.isFull()&&!event.shiftKey)this.domSelection.collapse(direction);else if(!platform.isIE&&!sel.isCollapsed()&&!event.shiftKey){var doc=this.getDocument();"left"===direction?this.setSelection(doc.createSelection(sel.start.path,sel.start.offset)):this.setSelection(doc.createSelection(sel.end.path,sel.end.offset))}window.setTimeout(function(){this.isMounted()&&this._updateModelSelection({direction:direction})}.bind(this))},ContainerEditor.prototype._handleLeftOrRightArrowKey=function(event){event.stopPropagation();var direction=event.keyCode===keys$2.LEFT?"left":"right",selState=this.getDocumentSession().getSelectionState(),sel=selState.getSelection();return sel.isNodeSelection()&&sel.isFull()&&!event.shiftKey?(event.preventDefault(),void this.setSelection(sel.collapse(direction))):void Surface$$1.prototype._handleLeftOrRightArrowKey.call(this,event)},ContainerEditor.prototype._handleEnterKey=function(event){var sel=this.getDocumentSession().getSelection();sel.isNodeSelection()&&sel.isFull()?(event.preventDefault(),event.stopPropagation()):Surface$$1.prototype._handleEnterKey.apply(this,arguments)},ContainerEditor.prototype.isContainerEditor=function(){return!0},ContainerEditor.prototype.getContainerId=function(){return this.containerId},ContainerEditor.prototype.getContainer=function(){return this.getDocument().get(this.getContainerId())},ContainerEditor.prototype.isEmpty=function(){var containerNode=this.getContainer();return containerNode&&0===containerNode.nodes.length},ContainerEditor.prototype.isEditable=function(){return Surface$$1.prototype.isEditable.call(this)&&!this.isEmpty()},ContainerEditor.prototype.extendBehavior=function(extension){extension.register(this.editingBehavior)},ContainerEditor.prototype.getTextTypes=function(){return this.textTypes||[]},ContainerEditor.prototype.getTextCommands=function(){var textCommands={};return this.commandRegistry.each(function(cmd){cmd.constructor.textTypeName&&(textCommands[cmd.getName()]=cmd)}),textCommands},ContainerEditor.prototype.break=function(tx,args){return breakNode(tx,args)},ContainerEditor.prototype.insertNode=function(tx,args){if(args.selection.isPropertySelection()||args.selection.isContainerSelection())return insertNode(tx,args)},ContainerEditor.prototype.switchType=function(tx,args){if(args.selection.isPropertySelection())return switchTextType(tx,args)},ContainerEditor.prototype.selectAll=function(){var doc=this.getDocument(),container=doc.get(this.getContainerId());if(0!==container.nodes.length){var firstNodeId=container.nodes[0],lastNodeId=last$1(container.nodes),sel=doc.createSelection({type:"container",containerId:container.id,startPath:[firstNodeId],startOffset:0,endPath:[lastNodeId],endOffset:1});this.setSelection(sel)}},ContainerEditor.prototype.selectFirst=function(){var doc=this.getDocument(),nodes=this.getContainer().nodes;if(0===nodes.length)return void console.warn("ContainerEditor.selectFirst(): Container is empty.");var sel,node=doc.get(nodes[0]);sel=node.isText()?doc.createSelection(node.getTextPath(),0):doc.createSelection(this.getContainerId(),[node.id],0,[node.id],1),this.setSelection(sel)},ContainerEditor.prototype.paste=function(tx,args){if(args.selection.isPropertySelection()||args.selection.isContainerSelection())return paste$1$1(tx,args)},ContainerEditor.prototype.onContainerChange=function(change){for(var this$1=this,doc=this.getDocument(),renderContext=RenderingEngine.createContext(this),$$=renderContext.$$,container=this.getContainer(),path=container.getContentPath(),i=0;i<change.ops.length;i++){var op=change.ops[i];if("update"===op.type&&op.path[0]===path[0]){var diff=op.diff;if("insert"===diff.type){var nodeId=diff.getValue(),node=doc.get(nodeId),nodeEl=void 0;nodeEl=node?this$1._renderNode($$,node):$$("div"),this$1.insertAt(diff.getOffset(),nodeEl)}else"delete"===diff.type&&this$1.removeAt(diff.getOffset())}}},ContainerEditor.prototype.onCreateText=function(e){e.preventDefault();var newSel;this.transaction(function(tx){var container=tx.get(this.props.containerId),textType=tx.getSchema().getDefaultTextType(),node=tx.create({id:uuid$1(textType),type:textType,content:""});container.show(node.id),newSel=tx.createSelection({type:"property",path:[node.id,"content"],startOffset:0,endOffset:0})}.bind(this)),this.rerender(),this.setSelection(newSel)},ContainerEditor.prototype.transaction=function(transformation,info){var documentSession=this.documentSession,surfaceId=this.getId(),containerId=this.getContainerId();return documentSession.transaction(function(tx,args){var sel=tx.before.selection;sel&&!sel.isNull()&&(sel.containerId=sel.containerId||containerId),tx.before.surfaceId=surfaceId,args.containerId=this.getContainerId(),args.editingBehavior=this.editingBehavior;var result=transformation(tx,args);if(result)return sel=result.selection,sel&&!sel.isNull()&&(sel.containerId=containerId),result}.bind(this),info)},Object.defineProperties(ContainerEditor.prototype,prototypeAccessors),ContainerEditor}(Surface);ContainerEditor.isContainerEditor=!0;var OverlayTools=function(Component$$1){function OverlayTools(){Component$$1.apply(this,arguments)}return Component$$1&&(OverlayTools.__proto__=Component$$1),OverlayTools.prototype=Object.create(Component$$1&&Component$$1.prototype),OverlayTools.prototype.constructor=OverlayTools,OverlayTools.prototype.render=function($$){var el=$$("div").addClass(this.getClassNames()),activeTools=this.getActiveTools();if(activeTools.length>0){var toolsEl=$$("div").addClass("se-active-tools");activeTools.forEach(function(tool){toolsEl.append($$(tool.Class,tool.toolProps).ref(tool.toolProps.name))}),el.append(toolsEl)}return el},OverlayTools.prototype.getActiveTools=function(){var this$1=this,commandStates=this.props.commandStates,tools=this.context.tools,overlayTools=tools.get("overlay"),activeTools=[];return overlayTools.forEach(function(tool,toolName){var toolProps=Object.assign({},commandStates[toolName],{name:toolName,icon:toolName,style:this$1.getToolStyle(toolName)});toolProps.disabled||activeTools.push({
Class:tool.Class,toolProps:toolProps})}),activeTools},OverlayTools.prototype.isVisible=function(){return this.getActiveTools().length>0},OverlayTools.prototype.getToolStyle=function(){throw new Error("this method is abstract")},OverlayTools.prototype.getClassNames=function(){throw new Error("this method is abstract")},OverlayTools}(Component),ProseEditorOverlayTools=function(OverlayTools$$1){function ProseEditorOverlayTools(){OverlayTools$$1.apply(this,arguments)}return OverlayTools$$1&&(ProseEditorOverlayTools.__proto__=OverlayTools$$1),ProseEditorOverlayTools.prototype=Object.create(OverlayTools$$1&&OverlayTools$$1.prototype),ProseEditorOverlayTools.prototype.constructor=ProseEditorOverlayTools,ProseEditorOverlayTools.prototype.getToolStyle=function(){return"outline-dark"},ProseEditorOverlayTools.prototype.getClassNames=function(){return"sc-prose-editor-overlay-tools"},ProseEditorOverlayTools}(OverlayTools),Toolbar=function(Component$$1){function Toolbar(){Component$$1.apply(this,arguments)}return Component$$1&&(Toolbar.__proto__=Component$$1),Toolbar.prototype=Object.create(Component$$1&&Component$$1.prototype),Toolbar.prototype.constructor=Toolbar,Toolbar.prototype.render=function($$){var el=$$("div").addClass(this.getClassNames()),commandStates=this.props.commandStates,componentRegistry=this.context.componentRegistry,toolTargets=this.context.tools;return toolTargets.forEach(function(tools,target){if("overlay"!==target){var ToolTargetClass=componentRegistry.get("tool-target-"+target);ToolTargetClass||(ToolTargetClass=ToolGroup);var toolTargetEl=$$(ToolTargetClass,{name:target,tools:tools,commandStates:commandStates});el.append(toolTargetEl)}}),el},Toolbar.prototype.getClassNames=function(){return"sc-toolbar"},Toolbar}(Component),ProseEditor=function(AbstractEditor$$1){function ProseEditor(){AbstractEditor$$1.apply(this,arguments)}return AbstractEditor$$1&&(ProseEditor.__proto__=AbstractEditor$$1),ProseEditor.prototype=Object.create(AbstractEditor$$1&&AbstractEditor$$1.prototype),ProseEditor.prototype.constructor=ProseEditor,ProseEditor.prototype.render=function($$){var SplitPane=this.componentRegistry.get("split-pane"),el=$$("div").addClass("sc-prose-editor"),toolbar=this._renderToolbar($$),editor=this._renderEditor($$),ScrollPane=this.componentRegistry.get("scroll-pane"),contentPanel=$$(ScrollPane,{scrollbarPosition:"right",overlay:ProseEditorOverlayTools}).append(editor).ref("contentPanel");return el.append($$(SplitPane,{splitType:"horizontal"}).append(toolbar,contentPanel)),el},ProseEditor.prototype._renderToolbar=function($$){var commandStates=this.commandManager.getCommandStates();return $$(Toolbar,{commandStates:commandStates}).ref("toolbar")},ProseEditor.prototype._renderEditor=function($$){var configurator=this.props.configurator;return $$(ContainerEditor,{disabled:this.props.disabled,documentSession:this.documentSession,node:this.doc.get("body"),commands:configurator.getSurfaceCommandNames(),textTypes:configurator.getTextTypes()}).ref("body")},ProseEditor.prototype.documentSessionUpdated=function(){var toolbar=this.refs.toolbar;if(toolbar){var commandStates=this.commandManager.getCommandStates();toolbar.setProps({commandStates:commandStates})}},ProseEditor}(AbstractEditor),InsertInlineNodeCommand=function(Command$$1){function InsertInlineNodeCommand(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];if(Command$$1.apply(this,args),!this.config.nodeType)throw new Error("Every InlineInlineNodeCommand must have a nodeType")}return Command$$1&&(InsertInlineNodeCommand.__proto__=Command$$1),InsertInlineNodeCommand.prototype=Object.create(Command$$1&&Command$$1.prototype),InsertInlineNodeCommand.prototype.constructor=InsertInlineNodeCommand,InsertInlineNodeCommand.prototype.getCommandState=function(params){var sel=params.selection,newState={disabled:!sel.isPropertySelection(),active:!1};return newState},InsertInlineNodeCommand.prototype.execute=function(params){var state=this.getCommandState(params);if(!state.disabled){var surface=params.surface;return surface&&surface.transaction(function(tx,args){return this.insertInlineNode(tx,args)}.bind(this)),!0}},InsertInlineNodeCommand.prototype.insertInlineNode=function(tx,args){return args.node=this.createNodeData(tx,args),insertInlineNode(tx,args)},InsertInlineNodeCommand.prototype.createNodeData=function(tx,args){return{type:this.config.nodeType}},InsertInlineNodeCommand}(Command),EditInlineNodeCommand=function(Command$$1){function EditInlineNodeCommand(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];if(Command$$1.apply(this,args),!this.config.nodeType)throw new Error("Every AnnotationCommand must have a nodeType")}return Command$$1&&(EditInlineNodeCommand.__proto__=Command$$1),EditInlineNodeCommand.prototype=Object.create(Command$$1&&Command$$1.prototype),EditInlineNodeCommand.prototype.constructor=EditInlineNodeCommand,EditInlineNodeCommand.prototype.getCommandState=function(params){var sel=params.selection,newState={disabled:!0,active:!1},annos=this._getAnnotationsForSelection(params);return 1===annos.length&&annos[0].getSelection().equals(sel)&&(newState.disabled=!1,newState.node=annos[0]),newState},EditInlineNodeCommand.prototype.execute=function(params){},EditInlineNodeCommand.prototype._getAnnotationsForSelection=function(params){return params.selectionState.getAnnotationsForType(this.config.nodeType)},EditInlineNodeCommand}(Command),ResponsiveApplication=function(Component$$1){function ResponsiveApplication(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];Component$$1.apply(this,args),this.pages={},this.handleActions({navigate:this.navigate})}return Component$$1&&(ResponsiveApplication.__proto__=Component$$1),ResponsiveApplication.prototype=Object.create(Component$$1&&Component$$1.prototype),ResponsiveApplication.prototype.constructor=ResponsiveApplication,ResponsiveApplication.prototype.getInitialState=function(){return{route:void 0,mobile:this._isMobile()}},ResponsiveApplication.prototype.didMount=function(){if(inBrowser){var _window=DefaultDOMElement.getBrowserWindow();_window.on("resize",this._onResize,this)}this.router=this.getRouter(),this.router.on("route:changed",this._onRouteChanged,this);var route=this.router.readRoute();this.navigate(route,{replace:!0})},ResponsiveApplication.prototype.dispose=function(){this.router.off(this),this.router.dispose()},ResponsiveApplication.prototype.navigate=function(route,opts){this.extendState({route:route}),this.router.writeRoute(route,opts)},ResponsiveApplication.prototype._onRouteChanged=function(route){this.navigate(route,{replace:!0})},ResponsiveApplication.prototype._isMobile=function(){if(inBrowser)return window.innerWidth<700},ResponsiveApplication.prototype._onResize=function(){this._isMobile()?this.state.mobile||this.extendState({mobile:!0}):this.state.mobile&&this.extendState({mobile:!1})},ResponsiveApplication.prototype._getPage=function(){return this.state.route.page||this.getDefaultPage()},ResponsiveApplication.prototype._getPageClass=function(){var page=this._getPage();return this.pages[page]},ResponsiveApplication.prototype._getPageProps=function(){var props=cloneDeep$1(this.state.route);return delete props.page,props.mobile=this.state.mobile,props},ResponsiveApplication.prototype.addPage=function(pageName,PageClass){this.pages[pageName]=PageClass},ResponsiveApplication.prototype.renderPage=function($$){var PageClass=this._getPageClass(),pageName=this._getPage();return $$(PageClass,this._getPageProps()).ref(pageName)},ResponsiveApplication.prototype.render=function($$){var el=$$("div").addClass("sc-responsive-application");return void 0===this.state.route?el:(el.append(this.renderPage($$)),el)},ResponsiveApplication}(Component),FontAwesomeIcon=function(Component$$1){function FontAwesomeIcon(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];Component$$1.apply(this,args)}return Component$$1&&(FontAwesomeIcon.__proto__=Component$$1),FontAwesomeIcon.prototype=Object.create(Component$$1&&Component$$1.prototype),FontAwesomeIcon.prototype.constructor=FontAwesomeIcon,FontAwesomeIcon.prototype.render=function($$){return $$("i").addClass("fa "+this.props.icon)},FontAwesomeIcon}(Component),TOC=function(Component$$1){function TOC(){Component$$1.apply(this,arguments)}return Component$$1&&(TOC.__proto__=Component$$1),TOC.prototype=Object.create(Component$$1&&Component$$1.prototype),TOC.prototype.constructor=TOC,TOC.prototype.didMount=function(){var tocProvider=this.context.tocProvider;tocProvider.on("toc:updated",this.onTOCUpdated,this)},TOC.prototype.dispose=function(){var tocProvider=this.context.tocProvider;tocProvider.off(this)},TOC.prototype.render=function($$){for(var this$1=this,tocProvider=this.context.tocProvider,activeEntry=tocProvider.activeEntry,ScrollPane=this.getComponent("scroll-pane"),tocEntries=$$("div").addClass("se-toc-entries").ref("tocEntries"),entries=tocProvider.getEntries(),i=0;i<entries.length;i++){var entry=entries[i],level=entry.level,tocEntryEl=$$("a").addClass("se-toc-entry").addClass("sm-level-"+level).attr({href:"#","data-id":entry.id}).ref(entry.id).on("click",this$1.handleClick).append($$(FontAwesomeIcon,{icon:"fa-caret-right"}),entry.name);activeEntry===entry.id&&tocEntryEl.addClass("sm-active"),tocEntries.append(tocEntryEl)}var el=$$("div").addClass("sc-toc").append($$(ScrollPane).ref("panelEl").append(tocEntries));return el},TOC.prototype.getDocument=function(){return this.context.doc},TOC.prototype.onTOCUpdated=function(){this.rerender()},TOC.prototype.handleClick=function(e){var nodeId=e.currentTarget.dataset.id;e.preventDefault(),this.send("tocEntrySelected",nodeId)},TOC}(Component),_baseValues=createCommonjsModule(function(module){function baseValues(object,props){return arrayMap(props,function(key){return object[key]})}var arrayMap=interopDefault(require$$0$36);module.exports=baseValues}),_baseValues$1=interopDefault(_baseValues),require$$1$36=Object.freeze({default:_baseValues$1}),values=createCommonjsModule(function(module){function values(object){return object?baseValues(object,keys(object)):[]}var baseValues=interopDefault(require$$1$36),keys=interopDefault(require$$0$3);module.exports=values}),values$1=interopDefault(values),require$$0$60=Object.freeze({default:values$1}),includes=createCommonjsModule(function(module){function includes(collection,value,fromIndex,guard){collection=isArrayLike(collection)?collection:values(collection),fromIndex=fromIndex&&!guard?toInteger(fromIndex):0;var length=collection.length;return fromIndex<0&&(fromIndex=nativeMax(length+fromIndex,0)),isString(collection)?fromIndex<=length&&collection.indexOf(value,fromIndex)>-1:!!length&&baseIndexOf(collection,value,fromIndex)>-1}var baseIndexOf=interopDefault(require$$4$13),isArrayLike=interopDefault(require$$3),isString=interopDefault(require$$2$5),toInteger=interopDefault(require$$1$25),values=interopDefault(require$$0$60),nativeMax=Math.max;module.exports=includes}),includes$1=interopDefault(includes),TOCProvider=function(EventEmitter$$1){function TOCProvider(document,config){EventEmitter$$1.call(this,document,config),this.document=document,this.config=config,this.entries=this.computeEntries(),this.entries.length>0?this.activeEntry=this.entries[0].id:this.activeEntry=null,this.document.on("document:changed",this.handleDocumentChange,this)}return EventEmitter$$1&&(TOCProvider.__proto__=EventEmitter$$1),TOCProvider.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),TOCProvider.prototype.constructor=TOCProvider,TOCProvider.prototype.dispose=function(){var doc=this.getDocument();doc.disconnect(this)},TOCProvider.prototype.handleDocumentChange=function(change){for(var doc=this.getDocument(),needsUpdate=!1,tocTypes=this.constructor.tocTypes,i=0;i<change.ops.length;i++){var op=change.ops[i],nodeType=void 0;if(op.isCreate()||op.isDelete()){var nodeData=op.getValue();if(nodeType=nodeData.type,includes$1(tocTypes,nodeType)){needsUpdate=!0;break}}else{var id=op.path[0],node=doc.get(id);if(node&&includes$1(tocTypes,node.type)){needsUpdate=!0;break}}}needsUpdate&&(this.entries=this.computeEntries(),this.emit("toc:updated"))},TOCProvider.prototype.computeEntries=function(){var doc=this.getDocument(),config=this.config,entries=[],contentNodes=doc.get(config.containerId).nodes;return each$2(contentNodes,function(nodeId){var node=doc.get(nodeId);"heading"===node.type&&entries.push({id:node.id,name:node.content,level:node.level,node:node})}),entries},TOCProvider.prototype.getEntries=function(){return this.entries},TOCProvider.prototype.getDocument=function(){return this.document},TOCProvider.prototype.markActiveEntry=function(scrollPane){var panelContent=scrollPane.getContentElement(),contentHeight=scrollPane.getContentHeight(),scrollPaneHeight=scrollPane.getHeight(),scrollPos=scrollPane.getScrollPosition(),scrollBottom=scrollPos+scrollPaneHeight,regularScanline=scrollPos,smartScanline=2*scrollBottom-contentHeight,scanline=Math.max(regularScanline,smartScanline),tocNodes=this.computeEntries();if(0!==tocNodes.length){for(var activeEntry=tocNodes[0].id,i=tocNodes.length-1;i>=0;i--){var tocNode=tocNodes[i],nodeEl=panelContent.find('[data-id="'+tocNode.id+'"]');if(!nodeEl)return void console.warn("Not found in Content panel",tocNode.id);var panelOffset=scrollPane.getPanelOffsetForElement(nodeEl);if(scanline>=panelOffset){activeEntry=tocNode.id;break}}this.activeEntry!==activeEntry&&(this.activeEntry=activeEntry,this.emit("toc:updated"))}},TOCProvider}(EventEmitter);TOCProvider.tocTypes=["heading"];var ToolDropdown=function(Component$$1){function ToolDropdown(){Component$$1.apply(this,arguments)}return Component$$1&&(ToolDropdown.__proto__=Component$$1),ToolDropdown.prototype=Object.create(Component$$1&&Component$$1.prototype),ToolDropdown.prototype.constructor=ToolDropdown,ToolDropdown.prototype.render=function($$){var tools=this.props.tools,commandStates=this.props.commandStates,el=$$("div").addClass("sc-tool-dropdown");if(el.addClass("sm-target-"+this.props.name),el.append(this.renderButton($$)),this.state.open){var optionEls=[];tools.forEach(function(tool,name){var toolProps=Object.assign({},commandStates[name]);toolProps.name=name,toolProps.label=name,toolProps.style="plain-dark",optionEls.push($$(tool.Class,toolProps))}),el.append($$("div").addClass("se-options").append($$("div").addClass("se-arrow"),$$("div").addClass("se-content").append(optionEls)))}return el},ToolDropdown.prototype.renderButton=function($$){var btn=$$(Button,{label:this.props.name,active:this.state.open,disabled:this.props.disabled,style:this.props.style}).on("click",this.onClick);return btn},ToolDropdown.prototype.onClick=function(){var open=!this.state.open;this.setState({open:open})},ToolDropdown}(Component),BlockNodeComponent=function(NodeComponent$$1){function BlockNodeComponent(){NodeComponent$$1.apply(this,arguments)}return NodeComponent$$1&&(BlockNodeComponent.__proto__=NodeComponent$$1),BlockNodeComponent.prototype=Object.create(NodeComponent$$1&&NodeComponent$$1.prototype),BlockNodeComponent.prototype.constructor=BlockNodeComponent,BlockNodeComponent}(NodeComponent),InsertNodeCommand=function(Command$$1){function InsertNodeCommand(){Command$$1.apply(this,arguments)}return Command$$1&&(InsertNodeCommand.__proto__=Command$$1),InsertNodeCommand.prototype=Object.create(Command$$1&&Command$$1.prototype),InsertNodeCommand.prototype.constructor=InsertNodeCommand,InsertNodeCommand.prototype.getCommandState=function(params){var sel=params.selection,newState={disabled:!0,active:!1};return sel&&!sel.isNull()&&sel.isPropertySelection()&&(newState.disabled=!1),newState},InsertNodeCommand.prototype.execute=function(params){var state=params.commandState;if(!state.disabled){var surface=params.surface;return surface&&surface.transaction(function(tx,args){return this.insertNode(tx,args)}.bind(this)),!0}},InsertNodeCommand.prototype.insertNode=function(tx,args){return args.node=this.createNodeData(tx,args),insertNode(tx,args)},InsertNodeCommand.prototype.createNodeData=function(tx,args){throw new Error("InsertNodeCommand.createNodeData() is abstract.")},InsertNodeCommand}(Command),Highlights=function(EventEmitter$$1){function Highlights(doc){EventEmitter$$1.call(this),this.doc=doc,this._highlights={}}return EventEmitter$$1&&(Highlights.__proto__=EventEmitter$$1),Highlights.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),Highlights.prototype.constructor=Highlights,Highlights.prototype.get=function(){return this._highlights},Highlights.prototype.set=function(highlights){var oldHighlights=this._highlights,doc=this.doc;forEach$2(highlights,function(newScopedHighlights,scope){var oldScopedHighlights=oldHighlights[scope]||[],toBeDeleted=without$1(oldScopedHighlights,newScopedHighlights),toBeAdded=without$1(newScopedHighlights,oldScopedHighlights);forEach$2(toBeDeleted,function(nodeId){var node=doc.get(nodeId);node&&node.setHighlighted(!1,scope)}),forEach$2(toBeAdded,function(nodeId){var node=doc.get(nodeId);node&&node.setHighlighted(!0,scope)})}),this._highlights=highlights,this.emit("highlights:updated",highlights)},Highlights}(EventEmitter),Router=function(EventEmitter$$1){function Router(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];EventEmitter$$1.apply(this,args),this.__isStarted__=!1}return EventEmitter$$1&&(Router.__proto__=EventEmitter$$1),Router.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),Router.prototype.constructor=Router,Router.prototype.start=function(){var window=DefaultDOMElement.getBrowserWindow();window.on("hashchange",this._onHashChange,this),this.__isStarted__=!0},Router.prototype.readRoute=function(){return this.__isStarted__||this.start(),this.parseRoute(this.getRouteString())},Router.prototype.writeRoute=function(route,opts){opts=opts||{};var routeString=this.stringifyRoute(route);routeString?this._writeRoute(routeString,opts):this.clearRoute(opts)},Router.prototype.dispose=function(){var window=DefaultDOMElement.getBrowserWindow();window.off(this)},Router.prototype.parseRoute=function(routeString){return Router.routeStringToObject(routeString)},Router.prototype.stringifyRoute=function(route){return Router.objectToRouteString(route)},Router.prototype.getRouteString=function(){return window.location.hash.slice(1)},Router.prototype._writeRoute=function(route,opts){this.__isSaving__=!0;try{opts.replace?window.history.replaceState({},"","#"+route):window.history.pushState({},"","#"+route)}finally{this.__isSaving__=!1}},Router.prototype.clearRoute=function(opts){this._writeRoute("",opts)},Router.prototype._onHashChange=function(){if(!this.__isSaving__){if(this.__isLoading__)return void console.error("FIXME: router is currently applying a route.");this.__isLoading__=!0;try{var routeString=this.getRouteString(),route=this.parseRoute(routeString);this.emit("route:changed",route)}finally{this.__isLoading__=!1}}},Router}(EventEmitter);Router.objectToRouteString=function(obj){var route=[];return each$2(obj,function(val,key){route.push(key+"="+val)}),route.join(",")},Router.routeStringToObject=function(routeStr){var obj={};if(!routeStr)return obj;var params=routeStr.split(",");return params.forEach(function(param){var tuple=param.split("=");if(2!==tuple.length)throw new Error("Illegal route.");obj[tuple[0].trim()]=tuple[1].trim()}),obj};var TextPropertyEditor=function(Surface$$1){function TextPropertyEditor(parent,props){if(props.name=props.name||props.path.join("."),Surface$$1.call(this,parent,props),!props.path)throw new Error("Property 'path' is mandatory.")}return Surface$$1&&(TextPropertyEditor.__proto__=Surface$$1),TextPropertyEditor.prototype=Object.create(Surface$$1&&Surface$$1.prototype),TextPropertyEditor.prototype.constructor=TextPropertyEditor,TextPropertyEditor.prototype.render=function($$){var el=Surface$$1.prototype.render.apply(this,arguments);return el.addClass("sc-text-property-editor"),this.props.disabled||(el.addClass("sm-enabled"),el.setAttribute("contenteditable",!0)),el.append($$(TextPropertyComponent,{tagName:this.props.tagName||"div",path:this.props.path,withoutBreak:this.props.withoutBreak})),el},TextPropertyEditor.prototype.selectAll=function(){var doc=this.getDocument(),path=this.props.path,text=doc.get(path),sel=doc.createSelection({type:"property",path:path,startOffset:0,endOffset:text.length});this.setSelection(sel)},TextPropertyEditor}(Surface),NodeRegistry=function(Registry$$1){function NodeRegistry(){Registry$$1.apply(this,arguments)}return Registry$$1&&(NodeRegistry.__proto__=Registry$$1),NodeRegistry.prototype=Object.create(Registry$$1&&Registry$$1.prototype),NodeRegistry.prototype.constructor=NodeRegistry,NodeRegistry.prototype.register=function(nodeClazz){var type=nodeClazz.prototype.type;if("string"!=typeof type||""===type)throw console.error("#### nodeClazz",nodeClazz),new Error("Node names must be strings and must not be empty");if(!nodeClazz.prototype._isNode)throw new Error("Nodes must be subclasses of Substance.Data.Node");if(this.contains(type))throw new Error("Node class is already registered: "+type);this.add(type,nodeClazz)},NodeRegistry}(Registry),Schema$1=function(name,version){this.name=name,this.version=version,this.nodeRegistry=new NodeRegistry,this.tocTypes=[],this.addNodes(this.getBuiltIns())};Schema$1.prototype.addNodes=function(nodes){nodes&&each$2(nodes,function(NodeClass){NodeClass.prototype._isNode?this.addNode(NodeClass):console.error("Illegal node class: ",NodeClass)}.bind(this))},Schema$1.prototype.addNode=function(NodeClass){this.nodeRegistry.register(NodeClass),NodeClass.tocType&&this.tocTypes.push(NodeClass.type)},Schema$1.prototype.getNodeClass=function(name){return this.nodeRegistry.get(name)},Schema$1.prototype.getBuiltIns=function(){return[]},Schema$1.prototype.isInstanceOf=function(type,parentType){var NodeClass=this.getNodeClass(type);return!!NodeClass&&Node.isInstanceOf(NodeClass,parentType)},Schema$1.prototype.each=function(){this.nodeRegistry.each.apply(this.nodeRegistry,arguments)},Schema$1.prototype.getTocTypes=function(){return this.tocTypes},Schema$1.prototype.getDefaultTextType=function(){throw new Error("Schmema.prototype.getDefaultTextType() must be overridden.")},Schema$1.prototype.getNodeSchema=function(type){var NodeClass=this.getNodeClass(type);return NodeClass?NodeClass.schema:(console.error("Unknown node type ",type),null)};var DocumentSchema$1=function(Schema){function DocumentSchema(){Schema.apply(this,arguments)}return Schema&&(DocumentSchema.__proto__=Schema),DocumentSchema.prototype=Object.create(Schema&&Schema.prototype),DocumentSchema.prototype.constructor=DocumentSchema,DocumentSchema.prototype.getDefaultTextType=function(){throw new Error("DocumentSchema.getDefaultTextType() is abstract and must be overridden.")},DocumentSchema.prototype.isAnnotationType=function(type){var nodeClass=this.getNodeClass(type);return nodeClass&&nodeClass.prototype._isPropertyAnnotation},DocumentSchema.prototype.getBuiltIns=function(){return[DocumentNode,PropertyAnnotation,Container,ContainerAnnotation]},DocumentSchema}(Schema$1),ComponentRegistry=function(Registry$$1){function ComponentRegistry(entries){Registry$$1.call(this,entries,function(ComponentClass){if(!ComponentClass.prototype._isComponent)throw new Error("Component registry: wrong type. Expected a ComponentClass. Was: "+String(ComponentClass))})}return Registry$$1&&(ComponentRegistry.__proto__=Registry$$1),ComponentRegistry.prototype=Object.create(Registry$$1&&Registry$$1.prototype),ComponentRegistry.prototype.constructor=ComponentRegistry,ComponentRegistry}(Registry),FontAwesomeIconProvider=function(icons){this.map={},forEach$2(icons,function(config,name){var faClass=config.fontawesome;faClass&&this.addIcon(name,faClass)}.bind(this))};FontAwesomeIconProvider.prototype.renderIcon=function($$,name){var iconClass=this.map[name];if(iconClass)return $$(FontAwesomeIcon,{icon:iconClass})},FontAwesomeIconProvider.prototype.addIcon=function(name,faClass){this.map[name]=faClass};var DefaultLabelProvider=function(labels,lang){this.lang=lang||"en",this.labels=labels};DefaultLabelProvider.prototype.getLabel=function(name){var labels=this.labels[this.lang];return labels?labels[name]||name:name};var Configurator=function(){this.config={schema:{},nodes:{},components:{},converters:{},importers:{},exporters:{},commands:{},tools:new Map,textTypes:[],editingBehaviors:[],macros:[],dndHandlers:[],icons:{},labels:{}}};Configurator.prototype.defineSchema=function(schema){this.config.schema=schema},Configurator.prototype.addNode=function(NodeClass){var type=NodeClass.type;if(!type)throw new Error("A NodeClass must have a type.");if(this.config.nodes[type])throw new Error("NodeClass with this type name is already registered: "+name);this.config.nodes[type]=NodeClass},Configurator.prototype.addConverter=function(type,converter){var converters=this.config.converters[type];if(converters||(converters={},this.config.converters[type]=converters),!converter.type)throw new Error("A converter needs an associated type.");converters[converter.type]=converter},Configurator.prototype.addImporter=function(type,ImporterClass){this.config.importers[type]=ImporterClass},Configurator.prototype.addExporter=function(type,ExporterClass){this.config.exporters[type]=ExporterClass},Configurator.prototype.addComponent=function(name,ComponentClass){if(this.config.components[name])throw new Error(name+" already registered");if(!ComponentClass)throw new Error("Provided nil for component "+name);if(!ComponentClass.prototype._isComponent)throw new Error("ComponentClass must be a subclass of ui/Component.");this.config.components[name]=ComponentClass},Configurator.prototype.addCommand=function(name,CommandClass,options){if(!isString$1(name))throw new Error("Expecting 'name' to be a String");if(!CommandClass)throw new Error("Provided nil for command "+name);if(!CommandClass.prototype._isCommand)throw new Error("Expecting 'CommandClass' to be of type ui/Command.");this.config.commands[name]={name:name,CommandClass:CommandClass,options:options||{}}},Configurator.prototype.addTool=function(name,ToolClass,options){if(options=options||{},!isString$1(name))throw new Error("Expecting 'name' to be a String");if(!ToolClass)throw new Error("Provided nil for tool "+name);if(!ToolClass||!ToolClass.prototype._isTool)throw new Error("Expecting 'ToolClass' to be of type ui/Tool. name:");var toolTarget=options.target;!toolTarget&&options.overlay?toolTarget="overlay":toolTarget||(toolTarget="default"),this.config.tools.has(toolTarget)||this.config.tools.set(toolTarget,new Map),this.config.tools.get(toolTarget).set(name,{name:name,Class:ToolClass,options:options||{}})},Configurator.prototype.addIcon=function(iconName,options){var iconConfig=this.config.icons[iconName];iconConfig||(iconConfig={},this.config.icons[iconName]=iconConfig),Object.assign(iconConfig,options)},Configurator.prototype.addLabel=function(labelName,label){isString$1(label)?(this.config.labels.en||(this.config.labels.en={}),this.config.labels.en[labelName]=label):forEach$2(label,function(label,lang){this.config.labels[lang]||(this.config.labels[lang]={}),this.config.labels[lang][labelName]=label}.bind(this))},Configurator.prototype.addSeed=function(seed){this.config.seed=seed},Configurator.prototype.addTextType=function(textType,options){this.config.textTypes.push({spec:textType,options:options||{}})},Configurator.prototype.addEditingBehavior=function(editingBehavior){this.config.editingBehaviors.push(editingBehavior)},Configurator.prototype.addMacro=function(macro){this.config.macros.push(macro)},Configurator.prototype.addDragAndDrop=function(DragAndDropHandlerClass){if(!DragAndDropHandlerClass.prototype._isDragAndDropHandler)throw new Error("Only instances of DragAndDropHandler are allowed.");this.config.dndHandlers.push(DragAndDropHandlerClass)},Configurator.prototype.import=function(pkg,options){return pkg.configure(this,options||{}),this},Configurator.prototype.getConfig=function(){return this.config},Configurator.prototype.getStyles=function(){return this.config.styles},Configurator.prototype.getSchema=function(){var schemaConfig=this.config.schema,schema=new DocumentSchema$1(schemaConfig.name,"1.0.0");return schema.getDefaultTextType=function(){return schemaConfig.defaultTextType},schema.addNodes(this.config.nodes),schema},Configurator.prototype.createArticle=function(seed){var schemaConfig=this.config.schema,schema=this.getSchema(),doc=new schemaConfig.ArticleClass(schema);return seed&&seed(doc),doc},Configurator.prototype.createImporter=function(type){var ImporterClass=this.config.importers[type],config={schema:this.getSchema(),converters:this.getConverterRegistry().get(type),DocumentClass:this.config.schema.ArticleClass};return new ImporterClass(config)},Configurator.prototype.createExporter=function(type){var ExporterClass=this.config.exporters[type],config={schema:this.getSchema(),converters:this.getConverterRegistry().get(type)};return new ExporterClass(config)},Configurator.prototype.getTools=function(){return this.config.tools},Configurator.prototype.getComponentRegistry=function(){var componentRegistry=new ComponentRegistry;return forEach$2(this.config.components,function(ComponentClass,name){componentRegistry.add(name,ComponentClass)}),componentRegistry},Configurator.prototype.getCommands=function(){return map$2(this.config.commands,function(item,name){return new item.CommandClass(Object.assign({name:name},item.options))})},Configurator.prototype.getSurfaceCommandNames=function(){var commands=this.getCommands(),commandNames=commands.map(function(C){return C.type});return commandNames},Configurator.prototype.getConverterRegistry=function(){if(!this.converterRegistry){var converterRegistry=new Registry;forEach$2(this.config.converters,function(converters,name){converterRegistry.add(name,new Registry(converters))}),this.converterRegistry=converterRegistry}return this.converterRegistry},Configurator.prototype.getSeed=function(){return this.config.seed},Configurator.prototype.getTextTypes=function(){return this.config.textTypes.map(function(t){return t.spec})},Configurator.prototype.getIconProvider=function(){return new FontAwesomeIconProvider(this.config.icons)},Configurator.prototype.getLabelProvider=function(){return new DefaultLabelProvider(this.config.labels)},Configurator.prototype.getEditingBehavior=function(){var editingBehavior=new EditingBehavior;return this.config.editingBehaviors.forEach(function(behavior){behavior.register(editingBehavior)}),editingBehavior},Configurator.prototype.getMacros=function(){return this.config.macros},Configurator.prototype.createDragHandlers=function(){return this.config.dndHandlers.map(function(DragAndDropHandlerClass){return new DragAndDropHandlerClass})};var Factory=function(Registry$$1){function Factory(){Registry$$1.apply(this,arguments)}return Registry$$1&&(Factory.__proto__=Registry$$1),Factory.prototype=Object.create(Registry$$1&&Registry$$1.prototype),Factory.prototype.constructor=Factory,Factory.prototype.create=function(name){var clazz=this.get(name);if(!clazz)throw new Error("No class registered by that name: "+name);var args=Array.prototype.slice.call(arguments,1),obj=Object.create(clazz.prototype);return clazz.apply(obj,args),obj},Factory}(Registry),twoParagraphs=function(tx){var body=tx.get("body");tx.create({id:"p1",type:"paragraph",content:"0123456789"}),body.show("p1"),tx.create({id:"p2",type:"paragraph",content:"0123456789"}),body.show("p2")},MessageQueue=function(EventEmitter$$1){function MessageQueue(){EventEmitter$$1.call(this),this.connections={},this.messages=[],this._log=[]}return EventEmitter$$1&&(MessageQueue.__proto__=EventEmitter$$1),MessageQueue.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),MessageQueue.prototype.constructor=MessageQueue,MessageQueue.prototype.start=function(){this._interval=setInterval(this._processMessage.bind(this),100)},MessageQueue.prototype.stop=function(){clearInterval(this._interval);
},MessageQueue.prototype.flush=function(){for(var this$1=this;this.messages.length;)this$1._processMessage()},MessageQueue.prototype.clear=function(){this.messages=[]},MessageQueue.prototype.tick=function(){this._processMessage()},MessageQueue.prototype.connectServer=function(server){if(this.connections[server.serverId])throw new Error("Server already registered:"+server.serverId);this.connections[server.serverId]={type:"server",serverId:server.serverId,server:server,sockets:{}}},MessageQueue.prototype.connectClientSocket=function(ws){var serverId=ws.serverId,clientId=ws.clientId,conn=this.connections[serverId];if(!conn||"server"!==conn.type)throw new Error("Can not connect to server. Unknown server id.");this.connections[ws.clientId]={type:"client",socket:ws},conn.server.handleConnectionRequest(clientId)},MessageQueue.prototype.disconnectClientSocket=function(ws){var serverId=ws.serverId,clientId=ws.clientId,conn=this.connections[serverId];if(!conn||"server"!==conn.type)throw new Error("Unknown server id.");conn.server.handleDisconnectRequest(clientId),delete this.connections[ws.clientId]},MessageQueue.prototype.connectServerSocket=function(ws){var server=this.connections[ws.serverId];if(!server)throw new Error("Server is not connected:"+ws.serverId);server.sockets[ws.clientId]=ws},MessageQueue.prototype.disconnectServerSocket=function(ws){var server=this.connections[ws.serverId];if(!server)throw new Error("Server is not connected:"+ws.serverId);delete server.sockets[ws.clientId]},MessageQueue.prototype.pushMessage=function(message){this.messages.push(message),this._log.push(message),this.emit("messages:updated",this.messages)},MessageQueue.prototype._processMessage=function(){var message=this.messages.shift();if(message){this.emit("messages:updated",this.messages);var socket,from=message.from,to=message.to,recipient=this.connections[to];socket="server"===recipient.type?recipient.sockets[from]:recipient.socket,socket?socket._onMessage(message.data):console.error("Could not deliver message:",message),this.emit("message:sent",message)}},MessageQueue}(EventEmitter),__id__$6=0,TestServerWebSocket=function(EventEmitter$$1){function TestServerWebSocket(messageQueue,serverId,clientId){EventEmitter$$1.call(this),this.__id__=__id__$6++,this.messageQueue=messageQueue,this.serverId=serverId,this.clientId=clientId,this._isSimulated=!0,this.readyState=1}return EventEmitter$$1&&(TestServerWebSocket.__proto__=EventEmitter$$1),TestServerWebSocket.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),TestServerWebSocket.prototype.constructor=TestServerWebSocket,TestServerWebSocket.prototype.connect=function(){this.messageQueue.connectServerSocket(this)},TestServerWebSocket.prototype._onMessage=function(data){this.emit("message",data)},TestServerWebSocket.prototype.send=function(data){var msg={from:this.serverId,to:this.clientId};data&&(msg.data=data),this.messageQueue.pushMessage(msg)},TestServerWebSocket}(EventEmitter),TestWebSocketServer=function(EventEmitter$$1){function TestWebSocketServer(config){EventEmitter$$1.call(this),this.messageQueue=config.messageQueue,this.serverId=config.serverId||"server",this.clients={},this._isSimulated=!0,config.manualConnect||this.connect()}return EventEmitter$$1&&(TestWebSocketServer.__proto__=EventEmitter$$1),TestWebSocketServer.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),TestWebSocketServer.prototype.constructor=TestWebSocketServer,TestWebSocketServer.prototype.connect=function(){this.messageQueue.connectServer(this)},TestWebSocketServer.prototype.handleConnectionRequest=function(clientId){var sws=new TestServerWebSocket(this.messageQueue,this.serverId,clientId);this.messageQueue.connectServerSocket(sws),this.clients[clientId]=sws,this.emit("connection",sws)},TestWebSocketServer.prototype.handleDisconnectRequest=function(clientId){var sws=this.clients[clientId];this.messageQueue.disconnectServerSocket(sws),sws.emit("close",sws),delete this.clients[clientId]},TestWebSocketServer}(EventEmitter),__id__$7=0,TestWebSocket=function(EventEmitter$$1){function TestWebSocket(config){EventEmitter$$1.call(this),this.__id__=__id__$7++,this.messageQueue=config.messageQueue,this.clientId=config.clientId||uuid$1(),this.serverId=config.serverId||"server",this.readyState=3,this._isSimulated=!0}return EventEmitter$$1&&(TestWebSocket.__proto__=EventEmitter$$1),TestWebSocket.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype),TestWebSocket.prototype.constructor=TestWebSocket,TestWebSocket.prototype.connect=function(){this.messageQueue.connectClientSocket(this),this.readyState=1,this.triggerOpen()},TestWebSocket.prototype.disconnect=function(){this.messageQueue.disconnectClientSocket(this),this.readyState=3,this.triggerClose()},TestWebSocket.prototype.addEventListener=function(eventName,handler){this["on"+eventName]&&console.warn("on"+eventName," is already set. Overriding handler."),this["on"+eventName]=handler},TestWebSocket.prototype.triggerOpen=function(){this.onopen&&this.onopen()},TestWebSocket.prototype.triggerClose=function(){this.onclose&&this.onclose()},TestWebSocket.prototype.removeEventListener=function(eventName){delete this["on"+eventName]},TestWebSocket.prototype._onMessage=function(data){this.onmessage({data:data})},TestWebSocket.prototype.send=function(data){var msg={from:this.clientId,to:this.serverId};data&&(msg.data=data),this.messageQueue.pushMessage(msg)},TestWebSocket}(EventEmitter),TestWebSocketConnection=function(ClientConnection$$1){function TestWebSocketConnection(){ClientConnection$$1.apply(this,arguments)}return ClientConnection$$1&&(TestWebSocketConnection.__proto__=ClientConnection$$1),TestWebSocketConnection.prototype=Object.create(ClientConnection$$1&&ClientConnection$$1.prototype),TestWebSocketConnection.prototype.constructor=TestWebSocketConnection,TestWebSocketConnection.prototype._createWebSocket=function(){var ws=new TestWebSocket(this.config);return ws},TestWebSocketConnection.prototype.connect=function(){this._connect()},TestWebSocketConnection.prototype.disconnect=function(){this._disconnect()},TestWebSocketConnection.prototype._connect=function(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];(ref=ClientConnection$$1.prototype)._connect.apply(this,args),this.ws.connect();var ref},TestWebSocketConnection.prototype._disconnect=function(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];this.ws.disconnect()(ref=ClientConnection$$1.prototype)._disconnect.apply(this,args);var ref},TestWebSocketConnection.prototype._onConnectionClose=function(){this.emit("close")},TestWebSocketConnection.prototype.serializeMessage=function(msg){return msg},TestWebSocketConnection.prototype.deserializeMessage=function(msg){return msg},TestWebSocketConnection}(ClientConnection),TestCollabServer=function(CollabServer$$1){function TestCollabServer(){CollabServer$$1.apply(this,arguments)}return CollabServer$$1&&(TestCollabServer.__proto__=CollabServer$$1),TestCollabServer.prototype=Object.create(CollabServer$$1&&CollabServer$$1.prototype),TestCollabServer.prototype.constructor=TestCollabServer,TestCollabServer.prototype.serializeMessage=function(msg){return msg},TestCollabServer.prototype.deserializeMessage=function(msg){return msg},TestCollabServer}(CollabServer),TestCollabSession=function(CollabSession$$1){function TestCollabSession(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];CollabSession$$1.apply(this,args),this._incomingMessages=[],this._outgoingMessages=[]}return CollabSession$$1&&(TestCollabSession.__proto__=CollabSession$$1),TestCollabSession.prototype=Object.create(CollabSession$$1&&CollabSession$$1.prototype),TestCollabSession.prototype.constructor=TestCollabSession,TestCollabSession.prototype._onMessage=function(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];this.config.logging&&this._incomingMessages.push(args[0]),(ref=CollabSession$$1.prototype)._onMessage.apply(this,args);var ref},TestCollabSession.prototype._onSend=function(){for(var args=[],len=arguments.length;len--;)args[len]=arguments[len];this.config.logging&&(this._outgoingMessages=[],this._outgoingMessages.push(args[0])),(ref=CollabSession$$1.prototype)._onSend.apply(this,args);var ref},TestCollabSession.prototype.dumpIncomingMessages=function(){return JSON.stringify(this._incomingMessages,null,"  ")},TestCollabSession.prototype.dumpOutgoingMessages=function(){return JSON.stringify(this._outgoingMessages,null,"  ")},TestCollabSession.prototype.serializeMessage=function(msg){return msg},TestCollabSession.prototype.deserializeMessage=function(msg){return msg},TestCollabSession.prototype.serializeChange=function(change){return change.toJSON()},TestCollabSession.prototype.deserializeChange=function(serializedChange){return DocumentChange.fromJSON(serializedChange)},TestCollabSession}(CollabSession),TestMetaNode=function(DocumentNode$$1){function TestMetaNode(){DocumentNode$$1.apply(this,arguments)}return DocumentNode$$1&&(TestMetaNode.__proto__=DocumentNode$$1),TestMetaNode.prototype=Object.create(DocumentNode$$1&&DocumentNode$$1.prototype),TestMetaNode.prototype.constructor=TestMetaNode,TestMetaNode}(DocumentNode);TestMetaNode.define({type:"meta",title:"text"});var TestNode=function(DocumentNode$$1){function TestNode(){DocumentNode$$1.apply(this,arguments)}return DocumentNode$$1&&(TestNode.__proto__=DocumentNode$$1),TestNode.prototype=Object.create(DocumentNode$$1&&DocumentNode$$1.prototype),TestNode.prototype.constructor=TestNode,TestNode}(DocumentNode);TestNode.define({type:"test-node",boolVal:{type:"boolean",default:!1},stringVal:{type:"string",default:""},arrayVal:{type:["array","string"],default:[]},objectVal:{type:"object",default:{}}}),TestNode.isBlock=!0;var TestContainerAnnotation=function(ContainerAnnotation$$1){function TestContainerAnnotation(){ContainerAnnotation$$1.apply(this,arguments)}return ContainerAnnotation$$1&&(TestContainerAnnotation.__proto__=ContainerAnnotation$$1),TestContainerAnnotation.prototype=Object.create(ContainerAnnotation$$1&&ContainerAnnotation$$1.prototype),TestContainerAnnotation.prototype.constructor=TestContainerAnnotation,TestContainerAnnotation}(ContainerAnnotation);TestContainerAnnotation.type="test-container-anno";var StructuredNode=function(DocumentNode$$1){function StructuredNode(){DocumentNode$$1.apply(this,arguments)}return DocumentNode$$1&&(StructuredNode.__proto__=DocumentNode$$1),StructuredNode.prototype=Object.create(DocumentNode$$1&&DocumentNode$$1.prototype),StructuredNode.prototype.constructor=StructuredNode,StructuredNode}(DocumentNode);StructuredNode.define({type:"structured-node",title:"text",body:"text",caption:"text"}),StructuredNode.isBlock=!0;var schema=new DocumentSchema$1("test-article","1.0.0");schema.getDefaultTextType=function(){return"paragraph"},schema.addNodes([TestMetaNode,Paragraph,Heading,Emphasis,Strong,Link,Image,Codeblock,TestNode,TestContainerAnnotation,StructuredNode,InlineWrapper]);var TestArticle=function(Document$$1){function TestArticle(){Document$$1.call(this,schema),this.create({type:"meta",id:"meta",title:"Untitled"}),this.create({type:"container",id:"body",nodes:[]})}return Document$$1&&(TestArticle.__proto__=Document$$1),TestArticle.prototype=Object.create(Document$$1&&Document$$1.prototype),TestArticle.prototype.constructor=TestArticle,TestArticle.prototype.getDocumentMeta=function(){return this.get("meta")},TestArticle}(Document),changeset1=createChangeset(new TestArticle,twoParagraphs),changeset2=createChangeset(new TestArticle,function(tx){twoParagraphs(tx),insertText$1$1(tx,{path:["p1","content"],pos:1,text:"!"}),insertText$1$1(tx,{path:["p1","content"],pos:3,text:"???"})}),changeStoreSeed={"test-doc":changeset1,"test-doc-2":changeset2},documentStoreSeed={"test-doc":{documentId:"test-doc",schemaName:"prose-article",schemaVersion:"1.0.0",version:1},"test-doc-2":{documentId:"test-doc-2",schemaName:"prose-article",schemaVersion:"1.0.0",version:3}};exports.ChangeStore=ChangeStore,exports.ClientConnection=ClientConnection,exports.CollabClient=CollabClient,exports.CollabEngine=CollabEngine,exports.CollabServer=CollabServer,exports.CollabSession=CollabSession,exports.DocumentClient=DocumentClient,exports.DocumentEngine=DocumentEngine,exports.DocumentServer=DocumentServer,exports.DocumentStore=DocumentStore,exports.SnapshotEngine=SnapshotEngine,exports.SnapshotStore=SnapshotStore,exports.WebSocketConnection=WebSocketConnection,exports.annotationHelpers=annotationHelpers,exports.Annotation=PropertyAnnotation,exports.BlockNode=BlockNode,exports.Container=Container,exports.ContainerAnnotation=ContainerAnnotation,exports.PropertyAnnotation=PropertyAnnotation,exports.Document=Document,exports.DocumentChange=DocumentChange,exports.documentHelpers=documentHelpers,exports.DocumentIndex=DocumentIndex,exports.DocumentNode=DocumentNode,exports.DocumentSession=DocumentSession,exports.DOMExporter=DOMExporter,exports.DOMImporter=DOMImporter,exports.Fragmenter=Fragmenter,exports.HTMLExporter=HTMLExporter,exports.HTMLImporter=HTMLImporter,exports.InlineNode=InlineNode,exports.JSONConverter=JSONConverter,exports.NodeIndex=NodeIndex,exports.TextBlock=TextBlock,exports.TextNode=TextNode$2,exports.Selection=Selection,exports.XMLExporter=XMLExporter,exports.XMLImporter=XMLImporter,exports.breakNode=breakNode,exports.copySelection=copySelection,exports.createAnnotation=createAnnotation,exports.deleteCharacter=deleteCharacter,exports.deleteNode=deleteNode,exports.deleteSelection=deleteSelection,exports.expandAnnotation=expandAnnotation,exports.fuseAnnotation=fuseAnnotation,exports.insertInlineNode=insertInlineNode,exports.insertNode=insertNode,exports.insertText=insertText,exports.mergeNodes=merge$1,exports.pasteContent=paste$1$1,exports.replaceText=replaceText,exports.switchTextType=switchTextType,exports.truncateAnnotation=truncateAnnotation,exports.updateAnnotations=updateAnnotations,exports.BasePackage=BasePackage,exports.BlockquotePackage=BlockquotePackage,exports.CodePackage=CodePackage,exports.EmphasisPackage=EmphasisPackage,exports.ImagePackage=ImagePackage,exports.InlineWrapperPackage=InlineWrapperPackage,exports.ParagraphPackage=ParagraphPackage,exports.PersistencePackage=PersistencePackage,exports.StrongPackage=StrongPackage,exports.SubscriptPackage=SubscriptPackage,exports.SuperscriptPackage=SuperscriptPackage,exports.HeadingPackage=HeadingPackage,exports.HeadingMacro=HeadingMacro,exports.SwitchTextTypeTool=SwitchTextTypeTool,exports.SwitchTextTypeCommand=SwitchTextTypeCommand,exports.ProseEditorPackage=ProseEditorPackage,exports.ProseEditor=ProseEditor,exports.ProseArticle=ProseArticle,exports.ProseEditorOverlayTools=ProseEditorOverlayTools,exports.LinkPackage=LinkPackage,exports.EditLinkTool=EditLinkTool,exports.Link=Link,exports.LinkCommand=LinkCommand,exports.LinkComponent=LinkComponent,exports.InsertInlineNodeCommand=InsertInlineNodeCommand,exports.EditInlineNodeCommand=EditInlineNodeCommand,exports.InlineNodeComponent=InlineNodeComponent,exports.Button=Button,exports.ScrollPanePackage=ScrollPanePackage,exports.ScrollPane=ScrollPane,exports.SplitPanePackage=SplitPanePackage,exports.SplitPane=SplitPane,exports.ScrollbarPackage=ScrollbarPackage,exports.Scrollbar=Scrollbar,exports.LayoutPackage=LayoutPackage,exports.Layout=Layout,exports.GridPackage=GridPackage,exports.Grid=Grid,exports.TabbedPanePackage=TabbedPanePackage,exports.TabbedPane=TabbedPane,exports.ModalPackage=ModalPackage,exports.Modal=Modal,exports.InputPackage=InputPackage,exports.Input=Input,exports.ResponsiveApplication=ResponsiveApplication,exports.TOC=TOC,exports.TOCProvider=TOCProvider,exports.ToolDropdown=ToolDropdown,exports.Tool=Tool,exports.Toolbar=Toolbar,exports.ToolGroup=ToolGroup,exports.Surface=Surface,exports.AbstractEditor=AbstractEditor,exports.AnnotationCommand=AnnotationCommand,exports.EditAnnotationCommand=EditAnnotationCommand,exports.AnnotationComponent=AnnotationComponent,exports.AnnotationTool=AnnotationTool,exports.BlockNodeComponent=BlockNodeComponent,exports.Command=Command,exports.Component=Component,exports.ContainerEditor=ContainerEditor,exports.DefaultDOMElement=DefaultDOMElement,exports.FontAwesomeIcon=FontAwesomeIcon,exports.InsertNodeCommand=InsertNodeCommand,exports.Highlights=Highlights,exports.OverlayTools=OverlayTools,exports.RenderingEngine=RenderingEngine,exports.Router=Router,exports.TextBlockComponent=TextBlockComponent,exports.TextPropertyComponent=TextPropertyComponent,exports.TextPropertyEditor=TextPropertyEditor,exports.UnsupportedNodeComponent=UnsupportedNodeComponent,exports.ArrayIterator=ArrayIterator,exports.Configurator=Configurator,exports.EventEmitter=EventEmitter,exports.Factory=Factory,exports.inBrowser=inBrowser,exports.makeMap=makeMap,exports.keys=keys$2,exports.platform=platform,exports.Registry=Registry,exports.request=request,exports.SubstanceError=SubstanceError,exports.substanceGlobals=substanceGlobals$1,exports.TreeIndex=TreeIndex,exports.uuid=uuid$1,exports.twoParagraphs=twoParagraphs,exports.MessageQueue=MessageQueue,exports.TestWebSocketServer=TestWebSocketServer,exports.TestWebSocketConnection=TestWebSocketConnection,exports.TestCollabServer=TestCollabServer,exports.TestCollabSession=TestCollabSession,exports.changeStoreSeed=changeStoreSeed,exports.documentStoreSeed=documentStoreSeed,exports.createTestDocumentFactory=createTestDocumentFactory,exports.ProseEditorConfigurator=Configurator}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"substance-cheerio":1}],3:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var _Editor=require("./package/editor/Editor"),_Editor2=_interopRequireDefault(_Editor),_Viewer=require("./package/viewer/Viewer"),_Viewer2=_interopRequireDefault(_Viewer);angular.module("angular-substance-editor",[]).controller("Controller",["$scope",function($scope){}]).directive("substance",["SubstanceService",function(substanceService){return{restrict:"A",scope:{optionsxx:"="},link:function(scope,element,attributes){if("editor"==attributes.type){var editor=new _Editor2.default(substanceService);editor.render()}if("viewer"==attributes.type){var viewer=new _Viewer2.default(substanceService);viewer.render()}},template:"<substanceEditor></substanceEditor>"}}])},{"./package/editor/Editor":4,"./package/viewer/Viewer":7}],4:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_substance=require("substance"),config={name:"angular-substance",configure:function(config){config.import(_substance.ProseEditorPackage),config.import(_substance.ImagePackage),config.import(_substance.PersistencePackage)}},Editor=function(){function Editor(substanceService){_classCallCheck(this,Editor),this.substanceService=substanceService}return _createClass(Editor,[{key:"render",value:function(){var configurator=(new _substance.Configurator).import(config),article=configurator.createArticle(this.substanceService.loadDocument),documentSession=new _substance.DocumentSession(article,{saveHandler:this.substanceService});_substance.ProseEditor.mount({documentSession:documentSession,configurator:configurator},"substanceEditor")}}]),Editor}();exports.default=Editor},{substance:2}],5:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!==("undefined"==typeof call?"undefined":_typeof(call))&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof superClass?"undefined":_typeof(superClass)));subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_ToolbarViewer=require("./ToolbarViewer"),_ToolbarViewer2=_interopRequireDefault(_ToolbarViewer),_substance=require("substance"),DocumentViewer=function(_ProseEditor){function DocumentViewer(){return _classCallCheck(this,DocumentViewer),_possibleConstructorReturn(this,(DocumentViewer.__proto__||Object.getPrototypeOf(DocumentViewer)).apply(this,arguments))}return _inherits(DocumentViewer,_ProseEditor),_createClass(DocumentViewer,[{key:"render",value:function($$){var SplitPane=this.componentRegistry.get("split-pane"),el=$$("div").addClass("sc-prose-editor"),toolbar=this._renderToolbar($$),editor=this._renderEditor($$),ScrollPane=this.componentRegistry.get("scroll-pane"),contentPanel=$$(ScrollPane,{scrollbarPosition:"right",overlay:_substance.ProseEditorOverlayTools}).append(editor).ref("contentPanel");return el.append($$(SplitPane,{splitType:"horizontal"}).append(toolbar,contentPanel)),el}},{key:"_renderToolbar",value:function($$){return $$(_ToolbarViewer2.default,{commandStates:{}}).ref("toolbar")}},{key:"_renderEditor",value:function($$){var configurator=this.props.configurator;return $$(_substance.ContainerEditor,{disabled:!0,documentSession:this.documentSession,node:this.doc.get("body"),commands:configurator.getSurfaceCommandNames(),textTypes:configurator.getTextTypes()}).ref("body")}}]),DocumentViewer}(_substance.ProseEditor);exports.default=DocumentViewer},{"./ToolbarViewer":6,substance:2}],6:[function(require,module,exports){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!==("undefined"==typeof call?"undefined":_typeof(call))&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+("undefined"==typeof superClass?"undefined":_typeof(superClass)));subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_substance=require("substance"),ToolbarViewer=function(_Component){function ToolbarViewer(){return _classCallCheck(this,ToolbarViewer),_possibleConstructorReturn(this,(ToolbarViewer.__proto__||Object.getPrototypeOf(ToolbarViewer)).apply(this,arguments))}return _inherits(ToolbarViewer,_Component),_createClass(ToolbarViewer,[{key:"render",value:function($$){var el=$$("div").addClass(this.getClassNames());return el}},{key:"getClassNames",value:function(){return"sc-toolbar"}}]),ToolbarViewer}(_substance.Component);exports.default=ToolbarViewer},{substance:2}],7:[function(require,module,exports){"use strict";function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),_substance=require("substance"),_DocumentViewer=require("./DocumentViewer"),_DocumentViewer2=_interopRequireDefault(_DocumentViewer),config={name:"angular-substance",configure:function(config){config.import(_substance.ProseEditorPackage)}},Viewer=function(){function Viewer(substanceService){_classCallCheck(this,Viewer),this.substanceService=substanceService}return _createClass(Viewer,[{key:"render",value:function(){var configurator=(new _substance.Configurator).import(config),article=configurator.createArticle(this.substanceService.loadDocument),documentSession=new _substance.DocumentSession(article);_DocumentViewer2.default.mount({documentSession:documentSession,configurator:configurator},"substanceEditor")}}]),Viewer}();exports.default=Viewer},{"./DocumentViewer":5,substance:2}]},{},[3]);